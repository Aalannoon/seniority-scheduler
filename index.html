<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Seniority Scheduler Dashboard</title>

<style>
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin: 20px;
  background: #1e1e2f;
  color: #f0f0f0;
}
body.light-mode { background:#f8f9fa; color:#333; }

h1 { font-size:26px; margin: 10px 0; }

/* TABS */
.tabs { 
  display:flex; 
  gap:6px; 
  margin-bottom:12px; 
  flex-wrap:wrap; 
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tabs button {
  padding:8px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#2e2e3d;
  color:#ccc;
  white-space: nowrap;
  min-height: 44px; /* Touch-friendly */
}
.tabs button.active { background:#4e9af1; color:#fff; }

/* INPUTS */
input, select, button {
  margin:4px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
  font-size: 14px;
  min-height: 40px; /* Touch-friendly */
}
button { 
  background:#4e9af1; 
  color:#fff; 
  font-weight:bold; 
  cursor:pointer;
  touch-action: manipulation; /* Prevent double-tap zoom */
}
button.delete { background:#c0392b; }
button.retire { background:#8e44ad; }
button.print { background:#27ae60; }

/* TABLE */
table { 
  border-collapse:collapse; 
  width:100%; 
  margin-top:10px;
  display: table; /* Desktop default */
}
th, td {
  padding:8px;
  text-align:center;
  border:1px solid #555;
  position:relative;
  min-width: 80px;
}
th { background:#4e9af1; color:#fff; font-weight: bold; }

/* STATUS */
.status-retired { background:#555; opacity:0.6; }

/* SHIFTS */
.shift-4 { background:#2ecc71; }      /* Green - 4 hours */
.shift-5 { background:#3498db; }      /* Blue - 5 hours */
.shift-6 { background:#e67e22; }      /* Orange - 6 hours */
.shift-7 { background:#e91e63; }      /* Pink - 7 hours */
.shift-8 { background:#f1c40f; color:#000; }  /* Yellow - 8 hours */
.shift-ot { background:#9b59b6; }     /* Purple - overtime (>8) */

/* LOCKED CELLS */
.locked-cell {
  border: 3px solid #f39c12 !important;
  position: relative;
}
.locked-cell::after {
  content: 'üîí';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 10px;
}

/* CONFLICT CELLS */
.conflict-cell {
  border: 3px solid #e74c3c !important;
  position: relative;
}
.conflict-cell::before {
  content: '‚ö†Ô∏è';
  position: absolute;
  top: 2px;
  left: 2px;
  font-size: 10px;
}

/* CLICKABLE CELLS */
td[onclick], td.clickable { cursor:pointer; }
td[onclick]:hover, td.clickable:hover { outline:2px dashed #4e9af1; }

/* TOOLTIP */
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 12px;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

/* AUDIT LOG */
.audit-entry {
  padding: 8px;
  margin: 4px 0;
  background: #2e2e3d;
  border-radius: 4px;
  font-size: 13px;
}
.audit-filters {
  margin-bottom: 15px;
}

/* PRINT */
@media print {
  body { background:#fff !important; color:#000 !important; }
  .tabs, button, input, select { display:none !important; }
  .tab { display:none !important; }
  #scheduleTab { display:block !important; }
  table { font-size:12px; page-break-inside: avoid; }
  th { background:#ddd !important; color:#000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .locked-cell::after, .conflict-cell::before { display: none; }
  .shift-4, .shift-5, .shift-6, .shift-7, .shift-8, .shift-ot {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  h1 { color: #000 !important; }
}

/* TABS */
.tab { display:none; }
.tab.active { display:block; }

/* SETTINGS */
.settings-section {
  margin: 20px 0;
  padding: 15px;
  background: #2e2e3d;
  border-radius: 8px;
  max-width: 100%;
}
.settings-section h3 {
  margin-top: 0;
}
.setting-row {
  margin: 10px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.setting-row label {
  min-width: 150px;
}
.setting-row input {
  width: 100px;
}

/* MOBILE SCHEDULE CARDS (hidden on desktop) */
.mobile-schedule {
  display: none;
}

.mobile-employee-card {
  background: #2e2e3d;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}

.mobile-employee-card h3 {
  margin: 0 0 10px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mobile-day-card {
  background: #1e1e2f;
  border-radius: 6px;
  padding: 10px;
  margin: 8px 0;
  border-left: 4px solid #4e9af1;
}

.mobile-day-header {
  font-weight: bold;
  margin-bottom: 5px;
  color: #4e9af1;
}

.mobile-shift-info {
  padding: 8px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 5px;
}

.mobile-shift-empty {
  color: #95a5a6;
  font-style: italic;
}

/* RESPONSIVE BREAKPOINTS */

/* TABLET: 768px - 1024px */
@media (max-width: 1024px) {
  body {
    margin: 10px;
  }
  
  h1 {
    font-size: 22px;
  }
  
  .tabs button {
    padding: 6px 10px;
    font-size: 13px;
  }
  
  /* Make table scrollable horizontally on tablet */
  .schedule-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  th, td {
    padding: 6px;
    font-size: 13px;
    min-width: 70px;
  }
  
  .settings-section {
    padding: 10px;
  }
  
  .setting-row {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .setting-row label {
    min-width: auto;
  }
}

/* MOBILE: < 768px */
@media (max-width: 768px) {
  body {
    margin: 5px;
  }
  
  h1 {
    font-size: 18px;
  }
  
  /* Stack tabs vertically on very small screens if needed */
  .tabs {
    gap: 4px;
  }
  
  .tabs button {
    padding: 8px 12px;
    font-size: 12px;
    flex: 1 1 auto;
  }
  
  /* Hide desktop table on mobile */
  #scheduleTable {
    display: none;
  }
  
  /* Show mobile card layout */
  .mobile-schedule {
    display: block;
  }
  
  /* Make inputs full width on mobile */
  input, select, textarea {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  
  /* Stack buttons vertically on mobile */
  button {
    display: block;
    width: 100%;
    margin: 4px 0;
  }
  
  /* Exception: Keep tab buttons inline */
  .tabs button {
    display: inline-block;
    width: auto;
  }
  
  /* Exception: Keep small utility buttons inline */
  button.delete,
  button.clear-day-btn {
    display: inline-block;
    width: auto;
    padding: 4px 8px;
    font-size: 10px;
    min-height: auto;
  }
  
  /* Tables in other tabs scroll horizontally */
  table {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    white-space: nowrap;
  }
  
  thead, tbody, tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  
  th, td {
    padding: 4px;
    font-size: 12px;
    min-width: 60px;
  }
  
  .audit-entry {
    font-size: 12px;
    padding: 6px;
  }
  
  .settings-section {
    padding: 8px;
  }
  
  .setting-row input {
    width: 100%;
  }
}

/* VERY SMALL MOBILE: < 480px */
@media (max-width: 480px) {
  h1 {
    font-size: 16px;
  }
  
  .tabs button {
    font-size: 11px;
    padding: 6px 8px;
  }
  
  .mobile-employee-card {
    padding: 10px;
  }
  
  .mobile-day-card {
    padding: 8px;
  }
  
  th, td {
    padding: 3px;
    font-size: 11px;
    min-width: 50px;
  }
}
</style>
</head>

<body>

<h1 id="weekHeader"></h1>

<button onclick="toggleDarkMode()">Toggle Dark Mode</button>
<button class="print" onclick="printSchedule()">Print / Save PDF</button>

<div class="tabs">
  <button id="tabEmpBtn" onclick="showTab('employeesTab')">Employees</button>
  <button id="tabEvBtn" onclick="showTab('eventsTab')">Events</button>
  <button id="tabSchBtn" onclick="showTab('scheduleTab')">Schedule</button>
  <button id="tabAuditBtn" onclick="showTab('auditTab')">Audit Log</button>
  <button id="tabSettingsBtn" onclick="showTab('settingsTab')">Settings</button>
  <button id="tabSupportBtn" onclick="showTab('supportTab')">Support / Contact</button>
</div>

<!-- EMPLOYEES -->
<div id="employeesTab" class="tab">
<h2>Employees</h2>

<input id="empName" placeholder="Name" />
<select id="empType"><option>FT</option><option>PT</option></select>
<input id="empSeniority" type="number" placeholder="Seniority" />
<select id="empPref">
  <option value="">No Pref</option>
  <option value="AM">AM</option>
  <option value="PM">PM</option>
</select>
<button onclick="addEmployee()">Add</button>

<table>
<thead>
<tr>
  <th>Name</th><th>Type</th><th>Seniority</th><th>Pref</th>
  <th>Vacation</th><th>Sick</th><th>Retire</th>
</tr>
</thead>
<tbody id="employeesTable"></tbody>
</table>
</div>

<!-- EVENTS -->
<div id="eventsTab" class="tab">
<h2>Events</h2>

<input id="eventName" placeholder="Event Name" />
<input id="eventDate" type="date" />
<input id="eventStart" type="time" onchange="autoRecommendStaff()" />
<input id="eventEnd" type="time" onchange="autoRecommendStaff()" />
<input id="eventGuests" type="number" placeholder="Guests" oninput="autoRecommendStaff()" />

<select id="eventService" onchange="autoRecommendStaff()">
  <option>Plated Service</option>
  <option>Buffet Service</option>
  <option>Reception</option>
  <option>Coffee Break</option>
</select>

<input id="eventStaff" type="number" placeholder="Staff Needed" />
<button onclick="addEvent()">Add / Save</button>

<table>
<thead>
<tr>
  <th>Name</th><th>Date</th><th>Time</th>
  <th>Guests</th><th>Service</th><th>Staff</th>
  <th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="eventsTable"></tbody>
</table>
</div>

<!-- SCHEDULE -->
<div id="scheduleTab" class="tab">
<h2>Schedule</h2>

<button onclick="changeWeek(-1)">‚¨Ö Previous Week</button>
<button onclick="changeWeek(1)">Next Week ‚û°</button>
<button onclick="generateSchedule()">Generate</button>
<button onclick="regenerateSchedule()">Regenerate</button>
<button id="globalLockBtn" onclick="toggleGlobalLock()" style="background:#f39c12;">üîì Unlock Schedule</button>

<div class="schedule-container">
  <table id="scheduleTable"></table>
</div>

<div id="mobileSchedule" class="mobile-schedule"></div>
</div>

<!-- AUDIT LOG -->
<div id="auditTab" class="tab">
<h2>Audit Log</h2>

<div class="audit-filters">
  <input id="auditEmployee" placeholder="Filter by employee" />
  <input id="auditDate" type="date" placeholder="Filter by date" />
  <button onclick="filterAuditLog()">Filter</button>
  <button onclick="clearAuditFilter()">Clear Filter</button>
</div>

<div id="auditLogContainer"></div>
</div>

<!-- SETTINGS -->
<div id="settingsTab" class="tab">
<h2>Settings</h2>

<div class="settings-section">
  <h3>Staffing Ratios</h3>
  <p>Set the recommended number of guests per server for each service type:</p>
  
  <div class="setting-row">
    <label>Plated Service:</label>
    <span>1 server per</span>
    <input type="number" id="ratioPlated" value="20" min="1" />
    <span>guests</span>
  </div>
  
  <div class="setting-row">
    <label>Buffet Service:</label>
    <span>1 server per</span>
    <input type="number" id="ratioBuffet" value="30" min="1" />
    <span>guests</span>
  </div>
  
  <div class="setting-row">
    <label>Reception:</label>
    <span>1 server per</span>
    <input type="number" id="ratioReception" value="40" min="1" />
    <span>guests</span>
  </div>
  
  <div class="setting-row">
    <label>Coffee Break:</label>
    <span>1 server per</span>
    <input type="number" id="ratioCoffee" value="50" min="1" />
    <span>guests</span>
  </div>
  
  <button onclick="saveSettings()">Save Settings</button>
</div>
</div>

<!-- SUPPORT / CONTACT -->
<div id="supportTab" class="tab">
<h2>Support / Contact</h2>

<div class="settings-section">
  <h3>Report a Bug or Suggest a Feature</h3>
  <p>Have feedback about the scheduler? Found a bug? Have a feature request? Let us know!</p>
  
  <div style="margin-top: 20px;">
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Category:</label>
      <select id="supportCategory" style="width: 100%; max-width: 400px;">
        <option value="Bug">Bug Report</option>
        <option value="Suggestion">Feature Suggestion</option>
        <option value="Other">Other</option>
      </select>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Subject: <span style="color: #e74c3c;">*</span></label>
      <input type="text" id="supportSubject" placeholder="Brief description of the issue or suggestion" 
             style="width: 100%; max-width: 600px; padding: 8px;" />
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Message: <span style="color: #e74c3c;">*</span></label>
      <textarea id="supportMessage" placeholder="Please provide details about the bug or your suggestion..."
                style="width: 100%; max-width: 600px; min-height: 150px; padding: 8px; font-family: inherit;"></textarea>
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px; background: #34495e; border-radius: 6px; max-width: 600px;">
      <small style="color: #ecf0f1;">
        <strong>Privacy Note:</strong> This form does not automatically send any employee data or schedule information. 
        Only the information you type in the subject and message fields will be included.
      </small>
    </div>
    
    <button onclick="submitSupport()" style="background: #27ae60; font-size: 16px; padding: 10px 20px;">
      üìß Send Message
    </button>
    
    <div id="supportFeedback" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
  </div>
  
  <div style="margin-top: 30px; padding: 15px; background: #2e2e3d; border-radius: 8px; max-width: 600px;">
    <h4 style="margin-top: 0;">Alternative Contact Methods:</h4>
    <p style="margin: 5px 0;">
      üìß Email directly: <a href="/cdn-cgi/l/email-protection#99d8f5f0f8f5f8f7f7f6f6f7d9fef4f8f0f5b7faf6f4" style="color: #4e9af1;"><span class="__cf_email__" data-cfemail="c081aca9a1aca1aeaeafafae80a7ada1a9aceea3afad">[email&#160;protected]</span></a>
    </p>
    <p style="margin: 5px 0; color: #95a5a6; font-size: 14px;">
      We typically respond within 1-2 business days.
    </p>
  </div>
</div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
let employees = JSON.parse(localStorage.getItem("employees") || "[]");
let events = JSON.parse(localStorage.getItem("events") || "[]");
let manualEdits = JSON.parse(localStorage.getItem("manualEdits") || "{}");
let lockedCells = JSON.parse(localStorage.getItem("lockedCells") || "{}");
let lockedRows = JSON.parse(localStorage.getItem("lockedRows") || "{}"); // NEW: Row locks
let scheduleGlobalLock = JSON.parse(localStorage.getItem("scheduleGlobalLock") || "false"); // NEW: Global lock
let auditLog = JSON.parse(localStorage.getItem("auditLog") || "[]");
let settings = JSON.parse(localStorage.getItem("settings") || JSON.stringify({
  ratios: {
    "Plated Service": 20,
    "Buffet Service": 30,
    "Reception": 40,
    "Coffee Break": 50
  }
}));
let editingEventId = null;
let currentWeekOffset = 0;

function save(){
  localStorage.setItem("employees", JSON.stringify(employees));
  localStorage.setItem("events", JSON.stringify(events));
  localStorage.setItem("manualEdits", JSON.stringify(manualEdits));
  localStorage.setItem("lockedCells", JSON.stringify(lockedCells));
  localStorage.setItem("lockedRows", JSON.stringify(lockedRows));
  localStorage.setItem("scheduleGlobalLock", JSON.stringify(scheduleGlobalLock));
  localStorage.setItem("auditLog", JSON.stringify(auditLog));
  localStorage.setItem("settings", JSON.stringify(settings));
}

function addAuditEntry(action, empId, date, oldValue, newValue){
  const emp = employees.find(e => e.id === empId);
  auditLog.unshift({
    timestamp: new Date().toISOString(),
    action,
    employee: emp ? emp.name : 'Unknown',
    employeeId: empId,
    date,
    oldValue,
    newValue
  });
  
  // Keep only last 1000 entries
  if(auditLog.length > 1000) auditLog = auditLog.slice(0, 1000);
  
  save();
}

/* TABS */
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="employeesTab") tabEmpBtn.classList.add("active");
  if(id==="eventsTab") tabEvBtn.classList.add("active");
  if(id==="scheduleTab") { tabSchBtn.classList.add("active"); displaySchedule(); }
  if(id==="auditTab") { tabAuditBtn.classList.add("active"); renderAuditLog(); }
  if(id==="settingsTab") { tabSettingsBtn.classList.add("active"); loadSettings(); }
  if(id==="supportTab") { tabSupportBtn.classList.add("active"); }
}

/* EMPLOYEES */
function addEmployee(){
  if(!empName.value) return;
  const newEmp = {
    id: crypto.randomUUID(),
    name: empName.value,
    type: empType.value,
    seniority:+empSeniority.value || employees.filter(e=>!e.retired).length + 1,
    pref: empPref.value,
    vacation:false,
    sick:false,
    retired:false
  };
  employees.push(newEmp);
  empName.value = "";
  empSeniority.value = "";
  rebalanceSeniority();
  
  addAuditEntry('Employee Added', newEmp.id, null, null, `${newEmp.name} (${newEmp.type}, Seniority ${newEmp.seniority})`);
  save(); 
  renderEmployees();
}

function rebalanceSeniority(){
  employees.filter(e=>!e.retired)
    .sort((a,b)=>a.seniority-b.seniority)
    .forEach((e,i)=>e.seniority=i+1);
}

function retireEmployee(id){
  if(!confirm("Retire this employee?")) return;
  const emp = employees.find(e=>e.id===id);
  emp.retired=true;
  rebalanceSeniority();
  
  addAuditEntry('Employee Retired', id, null, 'Active', 'Retired');
  save(); 
  renderEmployees();
}

function renderEmployees(){
  employeesTable.innerHTML="";
  employees.sort((a,b)=>a.seniority-b.seniority).forEach(e=>{
    const row = document.createElement('tr');
    row.className = e.retired ? 'status-retired' : '';
    
    row.innerHTML = `
      <td>${e.name}</td>
      <td>${e.type}</td>
      <td>${e.retired ? '-' : e.seniority}</td>
      <td>${e.pref || "-"}</td>
      <td><input type="checkbox" class="vacation-check" ${e.vacation ? "checked" : ""}></td>
      <td><input type="checkbox" class="sick-check" ${e.sick ? "checked" : ""}></td>
      <td>${e.retired ? "‚Äî" : '<button class="retire">Retire</button>'}</td>
    `;
    
    const vacationCheck = row.querySelector('.vacation-check');
    const sickCheck = row.querySelector('.sick-check');
    const retireBtn = row.querySelector('.retire');
    
    if(vacationCheck) {
      vacationCheck.onchange = function() {
        toggleVacation(e.id, this.checked);
      };
    }
    
    if(sickCheck) {
      sickCheck.onchange = function() {
        toggleSick(e.id, this.checked);
      };
    }
    
    if(retireBtn) {
      retireBtn.onclick = () => retireEmployee(e.id);
    }
    
    employeesTable.appendChild(row);
  });
}

function toggleVacation(id, checked){
  const emp = employees.find(e=>e.id===id);
  emp.vacation=checked;
  addAuditEntry('Vacation Changed', id, null, !checked, checked);
  save();
}

function toggleSick(id, checked){
  const emp = employees.find(e=>e.id===id);
  emp.sick=checked;
  addAuditEntry('Sick Status Changed', id, null, !checked, checked);
  save();
}

/* EVENTS */
function autoRecommendStaff(){
  const guests=+eventGuests.value;
  if(!guests) return;
  const serviceType = eventService.value;
  const ratio = settings.ratios[serviceType] || 30;
  eventStaff.value=Math.ceil(guests/ratio);
}

function addEvent(){
  if(!eventName.value || !eventDate.value) return;
  const data={
    id: editingEventId || crypto.randomUUID(),
    name:eventName.value,
    date:eventDate.value,
    start:eventStart.value || "09:00",
    end:eventEnd.value || "17:00",
    guests:+eventGuests.value || 0,
    service:eventService.value,
    staff:+eventStaff.value || 1
  };
  
  if(editingEventId){
    const oldEvent = events.find(e=>e.id===editingEventId);
    Object.assign(oldEvent, data);
    addAuditEntry('Event Modified', null, data.date, 
      `${oldEvent.name} (${oldEvent.staff} staff)`,
      `${data.name} (${data.staff} staff)`);
    editingEventId=null;
  } else {
    events.push(data);
    addAuditEntry('Event Created', null, data.date, null, `${data.name} (${data.staff} staff)`);
  }
  
  eventName.value="";
  eventDate.value="";
  eventStart.value="";
  eventEnd.value="";
  eventGuests.value="";
  eventStaff.value="";
  
  save(); 
  renderEvents();
}

function renderEvents(){
  eventsTable.innerHTML="";
  events.forEach(ev=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${ev.name}</td>
      <td>${ev.date}</td>
      <td>${ev.start}‚Äì${ev.end}</td>
      <td>${ev.guests}</td>
      <td>${ev.service}</td>
      <td>${ev.staff}</td>
      <td><button class="edit-btn">Edit</button></td>
      <td><button class="delete">Delete</button></td>
    `;
    
    row.querySelector('.edit-btn').onclick = () => editEvent(ev.id);
    row.querySelector('.delete').onclick = () => deleteEvent(ev.id);
    
    eventsTable.appendChild(row);
  });
}

function editEvent(id){
  const e=events.find(x=>x.id===id);
  editingEventId=id;
  eventName.value=e.name;
  eventDate.value=e.date;
  eventStart.value=e.start;
  eventEnd.value=e.end;
  eventGuests.value=e.guests;
  eventService.value=e.service;
  eventStaff.value=e.staff;
}

function deleteEvent(id){
  if(!confirm("Delete event?")) return;
  const ev = events.find(e=>e.id===id);
  events=events.filter(e=>e.id!==id);
  addAuditEntry('Event Deleted', null, ev.date, `${ev.name}`, null);
  save(); 
  renderEvents();
}

/* HELPER FUNCTIONS */
const iso=d=>d.toISOString().split("T")[0];

function getWeekStart(){
  const d=new Date();
  d.setDate(d.getDate()+currentWeekOffset*7);
  const diff=d.getDay()===0?-6:1-d.getDay();
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d;
}

function roundToHalfHour(date) {
  const mins = date.getMinutes();
  if (mins < 15) date.setMinutes(0);
  else if (mins < 45) date.setMinutes(30);
  else { date.setMinutes(0); date.setHours(date.getHours() + 1); }
  date.setSeconds(0, 0);
  return date;
}

function timeStr(d){
  return d.toTimeString().slice(0,5);
}

function getShiftClassByHours(h){
  if(h === 4) return "shift-4";
  if(h === 5) return "shift-5";
  if(h === 6) return "shift-6";
  if(h === 7) return "shift-7";
  if(h === 8) return "shift-8";
  if(h > 8) return "shift-ot";
  return "";
}

function calculateSmartShift(ev, paidHours) {
  const baseStart = new Date(`1970-01-01T${ev.start}`);
  const baseEnd   = new Date(`1970-01-01T${ev.end}`);

  let buffer = 1;
  if (ev.guests >= 200) buffer = 2;

  const scheduledHours = paidHours > 4 ? paidHours + 0.5 : paidHours;

  let startA = new Date(baseStart);
  startA.setHours(startA.getHours() - buffer);
  let endA = new Date(startA);
  endA.setMinutes(endA.getMinutes() + (scheduledHours * 60));

  let endB = new Date(baseEnd);
  endB.setHours(endB.getHours() + buffer);
  let startB = new Date(endB);
  startB.setMinutes(startB.getMinutes() - (scheduledHours * 60));

  startA = roundToHalfHour(new Date(startA));
  endA   = roundToHalfHour(new Date(endA));
  startB = roundToHalfHour(new Date(startB));
  endB   = roundToHalfHour(new Date(endB));

  const distA = Math.abs(startA - baseStart) + Math.abs(endA - baseEnd);
  const distB = Math.abs(startB - baseStart) + Math.abs(endB - baseEnd);

  return distA <= distB
    ? { start: startA, end: endA }
    : { start: startB, end: endB };
}

function normalizeHours(start, end){
  const diff=(new Date(`1970-01-01T${end}`)-new Date(`1970-01-01T${start}`))/3600000;
  if(diff<=4) return {h:4};
  if(diff<=5) return {h:5};
  if(diff<=6) return {h:6};
  if(diff<=7) return {h:7};
  if(diff<=8) return {h:8};
  return {h:Math.ceil(diff)};
}

/* CONFLICT DETECTION */
function detectConflicts(empId, date, shiftStart, shiftEnd){
  const conflicts = [];
  
  // Check all shifts for this employee across the week
  const start = getWeekStart();
  const days = [...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
  
  days.forEach(d => {
    const dateStr = iso(d);
    const key = empId + "_" + dateStr;
    
    if(dateStr === date) return; // Skip same day
    
    // Check if employee has a shift on adjacent days
    const edit = manualEdits[key];
    if(edit && edit.start && edit.end) {
      // Check rest time between shifts
      const prevDate = new Date(dateStr);
      const currDate = new Date(date);
      const dayDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);
      
      if(Math.abs(dayDiff) === 1) {
        const prevEnd = new Date(`1970-01-01T${edit.end}`);
        const currStart = new Date(`1970-01-01T${shiftStart}`);
        
        let gap;
        if(dayDiff === 1) {
          // Current is day after
          const prevEndMins = prevEnd.getHours() * 60 + prevEnd.getMinutes();
          const currStartMins = currStart.getHours() * 60 + currStart.getMinutes();
          gap = (1440 - prevEndMins) + currStartMins;
        } else {
          // Current is day before
          const currEndMins = new Date(`1970-01-01T${shiftEnd}`).getHours() * 60 + new Date(`1970-01-01T${shiftEnd}`).getMinutes();
          const prevStartMins = new Date(`1970-01-01T${edit.start}`).getHours() * 60 + new Date(`1970-01-01T${edit.start}`).getMinutes();
          gap = (1440 - currEndMins) + prevStartMins;
        }
        
        if(gap < 480) {
          conflicts.push(`Less than 8 hours rest from ${dateStr} shift`);
        }
      }
    }
  });
  
  return conflicts;
}

/* SCHEDULE FUNCTIONS */
function toggleGlobalLock(){
  scheduleGlobalLock = !scheduleGlobalLock;
  const btn = document.getElementById('globalLockBtn');
  
  if(scheduleGlobalLock) {
    btn.innerHTML = 'üîí Locked Schedule';
    btn.style.background = '#e74c3c';
    addAuditEntry('Schedule Locked', null, null, 'Unlocked', 'Locked');
  } else {
    btn.innerHTML = 'üîì Unlock Schedule';
    btn.style.background = '#f39c12';
    addAuditEntry('Schedule Unlocked', null, null, 'Locked', 'Unlocked');
  }
  
  save();
}

function toggleRowLock(empId){
  if(lockedRows[empId]) {
    delete lockedRows[empId];
    addAuditEntry('Row Unlocked', empId, null, 'Locked', 'Unlocked');
  } else {
    lockedRows[empId] = true;
    addAuditEntry('Row Locked', empId, null, 'Unlocked', 'Locked');
  }
  
  save();
  displaySchedule();
}

function toggleLock(empId, date){
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  
  if(lockedCells[key]) {
    delete lockedCells[key];
    addAuditEntry('Cell Unlocked', empId, date, 'Locked', 'Unlocked');
  } else {
    lockedCells[key] = true;
    addAuditEntry('Cell Locked', empId, date, 'Unlocked', 'Locked');
  }
  
  save();
  displaySchedule(); // Just refresh display, don't regenerate
}

function editScheduleCell(empId, date){
  // Check global lock first
  if(scheduleGlobalLock) {
    alert('Schedule is globally locked! Unlock it first using the "üîí Locked Schedule" button.');
    return;
  }
  
  // Check row lock
  if(lockedRows[empId]) {
    alert('This employee\'s entire row is locked! Click the lock icon next to their name to unlock.');
    return;
  }
  
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  const ev = events.find(e => e.date === date);
  
  let currentEdit = manualEdits[key];
  
  // Create a clearer menu dialog
  let dialog = "Edit shift for " + emp.name + " on " + date + ":\n\n";
  dialog += "Enter shift times:\n";
  dialog += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
  dialog += "SHIFT:\n";
  dialog += "  6 09:00 15:30\n";
  dialog += "  (hours start end)\n\n";
  dialog += "STATUS:\n";
  dialog += "  sick\n";
  dialog += "  vacation\n\n";
  dialog += "ACTIONS:\n";
  dialog += "  lock\n";
  dialog += "  clear\n";
  dialog += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
  
  if(lockedCells[key]) {
    dialog += "üîí LOCKED\n\n";
  }
  
  if(currentEdit) {
    if(currentEdit.status === 'sick') {
      dialog += "Current: SICK\n";
    } else if(currentEdit.status === 'vacation') {
      dialog += "Current: VACATION\n";
    } else if(currentEdit.start && currentEdit.end) {
      dialog += "Current: " + currentEdit.hours + "h (" + currentEdit.start + "-" + currentEdit.end + ")\n";
    } else {
      dialog += "Current: " + (currentEdit.hours || currentEdit) + "h (no times)\n";
    }
  } else if(ev) {
    dialog += "Event: " + ev.name + "\n";
  } else {
    dialog += "Current: (empty)\n";
  }
  
  const input = prompt(dialog);
  
  if(input === null) return;
  
  const trimmed = input.trim().toLowerCase();
  
  // Lock/unlock
  if(trimmed === 'lock') {
    toggleLock(empId, date);
    return;
  }
  
  // Remove shift
  if(trimmed === 'remove' || trimmed === 'clear' || trimmed === '') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
    delete manualEdits[key];
    addAuditEntry('Shift Removed', empId, date, oldValue, null);
    save(); 
    displaySchedule();
    return;
  }
  
  // Mark as sick
  if(trimmed === 'sick') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'sick' };
    addAuditEntry('Marked Sick', empId, date, oldValue, 'SICK');
    save();
    displaySchedule();
    return;
  }
  
  // Mark as vacation
  if(trimmed === 'vacation' || trimmed === 'vac') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'vacation' };
    addAuditEntry('Marked Vacation', empId, date, oldValue, 'VACATION');
    save();
    displaySchedule();
    return;
  }
  
  // Parse shift input - MUST include times
  let newEdit = null;
  
  const parts = input.trim().split(/\s+/);
  
  if(parts.length === 3) {
    // Format: "6 09:00 15:30"
    const hours = Number(parts[0]);
    const start = parts[1];
    const end = parts[2];
    
    // Validate time format
    if(/^\d{1,2}:\d{2}$/.test(start) && /^\d{1,2}:\d{2}$/.test(end) && !isNaN(hours)) {
      newEdit = {
        hours: hours,
        start: start,
        end: end
      };
    }
  }
  
  if(!newEdit) {
    alert('Invalid format!\n\nMust include hours AND times:\n‚Ä¢ Example: 6 09:00 15:30\n\nOr use:\n‚Ä¢ sick\n‚Ä¢ vacation\n‚Ä¢ lock\n‚Ä¢ clear');
    return;
  }
  
  const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
  manualEdits[key] = newEdit;
  addAuditEntry('Shift Manually Edited', empId, date, oldValue, JSON.stringify(newEdit));
  
  save(); 
  displaySchedule();
}

function clearDay(dateStr){
  if(!confirm("Clear all shifts for this day?")) return;

  Object.keys(manualEdits).forEach(key=>{
    if(key.endsWith("_"+dateStr)){
      delete manualEdits[key];
    }
  });
  
  addAuditEntry('Day Cleared', null, dateStr, 'All shifts', null);
  save();
  displaySchedule(); // Just refresh display
}

function generateSchedule(){
  // This function GENERATES shifts from events
  if(!confirm("Generate schedule from events? This will create shifts for all employees based on events and settings.")) return;
  
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
  
  let shiftsCreated = 0;
  let skippedDueToLimit = 0;
  let understaffedEvents = []; // Track events that couldn't be fully staffed
  
  // First, count existing work days for each employee (manual edits)
  const employeeWorkDays = {};
  employees.filter(e => !e.retired).forEach(e => {
    employeeWorkDays[e.id] = 0;
    
    // Count days that already have manual edits
    days.forEach(d => {
      const dateStr = iso(d);
      const key = e.id + "_" + dateStr;
      if(manualEdits[key] && manualEdits[key].status !== 'sick' && manualEdits[key].status !== 'vacation') {
        employeeWorkDays[e.id]++;
      }
    });
  });
  
  const assignments = assignEmployeesToWeek(days);
  
  // Convert assignments to manual edits (but don't overwrite locked/existing manual edits)
  days.forEach(d => {
    const dateStr = iso(d);
    const ev = events.find(e => e.date === dateStr);
    
    if(!ev) {
      console.log(`No event on ${dateStr}`);
      return;
    }
    
    const assignedCount = assignments[dateStr] ? assignments[dateStr].length : 0;
    const requiredStaff = ev.staff;
    
    // Check if event is understaffed
    if(assignedCount < requiredStaff) {
      understaffedEvents.push({
        name: ev.name,
        date: dateStr,
        assigned: assignedCount,
        required: requiredStaff,
        shortage: requiredStaff - assignedCount
      });
      console.log(`‚ö†Ô∏è ${ev.name} on ${dateStr}: only ${assignedCount}/${requiredStaff} staff assigned`);
    }
    
    if(!assignments[dateStr]) {
      console.log(`No assignments for ${dateStr} (event: ${ev.name})`);
      return;
    }
    
    console.log(`Event: ${ev.name} on ${dateStr}, assigned: ${assignedCount}/${requiredStaff} employees`);
    
    assignments[dateStr].forEach(empId => {
      const key = empId + "_" + dateStr;
      
      // Skip if locked or already manually edited
      if(lockedCells[key]) {
        console.log(`Skipping ${key} - locked`);
        return;
      }
      if(manualEdits[key]) {
        console.log(`Skipping ${key} - already has manual edit`);
        return;
      }
      
      // Check 5-day limit (including already scheduled days)
      if(employeeWorkDays[empId] >= 5) {
        const emp = employees.find(e => e.id === empId);
        console.log(`Skipping ${emp.name} on ${dateStr} - already worked 5 days this week`);
        skippedDueToLimit++;
        return;
      }
      
      // Calculate shift times
      const s = normalizeHours(ev.start, ev.end);
      const t = calculateSmartShift(ev, s.h);
      
      // Create the shift as a manual edit
      manualEdits[key] = {
        hours: s.h,
        start: timeStr(t.start),
        end: timeStr(t.end),
        generated: true // Mark as auto-generated
      };
      
      // Increment work day counter
      employeeWorkDays[empId]++;
      
      shiftsCreated++;
      console.log(`Created shift for ${key}: ${s.h}h (work days: ${employeeWorkDays[empId]})`);
    });
  });
  
  console.log(`Total shifts created: ${shiftsCreated}`);
  console.log(`Shifts skipped due to 5-day limit: ${skippedDueToLimit}`);
  console.log(`Understaffed events: ${understaffedEvents.length}`);
  
  // Build alert message
  let message = '';
  if(shiftsCreated === 0) {
    message = `No shifts were created. Make sure you have:\n1. Events in the current week\n2. Available employees (not retired/sick/vacation)\n3. Unlocked cells\n4. Employees haven't reached 5-day work limit`;
  } else {
    message = `‚úÖ Created ${shiftsCreated} shifts!`;
    
    if(skippedDueToLimit > 0) {
      message += `\n\n‚ö†Ô∏è ${skippedDueToLimit} potential shifts skipped (5-day limit)`;
    }
    
    if(understaffedEvents.length > 0) {
      message += `\n\nüö® UNDERSTAFFED EVENTS:\n`;
      understaffedEvents.forEach(evt => {
        const dateObj = new Date(evt.date);
        const dateDisplay = dateObj.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'});
        message += `\n‚Ä¢ ${evt.name} (${dateDisplay})\n  Needs ${evt.shortage} more staff (${evt.assigned}/${evt.required})`;
      });
      message += `\n\nYou may need to:\n- Manually assign more employees\n- Hire additional staff\n- Reduce event requirements`;
    }
  }
  alert(message);
  
  addAuditEntry('Schedule Generated', null, null, null, `Generated ${shiftsCreated} shifts, ${understaffedEvents.length} understaffed events`);
  save();
  displaySchedule();
}

function displaySchedule(){
  // This function just DISPLAYS the current schedule (manual edits + locked cells)
  scheduleTable.innerHTML="";
  const mobileSchedule = document.getElementById('mobileSchedule');
  mobileSchedule.innerHTML = "";
  
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });

  weekHeader.textContent = `${days[0].toLocaleDateString()} ‚Äì ${days[6].toLocaleDateString()}`;

  // ========== DESKTOP TABLE VIEW ==========
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>üîí</th><th>Employee</th>';
  
  days.forEach(d=>{
    const th = document.createElement('th');
    const ds = iso(d);
    th.innerHTML = `
      ${d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"})}
      <br>
      <button class="delete clear-day-btn" style="margin-top:4px; font-size:10px;">üóë</button>
    `;
    th.querySelector('.clear-day-btn').onclick = () => clearDay(ds);
    headerRow.appendChild(th);
  });
  
  headerRow.innerHTML += '<th>Total</th><th>Days</th>';
  scheduleTable.appendChild(headerRow);

  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0;
    let daysWorked=0;
    const row = document.createElement('tr');
    
    // Add row lock toggle
    const lockCell = document.createElement('td');
    const isRowLocked = lockedRows[emp.id];
    lockCell.innerHTML = isRowLocked ? 'üîí' : 'üîì';
    lockCell.style.cursor = 'pointer';
    lockCell.style.fontSize = '18px';
    lockCell.onclick = () => toggleRowLock(emp.id);
    lockCell.title = isRowLocked ? 'Click to unlock this row' : 'Click to lock this row';
    row.appendChild(lockCell);
    
    // Add employee name
    const nameCell = document.createElement('td');
    nameCell.textContent = emp.name;
    row.appendChild(nameCell);

    days.forEach(d=>{
      const dateStr = iso(d);
      const key=emp.id+"_"+dateStr;
      const cell = document.createElement('td');
      cell.className = 'clickable';
      cell.setAttribute('data-emp-id', emp.id);
      cell.setAttribute('data-date', dateStr);
      
      const isLocked = lockedCells[key];
      if(isLocked) cell.classList.add('locked-cell');
      if(lockedRows[emp.id]) cell.classList.add('locked-cell');

      // Check for manual edits (includes generated shifts)
      if(manualEdits[key]){
        const edit = manualEdits[key];
        
        if(edit.status === 'sick') {
          cell.style.background = '#95a5a6';
          cell.innerHTML = 'SICK';
          cell.onclick = () => editScheduleCell(emp.id, dateStr);
          row.appendChild(cell);
          return;
        }
        
        if(edit.status === 'vacation') {
          cell.style.background = '#3498db';
          cell.innerHTML = 'VAC';
          cell.onclick = () => editScheduleCell(emp.id, dateStr);
          row.appendChild(cell);
          return;
        }
        
        const h = edit.hours || edit;
        total += h;
        daysWorked++; // Count this as a worked day
        cell.className += ' ' + getShiftClassByHours(h);
        
        if(edit.start && edit.end) {
          const conflicts = detectConflicts(emp.id, dateStr, edit.start, edit.end);
          if(conflicts.length > 0) {
            cell.classList.add('conflict-cell');
            cell.title = 'Conflict: ' + conflicts.join(', ');
          }
          cell.innerHTML = `${h}h<br><small>${edit.start}‚Äì${edit.end}</small>`;
        } else {
          cell.innerHTML = `${h}h`;
        }
        
        cell.onclick = () => editScheduleCell(emp.id, dateStr);
        row.appendChild(cell);
        return;
      }

      // Empty cell if no manual edit
      cell.onclick = () => editScheduleCell(emp.id, dateStr);
      row.appendChild(cell);
    });

    const totalCell = document.createElement('td');
    totalCell.innerHTML = `<strong>${total}h</strong>`;
    row.appendChild(totalCell);
    
    // Add days worked column
    const daysCell = document.createElement('td');
    daysCell.innerHTML = `<strong>${daysWorked}/5</strong>`;
    if(daysWorked >= 5) {
      daysCell.style.background = '#e74c3c';
      daysCell.style.color = '#fff';
      daysCell.title = 'Maximum 5 days reached';
    } else if(daysWorked >= 4) {
      daysCell.style.background = '#f39c12';
      daysCell.style.color = '#000';
      daysCell.title = 'Close to 5-day limit';
    }
    row.appendChild(daysCell);
    
    scheduleTable.appendChild(row);
  });
  
  // ========== MOBILE CARD VIEW ==========
  employees.filter(e=>!e.retired).forEach(emp=>{
    let totalHours = 0;
    let totalDays = 0;
    
    const empCard = document.createElement('div');
    empCard.className = 'mobile-employee-card';
    
    const empHeader = document.createElement('h3');
    const isRowLocked = lockedRows[emp.id];
    
    const empNameSpan = document.createElement('span');
    empNameSpan.textContent = emp.name;
    
    const lockSpan = document.createElement('span');
    lockSpan.style.cursor = 'pointer';
    lockSpan.style.fontSize = '20px';
    lockSpan.textContent = isRowLocked ? 'üîí' : 'üîì';
    lockSpan.title = isRowLocked ? 'Unlock row' : 'Lock row';
    lockSpan.onclick = () => toggleRowLock(emp.id);
    
    empHeader.appendChild(empNameSpan);
    empHeader.appendChild(lockSpan);
    empCard.appendChild(empHeader);
    
    days.forEach(d => {
      const dateStr = iso(d);
      const key = emp.id + "_" + dateStr;
      
      const dayCard = document.createElement('div');
      dayCard.className = 'mobile-day-card';
      
      const dayHeader = document.createElement('div');
      dayHeader.className = 'mobile-day-header';
      dayHeader.textContent = d.toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'});
      dayCard.appendChild(dayHeader);
      
      const shiftInfo = document.createElement('div');
      shiftInfo.className = 'mobile-shift-info';
      shiftInfo.onclick = () => editScheduleCell(emp.id, dateStr);
      
      const isLocked = lockedCells[key];
      
      if(manualEdits[key]) {
        const edit = manualEdits[key];
        
        if(edit.status === 'sick') {
          shiftInfo.style.background = '#95a5a6';
          shiftInfo.innerHTML = '<strong>SICK</strong>';
        } else if(edit.status === 'vacation') {
          shiftInfo.style.background = '#3498db';
          shiftInfo.innerHTML = '<strong>VACATION</strong>';
        } else {
          const h = edit.hours || edit;
          totalHours += h;
          totalDays++;
          
          const shiftClass = getShiftClassByHours(h);
          shiftInfo.className += ' ' + shiftClass;
          
          if(isLocked) {
            shiftInfo.innerHTML = `üîí <strong>${h}h</strong>`;
          } else {
            shiftInfo.innerHTML = `<strong>${h}h</strong>`;
          }
          
          if(edit.start && edit.end) {
            shiftInfo.innerHTML += `<br><small>${edit.start} ‚Äì ${edit.end}</small>`;
          }
          
          const conflicts = detectConflicts(emp.id, dateStr, edit.start, edit.end);
          if(conflicts.length > 0) {
            shiftInfo.innerHTML = '‚ö†Ô∏è ' + shiftInfo.innerHTML;
            shiftInfo.title = 'Conflict: ' + conflicts.join(', ');
          }
        }
      } else {
        shiftInfo.className += ' mobile-shift-empty';
        shiftInfo.innerHTML = isLocked ? 'üîí Off' : 'Off';
      }
      
      dayCard.appendChild(shiftInfo);
      empCard.appendChild(dayCard);
    });
    
    // Add summary footer
    const summary = document.createElement('div');
    summary.style.marginTop = '10px';
    summary.style.padding = '10px';
    summary.style.background = '#1e1e2f';
    summary.style.borderRadius = '6px';
    summary.style.display = 'flex';
    summary.style.justifyContent = 'space-between';
    
    const totalHtml = `<strong>Total: ${totalHours}h</strong>`;
    let daysHtml = `<strong>Days: ${totalDays}/5</strong>`;
    
    if(totalDays >= 5) {
      daysHtml = `<strong style="color:#e74c3c;">Days: ${totalDays}/5 ‚ö†Ô∏è</strong>`;
    } else if(totalDays >= 4) {
      daysHtml = `<strong style="color:#f39c12;">Days: ${totalDays}/5</strong>`;
    }
    
    summary.innerHTML = `<span>${totalHtml}</span><span>${daysHtml}</span>`;
    empCard.appendChild(summary);
    
    mobileSchedule.appendChild(empCard);
  });
  
  // Update global lock button state
  const btn = document.getElementById('globalLockBtn');
  if(btn) {
    if(scheduleGlobalLock) {
      btn.innerHTML = 'üîí Locked Schedule';
      btn.style.background = '#e74c3c';
    } else {
      btn.innerHTML = 'üîì Unlock Schedule';
      btn.style.background = '#f39c12';
    }
  }
}

function assignEmployeesToWeek(days) {
  const assignments = {};
  const employeeShiftHistory = {};
  const employeeTotalHours = {};
  const employeeWorkDays = {}; // NEW: Track days worked per week
  
  employees.filter(e => !e.retired).forEach(e => {
    employeeShiftHistory[e.id] = null;
    employeeTotalHours[e.id] = 0;
    employeeWorkDays[e.id] = 0; // Initialize work day counter
  });
  
  days.forEach(d => {
    const dateStr = iso(d);
    const dayEvents = events.filter(e => e.date === dateStr);
    
    if(dayEvents.length === 0) return;
    
    dayEvents.sort((a, b) => a.start.localeCompare(b.start));
    
    const available = employees.filter(e => 
      !e.retired && 
      !e.sick && 
      !e.vacation
    ).map(e => ({...e, assignedToday: false}));
    
    dayEvents.forEach((ev, eventIndex) => {
      const isEarliestShift = eventIndex === 0;
      const isLatestShift = eventIndex === dayEvents.length - 1;
      
      const s = normalizeHours(ev.start, ev.end);
      const t = calculateSmartShift(ev, s.h);
      
      const scored = available
        .filter(emp => {
          const key = emp.id + "_" + dateStr;
          // Skip if locked or manually edited
          if(lockedCells[key] || manualEdits[key]) return false;
          // Skip if already assigned today
          if(emp.assignedToday) return false;
          
          // NEW: Skip if employee already worked 5 days this week
          if(employeeWorkDays[emp.id] >= 5) {
            console.log(`${emp.name} already worked 5 days this week, skipping`);
            return false;
          }
          
          return true;
        })
        .map(emp => {
          let score = 0;
          let canWork = true;
          
          const gapCheck = canWorkShift(emp.id, dateStr, t.start, employeeShiftHistory);
          if(!gapCheck.allowed) {
            canWork = false;
          }
          
          // FT FIRST, then seniority
          if(emp.type === 'FT') score += 10000;
          score += (100 - emp.seniority) * 100;
          
          const expectedHours = (100 - emp.seniority) * 0.5;
          if(employeeTotalHours[emp.id] < expectedHours) {
            score += 500;
          }
          
          if(emp.pref === 'AM' && isEarliestShift) {
            score += 200;
          } else if(emp.pref === 'PM' && isLatestShift) {
            score += 200;
          }
          
          return { ...emp, score, canWork };
        })
        .filter(emp => emp.canWork);
      
      scored.sort((a, b) => b.score - a.score);
      
      const assigned = scored.slice(0, ev.staff);
      
      assigned.forEach(emp => {
        const empRef = available.find(e => e.id === emp.id);
        if(empRef) empRef.assignedToday = true;
        
        employeeShiftHistory[emp.id] = {
          date: dateStr,
          endTime: t.end
        };
        
        employeeTotalHours[emp.id] += s.h;
        
        // NEW: Increment work day counter for this employee
        employeeWorkDays[emp.id] += 1;
      });
      
      if(!assignments[dateStr]) {
        assignments[dateStr] = [];
      }
      assigned.forEach(emp => {
        if(!assignments[dateStr].includes(emp.id)) {
          assignments[dateStr].push(emp.id);
        }
      });
    });
  });
  
  return assignments;
}

function canWorkShift(empId, currentDate, shiftStart, shiftHistory) {
  const lastShift = shiftHistory[empId];
  
  if(!lastShift) return {allowed: true};
  
  const lastDate = new Date(lastShift.date);
  const currentDateObj = new Date(currentDate);
  const daysDiff = Math.floor((currentDateObj - lastDate) / (1000 * 60 * 60 * 24));
  
  if(daysDiff > 1) return {allowed: true};
  
  if(daysDiff === 1) {
    const lastEnd = lastShift.endTime;
    const currentStart = shiftStart;
    
    const lastEndMinutes = lastEnd.getHours() * 60 + lastEnd.getMinutes();
    const currentStartMinutes = currentStart.getHours() * 60 + currentStart.getMinutes();
    
    const totalMinutesBetween = (1440 - lastEndMinutes) + currentStartMinutes;
    
    if(totalMinutesBetween >= 480) {
      return {allowed: true};
    } else {
      return {allowed: false, reason: 'needs 8 hour gap'};
    }
  }
  
  return {allowed: true};
}

function regenerateSchedule(){ 
  if(!confirm("This will clear ALL shifts (manual and generated) and regenerate from events. Continue?")) return;
  
  manualEdits = {};
  addAuditEntry('Schedule Regenerated', null, null, 'All shifts cleared', 'Regenerated from events');
  save();
  generateSchedule(); // This will regenerate
}

function changeWeek(n){ 
  currentWeekOffset+=n; 
  displaySchedule(); // Just display, don't regenerate
}

function toggleDarkMode(){ 
  document.body.classList.toggle("light-mode"); 
}

function printSchedule(){ 
  showTab("scheduleTab");
  // Wait for schedule to render before printing
  setTimeout(() => {
    window.print();
  }, 500);
}

/* AUDIT LOG */
function renderAuditLog(filter = {}){
  const container = document.getElementById('auditLogContainer');
  container.innerHTML = '';
  
  let filtered = auditLog;
  
  if(filter.employee) {
    filtered = filtered.filter(e => 
      e.employee.toLowerCase().includes(filter.employee.toLowerCase())
    );
  }
  
  if(filter.date) {
    filtered = filtered.filter(e => e.date === filter.date);
  }
  
  if(filtered.length === 0) {
    container.innerHTML = '<p>No audit entries found.</p>';
    return;
  }
  
  filtered.forEach(entry => {
    const div = document.createElement('div');
    div.className = 'audit-entry';
    
    const timestamp = new Date(entry.timestamp).toLocaleString();
    let html = `<strong>${entry.action}</strong> - ${timestamp}<br>`;
    
    if(entry.employee) html += `Employee: ${entry.employee}<br>`;
    if(entry.date) html += `Date: ${entry.date}<br>`;
    if(entry.oldValue) html += `Old: ${entry.oldValue}<br>`;
    if(entry.newValue) html += `New: ${entry.newValue}`;
    
    div.innerHTML = html;
    container.appendChild(div);
  });
}

function filterAuditLog(){
  renderAuditLog({
    employee: document.getElementById('auditEmployee').value,
    date: document.getElementById('auditDate').value
  });
}

function clearAuditFilter(){
  document.getElementById('auditEmployee').value = '';
  document.getElementById('auditDate').value = '';
  renderAuditLog();
}

/* SETTINGS */
function loadSettings(){
  document.getElementById('ratioPlated').value = settings.ratios["Plated Service"];
  document.getElementById('ratioBuffet').value = settings.ratios["Buffet Service"];
  document.getElementById('ratioReception').value = settings.ratios["Reception"];
  document.getElementById('ratioCoffee').value = settings.ratios["Coffee Break"];
}

function saveSettings(){
  settings.ratios["Plated Service"] = +document.getElementById('ratioPlated').value;
  settings.ratios["Buffet Service"] = +document.getElementById('ratioBuffet').value;
  settings.ratios["Reception"] = +document.getElementById('ratioReception').value;
  settings.ratios["Coffee Break"] = +document.getElementById('ratioCoffee').value;
  
  save();
  alert('Settings saved!');
}

/* SUPPORT / CONTACT */
function submitSupport(){
  const category = document.getElementById('supportCategory').value;
  const subject = document.getElementById('supportSubject').value.trim();
  const message = document.getElementById('supportMessage').value.trim();
  const feedback = document.getElementById('supportFeedback');
  
  // Validation
  if(!subject) {
    feedback.style.display = 'block';
    feedback.style.background = '#e74c3c';
    feedback.style.color = '#fff';
    feedback.innerHTML = '‚ùå Please enter a subject';
    return;
  }
  
  if(!message) {
    feedback.style.display = 'block';
    feedback.style.background = '#e74c3c';
    feedback.style.color = '#fff';
    feedback.innerHTML = '‚ùå Please enter a message';
    return;
  }
  
  // Build email content
  const emailSubject = `[Scheduler ${category}] ${subject}`;
  const emailBody = `Category: ${category}\n\n${message}\n\n---\nSent from Seniority Scheduler Dashboard`;
  
  // Create mailto link
  const mailtoLink = `mailto:Alialannoon@gmail.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
  
  // Open email client
  window.location.href = mailtoLink;
  
  // Show success message
  feedback.style.display = 'block';
  feedback.style.background = '#27ae60';
  feedback.style.color = '#fff';
  feedback.innerHTML = '‚úÖ Your email client should open shortly. Please send the pre-filled email to complete your submission.';
  
  // Clear form after a delay
  setTimeout(() => {
    document.getElementById('supportSubject').value = '';
    document.getElementById('supportMessage').value = '';
    document.getElementById('supportCategory').value = 'Bug';
  }, 2000);
  
  // Log in audit
  addAuditEntry('Support Request', null, null, null, `${category}: ${subject}`);
  save();
}

/* INIT */
renderEmployees();
renderEvents();
showTab("employeesTab");
</script>
</body>
</html>
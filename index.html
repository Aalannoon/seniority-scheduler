<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BanquetLogic - Employee Scheduler</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* Brand: blue + charcoal workforce palette */
:root {
  --brand-primary: #4e9af1;
  --brand-primary-dark: #3d7bc9;
  --brand-bg: #252a32;
  --brand-bg-elevated: #2d343e;
  --brand-text: #e8eaed;
  --brand-text-muted: #9ca3af;
  --brand-text-quiet: #6b7280;
  --brand-accent-muted: #6b7c8d;
  --brand-border: #3d4550;
}

body {
  font-family: "Inter", "DM Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  margin: 0;
  padding: 24px;
  background: var(--brand-bg);
  color: var(--brand-text);
  font-size: 14px;
  line-height: 1.5;
}
body.light-mode {
  background: #f0f2f5;
  color: #1a1f26;
  --brand-bg: #f0f2f5;
  --brand-bg-elevated: #ffffff;
  --brand-text: #1a1f26;
  --brand-text-muted: #374151;
  --brand-text-quiet: #4b5563;
  --brand-border: #9ca3af;
}
body.light-mode input,
body.light-mode select,
body.light-mode textarea {
  background: #fff !important;
  color: #1a1f26 !important;
  border-color: #9ca3af !important;
}
body.light-mode input::placeholder,
body.light-mode textarea::placeholder {
  color: #6b7280;
}
body.light-mode label {
  color: #374151;
}
body.light-mode .support-field label {
  color: #1a1f26;
}
body.light-mode .assignment-style-intro {
  color: #1a1f26;
}
body.light-mode .data-mgmt-note {
  color: #374151;
}
body.light-mode .labor-cost-disclaimer {
  color: #374151;
}
body.light-mode .email-cell-placeholder {
  color: #374151;
}
body.light-mode .labor-cost-panel {
  background: #e5e7eb !important;
  border-color: #9ca3af !important;
}
body.light-mode .labor-cost-panel,
body.light-mode .labor-cost-panel strong,
body.light-mode .labor-cost-panel p {
  color: #1a1f26;
}
body.light-mode #absenceModal label {
  color: #374151;
}
body.light-mode th,
body.light-mode td {
  border-color: #b8bcc4 !important;
}
body.light-mode td {
  color: #1a1f26;
}
body.light-mode .status-retired {
  color: #6b7280;
}

h1 {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0 0 4px 0;
  letter-spacing: -0.02em;
}
h2 {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0 0 12px 0;
  color: var(--brand-text);
}
body.light-mode h2 { color: #1a1f26; }
h3 {
  font-size: 1rem;
  font-weight: 600;
  margin: 0 0 8px 0;
  color: var(--brand-text-muted);
}
body.light-mode h3 { color: #374151; }

/* Header: logo + tagline (workforce / fairness feel) */
.app-header {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  padding: 14px 0 16px 0;
  border-bottom: 1px solid var(--brand-border);
  background: var(--brand-bg);
}
body.light-mode .app-header {
  border-bottom-color: #9ca3af;
  background: #fff;
}
.logo-block {
  display: flex;
  align-items: center;
  gap: 12px;
}
.logo-icon-wrap {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--brand-bg-elevated);
  border-radius: 8px;
  border: 1px solid var(--brand-border);
  width: 1.75rem;
  height: 1.75rem;
}
body.light-mode .logo-icon-wrap {
  background: #f3f4f6;
  border-color: #e5e7eb;
}
.logo-icon {
  width: 1.125rem;
  height: 1.125rem;
  color: var(--brand-primary);
  display: block;
}
.logo-icon .logo-icon-grid { opacity: 0.45; }
.logo-icon .logo-icon-cell { opacity: 1; }
body.light-mode .logo-icon { color: var(--brand-primary); }
.logo-text-col {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.logo-wordmark {
  font-size: 1.375rem;
  font-weight: 600;
  letter-spacing: -0.02em;
  color: var(--brand-primary);
  line-height: 1.2;
}
body.light-mode .logo-wordmark { color: var(--brand-primary); }
.tagline {
  font-size: 0.75rem;
  color: var(--brand-text-quiet);
  font-weight: 400;
  margin: 0;
  letter-spacing: 0.02em;
  line-height: 1.3;
}
body.light-mode .tagline { color: #374151; }
.week-header {
  font-size: 0.9375rem;
  color: var(--brand-text-muted);
  margin-left: auto;
  font-weight: 500;
}
body.light-mode .week-header { color: #374151; }

/* TABS */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tabs button {
  padding: 10px 16px;
  border: 1px solid var(--brand-border);
  border-radius: 8px;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  background: var(--brand-bg-elevated);
  color: var(--brand-text-muted);
  white-space: nowrap;
  min-height: 44px;
  transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
}
.tabs button:hover {
  background: #353d48;
  color: var(--brand-text);
}
body.light-mode .tabs button {
  background: #fff;
  color: #374151;
  border-color: #9ca3af;
}
body.light-mode .tabs button:hover {
  background: #f3f4f6;
  color: #1f2937;
}
.tabs button.active {
  background: var(--brand-primary);
  color: #fff;
  border-color: var(--brand-primary);
}

.employees-pool-selector {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  align-items: center;
}
.employees-pool-btn {
  padding: 8px 16px;
  border: 1px solid var(--brand-border);
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  background: var(--brand-bg-elevated);
  color: var(--brand-text-muted);
}
.employees-pool-btn:hover {
  background: #353d48;
  color: var(--brand-text);
}
.employees-pool-btn-active {
  background: var(--brand-primary);
  color: #fff;
  border-color: var(--brand-primary);
}
body.light-mode .employees-pool-btn {
  background: #fff;
  color: #374151;
  border-color: #9ca3af;
}
body.light-mode .employees-pool-btn:hover {
  background: #f3f4f6;
  color: #1f2937;
}
body.light-mode .employees-pool-btn-active {
  background: var(--brand-primary);
  color: #fff;
  border-color: var(--brand-primary);
}
.employees-pool-count {
  font-weight: 400;
}
.employees-pool-btn:not(.employees-pool-btn-active) .employees-pool-count {
  opacity: 0.85;
}
.employees-pool-btn-active .employees-pool-count {
  opacity: 0.9;
}
body.light-mode .employees-pool-btn:not(.employees-pool-btn-active) .employees-pool-count {
  color: #374151;
}

/* INPUTS */
input, select, button {
  margin: 4px;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid var(--brand-border);
  font-size: 14px;
  min-height: 40px;
  font-family: inherit;
}
button {
  background: var(--brand-primary);
  color: #fff;
  font-weight: 500;
  cursor: pointer;
  border: none;
  touch-action: manipulation;
  transition: opacity 0.15s ease, background 0.15s ease;
}
button:hover { opacity: 0.92; }
button.delete { background:#c0392b; }
button.retire { background:#8e44ad; }
button.print { background:#27ae60; }

/* TABLE */
table { 
  border-collapse:collapse; 
  width:100%; 
  margin-top:10px;
  display: table; /* Desktop default */
}
th, td {
  padding:8px;
  text-align:center;
  border:1px solid #555;
  position:relative;
  min-width: 80px;
}
th { background: var(--brand-primary); color: #fff; font-weight: 600; }

/* STATUS */
.status-retired { background:#555; opacity:0.6; }

/* SHIFTS */
.shift-4 { background:#2ecc71; }      /* Green - 4 hours */
.shift-5 { background:#3498db; }      /* Blue - 5 hours */
.shift-6 { background:#e67e22; }      /* Orange - 6 hours */
.shift-7 { background:#e91e63; }      /* Pink - 7 hours */
.shift-8 { background:#f1c40f; color:#000; }  /* Yellow - 8 hours */
.shift-ot { background:#9b59b6; }     /* Purple - overtime (>8) */

/* LOCKED CELLS */
.locked-cell {
  border: 3px solid #f39c12 !important;
  position: relative;
}
.locked-cell::after {
  content: 'üîí';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 10px;
}

/* CONFLICT CELLS */
.conflict-cell {
  border: 3px solid #e74c3c !important;
  position: relative;
}
.conflict-cell::before {
  content: '‚ö†';
  position: absolute;
  top: 2px;
  left: 2px;
  font-size: 10px;
}

/* STATUS CELLS (Sick, Vacation, Off, etc. - no shift, label only) */
.status-cell {
  background: #3d4550 !important;
  color: var(--brand-text);
  font-weight: 700;
  text-transform: uppercase;
  text-align: center;
  vertical-align: middle;
  user-select: none;
}
body.light-mode .status-cell {
  background: #d1d5db !important;
  color: #1a1f26;
}
#scheduleTable td.status-cell { cursor: pointer; }
#scheduleTable td.status-cell[draggable="true"] { cursor: pointer; }

/* CLICKABLE CELLS */
td[onclick], td.clickable { cursor:pointer; }
td[onclick]:hover, td.clickable:hover { outline:2px dashed #4e9af1; }
/* Valid drop target when dragging a shift */
#scheduleTable td.schedule-drop-zone { outline: 3px solid #27ae60; background: rgba(39, 174, 96, 0.2) !important; }
/* Shift blocks: grab cursor; when dragging, grabbing cursor */
#scheduleTable td[draggable="true"] { cursor: grab; }
body.dragging-shift { cursor: grabbing; }
.schedule-why-link { font-size: 11px; color: var(--brand-text-muted); text-decoration: none; }
.schedule-why-link:hover { color: var(--brand-primary); text-decoration: underline; }

/* TOOLTIP */
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 12px;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

/* AUDIT LOG */
.audit-filters {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px 16px;
  margin-bottom: 16px;
  padding: 12px 0;
}
.audit-filters .audit-filters-inputs {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px;
}
.audit-filters .audit-filters-inputs input {
  min-width: 140px;
}
.audit-filters .audit-filters-actions {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-left: 4px;
}
.audit-filters .audit-filters-actions button:first-child {
  font-weight: 500;
}

.audit-entry {
  padding: 12px 14px;
  margin: 6px 0;
  background: var(--brand-bg-elevated);
  border-radius: 6px;
  font-size: 13px;
  border: 1px solid var(--brand-border);
  border-left-width: 3px;
  border-left-color: var(--brand-border);
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px 0;
}
.audit-entry__header {
  display: flex;
  flex-wrap: wrap;
  align-items: baseline;
  gap: 8px 12px;
}
.audit-entry__action {
  font-weight: 600;
  font-size: 14px;
  color: var(--brand-text);
}
.audit-entry__time {
  font-size: 12px;
  color: var(--brand-text-muted);
  font-weight: 400;
}
.audit-entry__details {
  font-size: 12px;
  color: var(--brand-text-muted);
  line-height: 1.5;
}
.audit-entry__details span {
  display: inline-block;
  margin-right: 12px;
  margin-bottom: 2px;
}
.audit-entry__details strong {
  color: var(--brand-text-quiet);
  font-weight: 500;
  margin-right: 4px;
}
/* Action-type accents (inferred from log text) */
.audit-entry--add { border-left-color: #27ae60; }
.audit-entry--edit { border-left-color: #3498db; }
.audit-entry--remove { border-left-color: #e74c3c; }
body.light-mode .audit-entry__action { color: #1a1f26; }
body.light-mode .audit-entry__time,
body.light-mode .audit-entry__details { color: #374151; }
body.light-mode .audit-entry__details strong { color: #1a1f26; }

.audit-empty {
  padding: 24px 16px;
  text-align: center;
  font-size: 14px;
  color: var(--brand-text-muted);
  background: var(--brand-bg-elevated);
  border-radius: 8px;
  border: 1px solid var(--brand-border);
  margin-top: 8px;
}
body.light-mode .audit-empty { color: #374151; background: #f3f4f6; border-color: #9ca3af; }

@media (max-width: 640px) {
  #auditTab .audit-entry {
    padding: 10px 12px;
    word-break: break-word;
  }
  #auditTab .audit-entry__header {
    flex-direction: column;
    gap: 4px;
  }
  #auditTab .audit-entry__details span {
    display: block;
    margin-right: 0;
    margin-bottom: 4px;
  }
  .audit-filters {
    flex-direction: column;
    align-items: stretch;
  }
  .audit-filters .audit-filters-actions {
    margin-left: 0;
    justify-content: flex-start;
  }
}

/* PRINT */
@page {
  size: landscape;
  margin: 12mm;
}
@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  body {
    background: #fff !important;
    color: #000 !important;
    padding: 0 12px !important;
    margin: 0 !important;
    display: block !important;
    height: auto !important;
    overflow: visible !important;
  }
  .tabs, button, input, select, textarea { display: none !important; }
  .tab { display: none !important; }
  #scheduleTab {
    display: block !important;
    padding: 0 !important;
    margin: 0 !important;
    position: static !important;
    height: auto !important;
    overflow: visible !important;
  }
  #scheduleTab h2 { display: none !important; }
  .app-header {
    padding: 0 0 6px 0 !important;
    margin: 0 0 4px 0 !important;
    page-break-after: avoid !important;
    page-break-inside: avoid !important;
    position: static !important;
    display: block !important;
    height: auto !important;
    overflow: visible !important;
  }
  .app-header .logo-wordmark { font-size: 1.1rem !important; }
  .tagline { font-size: 12px !important; margin: 0 !important; }
  .week-header { font-size: 12px !important; }
  .schedule-container {
    margin: 0 !important;
    padding: 0 !important;
    min-height: 0 !important;
    width: 100% !important;
    height: auto !important;
    overflow: visible !important;
    page-break-before: avoid !important;
    position: static !important;
    display: block !important;
  }
  .schedule-actions,
  .schedule-pool-filter-wrap,
  .labor-cost-panel,
  #laborCostShowWrap,
  .schedule-grid-helper,
  .schedule-lock-helper,
  .schedule-th-helper,
  .schedule-why-link,
  #scheduleManagerNotice,
  .schedule-manager-notice,
  #scheduleOvertimeBanner,
  #scheduleSettingsWarning,
  .schedule-generate-note,
  .schedule-drag-tip,
  .schedule-overtime-hint-row { display: none !important; }
  #tourPrintExportWrap { display: none !important; }
  #scheduleTable td:nth-child(2) { font-weight: 800 !important; font-size: 11px !important; color: #000 !important; }
  #scheduleTable td small { font-weight: 700 !important; color: #000 !important; }
  #scheduleTable th, #scheduleTable td { color: #000 !important; }
  table {
    width: 100% !important;
    table-layout: fixed !important;
    font-size: 10px !important;
    border-collapse: collapse !important;
  }
  #scheduleTable {
    width: 100% !important;
    table-layout: fixed !important;
    border-collapse: collapse !important;
    page-break-inside: auto !important;
  }
  #scheduleTable thead { display: table-header-group !important; }
  #scheduleTable tbody tr { page-break-inside: avoid !important; page-break-after: auto !important; }
  #scheduleTable th,
  #scheduleTable td {
    border: 1px solid #000 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    padding: 5px 4px !important;
    overflow: hidden !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
    box-sizing: border-box !important;
  }
  #scheduleTable th:nth-child(2), #scheduleTable td:nth-child(2) { width: 14% !important; max-width: 14% !important; }
  #scheduleTable th:nth-child(3), #scheduleTable td:nth-child(3) { width: 9% !important; max-width: 9% !important; }
  #scheduleTable th:nth-child(4), #scheduleTable td:nth-child(4) { width: 9% !important; max-width: 9% !important; }
  #scheduleTable th:nth-child(5), #scheduleTable td:nth-child(5) { width: 9% !important; max-width: 9% !important; }
  #scheduleTable th:nth-child(6), #scheduleTable td:nth-child(6) { width: 9% !important; max-width: 9% !important; }
  #scheduleTable th:nth-child(7), #scheduleTable td:nth-child(7) { width: 9% !important; max-width: 9% !important; }
  #scheduleTable th:nth-child(8), #scheduleTable td:nth-child(8) { width: 9% !important; max-width: 9% !important; }
  #scheduleTable th:nth-child(9), #scheduleTable td:nth-child(9) { width: 9% !important; max-width: 9% !important; }
  #scheduleTable th:nth-child(10), #scheduleTable td:nth-child(10) { width: 8% !important; max-width: 8% !important; text-align: center !important; }
  #scheduleTable th:nth-child(11), #scheduleTable td:nth-child(11) { width: 6% !important; max-width: 6% !important; text-align: center !important; white-space: nowrap !important; }
  th { background: #ddd !important; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .locked-cell::after, .conflict-cell::before { display: none !important; }
  .shift-4, .shift-5, .shift-6, .shift-7, .shift-8, .shift-ot {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  #scheduleTable th:last-child,
  #scheduleTable td:last-child { min-width: 0 !important; white-space: nowrap !important; text-align: center !important; }
  #scheduleTable th:nth-last-child(2),
  #scheduleTable td:nth-last-child(2) { text-align: center !important; white-space: nowrap !important; }
  h1, .logo-wordmark, .tagline, .week-header { color: #000 !important; }
  .logo-icon { color: #000 !important; }
  .logo-icon-wrap { background: transparent !important; border-color: #ccc !important; }
  .app-header { border-bottom-color: #ccc !important; background: transparent !important; }
  #scheduleTable th:first-child,
  #scheduleTable td:first-child { display: none !important; }
}

/* Print: pool section headers (unified PDF) - on-screen fallback when print table is built */
.print-pool-header td {
  font-weight: 600;
  font-size: 13px;
  padding: 8px 5px 4px 5px;
  border-bottom: 1px solid #ccc;
  background: #e8e8e8;
  color: #333;
}

@media print {
  /* Pool section: clearly distinct from employee rows; never orphaned at page bottom */
  .print-pool-header {
    page-break-after: avoid !important;
    page-break-inside: avoid !important;
  }
  .print-pool-header td {
    background: #d0d0d0 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    overflow: hidden !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    letter-spacing: 0.08em !important;
    text-transform: uppercase !important;
    padding: 14px 8px 12px 8px !important;
    border-top: 4px solid #000 !important;
    border-bottom: 2px solid #000 !important;
    border-left: 1px solid #000 !important;
    border-right: 1px solid #000 !important;
    color: #000 !important;
  }
  #scheduleTable tbody tr.print-pool-header + tr td {
    border-top: 1px solid #000 !important;
  }
  /* Extra spacing above first pool section (after thead) */
  #scheduleTable tbody tr.print-pool-header:first-child td {
    padding-top: 18px !important;
  }
}

/* Print flow: lock layout and disable transitions (applied via class before print) */
body.print-pending * { transition: none !important; }
body.print-pending { max-width: 100% !important; }

/* TABS */
.tab { display:none; }
.tab.active { display:block; }

/* SETTINGS */
.settings-section {
  margin: 20px 0;
  padding: 20px;
  background: var(--brand-bg-elevated);
  border-radius: 8px;
  max-width: 100%;
  border: 1px solid var(--brand-border);
}
body.light-mode .settings-section { background: #fff; border-color: #9ca3af; }
.settings-section h3 {
  margin-top: 0;
  margin-bottom: 12px;
}

/* Settings: informational card (discoverability, no buttons or popups) */
.settings-info-card {
  display: flex;
  gap: 14px;
  align-items: flex-start;
  margin-bottom: 24px;
  padding: 18px 20px;
  background: var(--brand-bg-elevated);
  border: 1px solid var(--brand-border);
  border-radius: 10px;
  max-width: 100%;
}
body.light-mode .settings-info-card { background: #f3f4f6; border-color: #9ca3af; }
.settings-info-card-icon {
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 600;
  color: var(--brand-text-muted);
  background: rgba(78, 154, 241, 0.12);
  border-radius: 50%;
}
body.light-mode .settings-info-card-icon { color: #4b5563; background: #e0e7ff; }
.settings-info-card-title {
  margin: 0 0 6px 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--brand-text);
}
body.light-mode .settings-info-card-title { color: #1a1f26; }
.settings-info-card-body {
  margin: 0;
  font-size: 14px;
  line-height: 1.55;
  color: var(--brand-text-muted);
}
body.light-mode .settings-info-card-body { color: #374151; }

/* Reusable InfoTooltip: small √¢"Àú icon, hover/focus shows tooltip; does not block interaction */
.info-tooltip {
  position: relative;
  display: inline-flex;
  align-items: center;
  vertical-align: middle;
  margin-left: 4px;
}
.info-tooltip-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  font-size: 12px;
  line-height: 1;
  color: var(--brand-text-muted);
  cursor: help;
  border-radius: 50%;
  flex-shrink: 0;
}
.info-tooltip-icon:hover { color: var(--brand-primary); }
body.light-mode .info-tooltip-icon { color: #374151; }
body.light-mode .info-tooltip-icon:hover { color: var(--brand-primary); }
.info-tooltip-bubble {
  position: absolute;
  z-index: 1000;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-bottom: 6px;
  padding: 8px 10px;
  max-width: 240px;
  font-size: 12px;
  line-height: 1.4;
  color: #ecf0f1;
  background: #2c3e50;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  white-space: normal;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.15s ease, visibility 0.15s ease;
}
.info-tooltip-bubble::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -4px;
  border: 4px solid transparent;
  border-top-color: #2c3e50;
}
.info-tooltip:hover .info-tooltip-bubble,
.info-tooltip:focus .info-tooltip-bubble,
.info-tooltip:focus-within .info-tooltip-bubble {
  opacity: 1;
  visibility: visible;
}
.info-tooltip:focus { outline: none; }
.info-tooltip:focus .info-tooltip-icon { outline: 2px solid var(--brand-primary); outline-offset: 2px; border-radius: 50%; }

/* Optional: tooltip to the right of the icon (add class info-tooltip--right to wrapper) */
.info-tooltip--right .info-tooltip-bubble {
  bottom: auto;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  margin-bottom: 0;
  margin-left: 8px;
}
.info-tooltip--right .info-tooltip-bubble::after {
  top: 50%;
  left: 0;
  margin-left: -4px;
  margin-top: -4px;
  border-top-color: transparent;
  border-left-color: #2c3e50;
}

/* SUPPORT / CONTACT PAGE */
.support-page {
  max-width: 640px;
  margin: 0 auto;
  padding: 0 4px;
}
.support-page h2 {
  margin-top: 0;
  margin-bottom: 12px;
}
.support-intro {
  margin: 0 0 24px 0;
  color: var(--brand-text-muted);
  line-height: 1.5;
  font-size: 15px;
}
body.light-mode .support-intro { color: #374151; }
.support-form-card {
  background: var(--brand-bg-elevated);
  border: 1px solid var(--brand-border);
  border-radius: 8px;
  padding: 24px;
  margin-bottom: 24px;
}
body.light-mode .support-form-card { background: #fff; border-color: #9ca3af; }
.support-form-title {
  margin: 0 0 20px 0;
  font-size: 1.1em;
  font-weight: 600;
}
.support-field {
  margin-bottom: 20px;
}
.support-field label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 14px;
}
.support-field .required { color: #e74c3c; }
.support-field select,
.support-field input[type="text"],
.support-field textarea {
  width: 100%;
  max-width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--brand-border);
  border-radius: 6px;
  font-family: inherit;
  font-size: 14px;
  background: var(--brand-bg);
  color: var(--brand-text);
}
.support-field textarea { min-height: 140px; resize: vertical; }
.support-field select:focus,
.support-field input:focus,
.support-field textarea:focus {
  outline: none;
  border-color: var(--brand-primary);
  box-shadow: 0 0 0 2px rgba(78, 154, 241, 0.2);
}
body.light-mode .support-field select,
body.light-mode .support-field input,
body.light-mode .support-field textarea {
  background: #fff;
  border-color: #9ca3af;
  color: #1a1f26;
}
.support-helper {
  display: block;
  margin-top: 6px;
  font-size: 12px;
  color: var(--brand-text-muted);
  line-height: 1.4;
}
body.light-mode .support-helper { color: #374151; }
.support-privacy {
  margin: 20px 0;
  padding: 12px 14px;
  background: #34495e;
  border-radius: 6px;
  font-size: 13px;
  color: #ecf0f1;
  line-height: 1.45;
}
body.light-mode .support-privacy { background: #e5e7eb; color: #374151; }
.support-submit {
  background: #27ae60 !important;
  color: #fff !important;
  font-size: 16px;
  padding: 12px 24px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}
.support-submit:hover { background: #2ecc71 !important; }
.support-feedback {
  margin-top: 16px;
  padding: 14px 16px;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.45;
  display: none;
}
.support-feedback.visible { display: block; }
.support-feedback.success {
  background: #1e4620;
  color: #d4edda;
  border: 1px solid #27ae60;
}
.support-feedback.error {
  background: #2a1f1f;
  color: #f8d7da;
  border: 1px solid #e74c3c;
}
body.light-mode .support-feedback.success { background: #d4edda; color: #155724; border-color: #28a745; }
body.light-mode .support-feedback.error { background: #f8d7da; color: #721c24; border-color: #dc2626; }
.support-alternatives {
  padding: 20px;
  background: #2e2e3d;
  border-radius: 8px;
  border: 1px solid var(--brand-border);
}
body.light-mode .support-alternatives { background: #f3f4f6; border-color: #9ca3af; }
.support-alternatives h4 {
  margin: 0 0 10px 0;
  font-size: 1em;
}
.support-alternatives p { margin: 6px 0; }
.support-alternatives a { color: var(--brand-primary); }
.support-response-time {
  font-size: 13px;
  color: var(--brand-text-muted) !important;
}
body.light-mode .support-response-time { color: #374151 !important; }

.edit-helper { display: block; margin-top: 4px; font-size: 12px; color: var(--brand-text-muted); }
body.light-mode .edit-helper { color: #374151; }

/* Primary/secondary buttons: one primary per screen */
.btn-primary {
  font-weight: 600;
  background: var(--brand-primary, #4e9af1) !important;
  color: #fff !important;
}
.btn-primary:hover { filter: brightness(1.1); }
.btn-secondary {
  background: transparent !important;
  color: var(--brand-text-muted) !important;
  border: 1px solid var(--brand-border) !important;
}
.btn-secondary:hover { background: rgba(255,255,255,0.05) !important; }
body.light-mode .btn-secondary { color: #374151; border-color: #9ca3af !important; }
body.light-mode .btn-secondary:hover { background: #f3f4f6 !important; }

/* Section headers: consistent hierarchy */
.tab > h2,
.tab-section-title {
  font-size: 1.35rem;
  font-weight: 600;
  margin: 0 0 1rem 0;
}
.tab .settings-section h3,
.tab h3.tab-section-subtitle,
.tab-section-subtitle {
  font-size: 1.05rem;
  font-weight: 600;
  margin: 0 0 0.75rem 0;
}

/* Shift Assignment Style: spacing, selected state, readability */
.assignment-style-intro { margin-bottom: 4px; }
.assignment-style-options { margin: 16px 0; }
.assignment-option {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 14px 14px 16px;
  margin-bottom: 14px;
  background: var(--brand-bg-elevated);
  border: 1px solid var(--brand-border);
  border-radius: 8px;
  cursor: pointer;
  border-left: 3px solid transparent;
  transition: border-color 0.15s ease, background 0.15s ease;
}
.assignment-option:last-of-type { margin-bottom: 0; }
.assignment-option:hover { background: #34495e; }
.assignment-option input[type="radio"] { margin-top: 4px; flex-shrink: 0; }
.assignment-option-content { flex: 1; min-width: 0; }
.assignment-option-title { display: block; color: var(--brand-primary); font-size: 14px; margin-bottom: 6px; }
.assignment-option-desc {
  margin: 0;
  font-size: 13px;
  color: var(--brand-text-muted);
  line-height: 1.55;
  max-width: 56em;
}
.assignment-option:has(input:checked) {
  border-left-color: var(--brand-primary);
  background: rgba(78, 154, 241, 0.08);
  border-color: var(--brand-primary);
}
body.light-mode .assignment-option { background: #f9fafb; border-color: #9ca3af; }
body.light-mode .assignment-option:hover { background: #f3f4f6; }
body.light-mode .assignment-option:has(input:checked) { background: rgba(78, 154, 241, 0.06); border-color: var(--brand-primary); }
body.light-mode .assignment-option-desc { color: #374151; }

/* Event Types table: alignment, row height, Active column, button spacing */
.event-types-table { margin-top: 12px; }
.event-types-table th,
.event-types-table td { vertical-align: middle; padding: 10px 12px; }
.event-types-table th:first-child,
.event-types-table td:first-child { text-align: left; }
.event-types-table th:nth-child(2),
.event-types-table td:nth-child(2) { text-align: left; }
.event-types-table th:nth-child(3),
.event-types-table td:nth-child(3) { text-align: center; width: 1%; white-space: nowrap; }
.event-types-table th:nth-child(4),
.event-types-table td:nth-child(4) { text-align: right; }
.event-types-table .event-type-active-cell { text-align: center; }
.event-types-table .event-type-active-cell input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
.event-types-table .event-type-actions-cell { text-align: right; }
.event-types-table .event-type-actions { display: inline-flex; gap: 8px; }
.event-type-add-btn { margin-top: 12px; }

/* Data Management: grouped actions and spacing */
.data-mgmt-actions { display: flex; flex-wrap: wrap; gap: 20px 24px; align-items: flex-start; margin-top: 16px; }
.data-mgmt-group { display: flex; flex-direction: column; gap: 8px; }
.data-mgmt-group-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--brand-text-muted); }
.data-mgmt-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
.data-mgmt-note { font-size: 12px; color: var(--brand-text-muted); margin-top: 14px; }
body.light-mode .data-mgmt-group-label { color: #374151; }

/* Admin Clear All: keep visually distinct and dangerous */
.settings-section-danger {
  border: 1px solid #e74c3c !important;
  background: #2a1f1f !important;
  margin-top: 24px !important;
}
body.light-mode .settings-section-danger { background: #fef2f2 !important; border-color: #dc2626 !important; }
.danger-heading { color: #e74c3c !important; }
.danger-warning { color: #f0f0f0 !important; font-weight: bold; margin: 8px 0 12px 0; }
body.light-mode .danger-warning { color: #b91c1c !important; }
.btn-danger { background: #c0392b !important; color: #fff !important; }
body.light-mode .btn-danger { background: #dc2626 !important; }

.setting-row {
  margin: 10px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.setting-row label {
  min-width: 150px;
}
.setting-row input {
  width: 100px;
}

.settings-table { width: 100%; border-collapse: collapse; }
.settings-table th, .settings-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--brand-border); }
.settings-table th { color: var(--brand-text-muted); font-weight: 500; }
body.light-mode .settings-table th, body.light-mode .settings-table td { border-color: #9ca3af; }
body.light-mode .settings-table th { color: #1a1f26; }

/* Events form: time labels and helper text */
.event-time-label { display: block; margin-bottom: 4px; margin-top: 10px; font-size: 13px; color: var(--brand-text-muted); }
.event-time-label:first-of-type { margin-top: 10px; }
.event-type-helper { margin: 4px 0 0 0; font-size: 12px; color: var(--brand-text-muted); }
body.light-mode .event-time-label, body.light-mode .event-type-helper { color: #374151; }

/* Events table: hover, numeric alignment, Date/Time grouping */
.events-table tbody tr:hover { background: var(--brand-bg-elevated); }
body.light-mode .events-table tbody tr:hover { background: #f3f4f6; }
.events-table td:nth-child(4), .events-table th:nth-child(4), .events-table td:nth-child(6), .events-table th:nth-child(6) { text-align: right; }
.events-table th:nth-child(3), .events-table td:nth-child(3) { border-right: 2px solid var(--brand-border); }
body.light-mode .events-table th:nth-child(3), body.light-mode .events-table td:nth-child(3) { border-right-color: #9ca3af; }

/* Schedule: action button groups and lock helper */
.schedule-actions {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px 4px;
  margin-bottom: 12px;
}
.schedule-action-group {
  display: inline-flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
}
.schedule-action-sep {
  color: var(--brand-text-quiet);
  padding: 0 6px;
  font-size: 12px;
  user-select: none;
}
body.light-mode .schedule-action-sep { color: #374151; }
.schedule-lock-helper {
  font-size: 12px;
  color: var(--brand-text-muted);
  margin-left: 4px;
  margin-right: 4px;
}
body.light-mode .schedule-lock-helper { color: #374151; }

/* Schedule: one-line helper above grid */
.schedule-grid-helper {
  font-size: 12px;
  color: var(--brand-text-muted);
  margin: 0 0 10px 0;
}
body.light-mode .schedule-grid-helper { color: #374151; }

/* Schedule table: alternating row shading (tbody only, subtle) */
#scheduleTable tbody tr:nth-child(odd) { background: rgba(0, 0, 0, 0.06); }
#scheduleTable tbody tr:nth-child(even) { background: transparent; }
.schedule-pool-section-header td {
  font-weight: 600;
  font-size: 13px;
  padding: 6px 8px 4px 8px;
  border-bottom: 1px solid var(--brand-border, #444);
  background: rgba(0, 0, 0, 0.12);
  color: var(--brand-text, #ecf0f1);
}
body.light-mode .schedule-pool-section-header td {
  background: #e5e7eb;
  color: #1a1f26;
  border-bottom-color: #9ca3af;
}
body.light-mode #scheduleTable tbody tr:nth-child(odd) { background: rgba(0, 0, 0, 0.03); }

/* Schedule table: editable day cell hover (visual only) */
#scheduleTable td.clickable:hover {
  cursor: pointer;
  outline: 1px solid var(--brand-primary);
  outline-offset: -1px;
  background-color: rgba(78, 154, 241, 0.08) !important;
}
body.light-mode #scheduleTable td.clickable:hover {
  background-color: rgba(78, 154, 241, 0.12) !important;
}

/* Drag-and-drop: valid drop zone highlight */
#scheduleTable tr.schedule-drop-target td {
  outline: 2px solid var(--brand-primary, #3498db);
  background: rgba(52, 152, 219, 0.12) !important;
}

/* Schedule table: Total/Days column header helper text */
.schedule-th-helper {
  display: block;
  font-weight: 400;
  font-size: 10px;
  opacity: 0.85;
}

/* RESPONSIVE: Make table scrollable on smaller screens */
@media (max-width: 1024px) {
  body {
    margin: 10px;
  }
  
  h1 {
    font-size: 22px;
  }
  
  .tabs button {
    padding: 6px 10px;
    font-size: 13px;
  }
  
  /* Make table scrollable horizontally */
  .schedule-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  th, td {
    padding: 6px;
    font-size: 13px;
    min-width: 70px;
  }
  
  .settings-section {
    padding: 10px;
  }
  
  .setting-row {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .setting-row label {
    min-width: auto;
  }
}

@media (max-width: 768px) {
  body {
    margin: 5px;
  }
  
  h1 {
    font-size: 18px;
  }
  
  .tabs button {
    padding: 8px 12px;
    font-size: 12px;
  }
  
  /* Make inputs full width on mobile */
  input, select, textarea {
    max-width: 100%;
    box-sizing: border-box;
  }
  
  th, td {
    padding: 4px;
    font-size: 12px;
    min-width: 60px;
  }
}

/* Edit employee modal */
#employeeEditModalOverlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
#employeeEditModalOverlay.employee-edit-visible {
  display: flex;
}
#employeeEditModal {
  background: #2c3e50;
  color: #ecf0f1;
  padding: 24px;
  border-radius: 12px;
  min-width: 320px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
#employeeEditModal h3 { margin-top: 0; color: #4e9af1; }
#employeeEditModal .edit-row { margin: 12px 0; }
#employeeEditModal label { display: block; margin-bottom: 4px; font-size: 13px; color: #bdc3c7; }
#employeeEditModal select, #employeeEditModal input[type="checkbox"] { margin-right: 8px; }
#employeeEditModal .edit-actions { margin-top: 20px; display: flex; gap: 10px; }
#employeeEditModal .edit-actions button { padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
#employeeEditModal .edit-actions .save-btn { background: #27ae60; color: #fff; }
#employeeEditModal .edit-actions .cancel-btn { background: #7f8c8d; color: #fff; }
body.light-mode #employeeEditModal { background: #ecf0f1; color: #2c3e50; }
body.light-mode #employeeEditModal h3 { color: #2980b9; }
body.light-mode #employeeEditModal label { color: #374151; }

.override-indicator { color: #f39c12; font-size: 12px; cursor: help; }

/* Inline editable email in employees table */
.email-cell-wrap { cursor: pointer; padding: 4px 6px; border-radius: 4px; min-height: 1.5em; display: block; }
.email-cell-wrap:hover { background: var(--brand-bg-elevated); }
body.light-mode .email-cell-wrap:hover { background: #f3f4f6; }
.email-cell-placeholder { color: var(--brand-text-quiet); font-style: italic; font-size: 13px; }
.email-cell-input { width: 100%; max-width: 220px; padding: 4px 6px; border: 1px solid var(--brand-primary); border-radius: 4px; font-size: 13px; background: var(--brand-bg-elevated); color: var(--brand-text); box-sizing: border-box; }
body.light-mode .email-cell-input { background: #fff; color: #1a1f26; border-color: var(--brand-primary); }

#absenceModalOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
#absenceModalOverlay.absence-visible { display: flex; }
#absenceModal { background: var(--brand-bg-elevated); color: var(--brand-text); padding: 24px; border-radius: 12px; min-width: 340px; border: 1px solid var(--brand-border); }
#absenceModal h3 { margin-top: 0; color: var(--brand-primary); }
#absenceModal .edit-row { margin: 12px 0; }
#absenceModal label { display: block; margin-bottom: 4px; font-size: 13px; color: var(--brand-text-muted); }
#absenceModal input, #absenceModal select { width: 100%; max-width: 280px; padding: 8px; border-radius: 6px; border: 1px solid var(--brand-border); background: var(--brand-bg); color: var(--brand-text); font-size: 14px; box-sizing: border-box; }
#absenceModal .modal-actions { margin-top: 20px; display: flex; gap: 10px; }
#absenceModal .modal-actions button { padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: 500; }
#absenceModal .modal-actions .btn-primary { background: var(--brand-primary); color: #fff; }
#absenceModal .modal-actions .btn-secondary { background: var(--brand-border); color: var(--brand-text); }
body.light-mode #absenceModal { background: #fff; color: #1a1f26; border-color: #9ca3af; }
body.light-mode #absenceModal input, body.light-mode #absenceModal select { background: #fff; color: #1a1f26; border-color: #9ca3af; }

</style>
</head>

<body>

<header class="app-header">
  <div class="logo-block">
    <div class="logo-icon-wrap" aria-hidden="true">
      <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Schedule grid">
        <g stroke="currentColor" stroke-width="1.25" fill="none" class="logo-icon-grid">
          <rect x="0.5" y="0.5" width="7" height="7" rx="0.5"/>
          <rect x="8.5" y="0.5" width="7" height="7" rx="0.5"/>
          <rect x="16.5" y="0.5" width="7" height="7" rx="0.5"/>
          <rect x="0.5" y="8.5" width="7" height="7" rx="0.5"/>
          <rect x="16.5" y="8.5" width="7" height="7" rx="0.5"/>
          <rect x="0.5" y="16.5" width="7" height="7" rx="0.5"/>
          <rect x="8.5" y="16.5" width="7" height="7" rx="0.5"/>
          <rect x="16.5" y="16.5" width="7" height="7" rx="0.5"/>
        </g>
        <rect x="8.5" y="8.5" width="7" height="7" rx="0.5" fill="currentColor" class="logo-icon-cell"/>
      </svg>
    </div>
    <div class="logo-text-col">
      <h1 class="logo-wordmark">BanquetLogic</h1>
      <p class="tagline">Intelligent Scheduling. Manager Driven.</p>
    </div>
  </div>
  <span class="week-header" id="weekHeader"></span>
</header>

<div id="absenceModalOverlay">
  <div id="absenceModal">
    <h3 id="absenceModalTitle">Time Off / Sick</h3>
    <p id="absenceModalEmpName" style="margin: 0 0 16px 0; font-size: 15px;"></p>
    <div class="edit-row">
      <label for="absenceStartDate">Start date</label>
      <input type="date" id="absenceStartDate" />
    </div>
    <div class="edit-row">
      <label for="absenceEndDate">End date (optional - leave blank for single day)</label>
      <input type="date" id="absenceEndDate" placeholder="Optional" />
    </div>
    <div class="edit-row">
      <label for="absenceType">Type</label>
      <select id="absenceType">
        <option value="sick">Sick</option>
        <option value="vacation">Vacation (Paid)</option>
        <option value="floating_holiday">Floating Holiday (Paid)</option>
        <option value="unpaid_vacation">Unpaid Vacation</option>
        <option value="requested_off">Request Off</option>
      </select>
    </div>
    <p style="font-size: 12px; color: var(--brand-text-muted); margin: 8px 0 0 0;">Request Off is visual only; it does not remove an existing shift until you change it to another type.</p>
    <div class="modal-actions">
      <button type="button" class="btn-primary" id="absenceConfirmBtn">Confirm</button>
      <button type="button" class="btn-secondary" id="absenceCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<button type="button" onclick="toggleDarkMode()">Toggle Dark Mode</button>
<span id="tourPrintExportWrap" style="display: inline-flex; align-items: center; gap: 8px;">
  <label for="printPoolFilter" style="margin-left: 8px;">Print:</label>
  <select id="printPoolFilter" style="margin-left: 4px; padding: 4px 8px;" title="Affects PDF/print only">
    <option value="">All Pools</option>
  </select>
  <button type="button" class="print" onclick="printSchedule()">Print / Save PDF</button>
</span>

<div class="tabs">
  <button type="button" id="tabEmpBtn" onclick="showTab('employeesTab')">Employees</button>
  <button type="button" id="tabEvBtn" onclick="showTab('eventsTab')">Events</button>
  <button type="button" id="tabSchBtn" onclick="showTab('scheduleTab')">Schedule</button>
  <button type="button" id="tabAuditBtn" onclick="showTab('auditTab')">Audit Log</button>
  <button type="button" id="tabSettingsBtn" onclick="showTab('settingsTab')">Settings</button>
  <button type="button" id="tabSupportBtn" onclick="showTab('supportTab')">Support / Contact</button>
</div>

<!-- EMPLOYEES -->
<div id="employeesTab" class="tab">
<h2>Employees</h2>

<div id="employeesPoolSelector" class="employees-pool-selector" style="margin-bottom: 16px; display: flex; gap: 4px; flex-wrap: wrap;"></div>

<div style="margin-bottom: 15px; padding: 10px; background: #2e2e3d; border-radius: 8px;">
  <h3 style="margin-top: 0;">Add Employee Manually</h3>
  <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: flex-end; gap: 10px;">
    <input type="text" id="empName" placeholder="Name" />
    <div>
      <label for="empLaborPool" style="display: block; margin-bottom: 2px; font-size: 13px;">Labor Pool <span style="color:#e74c3c;">*</span></label>
      <select id="empLaborPool" required onchange="updateSeniorityPreFill()"></select>
    </div>
    <select id="empType"><option value="FT">FT</option><option value="PT">PT</option></select>
    <div>
      <label for="empSeniority" style="display: block; margin-bottom: 2px; font-size: 13px;">Seniority (within pool)</label>
      <input id="empSeniority" type="number" min="1" placeholder="Auto" style="width: 70px;" />
      <small style="display: block; margin-top: 2px; color: #95a5a6; font-size: 11px;">Auto-assigned; you can change it. Unique per labor pool.</small>
    </div>
    <select id="empPref">
      <option value="">No Pref</option>
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>
  </div>
  
  <div style="margin-top: 10px; padding: 8px; background: #1e1e2f; border-radius: 6px;">
    <strong>Optional Fields:</strong>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 8px;">
      <input id="empEmail" type="email" placeholder="Email (for schedule send)" style="border: 2px solid #3498db;" />
      <input type="text" id="empEmployeeId" placeholder="Employee ID (optional)" />
      <div>
        <label for="empHireDate" style="display: block; margin-bottom: 4px; font-size: 13px;">Hire Date (optional)</label>
        <input id="empHireDate" type="date" placeholder="yyyy-mm-dd" title="Hire Date (optional)" />
        <small style="display: block; margin-top: 2px; color: #95a5a6; font-size: 12px;">When they started. Does not affect seniority.</small>
      </div>
      <div>
        <label for="empBirthdate" style="display: block; margin-bottom: 4px; font-size: 13px;">Birthday (optional)</label>
        <input id="empBirthdate" type="date" placeholder="yyyy-mm-dd" title="Birthday (optional)" />
        <small style="display: block; margin-top: 2px; color: #95a5a6; font-size: 12px;">For reference only; not used in scheduling.</small>
      </div>
    </div>
    <small style="color: #95a5a6; display: block; margin-top: 5px;">
      üìß Email required for one-click schedule sending. Other fields are optional.
    </small>
  </div>
  
  <button type="button" class="btn-primary" onclick="addEmployee()" style="margin-top: 10px;">Add Employee</button>
</div>

<div style="margin-bottom: 15px; padding: 10px; background: #2e2e3d; border-radius: 8px;">
  <h3 style="margin-top: 0;">Import Seniority List</h3>
  <p style="margin: 5px 0; font-size: 13px; color: #95a5a6;">
    Upload a CSV file or paste text with employee data
  </p>
  
  <div style="margin: 10px 0;">
    <button type="button" onclick="document.getElementById('importFile').click()" style="background: #27ae60;">
      üì¢ Upload CSV File
    </button>
    <input type="file" id="importFile" accept=".csv,.txt" style="display: none;" onchange="handleFileImport(event)" />
    
    <button type="button" onclick="openPasteImport()" style="background: #9b59b6;">
      üìã Paste Text
    </button>
    
    <button type="button" onclick="exportEmployeeList()" style="background: #3498db;">
      üíæ Export List
    </button>
    
    <button type="button" onclick="showImportHelp()" style="background: #95a5a6;">
      √¢¬ù" Format Help
    </button>
  </div>
</div>

<table class="employees-table">
<thead>
<tr>
  <th>Name</th><th>Type</th><th>Email</th><th>Pref</th>
  <th>Max Days/Wk</th><th>Vacation</th><th>Day Prefs</th><th>Time Off</th><th>Sick</th><th>Actions</th>
</tr>
</thead>
<tbody id="employeesTable"></tbody>
</table>
</div>

<div id="employeeEditModalOverlay" class="employee-edit-overlay">
  <div id="employeeEditModal">
    <h3 id="employeeEditTitle">Edit employee</h3>
    <p id="employeeEditName" style="margin: 0 0 16px 0; font-size: 15px;"></p>
    <div class="edit-row">
      <label for="employeeEditType">Full-time / Part-time</label>
      <select id="employeeEditType">
        <option value="FT">Full-time (FT)</option>
        <option value="PT">Part-time (PT)</option>
      </select>
    </div>
    <div class="edit-row">
      <label for="employeeEditLaborPool">Labor Pool</label>
      <select id="employeeEditLaborPool"></select>
    </div>
    <div class="edit-row">
      <label for="employeeEditPref">AM / PM preference</label>
      <select id="employeeEditPref">
        <option value="">No preference</option>
        <option value="AM">AM (morning)</option>
        <option value="PM">PM (afternoon)</option>
      </select>
    </div>
    <div class="edit-row">
      <label for="employeeEditSeniority">Seniority (within pool, 1 = highest)</label>
      <input type="number" id="employeeEditSeniority" min="1" style="width: 80px;" />
      <small class="edit-helper">Override will be logged in the audit log.</small>
    </div>
    <div class="edit-row">
      <label><input type="checkbox" id="employeeEditSick" /> Mark as sick (unavailable this week)</label>
    </div>
    <p style="font-size: 12px; color: #95a5a6; margin: 12px 0 0 0;">Changes apply to future schedule generation only. Existing shifts are not changed.</p>
    <div class="edit-actions">
      <button type="button" class="save-btn btn-primary" id="employeeEditSaveBtn">Save Changes</button>
      <button type="button" class="cancel-btn" id="employeeEditCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- EVENTS -->
<div id="eventsTab" class="tab">
<h2>Events</h2>

<input type="text" id="eventName" placeholder="Event Name" />
<input id="eventDate" type="date" />
<label for="eventStart" class="event-time-label">Start Time</label>
<input id="eventStart" type="time" placeholder="--:--" onchange="autoRecommendStaff()" aria-label="Start Time" />
<label for="eventEnd" class="event-time-label">End Time</label>
<input id="eventEnd" type="time" placeholder="--:--" onchange="autoRecommendStaff()" aria-label="End Time" />
<input id="eventGuests" type="number" placeholder="Guests" oninput="autoRecommendStaff()" />

<select id="eventService" onchange="autoRecommendStaff()"></select>
<p class="event-type-helper">Affects staffing ratios and scheduling logic</p>

<div class="event-pool-reqs-section" style="margin-top: 12px;">
  <label style="display: block; margin-bottom: 6px; font-size: 13px;">Labor pool requirements</label>
  <p class="event-type-helper" style="margin: 0 0 8px 0;">Which pools are needed and how many (e.g. 1 Cashier, 2 Housemen).</p>
  <div id="eventLaborPoolReqsContainer"></div>
  <button type="button" onclick="addEventPoolReqRow()" style="margin-top: 6px;">Add pool requirement</button>
</div>

<p style="margin-top: 12px;"><label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;"><input type="checkbox" id="eventCashBar" /> Cash Bar</label><br><small class="event-type-helper">When enabled, the schedule will show a non-binding cashier recommendation for this event.</small></p>

<input id="eventStaff" type="number" placeholder="Staff Needed (legacy)" style="margin-top: 8px;" />
<button type="button" id="eventSubmitBtn" class="btn-primary" onclick="addEvent()">Add Event</button>

<table class="events-table">
<thead>
<tr>
  <th>Name</th><th>Date</th><th>Time</th>
  <th>Guests</th><th>Service</th><th>Staff</th>
  <th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="eventsTable"></tbody>
</table>
</div>

<!-- SCHEDULE -->
<div id="scheduleTab" class="tab">
<h2>Schedule</h2>

<div class="schedule-pool-filter-wrap" id="tourSchedulePoolFilterWrap" style="margin-bottom: 10px;">
  <label for="schedulePoolFilter">View:</label>
  <select id="schedulePoolFilter" style="margin-left: 6px; padding: 6px 10px;" title="Filter schedule by labor pool (on-screen only)">
    <option value="">All Pools</option>
  </select>
</div>

<div class="schedule-actions">
  <span class="schedule-action-group">
    <button type="button" onclick="changeWeek(-1)"><- Previous Week</button>
    <button type="button" onclick="changeWeek(1)">Next Week -></button>
  </span>
  <span class="schedule-action-sep" aria-hidden="true">|</span>
  <span class="schedule-action-group">
    <button type="button" class="btn-primary" onclick="generateSchedule()">Generate</button>
    <button type="button" class="btn-secondary" onclick="regenerateSchedule()">Regenerate</button>
  </span>
  <span class="schedule-action-sep" aria-hidden="true">|</span>
  <span class="schedule-action-group">
    <button type="button" id="globalLockBtn" onclick="toggleGlobalLock()" style="background:#f39c12;">üîì Unlock Schedule</button>
    <span id="scheduleLockHelperText" class="schedule-lock-helper">Edits enabled - changes will affect assignments</span>
    <button type="button" onclick="emailSchedulesToAll()" style="background:#27ae60;">üìß Email Schedules</button>
    <button type="button" onclick="showGenerationRules()" style="background:#9b59b6;">üìã Generation Rules</button>
    <button type="button" onclick="showConflictReport()" id="conflictReportBtn" style="background:#e74c3c; display:none;">‚ö† Conflicts</button>
    <button type="button" onclick="exportScheduleToCSV()" style="background:#16a085;">üì• Export CSV</button>
    <button type="button" onclick="openApplyRecommendationsModal()" style="background:#8e44ad;">Apply Recommendations</button>
    <span id="applyRecommendationsUndoWrap" style="display:none; margin-left: 8px;">
      <button type="button" id="applyRecommendationsUndoBtn" onclick="undoApplyRecommendations()" style="background:#c0392b;">Undo Apply Recommendations</button>
    </span>
  </span>
</div>
<p class="schedule-generate-note" style="margin: 6px 0 0 0; font-size: 12px; color: var(--brand-text-muted, #95a5a6);">The generated schedule is a starting draft. Managers should review for accuracy, preferences, and operational needs before publishing.</p>

<div id="applyRecommendationsModalOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000;">
  <div id="applyRecommendationsModal" style="background: #2c3e50; padding: 24px; border-radius: 8px; min-width: 320px; max-width: 90%;">
    <h3 style="margin-top: 0;">Apply Recommendations</h3>
    <p id="applyRecommendationsModalText">This will assign the recommended staff for the selected role to shifts this week, in seniority order. Only the selected role is affected. Assignments can be undone immediately after.</p>
    <p style="margin-top: 12px;"><label>Role: </label>
      <select id="applyRecommendationsRole">
        <option value="cashiers">Cashiers</option>
        <option value="housemen">Housemen</option>
      </select>
    </p>
    <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
      <button type="button" onclick="closeApplyRecommendationsModal()">Cancel</button>
      <button type="button" id="applyRecommendationsConfirmBtn" onclick="confirmApplyRecommendations()">Apply</button>
    </div>
  </div>
</div>

<p id="scheduleManagerNotice" class="schedule-manager-notice" style="margin: 8px 0; padding: 10px 12px; background: rgba(52, 152, 219, 0.2); border-left: 4px solid #3498db; border-radius: 4px;">Schedule auto-generated. Please review for overtime and preferences. Adjustments may be required. Fine-tune rules in Settings.</p>
<div id="scheduleOvertimeBanner" style="display: none; margin: 8px 0; padding: 10px 12px; background: rgba(230, 126, 34, 0.25); border-left: 4px solid #e67e22; border-radius: 4px;">
  <strong>Overtime suggested - review required.</strong>
  <p id="scheduleOvertimeBannerText" style="margin: 6px 0 0 0; font-size: 14px;"></p>
</div>
<div id="scheduleSettingsWarning" style="display: none; margin: 8px 0; padding: 10px 12px; background: rgba(241, 196, 15, 0.25); border-left: 4px solid #f1c40f; border-radius: 4px;">
  Schedule accuracy depends on employee preferences and availability. Review settings for best results.
</div>
<p class="schedule-grid-helper">Click a cell to assign an employee to an event or mark time off</p>
<p class="schedule-drag-tip" style="margin: 4px 0 8px 0; font-size: 12px; color: var(--brand-text-muted, #95a5a6);">Tip: You can drag and drop shifts to move or swap them.</p>
<div class="schedule-container">
  <table id="scheduleTable"></table>
</div>

<div id="laborCostPanel" class="labor-cost-panel" style="margin-top: 16px; padding: 12px 16px; background: rgba(0,0,0,0.15); border-radius: 8px; border: 1px solid var(--brand-border, #444);">
  <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
    <strong>Estimated labor cost (this week)</strong>
    <button type="button" id="laborCostToggleBtn" onclick="toggleLaborCostPanel()" style="padding: 4px 10px; font-size: 12px;">Hide</button>
  </div>
  <div id="laborCostContent">
    <div id="laborCostByPool"></div>
    <p id="laborCostTotal" style="margin: 8px 0 4px 0; font-weight: 600;"></p>
    <p class="labor-cost-disclaimer" style="margin: 0; font-size: 12px; color: var(--brand-text-muted);">Planning estimate only. Not payroll. Gratuities and other adjustments are not included.</p>
  </div>
</div>
<div id="laborCostShowWrap" style="display: none; margin-top: 10px;">
  <button type="button" onclick="toggleLaborCostPanel()" style="padding: 6px 12px; font-size: 12px;">Show labor cost</button>
</div>
</div>

<!-- AUDIT LOG -->
<div id="auditTab" class="tab">
<h2>Audit Log</h2>

<div class="audit-filters">
  <div class="audit-filters-inputs">
    <input type="text" id="auditEmployee" placeholder="Filter by employee" />
    <input id="auditDate" type="date" placeholder="Filter by date" />
  </div>
  <div class="audit-filters-actions">
    <button type="button" class="btn-primary" onclick="filterAuditLog()">Filter</button>
    <button type="button" class="btn-secondary" onclick="clearAuditFilter()">Clear filter</button>
  </div>
</div>

<div id="auditLogContainer"></div>
</div>

<!-- SETTINGS -->
<div id="settingsTab" class="tab">
<h2>Settings</h2>

<div class="settings-info-card" role="region" aria-labelledby="settings-info-card-title">
  <div>
    <h3 id="settings-info-card-title" class="settings-info-card-title">Need something different?</h3>
    <p class="settings-info-card-body">BanquetLogic is designed to adapt to your operation. Customize employee types, labor pools, and event types to fit your venue - or remove anything you don't use.</p>
  </div>
</div>

<div class="settings-section">
  <h3>Shift Assignment Style</h3>
  <p class="assignment-style-intro">Choose how shifts are assigned when generating schedules:</p>
  
  <div class="assignment-style-options">
    <label for="assignmentStyle_strict" class="assignment-option">
      <input type="radio" id="assignmentStyle_strict" name="assignmentStyle" value="strict" checked>
      <div class="assignment-option-content">
        <strong class="assignment-option-title">Strict Seniority</strong>
        <p class="assignment-option-desc">Higher-seniority employees are always assigned first. Seniority 1 gets all available shifts before Seniority 2, and so on. Preferences are only respected if they don't conflict with seniority priority.</p>
      </div>
    </label>
    <label for="assignmentStyle_balanced" class="assignment-option">
      <input type="radio" id="assignmentStyle_balanced" name="assignmentStyle" value="balanced">
      <div class="assignment-option-content">
        <strong class="assignment-option-title">Seniority + Balanced Coverage</strong>
        <p class="assignment-option-desc">Seniority is prioritized, but shifts are balanced across employee groups (FT/PT). Prevents one group from getting all shifts while others are eligible. Better distribution while still respecting seniority within each group.</p>
      </div>
    </label>
    <label for="assignmentStyle_fair" class="assignment-option">
      <input type="radio" id="assignmentStyle_fair" name="assignmentStyle" value="fair">
      <div class="assignment-option-content">
        <strong class="assignment-option-title">Fair Distribution</strong>
        <p class="assignment-option-desc">Shifts distributed as evenly as possible across all eligible employees. Everyone gets similar hours regardless of seniority. Seniority is only used as a tie-breaker when two employees have equal hours.</p>
      </div>
    </label>
  </div>
  
  <h3 style="margin-top: 20px;">Staffing ratios (recommendations only)</h3>
  <p class="event-type-helper">These affect suggested staff counts only. They do not force assignments.</p>
  <p style="margin-top: 10px;"><label>Servers:</label> <span id="settingsServersRatioLabel">Uses event type ratios (e.g. 1 server per 20 guests for Plated Service). Edit in Event Types below.</span></p>
  <p style="margin-top: 10px;"><label>Cashiers:</label> 1 cashier per <input type="number" id="settingsCashierRatio" min="1" value="150" style="width: 70px; padding: 6px;" /> guests</p>
  <p style="margin-top: 10px;"><label>Housemen:</label>
    <label style="display: inline-flex; align-items: center; gap: 6px; margin-left: 8px;"><input type="radio" name="housemenRatioMode" value="per_guests" /> 1 houseman per <input type="number" id="settingsHousemenPerGuests" min="1" value="100" style="width: 60px; padding: 6px;" /> guests</label>
    <label style="display: inline-flex; align-items: center; gap: 6px; margin-left: 12px;"><input type="radio" name="housemenRatioMode" value="flat" /> Flat: <input type="number" id="settingsHousemenFlat" min="0" value="2" style="width: 50px; padding: 6px;" /> per event</label>
  </p>
  <button type="button" class="btn-primary" onclick="saveSettings()">Save Settings</button>
</div>

<div class="settings-section" id="laborPoolsSection">
  <h3>Labor Pools</h3>
  <p>Create pools (e.g. Servers, Cashiers, Housemen). Each employee is assigned to one pool. Seniority is tracked separately within each pool. Control whether a pool can be scheduled and whether it appears in event requirements.</p>
  
  <table class="settings-table event-types-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Default wage</th>
        <th>Can schedule</th>
        <th>In events</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="laborPoolsTableBody"></tbody>
  </table>
  <button type="button" onclick="openLaborPoolModal()" class="event-type-add-btn">Add labor pool</button>
</div>

<div id="laborPoolModalOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;" onclick="if(event.target===this) closeLaborPoolModal();">
  <div id="laborPoolModal" style="background: #2c3e50; padding: 24px; border-radius: 8px; min-width: 320px; max-width: 90%;" onclick="event.stopPropagation();">
    <h3 style="margin-top: 0;" id="laborPoolModalTitle">Add labor pool</h3>
    <input type="hidden" id="laborPoolEditId" value="" />
    <div style="margin-bottom: 12px;">
      <label for="laborPoolName" style="display: block; margin-bottom: 4px;">Name</label>
      <input type="text" id="laborPoolName" placeholder="e.g. Servers" style="width: 100%; padding: 8px; box-sizing: border-box;" />
    </div>
    <div style="margin-bottom: 12px;">
      <label for="laborPoolWage" style="display: block; margin-bottom: 4px;">Default hourly wage</label>
      <input type="number" id="laborPoolWage" min="0" step="0.01" value="0" style="width: 120px; padding: 8px;" />
    </div>
    <div style="margin-bottom: 12px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="laborPoolCanSchedule" checked />
        Can be scheduled
      </label>
    </div>
    <div style="margin-bottom: 16px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="laborPoolAppearsInEvents" checked />
        Appears in events
      </label>
    </div>
    <div style="display: flex; gap: 8px; justify-content: flex-end;">
      <button type="button" onclick="closeLaborPoolModal()">Cancel</button>
      <button type="button" class="btn-primary" onclick="saveLaborPoolFromModal()">Save Changes</button>
    </div>
  </div>
</div>

<div class="settings-section" id="eventTypesSection">
  <h3>Event Types</h3>
  <p>Define event types and staffing ratios (1 server per X guests). Inactive types are hidden when creating events but existing events keep displaying correctly.</p>
  
  <table class="settings-table event-types-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>1 Server per ___ Guests</th>
        <th>Active</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="eventTypesTableBody"></tbody>
  </table>
  <button type="button" onclick="openEventTypeModal()" class="event-type-add-btn">Add event type</button>
</div>

<div id="eventTypeModalOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
  <div id="eventTypeModal" style="background: #2c3e50; padding: 24px; border-radius: 8px; min-width: 320px; max-width: 90%;">
    <h3 style="margin-top: 0;" id="eventTypeModalTitle">Add event type</h3>
    <input type="hidden" id="eventTypeEditId" value="" />
    <div style="margin-bottom: 12px;">
      <label for="eventTypeName" style="display: block; margin-bottom: 4px;">Name</label>
      <input type="text" id="eventTypeName" placeholder="e.g. Plated Service" style="width: 100%; padding: 8px; box-sizing: border-box;" />
    </div>
    <div style="margin-bottom: 16px;">
      <label for="eventTypeGuestsPerServer" style="display: block; margin-bottom: 4px;">1 Server per ___ Guests</label>
      <input type="number" id="eventTypeGuestsPerServer" min="1" value="20" style="width: 100px; padding: 8px;" />
    </div>
    <div style="display: flex; gap: 8px; justify-content: flex-end;">
      <button type="button" onclick="closeEventTypeModal()">Cancel</button>
      <button type="button" class="btn-primary" onclick="saveEventTypeFromModal()">Save Changes</button>
    </div>
  </div>
</div>

<div class="settings-section" id="dataManagementSection">
  <h3>Data Management</h3>
  <p>Back up your data to a file or restore from a previous backup. The app also saves automatic backups when you make changes.</p>
  <div class="data-mgmt-actions">
    <div class="data-mgmt-group">
      <span class="data-mgmt-group-label">Export / Import</span>
      <div class="data-mgmt-buttons">
        <button type="button" onclick="exportData()">Export Data</button>
        <button type="button" onclick="document.getElementById('importDataFile').click()">Import Data</button>
      </div>
    </div>
    <div class="data-mgmt-group">
      <span class="data-mgmt-group-label">Backup</span>
      <div class="data-mgmt-buttons">
        <button type="button" onclick="createManualBackup()">Create backup now</button>
        <button type="button" onclick="openRestoreBackupModal()">Restore from Backup</button>
      </div>
    </div>
    <input type="file" id="importDataFile" accept=".json,application/json" style="display: none;" onchange="handleImportFile(event)" />
  </div>
  <p class="data-mgmt-note">Import replaces everything currently in the app with the file you choose. Restore from Backup uses a backup saved automatically or one you exported earlier.</p>
</div>

<div id="restoreBackupModalOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;" onclick="if(event.target===this) closeRestoreBackupModal();">
  <div id="restoreBackupModal" style="background: #2c3e50; padding: 24px; border-radius: 8px; min-width: 360px; max-width: 95%; max-height: 85vh; overflow: auto;" onclick="event.stopPropagation();">
    <h3 style="margin-top: 0;">Restore from Backup</h3>
    <p style="color: var(--brand-text-muted); font-size: 13px; margin-bottom: 16px;">Choose a backup to restore or export to a file.</p>
    <div id="restoreBackupList"></div>
    <div style="margin-top: 16px;">
      <button type="button" onclick="closeRestoreBackupModal()">Close</button>
    </div>
  </div>
</div>

<div class="settings-section settings-section-danger">
  <h3 class="danger-heading">Admin: Clear All Data</h3>
  <p>Reset the app to a completely fresh state. Use this to remove all employees, events, schedules (all weeks), and audit log.</p>
  <p class="danger-warning">This action cannot be undone. All data will be permanently deleted.</p>
  <button type="button" onclick="clearAllData()" class="btn-danger">Clear All Employee Data</button>
</div>
</div>

<!-- SUPPORT / CONTACT -->
<div id="supportTab" class="tab">
  <div class="support-page">
    <h2>Support &amp; Contact</h2>

    <div class="support-doc-card" style="margin-bottom: 24px; padding: 18px 20px; background: var(--brand-bg-elevated); border: 1px solid var(--brand-border); border-radius: 10px;">
      <h3 class="support-form-title" style="margin-top: 0;">User Guide</h3>
      <p style="margin: 0 0 12px 0; font-size: 14px; color: var(--brand-text-muted);">A complete feature guide with step-by-step instructions. Open the guide and use your browser's Print ‚Üí Save as PDF to download a PDF copy.</p>
      <a href="support/BanquetLogic-User-Guide.html" target="_blank" rel="noopener noreferrer" class="btn-primary" style="display: inline-block; padding: 10px 18px; text-decoration: none; border-radius: 8px; font-weight: 500;">Open BanquetLogic User Guide</a>
    </div>

    <p class="support-intro">
      Use this form to report issues, suggest improvements, or ask a question. Your message opens in your email client-only what you type here is sent. No employee or schedule data is ever included.
    </p>

    <div class="support-form-card">
      <h3 class="support-form-title">Send a message</h3>

      <div class="support-field">
        <label for="supportCategory">Category</label>
        <select id="supportCategory">
          <option value="Bug">Bug report</option>
          <option value="Suggestion">Feature suggestion</option>
          <option value="Question">Question</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="support-field">
        <label for="supportSubject">Subject <span class="required">*</span></label>
        <input type="text" id="supportSubject" placeholder="e.g. Schedule not saving after refresh" />
        <span class="support-helper">A short summary helps us route your message quickly.</span>
      </div>

      <div class="support-field">
        <label for="supportMessage">Message <span class="required">*</span></label>
        <textarea id="supportMessage" placeholder="Describe what happened or what you'd like to see. For bugs, include steps to reproduce and your browser if possible." rows="6"></textarea>
        <span class="support-helper">The more detail you provide, the better we can help. Include steps to reproduce for bugs.</span>
      </div>

      <div class="support-privacy">
        <strong>Privacy:</strong> Only the text you enter above is used. We do not access or send any employee names, schedules, or other app data.
      </div>

      <button type="button" class="support-submit" onclick="submitSupport()">Send message</button>

      <div id="supportFeedback" class="support-feedback" role="status" aria-live="polite"></div>
    </div>

    <div class="support-alternatives">
      <h4>Other ways to reach us</h4>
      <p>
        Email: <a href="mailto:Alialannoon@gmail.com">Alialannoon@gmail.com</a>
      </p>
      <p class="support-response-time">
        We aim to respond within 1-2 business days.
      </p>
    </div>
  </div>
</div>


  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script>
let employees = JSON.parse(localStorage.getItem("employees") || "[]");
let events = JSON.parse(localStorage.getItem("events") || "[]");
let manualEdits = JSON.parse(localStorage.getItem("manualEdits") || "{}");
let lockedCells = JSON.parse(localStorage.getItem("lockedCells") || "{}");
let lockedRows = JSON.parse(localStorage.getItem("lockedRows") || "{}");
let scheduleGlobalLock = JSON.parse(localStorage.getItem("scheduleGlobalLock") || "false");
let auditLog = JSON.parse(localStorage.getItem("auditLog") || "[]");
(function() {
  var reasonVersion = localStorage.getItem("assignmentReasonVersion");
  if (reasonVersion !== "2") {
    localStorage.removeItem("assignmentReasons");
    localStorage.removeItem("assignmentReasonTags");
    localStorage.setItem("assignmentReasonVersion", "2");
  }
})();
let assignmentReasons = JSON.parse(localStorage.getItem("assignmentReasons") || "{}"); // Store why each shift was assigned (plain-language only)
let assignmentReasonTags = JSON.parse(localStorage.getItem("assignmentReasonTags") || "{}");
let assignmentReasonCodes = JSON.parse(localStorage.getItem("assignmentReasonCodes") || "{}");
/** Week keys (YYYY-MM-DD Monday) that have generated schedule data. Used for load-before-generate. */
let scheduleGeneratedWeeks = JSON.parse(localStorage.getItem("scheduleGeneratedWeeks") || "{}");
/** Per-week schedule snapshots for persistence when navigating between weeks. Key: weekKey (YYYY-MM-DD Monday). Loaded from localStorage on init. */
var weeklySchedules = (function() {
  var saved = localStorage.getItem('weeklySchedules');
  if (saved) try { return JSON.parse(saved); } catch(e) {}
  return {};
})();
/** Set during drag of a shift cell; used by dragover to highlight valid drop targets. Cleared on drop/dragend. */
var draggedShiftKey = null;
var draggedShiftDateStr = null;
let generationConflicts = [];
var lastOvertimeSuggestions = [];
var lastScheduleNeedsReview = false;
var lastOvertimeLikelyByDay = {};
var lastApplyRecommendationsSnapshot = null;
var APP_VERSION = '1.0';
var SCHEMA_VERSION = 1;

var REASON_CODE_EXPLANATIONS = {
  PREFERENCE_MATCH: 'Assigned to match preferred shift (AM/PM or day). Higher seniority with matching preference selected.',
  PREFERENCE_MISMATCH: 'Assigned despite preference mismatch to ensure coverage. Only eligible candidate or seniority override.',
  SENIORITY_PRIORITY: 'Assigned by seniority (lower number = higher priority). Used when preferences are equal or no preference set.',
  OT_SUGGESTED: 'This assignment would exceed 8 hours for the day. Overtime suggested - review required. Manager must approve OT.',
  LIMITED_AVAILABILITY: 'Assigned because few or no other eligible staff were available for this slot.'
};

var REASON_TAG_EXPLANATIONS = {
  manual_lock: 'This shift was manually assigned or locked.',
  availability: 'Employee was available for this shift.',
  seniority: 'Selected in line with seniority policy.',
  no_conflicts: 'No scheduling conflicts this week.',
  rotation_balance: 'Assigned to support balanced hours under current policy.',
  within_max_days: 'Within allowed working days for the week.',
  full_time: 'Full-time status under current policy.',
  prefers_shift: 'Shift preference matched for this time.',
  day_preference: 'Day preference matched.',
  preference_overridden: 'Preference overridden to prevent uncovered hours.'
};

var ABSENCE_TYPES = [
  { id: 'sick', label: 'Sick', cellLabel: '(Sick)', reason: 'Marked Sick manually', paid: true },
  { id: 'vacation', label: 'Vacation (Paid)', cellLabel: '(Vacation)', reason: 'Vacation added by manager', paid: true },
  { id: 'floating_holiday', label: 'Floating Holiday (Paid)', cellLabel: '(Floating Holiday)', reason: 'Floating holiday added by manager', paid: true },
  { id: 'unpaid_vacation', label: 'Unpaid Vacation', cellLabel: '(Unpaid Vacation)', reason: 'Unpaid vacation added by manager', paid: false },
  { id: 'requested_off', label: 'Request Off', cellLabel: '(Requested Off)', reason: 'Request off (visual only)', paid: null }
];
function isFullAbsenceStatus(status) {
  return status === 'sick' || status === 'vacation' || status === 'floating_holiday' || status === 'unpaid_vacation' || status === 'requested_off';
}
var REASON_TAG_PRIORITY = ['manual_lock', 'availability', 'seniority', 'no_conflicts', 'rotation_balance', 'within_max_days', 'full_time', 'prefers_shift', 'day_preference', 'preference_overridden'];
let settings = JSON.parse(localStorage.getItem("settings") || JSON.stringify({
  assignmentStyle: "strict", // Default: Strict Seniority
  ratios: {
    "Plated Service": 20,
    "Buffet Service": 30,
    "Reception": 40,
    "Coffee Break": 50
  },
  cashierRecommendationRatio: 150,
  housemenRecommendationMode: 'per_guests',
  housemenPerGuests: 100,
  housemenFlatCount: 2
}));

function getDefaultEventTypes() {
  var r = settings.ratios || { "Plated Service": 20, "Buffet Service": 30, "Reception": 40, "Coffee Break": 50 };
  return Object.keys(r).map(function(name) {
    return { id: crypto.randomUUID(), name: name, guestsPerServer: r[name], active: true };
  });
}
var eventTypes = JSON.parse(localStorage.getItem("eventTypes") || "null");
if (!eventTypes || eventTypes.length === 0) {
  eventTypes = getDefaultEventTypes();
  localStorage.setItem("eventTypes", JSON.stringify(eventTypes));
}
function getActiveEventTypes() { return eventTypes.filter(function(t) { return t.active; }); }

var DEFAULT_SERVERS_POOL_ID = 'default-servers';
var DEFAULT_CASHIERS_POOL_ID = 'default-cashiers';
var DEFAULT_HOUSEMEN_POOL_ID = 'default-housemen';
function getDefaultLaborPools() {
  return [
    { id: DEFAULT_SERVERS_POOL_ID, name: 'Servers', defaultHourlyWage: 0, canBeScheduled: true, appearsInEvents: true },
    { id: DEFAULT_CASHIERS_POOL_ID, name: 'Cashiers', defaultHourlyWage: 0, canBeScheduled: true, appearsInEvents: true },
    { id: DEFAULT_HOUSEMEN_POOL_ID, name: 'Housemen', defaultHourlyWage: 0, canBeScheduled: true, appearsInEvents: true }
  ];
}
var laborPools = JSON.parse(localStorage.getItem("laborPools") || "null");
if (!laborPools || laborPools.length === 0) {
  laborPools = getDefaultLaborPools();
  localStorage.setItem("laborPools", JSON.stringify(laborPools));
}
// Ensure Cashier pool exists for existing installs
var cashierPool = laborPools.find(function(p) { return p.id === DEFAULT_CASHIERS_POOL_ID || (p.name && p.name.toLowerCase() === 'cashiers'); });
if (!cashierPool) {
  laborPools.push({ id: DEFAULT_CASHIERS_POOL_ID, name: 'Cashiers', defaultHourlyWage: 0, canBeScheduled: true, appearsInEvents: true });
  localStorage.setItem("laborPools", JSON.stringify(laborPools));
}
// Ensure Housemen pool exists for existing installs
var housemenPool = laborPools.find(function(p) { return p.id === DEFAULT_HOUSEMEN_POOL_ID || (p.name && p.name.toLowerCase() === 'housemen'); });
if (!housemenPool) {
  laborPools.push({ id: DEFAULT_HOUSEMEN_POOL_ID, name: 'Housemen', defaultHourlyWage: 0, canBeScheduled: true, appearsInEvents: true });
  localStorage.setItem("laborPools", JSON.stringify(laborPools));
}
function getLaborPoolById(id) { return laborPools.find(function(p) { return p.id === id; }); }
function getCashierPoolId() {
  var p = laborPools.find(function(x) { return x.id === DEFAULT_CASHIERS_POOL_ID || (x.name && x.name.toLowerCase() === 'cashiers'); });
  return p ? p.id : null;
}
function getHousemenPoolId() {
  var p = laborPools.find(function(x) { return x.id === DEFAULT_HOUSEMEN_POOL_ID || (x.name && x.name.toLowerCase() === 'housemen'); });
  return p ? p.id : null;
}
function getEmployeesTabSelectedPoolId() {
  var stored = localStorage.getItem('employeesTabSelectedPoolId');
  if (stored && getLaborPoolById(stored)) return stored;
  if (getLaborPoolById(DEFAULT_SERVERS_POOL_ID)) return DEFAULT_SERVERS_POOL_ID;
  return laborPools.length ? laborPools[0].id : null;
}
function setEmployeesTabSelectedPoolId(poolId) {
  if (!poolId || !getLaborPoolById(poolId)) return;
  localStorage.setItem('employeesTabSelectedPoolId', poolId);
}
function renderEmployeesPoolSelector() {
  var container = document.getElementById('employeesPoolSelector');
  if (!container) return;
  container.innerHTML = '';
  var selectedId = getEmployeesTabSelectedPoolId();
  var pools = laborPools.length ? laborPools : getDefaultLaborPools();
  pools.forEach(function(p) {
    var count = employees.filter(function(e) { return e.laborPoolId === p.id; }).length;
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'employees-pool-btn' + (p.id === selectedId ? ' employees-pool-btn-active' : '');
    btn.innerHTML = (p.name || p.id) + ' <span class="employees-pool-count">(' + count + ')</span>';
    btn.setAttribute('data-pool-id', p.id);
    btn.onclick = function() {
      setEmployeesTabSelectedPoolId(p.id);
      renderEmployeesPoolSelector();
      setAddFormToSelectedPool();
      renderEmployees();
    };
    container.appendChild(btn);
  });
}
function setAddFormToSelectedPool() {
  var sel = document.getElementById('empLaborPool');
  var poolId = getEmployeesTabSelectedPoolId();
  if (sel && poolId) {
    if (getLaborPoolById(poolId)) sel.value = poolId;
    updateSeniorityPreFill();
  }
}
function getCashierRecommendationForDate(dateStr) {
  var cashierPoolId = getCashierPoolId();
  if (!cashierPoolId) return { count: 0, names: [] };
  var dayEvents = events.filter(function(e) { return e.date === dateStr && e.cashBarEnabled; });
  var ratio = (settings.cashierRecommendationRatio != null && settings.cashierRecommendationRatio >= 1) ? settings.cashierRecommendationRatio : 150;
  var totalRecommended = 0;
  dayEvents.forEach(function(ev) {
    var guests = (ev.guests != null && !isNaN(ev.guests)) ? +ev.guests : 0;
    if (guests > 0) totalRecommended += Math.ceil(guests / ratio);
  });
  if (totalRecommended <= 0) return { count: 0, names: [] };
  var cashiers = employees.filter(function(e) {
    if (e.retired || e.laborPoolId !== cashierPoolId) return false;
    var k = e.id + '_' + dateStr;
    var ed = manualEdits[k];
    if (ed && isFullAbsenceStatus(ed.status)) return false;
    return true;
  });
  cashiers.sort(function(a, b) {
    var sa = getSeniorityForEmployee(a);
    var sb = getSeniorityForEmployee(b);
    sa = sa != null ? sa : 999;
    sb = sb != null ? sb : 999;
    return sa - sb;
  });
  var names = cashiers.slice(0, totalRecommended).map(function(e) { return e.name; });
  return { count: totalRecommended, names: names };
}
function getHousemenRecommendationForDate(dateStr) {
  var housemenPoolId = getHousemenPoolId();
  if (!housemenPoolId) return { count: 0, names: [] };
  var dayEvents = events.filter(function(e) { return e.date === dateStr; });
  var mode = settings.housemenRecommendationMode === 'flat' ? 'flat' : 'per_guests';
  var perGuests = (settings.housemenPerGuests != null && settings.housemenPerGuests >= 1) ? settings.housemenPerGuests : 100;
  var flatCount = (settings.housemenFlatCount != null && settings.housemenFlatCount >= 0) ? settings.housemenFlatCount : 2;
  var totalRecommended = 0;
  dayEvents.forEach(function(ev) {
    if (mode === 'flat') {
      totalRecommended += flatCount;
    } else {
      var guests = (ev.guests != null && !isNaN(ev.guests)) ? +ev.guests : 0;
      if (guests > 0) totalRecommended += Math.ceil(guests / perGuests);
    }
  });
  if (totalRecommended <= 0) return { count: 0, names: [] };
  var housemen = employees.filter(function(e) {
    if (e.retired || e.laborPoolId !== housemenPoolId) return false;
    var k = e.id + '_' + dateStr;
    var ed = manualEdits[k];
    if (ed && isFullAbsenceStatus(ed.status)) return false;
    return true;
  });
  housemen.sort(function(a, b) {
    var sa = getSeniorityForEmployee(a);
    var sb = getSeniorityForEmployee(b);
    sa = sa != null ? sa : 999;
    sb = sb != null ? sb : 999;
    return sa - sb;
  });
  var names = housemen.slice(0, totalRecommended).map(function(e) { return e.name; });
  return { count: totalRecommended, names: names };
}
function getRecommendedCashiersForDate(dateStr) {
  var rec = getCashierRecommendationForDate(dateStr);
  var cashierPoolId = getCashierPoolId();
  if (!cashierPoolId || rec.count <= 0) return [];
  var cashiers = employees.filter(function(e) {
    if (e.retired || e.laborPoolId !== cashierPoolId) return false;
    var k = e.id + '_' + dateStr;
    var ed = manualEdits[k];
    if (ed && isFullAbsenceStatus(ed.status)) return false;
    return true;
  });
  cashiers.sort(function(a, b) {
    var sa = getSeniorityForEmployee(a);
    var sb = getSeniorityForEmployee(b);
    return (sa != null ? sa : 999) - (sb != null ? sb : 999);
  });
  return cashiers.slice(0, rec.count);
}
function getRecommendedHousemenForDate(dateStr) {
  var rec = getHousemenRecommendationForDate(dateStr);
  var housemenPoolId = getHousemenPoolId();
  if (!housemenPoolId || rec.count <= 0) return [];
  var housemen = employees.filter(function(e) {
    if (e.retired || e.laborPoolId !== housemenPoolId) return false;
    var k = e.id + '_' + dateStr;
    var ed = manualEdits[k];
    if (ed && isFullAbsenceStatus(ed.status)) return false;
    return true;
  });
  housemen.sort(function(a, b) {
    var sa = getSeniorityForEmployee(a);
    var sb = getSeniorityForEmployee(b);
    return (sa != null ? sa : 999) - (sb != null ? sb : 999);
  });
  return housemen.slice(0, rec.count);
}
ensureEmployeeDefaults(employees);
function getSchedulableLaborPools() { return laborPools.filter(function(p) { return p.canBeScheduled; }); }
function getEventLaborPools() { return laborPools.filter(function(p) { return p.appearsInEvents; }); }
function isLaborPoolUsedByEmployees(pool) {
  return employees.some(function(e) { return e.laborPoolId === pool.id; });
}
function getEventTypeById(id) { return eventTypes.find(function(t) { return t.id === id; }); }
function getEventTypeByName(name) { return eventTypes.find(function(t) { return t.name === name; }); }
function isEventTypeUsedByEvents(type) {
  return events.some(function(ev) { return ev.eventTypeId === type.id || ev.service === type.name; });
}

let editingEventId = null;
let currentWeekOffset = 0;

// Initialize day preferences for existing employees (backward compatibility).
// Day preferences use Monday-based index: 0=Monday ... 6=Sunday (see getMondayBasedIndex).
function ensureDayPreferencesMondayBased(emp) {
  if (!emp.dayPreferences) {
    emp.dayPreferences = { 0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null };
    return;
  }
  if (emp._dayPrefsMondayBased) return;
  var old = emp.dayPreferences;
  var next = {};
  for (var k = 0; k <= 6; k++) {
    next[(k + 6) % 7] = old[k] !== undefined ? old[k] : null;
  }
  emp.dayPreferences = next;
  emp._dayPrefsMondayBased = true;
}
employees.forEach(emp => {
  ensureDayPreferencesMondayBased(emp);
  if(emp.maxDaysPerWeek === undefined) {
    emp.maxDaysPerWeek = 5; // Default to 5 days per week
  }
});

function save(){
  localStorage.setItem("employees", JSON.stringify(employees));
  localStorage.setItem("events", JSON.stringify(events));
  localStorage.setItem("manualEdits", JSON.stringify(manualEdits));
  localStorage.setItem("lockedCells", JSON.stringify(lockedCells));
  localStorage.setItem("lockedRows", JSON.stringify(lockedRows));
  localStorage.setItem("scheduleGlobalLock", JSON.stringify(scheduleGlobalLock));
  localStorage.setItem("auditLog", JSON.stringify(auditLog));
  localStorage.setItem("assignmentReasons", JSON.stringify(assignmentReasons));
  localStorage.setItem("assignmentReasonTags", JSON.stringify(assignmentReasonTags));
  localStorage.setItem("assignmentReasonCodes", JSON.stringify(assignmentReasonCodes));
  localStorage.setItem("settings", JSON.stringify(settings));
  localStorage.setItem("eventTypes", JSON.stringify(eventTypes));
  localStorage.setItem("laborPools", JSON.stringify(laborPools));
  localStorage.setItem("scheduleGeneratedWeeks", JSON.stringify(scheduleGeneratedWeeks));
  localStorage.setItem("weeklySchedules", JSON.stringify(weeklySchedules));
  scheduleAutoBackup();
}

/* DATA EXPORT / IMPORT (centralized for future cloud sync) */
function getDataForExport() {
  return {
    employees: employees,
    events: events,
    manualEdits: manualEdits,
    lockedCells: lockedCells,
    lockedRows: lockedRows,
    scheduleGlobalLock: scheduleGlobalLock,
    auditLog: auditLog,
    assignmentReasons: assignmentReasons,
    assignmentReasonTags: assignmentReasonTags,
    assignmentReasonCodes: assignmentReasonCodes,
    settings: settings,
    eventTypes: eventTypes,
    laborPools: laborPools,
    metadata: {
      schemaVersion: SCHEMA_VERSION,
      appVersion: APP_VERSION,
      exportTimestamp: new Date().toISOString()
    }
  };
}

function getDataForBackup(backupType) {
  var payload = getDataForExport();
  payload.metadata.exportTimestamp = undefined;
  payload.metadata.backupTimestamp = new Date().toISOString();
  payload.metadata.backupType = backupType;
  return payload;
}

/* AUTOMATIC BACKUPS (IndexedDB - separate from live data) */
var BACKUP_DB_NAME = 'BanquetLogicBackups';
var BACKUP_STORE = 'backups';
var MAX_AUTO_BACKUPS = 10;
var lastAutoBackupTime = 0;
var AUTO_BACKUP_THROTTLE_MS = 60000;

function backupOpenDB() {
  return new Promise(function(resolve, reject) {
    var req = indexedDB.open(BACKUP_DB_NAME, 1);
    req.onerror = function() { reject(req.error); };
    req.onsuccess = function() { resolve(req.result); };
    req.onupgradeneeded = function(ev) {
      var db = ev.target.result;
      if (!db.objectStoreNames.contains(BACKUP_STORE)) {
        var store = db.createObjectStore(BACKUP_STORE, { keyPath: 'id', autoIncrement: true });
        store.createIndex('byTimestamp', 'backupTimestamp', { unique: false });
        store.createIndex('byType', 'backupType', { unique: false });
      }
    };
  });
}

function backupCreate(backupType, payload) {
  if (!payload) payload = getDataForBackup(backupType);
  var record = {
    backupTimestamp: payload.metadata.backupTimestamp,
    backupType: backupType,
    data: payload
  };
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readwrite');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.add(record);
      req.onsuccess = function() { db.close(); resolve(req.result); };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupList() {
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readonly');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.getAll();
      req.onsuccess = function() {
        db.close();
        var list = req.result || [];
        list.sort(function(a, b) {
          var tA = a.backupTimestamp || '';
          var tB = b.backupTimestamp || '';
          return tA > tB ? -1 : tA < tB ? 1 : 0;
        });
        resolve(list);
      };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupGet(id) {
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readonly');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.get(id);
      req.onsuccess = function() { db.close(); resolve(req.result); };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupDelete(id) {
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readwrite');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.delete(id);
      req.onsuccess = function() { db.close(); resolve(); };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupPruneAuto() {
  return backupList().then(function(list) {
    var auto = list.filter(function(b) { return b.backupType === 'auto'; });
    if (auto.length <= MAX_AUTO_BACKUPS) return Promise.resolve();
    var toRemove = auto.slice(MAX_AUTO_BACKUPS);
    return Promise.all(toRemove.map(function(b) { return backupDelete(b.id); }));
  });
}

function scheduleAutoBackup() {
  var now = Date.now();
  if (lastAutoBackupTime && (now - lastAutoBackupTime) < AUTO_BACKUP_THROTTLE_MS) return;
  lastAutoBackupTime = now;
  backupCreate('auto').then(function() {
    return backupPruneAuto();
  }).catch(function() {});
}

function formatBackupLabel(record) {
  var ts = record.backupTimestamp || '';
  var type = (record.backupType === 'manual') ? 'Manual Backup' : 'Auto Backup';
  var dateStr = '';
  if (ts) {
    try {
      var d = new Date(ts);
      dateStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) + ', ' + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    } catch (e) { dateStr = ts; }
  } else {
    dateStr = 'Unknown date';
  }
  return type + ' - ' + dateStr;
}

function openRestoreBackupModal() {
  var overlay = document.getElementById('restoreBackupModalOverlay');
  overlay.style.display = 'flex';
  function onRestoreKey(e) {
    if (e.key === 'Escape') { closeRestoreBackupModal(); remove(); }
  }
  function remove() {
    document.removeEventListener('keydown', onRestoreKey);
  }
  document.addEventListener('keydown', onRestoreKey);
  overlay._modalCleanup = remove;
  var listEl = document.getElementById('restoreBackupList');
  listEl.innerHTML = '<p style="color: var(--brand-text-muted);">Loading backups‚Ä¶</p>';
  backupList().then(function(list) {
    if (!list.length) {
      listEl.innerHTML = '<p style="color: var(--brand-text-muted);">No backups found. Automatic backups are created when you make changes.</p>';
      return;
    }
    listEl.innerHTML = '';
    list.forEach(function(rec) {
      var row = document.createElement('div');
      row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--brand-border);';
      row.innerHTML = '<span>' + formatBackupLabel(rec) + '</span><span><button type="button" onclick="restoreFromBackup(' + rec.id + ')">Restore</button> <button type="button" onclick="exportBackupToFile(' + rec.id + ')">Export</button></span>';
      listEl.appendChild(row);
    });
  }).catch(function() {
    listEl.innerHTML = '<p style="color: #e74c3c;">Could not load backups. Please try again.</p>';
  });
}

function closeRestoreBackupModal() {
  var overlay = document.getElementById('restoreBackupModalOverlay');
  if (overlay._modalCleanup) overlay._modalCleanup();
  overlay.style.display = 'none';
}

function restoreFromBackup(id) {
  if (!confirm('Restoring will replace all current data. Continue?')) return;
  backupGet(id).then(function(record) {
    if (!record || !record.data) {
      alert('This backup could not be read.');
      return;
    }
    var data = record.data;
    var errMsg = validateImportData(data);
    if (errMsg) {
      alert('This backup cannot be restored: ' + errMsg);
      return;
    }
    data = migrateImportData(data);
    applyImportedData(data);
    reRenderAfterImport();
    closeRestoreBackupModal();
    alert('Restore complete. Your backup has been restored.');
  }).catch(function() {
    alert('Could not load this backup. Please try again.');
  });
}

function createManualBackup() {
  backupCreate('manual').then(function() {
    alert('Backup created. You can restore it anytime from Restore from Backup.');
  }).catch(function() {
    alert('Could not create backup. Please try again.');
  });
}

function exportBackupToFile(id) {
  backupGet(id).then(function(record) {
    if (!record || !record.data) {
      alert('This backup could not be read.');
      return;
    }
    var payload = record.data;
    var json = JSON.stringify(payload, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var ts = record.backupTimestamp || new Date().toISOString();
    var d = new Date(ts);
    var dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    var filename = 'banquetlogic-backup-' + dateStr + '.json';
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }).catch(function() {
    alert('Could not load this backup. Please try again.');
  });
}

function exportData() {
  var payload = getDataForExport();
  var json = JSON.stringify(payload, null, 2);
  var blob = new Blob([json], { type: 'application/json' });
  var date = new Date();
  var dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
  var filename = 'banquetlogic-backup-' + dateStr + '.json';
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function getImportedSchemaVersion(data) {
  if (!data || !data.metadata || typeof data.metadata !== 'object') return 0;
  var v = data.metadata.schemaVersion;
  return typeof v === 'number' && v >= 0 ? v : 0;
}

function validateImportData(data) {
  if (!data || typeof data !== 'object') return 'The file does not contain valid backup data.';
  if (data.employees !== undefined && !Array.isArray(data.employees)) return 'Employee data in the file is not in the expected format.';
  if (data.events !== undefined && !Array.isArray(data.events)) return 'Event data in the file is not in the expected format.';
  if (data.auditLog !== undefined && !Array.isArray(data.auditLog)) return 'Audit log data in the file is not in the expected format.';
  if (data.eventTypes !== undefined && !Array.isArray(data.eventTypes)) return 'Event types in the file are not in the expected format.';
  if (data.laborPools !== undefined && !Array.isArray(data.laborPools)) return 'Labor pools in the file are not in the expected format.';
  if (data.manualEdits !== undefined && (typeof data.manualEdits !== 'object' || data.manualEdits === null)) return 'Schedule data in the file is not in the expected format.';
  if (data.lockedCells !== undefined && (typeof data.lockedCells !== 'object' || data.lockedCells === null)) return 'Lock data in the file is not in the expected format.';
  if (data.lockedRows !== undefined && (typeof data.lockedRows !== 'object' || data.lockedRows === null)) return 'Lock data in the file is not in the expected format.';
  if (data.assignmentReasons !== undefined && (typeof data.assignmentReasons !== 'object' || data.assignmentReasons === null)) return 'Assignment data in the file is not in the expected format.';
  if (data.assignmentReasonTags !== undefined && (typeof data.assignmentReasonTags !== 'object' || data.assignmentReasonTags === null)) return 'Assignment data in the file is not in the expected format.';
  if (data.assignmentReasonCodes !== undefined && (typeof data.assignmentReasonCodes !== 'object' || data.assignmentReasonCodes === null)) return 'Assignment reason codes in the file are not in the expected format.';
  if (data.settings !== undefined && (typeof data.settings !== 'object' || data.settings === null)) return 'Settings in the file are not in the expected format.';
  return null;
}

function migrateImportData(data) {
  var result = {};
  var k;
  for (k in data) if (Object.prototype.hasOwnProperty.call(data, k)) result[k] = data[k];
  if (!Array.isArray(result.employees)) result.employees = [];
  if (!Array.isArray(result.events)) result.events = [];
  if (!result.manualEdits || typeof result.manualEdits !== 'object') result.manualEdits = {};
  if (!result.lockedCells || typeof result.lockedCells !== 'object') result.lockedCells = {};
  if (!result.lockedRows || typeof result.lockedRows !== 'object') result.lockedRows = {};
  result.scheduleGlobalLock = result.scheduleGlobalLock === true || result.scheduleGlobalLock === 'true';
  if (!Array.isArray(result.auditLog)) result.auditLog = [];
  if (!result.assignmentReasons || typeof result.assignmentReasons !== 'object') result.assignmentReasons = {};
  if (!result.assignmentReasonTags || typeof result.assignmentReasonTags !== 'object') result.assignmentReasonTags = {};
  if (!result.assignmentReasonCodes || typeof result.assignmentReasonCodes !== 'object') result.assignmentReasonCodes = {};
  if (!result.settings || typeof result.settings !== 'object') result.settings = { assignmentStyle: 'strict', ratios: {} };
  if (!Array.isArray(result.eventTypes)) {
    var r = (result.settings && result.settings.ratios) ? result.settings.ratios : { 'Plated Service': 20, 'Buffet Service': 30, 'Reception': 40, 'Coffee Break': 50 };
    result.eventTypes = Object.keys(r).map(function(name) {
      return { id: crypto.randomUUID(), name: name, guestsPerServer: r[name], active: true };
    });
  }
  if (!Array.isArray(result.laborPools)) {
    result.laborPools = getDefaultLaborPools();
  }
  if (!result.metadata || typeof result.metadata !== 'object') result.metadata = {};
  result.metadata.schemaVersion = SCHEMA_VERSION;
  return result;
}

function ensureEmployeeDefaults(list) {
  if (!Array.isArray(list)) return;
  var defaultPoolId = (laborPools.length && getLaborPoolById(DEFAULT_SERVERS_POOL_ID)) ? DEFAULT_SERVERS_POOL_ID : (laborPools[0] ? laborPools[0].id : null);
  list.forEach(function(emp) {
    if (!emp.laborPoolId) emp.laborPoolId = defaultPoolId || (laborPools[0] ? laborPools[0].id : null);
    if (!emp.seniorityByPool) emp.seniorityByPool = {};
    if (emp.seniority != null && emp.laborPoolId && emp.seniorityByPool[emp.laborPoolId] === undefined) emp.seniorityByPool[emp.laborPoolId] = emp.seniority;
    ensureDayPreferencesMondayBased(emp);
    if (emp.maxDaysPerWeek === undefined) emp.maxDaysPerWeek = 5;
  });
}

function applyImportedData(data) {
  employees = Array.isArray(data.employees) ? data.employees : [];
  ensureEmployeeDefaults(employees);
  events = Array.isArray(data.events) ? data.events : [];
  manualEdits = data.manualEdits && typeof data.manualEdits === 'object' ? data.manualEdits : {};
  lockedCells = data.lockedCells && typeof data.lockedCells === 'object' ? data.lockedCells : {};
  lockedRows = data.lockedRows && typeof data.lockedRows === 'object' ? data.lockedRows : {};
  scheduleGlobalLock = data.scheduleGlobalLock === true || data.scheduleGlobalLock === 'true';
  auditLog = Array.isArray(data.auditLog) ? data.auditLog : [];
  assignmentReasons = data.assignmentReasons && typeof data.assignmentReasons === 'object' ? data.assignmentReasons : {};
  assignmentReasonTags = data.assignmentReasonTags && typeof data.assignmentReasonTags === 'object' ? data.assignmentReasonTags : {};
  assignmentReasonCodes = data.assignmentReasonCodes && typeof data.assignmentReasonCodes === 'object' ? data.assignmentReasonCodes : {};
  settings = data.settings && typeof data.settings === 'object' ? data.settings : { assignmentStyle: 'strict', ratios: {} };
  eventTypes = Array.isArray(data.eventTypes) ? data.eventTypes : getDefaultEventTypes();
  laborPools = Array.isArray(data.laborPools) ? data.laborPools : getDefaultLaborPools();
  editingEventId = null;
}

function reRenderAfterImport() {
  save();
  populateLaborPoolDropdowns();
  renderEmployeesPoolSelector();
  setAddFormToSelectedPool();
  renderEmployees();
  renderEvents();
  displaySchedule();
  loadSettings();
  renderAuditLog();
  populateEventServiceDropdown();
}

function handleImportFile(ev) {
  var file = ev.target.files[0];
  ev.target.value = '';
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function() {
    var errMsg = null;
    var data = null;
    try {
      data = JSON.parse(reader.result);
      errMsg = validateImportData(data);
    } catch (e) {
      errMsg = 'The file could not be read. It may be damaged or not a valid backup file.';
    }
    if (errMsg) {
      alert(errMsg);
      return;
    }
    var importedVersion = getImportedSchemaVersion(data);
    if (importedVersion > SCHEMA_VERSION) {
      if (!confirm('This backup was created by a newer version of the app. Some information may not work as expected in this version.\n\nDo you want to try importing anyway?')) return;
    } else if (!confirm('Importing will replace all existing data. Continue?')) return;
    data = migrateImportData(data);
    applyImportedData(data);
    reRenderAfterImport();
    if (importedVersion > SCHEMA_VERSION) {
      alert('Import complete. If anything looks wrong, try updating the app and then import again.');
    } else if (importedVersion < SCHEMA_VERSION) {
      alert('Import complete. Your backup has been restored and updated for this version.');
    } else {
      alert('Import complete. Your backup has been restored.');
    }
  };
  reader.onerror = function() {
    alert('The file could not be read. Please try again.');
  };
  reader.readAsText(file, 'UTF-8');
}

function addAuditEntry(action, empId, date, oldValue, newValue){
  const emp = employees.find(e => e.id === empId);
  auditLog.unshift({
    timestamp: new Date().toISOString(),
    action,
    employee: emp ? emp.name : 'Unknown',
    employeeId: empId,
    date,
    oldValue,
    newValue
  });
  
  // Keep only last 1000 entries
  if(auditLog.length > 1000) auditLog = auditLog.slice(0, 1000);
  
  save();
}

/* TABS */
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="employeesTab") {
    tabEmpBtn.classList.add("active");
    populateLaborPoolDropdowns();
    renderEmployeesPoolSelector();
    setAddFormToSelectedPool();
    renderEmployees();
    setTimeout(function(){ var el = document.getElementById('empName'); if(el) el.focus(); }, 80);
  }
  if(id==="eventsTab") {
    tabEvBtn.classList.add("active");
    populateEventServiceDropdown();
    setTimeout(function(){ var el = document.getElementById('eventName'); if(el) el.focus(); }, 80);
  }
  if(id==="scheduleTab") { tabSchBtn.classList.add("active"); populatePrintPoolFilter(); renderSchedulePoolSelector(); displaySchedule(); }
  if(id==="auditTab") { tabAuditBtn.classList.add("active"); renderAuditLog(); }
  if(id==="settingsTab") { tabSettingsBtn.classList.add("active"); loadSettings(); }
  if(id==="supportTab") { tabSupportBtn.classList.add("active"); }
}


function showGenerationRules() {
  const assignmentStyle = settings.assignmentStyle || 'strict';
  
  let rules = 'üìã How We Build Your Schedule\n';
  rules += '--------------------------\n\n';
  rules += 'We only assign people who are available and within your rules. ';
  rules += 'That means we skip anyone who is sick, on vacation, or already working their max days that week. ';
  rules += 'We never change locked shifts or locked rows-those stay exactly as you set them. ';
  rules += 'We also make sure everyone has at least 8 hours rest between shifts.\n\n';
  
  rules += 'Within that, we pick who gets each shift based on your current mode:\n\n';
  
  if(assignmentStyle === 'strict') {
    rules += 'Strict Seniority\n';
    rules += 'We prioritize by seniority first. More senior staff get first choice of shifts. ';
    rules += 'Full-time staff are preferred over part-time when it makes sense. ';
    rules += 'We also try to match people\'s preferences for morning vs afternoon and for certain days of the week.\n\n';
  } else if(assignmentStyle === 'balanced') {
    rules += 'Seniority + Balanced Coverage\n';
    rules += 'We balance full-time and part-time coverage across the week so no one type is overused. ';
    rules += 'Within that balance, we favor seniority and try to keep hours in line with what each person typically works. ';
    rules += 'We also respect preferences for morning vs afternoon and for specific days.\n\n';
  } else {
    rules += 'Fair Distribution\n';
    rules += 'We spread hours fairly so people who have worked less so far get more opportunity. ';
    rules += 'We still respect preferences for morning vs afternoon and for certain days. ';
    rules += 'Seniority is used only to break ties when needed.\n\n';
  }
  
  rules += 'If we can\'t fill a shift (e.g. not enough eligible staff), we assign who we can and note it in the Conflicts report. ';
  rules += 'You can click any generated shift to see why that person was chosen.';
  
  alert(rules);
}

function showConflictReport() {
  if(generationConflicts.length === 0) {
    alert('No conflicts detected in last generation.\n\nAll shifts were successfully assigned!');
    return;
  }
  
  let report = '‚ö† SCHEDULE GENERATION CONFLICTS\n';
  report += '--------------------------\n\n';
  report += `Found ${generationConflicts.length} conflict(s):\n\n`;
  
  generationConflicts.forEach((conflict, index) => {
    report += `${index + 1}. ${conflict.event} on ${conflict.date}\n`;
    if (conflict.required != null) {
      report += `   Required: ${conflict.required} staff\n`;
      report += `   Assigned: ${conflict.assigned} staff\n`;
      report += `   Shortage: ${conflict.shortage} staff\n`;
    }
    report += `   Reason: ${conflict.reason}\n`;
    if (conflict.suggestedNames && conflict.suggestedNames.length) report += `   Non-binding suggestion: ${conflict.suggestedNames.join(', ')}\n`;
    report += '\n';
  });
  
  report += 'POSSIBLE SOLUTIONS:\n';
  report += '‚Ä¢ Hire additional staff\n';
  report += '‚Ä¢ Adjust employee max days/week limits\n';
  report += '‚Ä¢ Remove vacation/sick days if not needed\n';
  report += '‚Ä¢ Reduce event staffing requirements\n';
  report += '‚Ä¢ For overtime slots: manually assign and approve OT\n';
  report += '‚Ä¢ Manually override and assign shifts';
  
  alert(report);
}

function getAssignmentExplanation(empId, dateStr) {
  const key = empId + "_" + dateStr;
  var edit = manualEdits[key];
  if (edit && edit.absenceReason) return edit.absenceReason;
  if (edit && edit.manualOverride) return 'Manually assigned by scheduler.';
  if (lockedCells[key]) return REASON_TAG_EXPLANATIONS.manual_lock;
  var code = assignmentReasonCodes[key];
  if (code && REASON_CODE_EXPLANATIONS[code]) return REASON_CODE_EXPLANATIONS[code];
  var stored = assignmentReasons[key];
  if (stored && Array.isArray(stored) && stored.length > 0 && typeof stored[0] === 'string') return stored[0];
  const tags = assignmentReasonTags[key];
  if (!tags || !tags.length) return null;
  var ordered = [];
  for (var i = 0; i < REASON_TAG_PRIORITY.length && ordered.length < 3; i++) {
    var t = REASON_TAG_PRIORITY[i];
    if (t === 'manual_lock') continue;
    if (tags.indexOf(t) !== -1) ordered.push(t);
  }
  if (ordered.length === 0) return 'Selected per current scheduling policy.';
  var combined = [];
  var usedAvailability = false;
  var usedNoConflicts = false;
  for (var j = 0; j < ordered.length; j++) {
    var tag = ordered[j];
    if (tag === 'availability' && ordered.indexOf('no_conflicts') !== -1) {
      if (!usedAvailability) { combined.push('Available with no scheduling conflicts this week.'); usedAvailability = true; usedNoConflicts = true; }
      continue;
    }
    if (tag === 'no_conflicts') { if (!usedNoConflicts) combined.push(REASON_TAG_EXPLANATIONS.no_conflicts); usedNoConflicts = true; continue; }
    if (tag === 'availability') { if (!usedAvailability) combined.push(REASON_TAG_EXPLANATIONS.availability); usedAvailability = true; continue; }
    combined.push(REASON_TAG_EXPLANATIONS[tag] || tag);
  }
  if (combined.length === 0) return 'Selected per current scheduling policy.';
  if (combined.length === 1) return combined[0];
  return combined.slice(0, 2).join(' ') + (combined.length > 2 ? ' ' + combined[2] : '');
}

function showAssignmentReason(empId, dateStr) {
  const key = empId + "_" + dateStr;
  const emp = employees.find(e => e.id === empId);
  const date = new Date(dateStr);
  const explanation = getAssignmentExplanation(empId, dateStr);
  const title = emp ? (emp.name + ' - ' + date.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' })) : 'Shift';
  if (explanation) {
    alert(title + '\n\n' + explanation);
  } else {
    alert(title + '\n\nThis shift was manually assigned or comes from an earlier schedule. No policy-based explanation is stored.');
  }
}

/* EMAIL SCHEDULES */
function emailSchedulesToAll() {
  // Get current week
  const start = getWeekStart();
  const days = [...Array(7)].map((_, i) => {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    return d;
  });
  
  const weekRange = `${days[0].toLocaleDateString()} - ${days[6].toLocaleDateString()}`;
  
  // Check for employees without email
  const activeEmployees = employees.filter(e => !e.retired);
  const employeesWithoutEmail = [];
  const employeesWithSchedule = [];
  
  activeEmployees.forEach(emp => {
    // Check if employee has any shifts this week
    let hasShifts = false;
    days.forEach(d => {
      const dateStr = iso(d);
      const key = emp.id + "_" + dateStr;
      if(manualEdits[key] && !isFullAbsenceStatus(manualEdits[key].status) && (manualEdits[key].hours || manualEdits[key].start)) {
        hasShifts = true;
      }
    });
    
    if(hasShifts) {
      if(!emp.email) {
        employeesWithoutEmail.push(emp.name);
      } else {
        employeesWithSchedule.push(emp);
      }
    }
  });
  
  // Show warning if any employees missing email
  if(employeesWithoutEmail.length > 0) {
    let warning = '‚ö† WARNING: Cannot send schedules to employees without email addresses!\n\n';
    warning += 'Missing email for:\n';
    employeesWithoutEmail.forEach(name => {
      warning += `‚Ä¢ ${name}\n`;
    });
    warning += '\nPlease add or edit email addresses in the Employees tab (click the email cell).\n\n';
    
    if(employeesWithSchedule.length > 0) {
      warning += `Continue sending to ${employeesWithSchedule.length} employee(s) with valid emails?`;
      
      if(!confirm(warning)) {
        return;
      }
    } else {
      alert(warning + '\nNo employees have email addresses set. Cannot send any schedules.');
      return;
    }
  }
  
  if(employeesWithSchedule.length === 0) {
    alert('No employees with shifts and valid email addresses for this week.');
    return;
  }
  
  // Generate individual schedules and open email clients
  let successCount = 0;
  
  employeesWithSchedule.forEach((emp, index) => {
    setTimeout(() => {
      const emailContent = generateEmployeeScheduleEmail(emp, days);
      
      const subject = encodeURIComponent(`Your BanquetLogic Schedule - Week of ${days[0].toLocaleDateString()}`);
      const body = encodeURIComponent(emailContent);
      const mailtoLink = `mailto:${emp.email}?subject=${subject}&body=${body}`;
      
      // Open email client
      window.open(mailtoLink, '_blank');
      
      successCount++;
      
      // Log in audit
      addAuditEntry('Schedule Emailed', emp.id, null, null, `Week: ${weekRange}`);
      
    }, index * 500); // Delay each email by 500ms to avoid browser blocking
  });
  
  save();
  
  // Show confirmation
  setTimeout(() => {
    let message = `√¢≈ì‚Ä¶ Opened ${successCount} email client window(s)!\n\n`;
    message += `Please send each email from your email client.\n\n`;
    message += `Employees receiving schedules:\n`;
    employeesWithSchedule.forEach(emp => {
      message += `‚Ä¢ ${emp.name} (${emp.email})\n`;
    });
    
    if(employeesWithoutEmail.length > 0) {
      message += `\n‚ö† Skipped (no email):\n`;
      employeesWithoutEmail.forEach(name => {
        message += `‚Ä¢ ${name}\n`;
      });
    }
    
    alert(message);
  }, employeesWithSchedule.length * 500 + 200);
}

function generateEmployeeScheduleEmail(emp, days) {
  let email = `Hello ${emp.name},\n\n`;
  email += `Here is your work schedule for the week of ${days[0].toLocaleDateString()}:\n\n`;
  email += `------------------------------\n\n`;
  
  let totalHours = 0;
  let daysWorked = 0;
  
  days.forEach(d => {
    const dateStr = iso(d);
    const key = emp.id + "_" + dateStr;
    const dayName = d.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
    
    if(manualEdits[key]) {
      const edit = manualEdits[key];
      var absInfo = edit.status ? ABSENCE_TYPES.find(function(a) { return a.id === edit.status; }) : null;
      if (absInfo && (isFullAbsenceStatus(edit.status) || (edit.status === 'requested_off' && !edit.hours && !edit.start))) {
        email += `${dayName}\n`;
        email += `  Status: ${absInfo.cellLabel}\n\n`;
      } else if (edit.hours || edit.start) {
        const hours = edit.hours || edit;
        totalHours += hours;
        daysWorked++;
        
        email += `${dayName}\n`;
        email += `  Hours: ${hours}h\n`;
        if(edit.start && edit.end) {
          email += `  Time: ${edit.start} - ${edit.end}\n`;
        }
        
        // Find event for this day
        const event = events.find(ev => ev.date === dateStr);
        if(event) {
          email += `  Event: ${event.name}\n`;
        }
        email += '\n';
      } else {
        email += `${dayName}\n`;
        email += `  OFF\n\n`;
      }
    } else {
      email += `${dayName}\n`;
      email += `  OFF\n\n`;
    }
  });
  
  email += `------------------------------\n\n`;
  email += `SUMMARY:\n`;
  email += `Total Hours: ${totalHours}h\n`;
  email += `Days Worked: ${daysWorked}\n\n`;
  
  email += `If you have any questions or concerns about your schedule, please contact your manager.\n\n`;
  email += `Thank you,\nBanquetLogic Scheduling`;
  
  return email;
}

/* EMPLOYEES */
function getSeniorityForEmployee(emp) {
  if (!emp) return null;
  if (emp.laborPoolId && emp.seniorityByPool && emp.seniorityByPool[emp.laborPoolId] != null) return emp.seniorityByPool[emp.laborPoolId];
  return emp.seniority != null ? emp.seniority : null;
}

function getNextSeniority(poolId) {
  var inPool = employees.filter(function(e) { return e.laborPoolId === poolId; });
  if (inPool.length === 0) return 1;
  var max = Math.max.apply(null, inPool.map(function(e) { return getSeniorityForEmployee(e) || 0; }));
  return max + 1;
}

function validateSeniority(value, excludeEmployeeId, poolId) {
  var num = parseInt(value, 10);
  if (value === '' || value === null || value === undefined) return { ok: false, message: 'Please enter a seniority number (1 = highest).' };
  if (isNaN(num)) return { ok: false, message: 'Seniority must be a number.' };
  if (num < 1) return { ok: false, message: 'Seniority must be at least 1.' };
  var inPool = employees.filter(function(e) { return e.laborPoolId === poolId; });
  var taken = inPool.some(function(e) { return e.id !== excludeEmployeeId && (getSeniorityForEmployee(e)) === num; });
  if (taken) return { ok: false, message: 'This number is already used in this pool. Seniority must be unique per pool.' };
  return { ok: true, value: num };
}

function updateSeniorityPreFill() {
  var poolSel = document.getElementById('empLaborPool');
  var poolId = poolSel && poolSel.value ? poolSel.value : (laborPools[0] ? laborPools[0].id : null);
  var el = document.getElementById('empSeniority');
  if (el && poolId) el.value = getNextSeniority(poolId);
}

function addEmployee(){
  var empNameEl = document.getElementById('empName');
  var empLaborPoolEl = document.getElementById('empLaborPool');
  if (!empNameEl || !empNameEl.value) return;
  if (!empLaborPoolEl || !empLaborPoolEl.value) {
    alert('Please select a labor pool to continue.');
    return;
  }
  var poolId = empLaborPoolEl.value;
  var suggested = getNextSeniority(poolId);
  var empSeniorityEl = document.getElementById('empSeniority');
  var rawSeniority = (empSeniorityEl && empSeniorityEl.value || '').trim();
  var seniorityVal = rawSeniority === '' ? suggested : null;
  if (rawSeniority !== '') {
    var check = validateSeniority(rawSeniority, null, poolId);
    if (!check.ok) {
      alert(check.message);
      return;
    }
    seniorityVal = check.value;
  }
  var seniorityByPool = {};
  seniorityByPool[poolId] = seniorityVal;
  const newEmp = {
    id: crypto.randomUUID(),
    name: empNameEl.value,
    laborPoolId: poolId,
    seniorityByPool: seniorityByPool,
    seniority: seniorityVal,
    type: document.getElementById('empType').value,
    pref: document.getElementById('empPref').value,
    email: document.getElementById('empEmail').value || null,
    employeeId: document.getElementById('empEmployeeId').value || null,
    hireDate: document.getElementById('empHireDate').value || null,
    birthdate: document.getElementById('empBirthdate').value || null,
    sick: false,
    retired: false,
    maxDaysPerWeek: 5,
    dayPreferences: {
      0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null
    }
  };
  employees.push(newEmp);
  empNameEl.value = "";
  document.getElementById('empEmail').value = "";
  document.getElementById('empEmployeeId').value = "";
  document.getElementById('empHireDate').value = "";
  document.getElementById('empBirthdate').value = "";
  updateSeniorityPreFill();
  
  addAuditEntry('Employee Added', newEmp.id, null, null, `${newEmp.name} (${newEmp.type}, Seniority ${newEmp.seniority})`);
  save(); 
  renderEmployeesPoolSelector();
  renderEmployees();
}

/* IMPORT FUNCTIONS */
function showImportHelp() {
  const helpText = `
SENIORITY LIST IMPORT FORMAT
--------------------------------

You can import employees using CSV or plain text.

CSV FORMAT (with header):
Name,Type,Seniority,Preference
John Doe,FT,1,AM
Jane Smith,PT,2,PM
Bob Johnson,FT,3,

CSV FORMAT (without header):
John Doe,FT,1,AM
Jane Smith,PT,2,PM
Bob Johnson,FT,3

TEXT FORMAT (tab or comma separated):
John Doe    FT    1    AM
Jane Smith  PT    2    PM
Bob Johnson FT    3

FIELDS:
‚Ä¢ Name (required)
‚Ä¢ Type: FT or PT (required)
‚Ä¢ Seniority: number (required)
‚Ä¢ Preference: AM, PM, or blank (optional)

IMPORT MODES:
‚Ä¢ Replace: Removes all existing employees
‚Ä¢ Merge: Adds to existing employees, rebalances seniority

TIP: Export your current list first as a backup!
  `;
  
  alert(helpText);
}

function openPasteImport() {
  const input = prompt(
    "Paste your employee list:\n\n" +
    "Format: Name, Type, Seniority, Preference\n" +
    "Example:\n" +
    "John Doe, FT, 1, AM\n" +
    "Jane Smith, PT, 2, PM\n\n" +
    "Paste your list below:"
  );
  
  if (!input || input.trim() === '') return;
  
  parseAndImportText(input);
}

function handleFileImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    parseAndImportText(text);
  };
  reader.readAsText(file);
  
  // Reset file input
  event.target.value = '';
}

function parseAndImportText(text) {
  const lines = text.trim().split('\n').filter(line => line.trim() !== '');
  
  if (lines.length === 0) {
    alert('No data found in import');
    return;
  }
  
  const parsed = [];
  let hasHeader = false;
  let startIndex = 0;
  
  // Check if first line is a header
  const firstLine = lines[0].toLowerCase();
  if (firstLine.includes('name') && (firstLine.includes('type') || firstLine.includes('seniority'))) {
    hasHeader = true;
    startIndex = 1;
  }
  
  // Parse each line
  for (let i = startIndex; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Split by comma or tab
    let parts;
    if (line.includes(',')) {
      parts = line.split(',').map(p => p.trim());
    } else if (line.includes('\t')) {
      parts = line.split('\t').map(p => p.trim());
    } else {
      // Try splitting by multiple spaces
      parts = line.split(/\s{2,}/).map(p => p.trim());
    }
    
    if (parts.length < 3) {
      console.warn(`Skipping invalid line ${i + 1}: ${line}`);
      continue;
    }
    
    const name = parts[0];
    const type = parts[1].toUpperCase();
    const seniority = parseInt(parts[2]);
    const pref = parts[3] ? parts[3].toUpperCase() : '';
    
    // Validate
    if (!name || (type !== 'FT' && type !== 'PT') || isNaN(seniority)) {
      console.warn(`Skipping invalid employee on line ${i + 1}: ${line}`);
      continue;
    }
    
    parsed.push({
      name,
      type,
      seniority,
      pref: (pref === 'AM' || pref === 'PM') ? pref : ''
    });
  }
  
  if (parsed.length === 0) {
    alert('No valid employees found in import.\n\nCheck format:\nName, Type, Seniority, Preference');
    return;
  }
  
  // Ask import mode
  const mode = confirm(
    `Found ${parsed.length} employees to import.\n\n` +
    `Click OK to REPLACE all existing employees\n` +
    `Click Cancel to MERGE with existing employees`
  );
  
  if (mode) {
    // Replace mode
    if (!confirm(`This will DELETE all ${employees.length} existing employees and import ${parsed.length} new ones.\n\nAre you sure?`)) {
      return;
    }
    
    employees = [];
  }
  
  var defaultPoolId = (laborPools.length && getLaborPoolById(DEFAULT_SERVERS_POOL_ID)) ? DEFAULT_SERVERS_POOL_ID : (laborPools[0] ? laborPools[0].id : null);
  let imported = 0;
  parsed.forEach(emp => {
    var seniorityByPool = {};
    if (defaultPoolId) seniorityByPool[defaultPoolId] = emp.seniority;
    employees.push({
      id: crypto.randomUUID(),
      name: emp.name,
      laborPoolId: defaultPoolId,
      seniorityByPool: seniorityByPool,
      seniority: emp.seniority,
      type: emp.type,
      pref: emp.pref || null,
      sick: false,
      retired: false,
      maxDaysPerWeek: 5,
      dayPreferences: { 0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null }
    });
    imported++;
  });
  
  rebalanceSeniority();
  ensureEmployeeDefaults(employees);
  
  addAuditEntry('Employees Imported', null, null, null, `${imported} employees imported (${mode ? 'Replace' : 'Merge'} mode)`);
  save();
  renderEmployeesPoolSelector();
  renderEmployees();
  
  alert(`√¢≈ì‚Ä¶ Successfully imported ${imported} employees!${mode ? '\n\nAll previous employees were replaced.' : '\n\nSeniority has been rebalanced.'}`);
}

/* EXPORT FUNCTION */
function exportEmployeeList() {
  if (employees.length === 0) {
    alert('No employees to export');
    return;
  }
  
  // Generate CSV
  let csv = 'Name,Type,Seniority,Preference\n';
  
  employees.filter(e => !e.retired)
    .sort((a, b) => a.seniority - b.seniority)
    .forEach(e => {
      csv += `${e.name},${e.type},${e.seniority},${e.pref || ''}\n`;
    });
  
  // Create download
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `BanquetLogic-Employees-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  alert('√¢≈ì‚Ä¶ Employee list exported!');
}

function rebalanceSeniority(){
  laborPools.forEach(function(pool) {
    var inPool = employees.filter(function(e) { return !e.retired && e.laborPoolId === pool.id; });
    inPool.sort(function(a, b) { return (getSeniorityForEmployee(a) || 999) - (getSeniorityForEmployee(b) || 999); });
    inPool.forEach(function(e, i) {
      if (!e.seniorityByPool) e.seniorityByPool = {};
      e.seniorityByPool[pool.id] = i + 1;
      e.seniority = i + 1;
    });
  });
}

function retireEmployee(id){
  if(!confirm("Retire this employee?")) return;
  const emp = employees.find(e=>e.id===id);
  emp.retired=true;
  rebalanceSeniority();
  
  addAuditEntry('Employee Retired', id, null, 'Active', 'Retired');
  save(); 
  renderEmployeesPoolSelector();
  renderEmployees();
}

function renderEmployees(){
  var tableEl = document.getElementById('employeesTable');
  if (!tableEl) return;
  tableEl.innerHTML = "";
  var selectedPoolId = getEmployeesTabSelectedPoolId();
  var filtered = employees.filter(function(e) { return e.laborPoolId === selectedPoolId; });
  filtered.sort(function(a, b) {
    return (getSeniorityForEmployee(a) || 999) - (getSeniorityForEmployee(b) || 999);
  });
  filtered.forEach(function(e) {
    const row = document.createElement('tr');
    row.className = e.retired ? 'status-retired' : '';
    
    const maxDays = e.maxDaysPerWeek !== undefined ? e.maxDaysPerWeek : 5;
    
    row.innerHTML = `
      <td>${e.name}</td>
      <td>${e.type}</td>
      <td class="email-cell-td" data-emp-id="${e.id}" title="${e.email ? 'Click to edit' : 'Click to add email'}"></td>
      <td>${e.pref || "-"}</td>
      <td><input type="number" class="max-days-input" value="${maxDays}" min="1" max="5" placeholder="5" style="width:50px;" ${e.retired ? 'disabled' : ''}></td>
      <td><button type="button" class="vacation-btn" style="background:#3498db; padding:4px 8px;">Vacation</button></td>
      <td><button type="button" class="dayprefs-btn" style="background:#9b59b6; padding:4px 8px;">Day Prefs</button></td>
      <td><button type="button" class="timeoff-btn" style="background:#6b7c8d; padding:4px 8px;" title="Time Off / Sick">Time Off</button></td>
      <td><input type="checkbox" class="sick-check" ${e.sick ? "checked" : ""}></td>
      <td>
        <button type="button" class="info-btn" style="background:#27ae60; padding:4px 8px;" title="View/Edit Info">Info</button>
        ${e.retired ? "-" : '<button type="button" class="retire">Retire</button>'}
      </td>
    `;
    
    const emailTd = row.querySelector('.email-cell-td');
    if (emailTd) {
      function setEmailCellDisplay() {
        const emp = employees.find(function(x) { return x.id === e.id; });
        const val = emp ? emp.email : '';
        const display = val ? (val.length > 20 ? val.substring(0, 17) + '...' : val) : '';
        emailTd.innerHTML = '';
        const wrap = document.createElement('span');
        wrap.className = 'email-cell-wrap' + (display ? '' : ' email-cell-placeholder');
        wrap.textContent = display || 'Add email';
        wrap.title = display ? 'Click to edit' : 'Click to add email';
        wrap.onclick = function() {
          const inp = document.createElement('input');
          inp.type = 'email';
          inp.className = 'email-cell-input';
          inp.placeholder = 'email@example.com';
          inp.value = (employees.find(function(x) { return x.id === e.id; }) || {}).email || '';
          emailTd.innerHTML = '';
          emailTd.appendChild(inp);
          inp.focus();
          inp.select();
          function saveEmail() {
            const newVal = (inp.value || '').trim() || null;
            const emp = employees.find(function(x) { return x.id === e.id; });
            if (emp) {
              const oldVal = emp.email || null;
              if (oldVal !== newVal) {
                emp.email = newVal;
                addAuditEntry('Email Updated', e.id, null, oldVal || '(none)', newVal || '(none)');
                save();
              }
            }
            setEmailCellDisplay();
          }
          inp.onblur = saveEmail;
          inp.onkeydown = function(ev) {
            if (ev.key === 'Enter') { inp.blur(); ev.preventDefault(); }
            if (ev.key === 'Escape') { setEmailCellDisplay(); ev.preventDefault(); }
          };
        };
        emailTd.appendChild(wrap);
      }
      setEmailCellDisplay();
    }
    
    const maxDaysInput = row.querySelector('.max-days-input');
    const vacationBtn = row.querySelector('.vacation-btn');
    const dayPrefsBtn = row.querySelector('.dayprefs-btn');
    const timeoffBtn = row.querySelector('.timeoff-btn');
    const sickCheck = row.querySelector('.sick-check');
    const retireBtn = row.querySelector('.retire');
    const infoBtn = row.querySelector('.info-btn');
    
    if(timeoffBtn) {
      timeoffBtn.onclick = function() { openAbsenceModal(e.id); };
    }
    
    if(maxDaysInput) {
      maxDaysInput.onchange = function() {
        setMaxDaysPerWeek(e.id, parseInt(this.value));
      };
    }
    
    if(vacationBtn) {
      vacationBtn.onclick = function() {
        openVacationPicker(e.id);
      };
    }
    
    if(dayPrefsBtn) {
      dayPrefsBtn.onclick = function() {
        openDayPreferences(e.id);
      };
    }
    
    if(sickCheck) {
      sickCheck.onchange = function() {
        toggleSick(e.id, this.checked);
      };
    }
    
    if(retireBtn) {
      retireBtn.onclick = () => retireEmployee(e.id);
    }
    
    if(infoBtn) {
      infoBtn.onclick = function() {
        viewEmployeeInfo(e.id);
      };
    }
    
    tableEl.appendChild(row);
  });
  var poolName = getLaborPoolById(selectedPoolId) ? getLaborPoolById(selectedPoolId).name : 'this pool';
  if (filtered.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="10" style="text-align:center;padding:1.5rem;color:#7f8c8d;">No ' + poolName + ' yet. Add an employee above to get started.</td>';
    tableEl.appendChild(emptyRow);
  }
}

function openVacationPicker(empId) {
  const emp = employees.find(e => e.id === empId);
  
  // Get current week
  const start = getWeekStart();
  const days = [...Array(7)].map((_, i) => {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    return d;
  });
  
  // Build dialog
  let dialog = `Set vacation days for ${emp.name}\n`;
  dialog += `Current week: ${days[0].toLocaleDateString()} - ${days[6].toLocaleDateString()}\n\n`;
  dialog += `Select days to mark as VACATION:\n`;
  dialog += `--------------------------\n`;
  
  const dayOptions = [];
  days.forEach((d, index) => {
    const dateStr = iso(d);
    const dayName = d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' });
    const key = empId + "_" + dateStr;
    const ed = manualEdits[key];
    const isTimeOff = ed && ed.status && (isFullAbsenceStatus(ed.status) || ed.status === 'requested_off');
    dialog += `${index + 1}. ${dayName}${isTimeOff ? ' √¢≈ì"' : ''}\n`;
    dayOptions.push({ dateStr, dayName, isTimeOff });
  });
  
  dialog += `--------------------------\n\n`;
  dialog += `Enter day numbers separated by commas:\n`;
  dialog += `Example: 1,3,5 (for Mon, Wed, Fri)\n`;
  dialog += `Or enter "all" for entire week\n`;
  dialog += `Or enter "clear" to remove all vacation days\n`;
  
  const input = prompt(dialog);
  
  if (input === null) return; // Cancelled
  
  const trimmed = input.trim().toLowerCase();
  
  // Clear all vacation days
  if (trimmed === 'clear' || trimmed === '') {
    days.forEach(d => {
      const dateStr = iso(d);
      const key = empId + "_" + dateStr;
      if (manualEdits[key] && isFullAbsenceStatus(manualEdits[key].status)) {
        delete manualEdits[key];
      }
    });
    
    addAuditEntry('Time Off Cleared', empId, null, 'Had time off', 'Cleared');
    save();
    displaySchedule();
    return;
  }
  
  // Mark all days
  if (trimmed === 'all') {
    days.forEach(d => {
      const dateStr = iso(d);
      const key = empId + "_" + dateStr;
      manualEdits[key] = { status: 'vacation', manualOverride: true };
      delete assignmentReasonTags[key];
      delete assignmentReasons[key];
      delete assignmentReasonCodes[key];
    });
    
    addAuditEntry('Vacation Set', empId, null, null, 'Entire week');
    save();
    displaySchedule();
    return;
  }
  
  // Parse specific days
  const selectedDays = trimmed.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 7);
  
  if (selectedDays.length === 0) {
    alert('Check required. Please enter day numbers (1-7), "all", or "clear".');
    return;
  }
  
  // Clear existing vacation days first
  days.forEach(d => {
    const dateStr = iso(d);
    const key = empId + "_" + dateStr;
    if (manualEdits[key] && isFullAbsenceStatus(manualEdits[key].status)) {
      delete manualEdits[key];
    }
  });
  
  // Set new vacation days
  const vacationDates = [];
  selectedDays.forEach(dayNum => {
    const d = days[dayNum - 1];
    if (d) {
      const dateStr = iso(d);
      const key = empId + "_" + dateStr;
      manualEdits[key] = { status: 'vacation', manualOverride: true };
      delete assignmentReasonTags[key];
      delete assignmentReasons[key];
      delete assignmentReasonCodes[key];
      vacationDates.push(d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' }));
    }
  });
  
  addAuditEntry('Vacation Set', empId, null, null, vacationDates.join(', '));
  save();
  displaySchedule();
}

function openDayPreferences(empId) {
  const emp = employees.find(e => e.id === empId);
  
  ensureDayPreferencesMondayBased(emp);
  
  // dayPreferences use Monday-based index: 0=Monday ... 6=Sunday (DAY_NAMES_MONDAY_BASED)
  var dayNames = DAY_NAMES_MONDAY_BASED;
  
  let dialog = `Set weekly day preferences for ${emp.name}\n\n`;
  dialog += `These are PREFERENCES only - employee can still be scheduled\n`;
  dialog += `on any day if needed to maximize hours.\n\n`;
  dialog += `Current preferences:\n`;
  dialog += `--------------------------\n`;
  
  dayNames.forEach((name, index) => {
    var pref = emp.dayPreferences[index];
    var prefText = '(no preference)';
    if (pref === true) prefText = '√¢≈ì" PREFERS to work';
    if (pref === false) prefText = '√¢≈ì- PREFERS OFF';
    dialog += index + '. ' + name.padEnd(10) + ' ' + prefText + '\n';
  });
  
  dialog += `--------------------------\n\n`;
  dialog += `To set preferences, enter day numbers (0=Mon ... 6=Sun):\n\n`;
  dialog += `PREFERS TO WORK: Enter numbers with '+'\n`;
  dialog += `  Example: +0,1,4 (prefers Mon, Tue, Fri)\n\n`;
  dialog += `PREFERS OFF: Enter numbers with '-'\n`;
  dialog += `  Example: -5,6 (prefers off Sat, Sun)\n\n`;
  dialog += `BOTH: Separate with semicolon\n`;
  dialog += `  Example: +0,1,2,3,4;-5,6\n`;
  dialog += `  (prefers to work weekdays, off weekends)\n\n`;
  dialog += `CLEAR ALL: Enter "clear"\n`;
  
  const input = prompt(dialog);
  
  if(input === null) return; // Cancelled
  
  const trimmed = input.trim().toLowerCase();
  
  // Clear all preferences
  if(trimmed === 'clear' || trimmed === '') {
    emp.dayPreferences = {
      0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null
    };
    addAuditEntry('Day Preferences Cleared', empId, null, 'Has preferences', 'No preferences');
    save();
    return;
  }
  
  // Parse input
  const parts = input.split(';');
  const prefersWork = [];
  const prefersOff = [];
  
  parts.forEach(part => {
    const trimmedPart = part.trim();
    
    if(trimmedPart.startsWith('+')) {
      // Prefers to work
      const days = trimmedPart.substring(1).split(',')
        .map(s => parseInt(s.trim()))
        .filter(n => !isNaN(n) && n >= 0 && n <= 6);
      prefersWork.push(...days);
    } else if(trimmedPart.startsWith('-')) {
      // Prefers off
      const days = trimmedPart.substring(1).split(',')
        .map(s => parseInt(s.trim()))
        .filter(n => !isNaN(n) && n >= 0 && n <= 6);
      prefersOff.push(...days);
    }
  });
  
  if (prefersWork.length === 0 && prefersOff.length === 0) {
    alert('Format needs review. Use:\n+0,1,4 (prefers Mon, Tue, Fri)\n-5,6 (prefers off Sat, Sun)\n+0,1,2,3,4;-5,6 (both)');
    return;
  }
  
  emp.dayPreferences = { 0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null };
  prefersWork.forEach(function(day) { emp.dayPreferences[day] = true; });
  prefersOff.forEach(function(day) { emp.dayPreferences[day] = false; });
  
  var workDays = prefersWork.map(function(d) { return dayNames[d]; }).join(', ');
  var offDays = prefersOff.map(function(d) { return dayNames[d]; }).join(', ');
  let auditMsg = '';
  if(workDays) auditMsg += `Work: ${workDays}`;
  if(offDays) auditMsg += `${auditMsg ? '; ' : ''}Off: ${offDays}`;
  
  addAuditEntry('Day Preferences Set', empId, null, null, auditMsg);
  save();
  alert(`Preferences saved!\n\nPrefers to work: ${workDays || 'none'}\nPrefers off: ${offDays || 'none'}`);
}

var absenceModalEmpId = null;

function openAbsenceModal(empId) {
  var emp = employees.find(function(e) { return e.id === empId; });
  if (!emp) return;
  absenceModalEmpId = empId;
  document.getElementById('absenceModalTitle').textContent = 'Time Off / Sick';
  document.getElementById('absenceModalEmpName').textContent = emp.name;
  var start = getWeekStart();
  document.getElementById('absenceStartDate').value = iso(start);
  document.getElementById('absenceEndDate').value = '';
  document.getElementById('absenceType').value = 'sick';
  document.getElementById('absenceModalOverlay').classList.add('absence-visible');
  setTimeout(function(){ var el = document.getElementById('absenceStartDate'); if(el) el.focus(); }, 50);
  function onAbsenceKey(e) {
    if (e.key === 'Escape') { closeAbsenceModal(); remove(); }
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); applyAbsence(); }
  }
  function remove() {
    document.removeEventListener('keydown', onAbsenceKey);
  }
  document.addEventListener('keydown', onAbsenceKey);
  document.getElementById('absenceModalOverlay')._modalCleanup = remove;
}

function closeAbsenceModal() {
  var overlay = document.getElementById('absenceModalOverlay');
  if (overlay._modalCleanup) overlay._modalCleanup();
  absenceModalEmpId = null;
  overlay.classList.remove('absence-visible');
}

function getDatesBetween(startStr, endStr) {
  var out = [];
  var d = new Date(startStr);
  var end = new Date(endStr || startStr);
  if (d > end) { var t = d; d = end; end = t; }
  while (d <= end) {
    out.push(iso(d));
    d.setDate(d.getDate() + 1);
  }
  return out;
}

function applyAbsence() {
  if (!absenceModalEmpId) return;
  var startStr = document.getElementById('absenceStartDate').value;
  if (!startStr) {
    alert('Please select a start date.');
    return;
  }
  var endStr = document.getElementById('absenceEndDate').value || startStr;
  var typeId = document.getElementById('absenceType').value;
  var typeInfo = ABSENCE_TYPES.find(function(t) { return t.id === typeId; });
  if (!typeInfo) return;
  var dateStrs = getDatesBetween(startStr, endStr);
  var emp = employees.find(function(e) { return e.id === absenceModalEmpId; });
  if (!emp) return;
  var isRequestOff = typeId === 'requested_off';
  dateStrs.forEach(function(dateStr) {
    var key = absenceModalEmpId + '_' + dateStr;
    if (isRequestOff) {
      var existing = manualEdits[key];
      if (existing && (existing.hours || existing.start)) {
        manualEdits[key] = { status: 'requested_off', manualOverride: true, absenceReason: typeInfo.reason, requestedOff: true, hours: existing.hours, start: existing.start, end: existing.end };
      } else {
        manualEdits[key] = { status: 'requested_off', manualOverride: true, absenceReason: typeInfo.reason, requestedOff: true };
      }
    } else {
      manualEdits[key] = { status: typeId, manualOverride: true, absenceReason: typeInfo.reason };
      delete assignmentReasonTags[key];
      delete assignmentReasons[key];
      delete assignmentReasonCodes[key];
    }
  });
  var actionLabel = typeInfo.label;
  addAuditEntry('Absence Added', absenceModalEmpId, null, null, actionLabel + ': ' + (dateStrs.length === 1 ? dateStrs[0] : dateStrs[0] + ' to ' + dateStrs[dateStrs.length - 1]));
  save();
  displaySchedule();
  closeAbsenceModal();
}

function initAbsenceModal() {
  document.getElementById('absenceConfirmBtn').onclick = applyAbsence;
  document.getElementById('absenceCancelBtn').onclick = closeAbsenceModal;
  document.getElementById('absenceModalOverlay').onclick = function(e) {
    if (e.target === this) closeAbsenceModal();
  };
}

function syncSickToSchedule(empId, isSick) {
  var start = getWeekStart();
  var weekKey = dateToLocalYYYYMMDD(start);
  var dateStrs = getDateStrsForWeek(weekKey);
  var typeInfo = ABSENCE_TYPES.find(function(a) { return a.id === 'sick'; });
  dateStrs.forEach(function(dateStr) {
    var key = empId + '_' + dateStr;
    if (isSick) {
      manualEdits[key] = { status: 'sick', manualOverride: true, absenceReason: typeInfo ? typeInfo.reason : 'Marked Sick manually' };
    } else {
      if (manualEdits[key] && manualEdits[key].status === 'sick') delete manualEdits[key];
    }
  });
}

function toggleSick(id, checked){
  const emp = employees.find(e=>e.id===id);
  emp.sick=checked;
  syncSickToSchedule(id, checked);
  addAuditEntry('Sick Status Changed', id, null, !checked, checked);
  save();
  displaySchedule();
}

function setMaxDaysPerWeek(empId, maxDays) {
  const emp = employees.find(e => e.id === empId);
  
  // Default to 5 if empty or invalid
  if(maxDays === '' || maxDays === null || maxDays === undefined || isNaN(maxDays)) {
    maxDays = 5;
  }
  
  maxDays = parseInt(maxDays);
  
  // Validate input - max 5 days per week
  if(maxDays < 1 || maxDays > 5) {
    alert('Max days per week must be between 1 and 5. Leave empty for 5.');
    renderEmployees(); // Reset display
    return;
  }
  
  const oldValue = emp.maxDaysPerWeek || 5;
  emp.maxDaysPerWeek = maxDays;
  
  addAuditEntry('Max Days Changed', empId, null, `${oldValue} days/week`, `${maxDays} days/week`);
  save();
  
  console.log(`${emp.name} max days set to ${maxDays}/week`);
}

var editingEmployeeId = null;

function viewEmployeeInfo(empId) {
  const emp = employees.find(e => e.id === empId);
  if (!emp) return;
  editingEmployeeId = empId;
  populateLaborPoolDropdowns();
  document.getElementById('employeeEditTitle').textContent = 'Edit employee';
  document.getElementById('employeeEditName').textContent = emp.name;
  document.getElementById('employeeEditType').value = emp.type || 'FT';
  document.getElementById('employeeEditLaborPool').value = emp.laborPoolId || (laborPools[0] ? laborPools[0].id : '');
  document.getElementById('employeeEditPref').value = emp.pref || '';
  document.getElementById('employeeEditSeniority').value = getSeniorityForEmployee(emp) != null ? getSeniorityForEmployee(emp) : '';
  document.getElementById('employeeEditSick').checked = !!emp.sick;
  var overlay = document.getElementById('employeeEditModalOverlay');
  overlay.classList.add('employee-edit-visible');
  setTimeout(function(){ var el = document.getElementById('employeeEditType'); if(el) el.focus(); }, 50);
  function onEditKey(e) {
    if (e.key === 'Escape') { closeEmployeeEditModal(); remove(); }
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); saveEmployeeEdit(); }
  }
  function remove() {
    document.removeEventListener('keydown', onEditKey);
  }
  document.addEventListener('keydown', onEditKey);
  overlay._modalCleanup = remove;
}

function closeEmployeeEditModal() {
  var overlay = document.getElementById('employeeEditModalOverlay');
  if (overlay._modalCleanup) overlay._modalCleanup();
  editingEmployeeId = null;
  overlay.classList.remove('employee-edit-visible');
}

function saveEmployeeEdit() {
  if (!editingEmployeeId) return;
  const emp = employees.find(e => e.id === editingEmployeeId);
  if (!emp) return;
  
  var typeEl = document.getElementById('employeeEditType');
  var poolEl = document.getElementById('employeeEditLaborPool');
  var prefEl = document.getElementById('employeeEditPref');
  var seniorityEl = document.getElementById('employeeEditSeniority');
  var sickEl = document.getElementById('employeeEditSick');
  
  var poolId = poolEl && poolEl.value ? poolEl.value : emp.laborPoolId;
  if (!poolId) {
    alert('Please select a labor pool to continue.');
    return;
  }
  var rawSeniority = (seniorityEl.value || '').trim();
  var check = validateSeniority(rawSeniority, editingEmployeeId, poolId);
  if (!check.ok) {
    alert(check.message);
    return;
  }
  
  var oldType = emp.type;
  var oldPoolId = emp.laborPoolId;
  var oldPref = emp.pref || '';
  var oldSeniority = getSeniorityForEmployee(emp);
  var oldSick = emp.sick;
  
  emp.type = typeEl.value;
  emp.laborPoolId = poolId;
  if (!emp.seniorityByPool) emp.seniorityByPool = {};
  emp.seniorityByPool[poolId] = check.value;
  emp.seniority = check.value;
  emp.pref = prefEl.value || null;
  emp.sick = sickEl.checked;
  
  var changes = [];
  if (oldType !== emp.type) changes.push('type ' + oldType + ' ‚Üí ' + emp.type);
  if (oldPoolId !== emp.laborPoolId) changes.push('labor pool ‚Üí ' + (getLaborPoolById(emp.laborPoolId) ? getLaborPoolById(emp.laborPoolId).name : emp.laborPoolId));
  if (oldPref !== (emp.pref || '')) changes.push('preference ' + (oldPref || 'none') + ' ‚Üí ' + (emp.pref || 'none'));
  if (oldSeniority !== emp.seniority) changes.push('seniority ' + oldSeniority + ' ‚Üí ' + emp.seniority);
  if (oldSick !== emp.sick) changes.push('sick ' + (oldSick ? 'yes' : 'no') + ' ‚Üí ' + (emp.sick ? 'yes' : 'no'));
  
  if (changes.length) {
    addAuditEntry('Employee Updated', emp.id, null, changes.join('; '), emp.name);
  }
  
  if (oldSick !== emp.sick) syncSickToSchedule(emp.id, emp.sick);
  save();
  renderEmployeesPoolSelector();
  renderEmployees();
  displaySchedule();
  closeEmployeeEditModal();
}

function initEmployeeEditModal() {
  document.getElementById('employeeEditSaveBtn').onclick = saveEmployeeEdit;
  document.getElementById('employeeEditCancelBtn').onclick = closeEmployeeEditModal;
  document.getElementById('employeeEditModalOverlay').onclick = function(e) {
    if (e.target === this) closeEmployeeEditModal();
  };
}

/* EVENTS */
function populateEventServiceDropdown(){
  var sel = document.getElementById('eventService');
  if (!sel) return;
  var active = getActiveEventTypes();
  sel.innerHTML = '';
  active.forEach(function(t){
    var opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = t.name;
    sel.appendChild(opt);
  });
}

function autoRecommendStaff(){
  const guests = +eventGuests.value;
  if (!guests) return;
  const typeId = eventService.value;
  const t = getEventTypeById(typeId);
  const ratio = t ? t.guestsPerServer : 30;
  eventStaff.value = Math.ceil(guests / ratio);
}

function addEventPoolReqRow(poolId, quantity) {
  var container = document.getElementById('eventLaborPoolReqsContainer');
  if (!container) return;
  var row = document.createElement('div');
  row.className = 'event-pool-req-row';
  row.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 6px;';
  var sel = document.createElement('select');
  sel.className = 'event-pool-req-pool';
  var pools = getEventLaborPools();
  pools.forEach(function(p) {
    var opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name || p.id;
    sel.appendChild(opt);
  });
  if (poolId) sel.value = poolId;
  var qty = document.createElement('input');
  qty.type = 'number';
  qty.min = 1;
  qty.className = 'event-pool-req-qty';
  qty.value = quantity != null ? quantity : 1;
  qty.style.width = '60px';
  var btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = 'Remove';
  btn.onclick = function() { row.remove(); };
  row.appendChild(sel);
  row.appendChild(qty);
  row.appendChild(btn);
  container.appendChild(row);
}

function getEventLaborPoolReqsFromForm() {
  var container = document.getElementById('eventLaborPoolReqsContainer');
  if (!container) return [];
  var rows = container.querySelectorAll('.event-pool-req-row');
  var reqs = [];
  rows.forEach(function(row) {
    var sel = row.querySelector('.event-pool-req-pool');
    var qty = row.querySelector('.event-pool-req-qty');
    if (sel && sel.value && qty) {
      var n = parseInt(qty.value, 10);
      if (!isNaN(n) && n >= 1) reqs.push({ laborPoolId: sel.value, quantity: n });
    }
  });
  return reqs;
}

function addEvent(){
  if(!eventName.value || !eventDate.value) return;
  var typeId = eventService.value;
  var type = getEventTypeById(typeId);
  var typeName = type ? type.name : (eventService.options[eventService.selectedIndex] ? eventService.options[eventService.selectedIndex].text : '');
  var poolReqs = getEventLaborPoolReqsFromForm();
  var totalStaff = poolReqs.length ? poolReqs.reduce(function(s, r) { return s + r.quantity; }, 0) : (+eventStaff.value || 1);
  var eventCashBarEl = document.getElementById('eventCashBar');
  const data={
    id: editingEventId || crypto.randomUUID(),
    name: eventName.value,
    date: eventDate.value,
    start: eventStart.value || "09:00",
    end: eventEnd.value || "17:00",
    guests: +eventGuests.value || 0,
    service: typeName,
    eventTypeId: typeId || undefined,
    eventTypeName: typeName,
    staff: totalStaff,
    laborPoolRequirements: poolReqs,
    cashBarEnabled: !!(eventCashBarEl && eventCashBarEl.checked)
  };
  
  if(editingEventId){
    const oldEvent = events.find(e=>e.id===editingEventId);
    Object.assign(oldEvent, data);
    addAuditEntry('Event Modified', null, data.date, 
      `${oldEvent.name} (${oldEvent.staff} staff)`,
      `${data.name} (${data.staff} staff)`);
    editingEventId=null;
  } else {
    events.push(data);
    addAuditEntry('Event Created', null, data.date, null, `${data.name} (${data.staff} staff)`);
  }
  
  eventName.value="";
  eventDate.value="";
  eventStart.value="";
  eventEnd.value="";
  eventGuests.value="";
  eventStaff.value="";
  if (eventCashBarEl) eventCashBarEl.checked = false;
  var container = document.getElementById('eventLaborPoolReqsContainer');
  if (container) container.innerHTML = '';
  
  save(); 
  renderEvents();
}

function formatEventPoolReqs(ev) {
  if (ev.laborPoolRequirements && ev.laborPoolRequirements.length) {
    return ev.laborPoolRequirements.map(function(r) {
      var p = getLaborPoolById(r.laborPoolId);
      return (r.quantity || 1) + ' ' + (p ? p.name : r.laborPoolId);
    }).join(', ');
  }
  return ev.staff != null ? String(ev.staff) : '-';
}

function renderEvents(){
  eventsTable.innerHTML="";
  events.forEach(ev=>{
    const row = document.createElement('tr');
    var staffDisplay = formatEventPoolReqs(ev);
    if (ev.laborPoolRequirements && ev.laborPoolRequirements.length && ev.staff != null) staffDisplay = ev.staff + ' total (' + staffDisplay + ')';
    row.innerHTML = `
      <td>${ev.name}</td>
      <td>${ev.date}</td>
      <td>${ev.start}-${ev.end}</td>
      <td>${ev.guests}</td>
      <td>${ev.eventTypeName || ev.service || ev.serviceType || ''}</td>
      <td>${staffDisplay}</td>
      <td><button type="button" class="edit-btn">Edit</button></td>
      <td><button type="button" class="delete">Delete</button></td>
    `;
    
    row.querySelector('.edit-btn').onclick = () => editEvent(ev.id);
    row.querySelector('.delete').onclick = () => deleteEvent(ev.id);
    
    eventsTable.appendChild(row);
  });
  if(events.length === 0){
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="8" style="text-align:center;padding:1.5rem;color:#7f8c8d;">No events yet. Add an event above to get started.</td>';
    eventsTable.appendChild(emptyRow);
  }
  var eventSubmitBtn = document.getElementById('eventSubmitBtn');
  if (eventSubmitBtn) eventSubmitBtn.textContent = editingEventId ? 'Save Changes' : 'Add Event';
}

function editEvent(id){
  const e = events.find(x => x.id === id);
  editingEventId = id;
  document.getElementById('eventSubmitBtn').textContent = 'Save Changes';
  eventName.value = e.name;
  eventDate.value = e.date;
  eventStart.value = e.start || '09:00';
  eventEnd.value = e.end || '17:00';
  eventGuests.value = e.guests;
  var typeId = e.eventTypeId || (getEventTypeByName(e.service) ? getEventTypeByName(e.service).id : '');
  var type = typeId ? getEventTypeById(typeId) : null;
  if (typeId && type && !type.active) {
    var hasOpt = [].slice.call(eventService.options).some(function(o) { return o.value === typeId; });
    if (!hasOpt) {
      var opt = document.createElement('option');
      opt.value = typeId;
      opt.textContent = e.eventTypeName || e.service || type.name || 'Unknown';
      eventService.appendChild(opt);
    }
  }
  eventService.value = typeId || (eventService.options.length ? eventService.options[0].value : '');
  eventStaff.value = e.staff;
  var eventCashBarEl = document.getElementById('eventCashBar');
  if (eventCashBarEl) eventCashBarEl.checked = !!e.cashBarEnabled;
  var container = document.getElementById('eventLaborPoolReqsContainer');
  if (container) {
    container.innerHTML = '';
    var reqs = e.laborPoolRequirements;
    if (reqs && reqs.length) {
      reqs.forEach(function(r) { addEventPoolReqRow(r.laborPoolId, r.quantity); });
    } else if (e.staff) {
      addEventPoolReqRow(getLaborPoolById(DEFAULT_SERVERS_POOL_ID) ? DEFAULT_SERVERS_POOL_ID : (laborPools[0] ? laborPools[0].id : ''), e.staff);
    }
  }
}

function deleteEvent(id){
  if(!confirm("Delete event?")) return;
  const ev = events.find(e=>e.id===id);
  events=events.filter(e=>e.id!==id);
  addAuditEntry('Event Deleted', null, ev.date, `${ev.name}`, null);
  save(); 
  renderEvents();
}

/* HELPER FUNCTIONS */
/** Local date only - no time, no timezone. Use for all storage keys. */
function dateToLocalYYYYMMDD(d) {
  var y = d.getFullYear(), m = d.getMonth() + 1, day = d.getDate();
  return y + '-' + (m < 10 ? '0' : '') + m + '-' + (day < 10 ? '0' : '') + day;
}
/** Primary date string for schedule keys. Replaces toISOString() to avoid timezone shift. */
function iso(d) {
  return dateToLocalYYYYMMDD(d);
}

/** Stable week identifier: Monday of week as YYYY-MM-DD (local). Any day in Feb 9-15 2026 ‚Üí "2026-02-09". */
function getWeekKey(date) {
  var d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  var mondayIndex = getMondayBasedIndex(d);
  d.setDate(d.getDate() - mondayIndex);
  return dateToLocalYYYYMMDD(d);
}

/** Returns array of 7 date strings (YYYY-MM-DD) for the week whose Monday is weekKey. */
function getDateStrsForWeek(weekKey) {
  var parts = weekKey.split('-');
  var y = parseInt(parts[0], 10), m = parseInt(parts[1], 10) - 1, day = parseInt(parts[2], 10);
  var out = [];
  for (var i = 0; i < 7; i++) {
    var d = new Date(y, m, day + i);
    out.push(dateToLocalYYYYMMDD(d));
  }
  return out;
}

function saveWeeklyScheduleSnapshot(weekKey) {
  var days = getDateStrsForWeek(weekKey);
  var snap = {};
  for (var k in manualEdits) {
    var idx = k.indexOf('_');
    if (idx === -1) continue;
    var dateStr = k.substring(idx + 1);
    if (days.indexOf(dateStr) !== -1) snap[k] = manualEdits[k];
  }
  weeklySchedules[weekKey] = snap;
}

function restoreWeeklySchedule(weekKey) {
  var snap = weeklySchedules[weekKey];
  if (!snap || typeof snap !== 'object') return;
  var days = getDateStrsForWeek(weekKey);
  employees.filter(function(e) { return !e.retired; }).forEach(function(e) {
    days.forEach(function(d) { delete manualEdits[e.id + '_' + d]; });
  });
  for (var k in snap) manualEdits[k] = snap[k];
}

/** Single source of truth for weekday indexing. 0=Monday ... 6=Sunday. Use everywhere. */
function getMondayBasedIndex(date) {
  var jsDay = date.getDay();
  return (jsDay + 6) % 7;
}

/** Day names in Monday-based order (index 0 = Monday). Use with getMondayBasedIndex(date). */
var DAY_NAMES_MONDAY_BASED = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

function getWeekStart(){
  var d = new Date();
  d.setDate(d.getDate() + currentWeekOffset * 7);
  var mondayIndex = getMondayBasedIndex(d);
  d.setDate(d.getDate() - mondayIndex);
  d.setHours(0, 0, 0, 0);
  return d;
}

function roundToHalfHour(date) {
  const mins = date.getMinutes();
  if (mins < 15) date.setMinutes(0);
  else if (mins < 45) date.setMinutes(30);
  else { date.setMinutes(0); date.setHours(date.getHours() + 1); }
  date.setSeconds(0, 0);
  return date;
}

function timeStr(d){
  return d.toTimeString().slice(0,5);
}

function getShiftClassByHours(h){
  if(h === 4) return "shift-4";
  if(h === 5) return "shift-5";
  if(h === 6) return "shift-6";
  if(h === 7) return "shift-7";
  if(h === 8) return "shift-8";
  if(h > 8) return "shift-ot";
  return "";
}

function calculateSmartShift(ev, paidHours) {
  const baseStart = new Date(`1970-01-01T${ev.start}`);
  const baseEnd   = new Date(`1970-01-01T${ev.end}`);

  let buffer = 1;
  if (ev.guests >= 200) buffer = 2;

  const scheduledHours = paidHours > 4 ? paidHours + 0.5 : paidHours;

  let startA = new Date(baseStart);
  startA.setHours(startA.getHours() - buffer);
  let endA = new Date(startA);
  endA.setMinutes(endA.getMinutes() + (scheduledHours * 60));

  let endB = new Date(baseEnd);
  endB.setHours(endB.getHours() + buffer);
  let startB = new Date(endB);
  startB.setMinutes(startB.getMinutes() - (scheduledHours * 60));

  startA = roundToHalfHour(new Date(startA));
  endA   = roundToHalfHour(new Date(endA));
  startB = roundToHalfHour(new Date(startB));
  endB   = roundToHalfHour(new Date(endB));

  const distA = Math.abs(startA - baseStart) + Math.abs(endA - baseEnd);
  const distB = Math.abs(startB - baseStart) + Math.abs(endB - baseEnd);

  const result = distA <= distB ? { start: startA, end: endA } : { start: startB, end: endB };
  console.log("SMART SHIFT INPUT:", ev.start, "Hours:", paidHours);
  console.log("SMART SHIFT OUTPUT:", result.start);
  return result;
}

function normalizeHours(start, end){
  const diff=(new Date(`1970-01-01T${end}`)-new Date(`1970-01-01T${start}`))/3600000;
  if(diff<=4) return {h:4};
  if(diff<=5) return {h:5};
  if(diff<=6) return {h:6};
  if(diff<=7) return {h:7};
  if(diff<=8) return {h:8};
  return {h:Math.ceil(diff)};
}

/** Add hours to a Date (same day / no timezone shift). Used for segmenting long shifts. */
function addHoursToDate(d, h) {
  const out = new Date(d.getTime());
  out.setTime(out.getTime() + h * 3600000);
  return out;
}

/** Max regular hours per day before overtime. */
var REGULAR_HOURS_MAX = 8;
var TARGET_WEEKLY_HOURS = 40;

/** Minimum shift length (no micro-shifts). Shorter uncovered time is merged or flagged. */
var MIN_SHIFT_HOURS = 4;

/* CONFLICT DETECTION */
function detectConflicts(empId, date, shiftStart, shiftEnd){
  const conflicts = [];
  
  // Check all shifts for this employee across the week
  const start = getWeekStart();
  const days = [...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
  
  days.forEach(d => {
    const dateStr = iso(d);
    const key = empId + "_" + dateStr;
    
    if(dateStr === date) return; // Skip same day
    
    // Check if employee has a shift on adjacent days
    const edit = manualEdits[key];
    if(edit && edit.start && edit.end) {
      // Check rest time between shifts
      const prevDate = new Date(dateStr);
      const currDate = new Date(date);
      const dayDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);
      
      if(Math.abs(dayDiff) === 1) {
        const prevEnd = new Date(`1970-01-01T${edit.end}`);
        const currStart = new Date(`1970-01-01T${shiftStart}`);
        
        let gap;
        if(dayDiff === 1) {
          // Current is day after
          const prevEndMins = prevEnd.getHours() * 60 + prevEnd.getMinutes();
          const currStartMins = currStart.getHours() * 60 + currStart.getMinutes();
          gap = (1440 - prevEndMins) + currStartMins;
        } else {
          // Current is day before
          const currEndMins = new Date(`1970-01-01T${shiftEnd}`).getHours() * 60 + new Date(`1970-01-01T${shiftEnd}`).getMinutes();
          const prevStartMins = new Date(`1970-01-01T${edit.start}`).getHours() * 60 + new Date(`1970-01-01T${edit.start}`).getMinutes();
          gap = (1440 - currEndMins) + prevStartMins;
        }
        
        if(gap < 480) {
          conflicts.push(`Less than 8 hours rest from ${dateStr} shift`);
        }
      }
    }
  });
  
  return conflicts;
}

/* SCHEDULE FUNCTIONS */
function toggleGlobalLock(){
  scheduleGlobalLock = !scheduleGlobalLock;
  const btn = document.getElementById('globalLockBtn');
  
  if(scheduleGlobalLock) {
    btn.innerHTML = 'üîí Locked Schedule';
    btn.style.background = '#e74c3c';
    var hel = document.getElementById('scheduleLockHelperText');
    if (hel) hel.textContent = 'Locked schedules cannot be edited';
    addAuditEntry('Schedule Locked', null, null, 'Unlocked', 'Locked');
  } else {
    btn.innerHTML = 'üîì Unlock Schedule';
    btn.style.background = '#f39c12';
    var hel = document.getElementById('scheduleLockHelperText');
    if (hel) hel.textContent = 'Edits enabled - changes will affect assignments';
    addAuditEntry('Schedule Unlocked', null, null, 'Locked', 'Unlocked');
  }
  
  save();
}

function toggleRowLock(empId){
  if(lockedRows[empId]) {
    delete lockedRows[empId];
    addAuditEntry('Row Unlocked', empId, null, 'Locked', 'Unlocked');
  } else {
    lockedRows[empId] = true;
    addAuditEntry('Row Locked', empId, null, 'Unlocked', 'Locked');
  }
  
  save();
  displaySchedule();
}

function toggleLock(empId, date){
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  
  if(lockedCells[key]) {
    delete lockedCells[key];
    addAuditEntry('Cell Unlocked', empId, date, 'Locked', 'Unlocked');
  } else {
    lockedCells[key] = true;
    addAuditEntry('Cell Locked', empId, date, 'Unlocked', 'Locked');
  }
  
  save();
  displaySchedule(); // Just refresh display, don't regenerate
}

var OVERRIDE_REASONS = [
  'Manager discretion',
  'Training / development',
  'Employee request',
  'Coverage need',
  'Other'
];

function getEligibleEmployeesForDate(dateStr) {
  return employees.filter(function(e) {
    if (e.retired || e.sick) return false;
    var vk = e.id + '_' + dateStr;
    if (manualEdits[vk] && isFullAbsenceStatus(manualEdits[vk].status)) return false;
    return true;
  });
}

function getEmployeesWithShiftOnDate(dateStr) {
  return employees.filter(function(e) {
    if (e.retired) return false;
    var k = e.id + '_' + dateStr;
    var edit = manualEdits[k];
    return edit && !isFullAbsenceStatus(edit.status) && (edit.hours || edit.start || edit.end);
  });
}

function checkSeniorityViolation(empIdReceiving, dateStr) {
  var receiving = employees.find(function(e) { return e.id === empIdReceiving; });
  if (!receiving || receiving.retired) return { violated: false };
  var eligible = getEligibleEmployeesForDate(dateStr);
  var hasShift = {};
  eligible.forEach(function(e) {
    var k = e.id + '_' + dateStr;
    var ed = manualEdits[k];
    hasShift[e.id] = !!(ed && !isFullAbsenceStatus(ed.status) && (ed.hours || ed.start || ed.end));
  });
  var higherRankNoShift = eligible.filter(function(e) {
    return e.id !== empIdReceiving && !hasShift[e.id] && (e.seniority != null) && (receiving.seniority != null) && e.seniority < receiving.seniority;
  });
  if (higherRankNoShift.length === 0) return { violated: false };
  return { violated: true, names: higherRankNoShift.map(function(e) { return e.name; }) };
}

function checkCashierSeniorityOverride(empId, dateStr) {
  var cashierPoolId = getCashierPoolId();
  if (!cashierPoolId) return { shouldWarn: false };
  var emp = employees.find(function(e) { return e.id === empId; });
  if (!emp || emp.retired || emp.laborPoolId !== cashierPoolId) return { shouldWarn: false };
  var cashiers = employees.filter(function(e) { return !e.retired && e.laborPoolId === cashierPoolId; });
  var empSeniority = getSeniorityForEmployee(emp);
  empSeniority = empSeniority != null ? empSeniority : 999;
  for (var i = 0; i < cashiers.length; i++) {
    if (cashiers[i].id === empId) continue;
    var k = cashiers[i].id + '_' + dateStr;
    var ed = manualEdits[k];
    if (ed && isFullAbsenceStatus(ed.status)) continue;
    if (ed && !isFullAbsenceStatus(ed.status) && (ed.hours || ed.start || ed.end)) continue;
    var otherSeniority = getSeniorityForEmployee(cashiers[i]);
    otherSeniority = otherSeniority != null ? otherSeniority : 999;
    if (otherSeniority < empSeniority) return { shouldWarn: true };
  }
  return { shouldWarn: false };
}

function promptOverrideReason() {
  var msg = 'Reason for override (required):\n\n';
  OVERRIDE_REASONS.forEach(function(r, i) { msg += (i + 1) + ' = ' + r + '\n'; });
  msg += '\nEnter number or type your reason:';
  var raw = prompt(msg);
  if (raw === null || (raw && raw.trim()) === '') return null;
  var n = parseInt(raw.trim(), 10);
  if (!isNaN(n) && n >= 1 && n <= OVERRIDE_REASONS.length) return OVERRIDE_REASONS[n - 1];
  return raw.trim();
}

function applyOverrideToEdit(edit, reason) {
  if (!edit) return;
  edit.seniorityOverride = true;
  edit.overrideReason = reason;
  edit.overrideTimestamp = new Date().toISOString();
}

function editScheduleCell(empId, date){
  // Check global lock first
  if(scheduleGlobalLock) {
    alert('Schedule is locked. Unlock it using the lock button above to make changes.');
    return;
  }
  
  // Check row lock
  if(lockedRows[empId]) {
    alert('This employee\'s row is locked. Click the lock icon next to their name to unlock and edit.');
    return;
  }
  
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  const ev = events.find(e => e.date === date);
  
  let currentEdit = manualEdits[key];
  var hasShift = currentEdit && !isFullAbsenceStatus(currentEdit.status) && (currentEdit.hours || currentEdit.start || currentEdit.end);
  
  // Create a clearer menu dialog
  let dialog = "Edit shift for " + emp.name + " on " + date + ":\n\n";
  dialog += "Enter start and end time (hours are calculated for you):\n";
  dialog += "--------------------\n";
  dialog += "SHIFT (start end):\n";
  dialog += "  09:00 15:30\n\n";
  dialog += "STATUS:\n";
  dialog += "  sick\n";
  dialog += "  vacation\n";
  dialog += "  floating_holiday  (or floating)\n";
  dialog += "  unpaid_vacation   (or unpaid)\n";
  dialog += "  off               (requested off)\n\n";
  dialog += "ACTIONS:\n";
  if (hasShift) {
    dialog += "  swap    (swap this shift with another employee)\n";
    dialog += "  reassign (give this shift to another employee)\n";
  }
  dialog += "  lock\n";
  dialog += "  clear\n";
  dialog += "--------------------\n\n";
  
  if(lockedCells[key]) {
    dialog += "üîí LOCKED\n\n";
  }
  
  if(currentEdit) {
    var curAbsence = currentEdit.status ? ABSENCE_TYPES.find(function(a) { return a.id === currentEdit.status; }) : null;
    if (curAbsence) {
      dialog += "Current: " + curAbsence.cellLabel + "\n";
    } else if(currentEdit.start && currentEdit.end) {
      dialog += "Current: " + currentEdit.hours + "h (" + currentEdit.start + "-" + currentEdit.end + ")\n";
    } else {
      dialog += "Current: " + (currentEdit.hours || currentEdit) + "h (no times)\n";
    }
  } else if(ev) {
    dialog += "Event: " + ev.name + "\n";
  } else {
    dialog += "Current: (empty)\n";
  }
  
  const input = prompt(dialog);
  
  if(input === null) return;
  
  const trimmed = input.trim().toLowerCase();
  
  // Lock/unlock
  if(trimmed === 'lock') {
    toggleLock(empId, date);
    return;
  }
  
  // Remove shift
  if(trimmed === 'remove' || trimmed === 'clear' || trimmed === '') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
    delete manualEdits[key];
    addAuditEntry('Shift Removed', empId, date, oldValue, null);
    save(); 
    displaySchedule();
    return;
  }
  
  // Mark as sick
  if(trimmed === 'sick') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'sick', manualOverride: true, absenceReason: 'Marked Sick manually' };
    delete assignmentReasonTags[key];
    delete assignmentReasons[key];
    delete assignmentReasonCodes[key];
    addAuditEntry('Absence Added', empId, date, oldValue, 'Sick');
    save();
    displaySchedule();
    return;
  }
  
  // Mark as vacation
  if(trimmed === 'vacation' || trimmed === 'vac') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'vacation', manualOverride: true, absenceReason: 'Vacation added by manager' };
    delete assignmentReasonTags[key];
    delete assignmentReasons[key];
    delete assignmentReasonCodes[key];
    addAuditEntry('Absence Added', empId, date, oldValue, 'Vacation');
    save();
    displaySchedule();
    return;
  }
  // Mark as floating holiday
  if(trimmed === 'floating_holiday' || trimmed === 'floating' || trimmed === 'floating holiday') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'floating_holiday', manualOverride: true, absenceReason: 'Floating holiday added by manager' };
    delete assignmentReasonTags[key];
    delete assignmentReasons[key];
    delete assignmentReasonCodes[key];
    addAuditEntry('Absence Added', empId, date, oldValue, 'Floating Holiday');
    save();
    displaySchedule();
    return;
  }
  // Mark as unpaid vacation
  if(trimmed === 'unpaid_vacation' || trimmed === 'unpaid' || trimmed === 'unpaid vacation') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'unpaid_vacation', manualOverride: true, absenceReason: 'Unpaid vacation added by manager' };
    delete assignmentReasonTags[key];
    delete assignmentReasons[key];
    delete assignmentReasonCodes[key];
    addAuditEntry('Absence Added', empId, date, oldValue, 'Unpaid Vacation');
    save();
    displaySchedule();
    return;
  }
  // Mark as requested off (off)
  if(trimmed === 'off' || trimmed === 'requested_off' || trimmed === 'request off') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'requested_off', manualOverride: true, absenceReason: 'Request off', requestedOff: true };
    delete assignmentReasonTags[key];
    delete assignmentReasons[key];
    delete assignmentReasonCodes[key];
    addAuditEntry('Absence Added', empId, date, oldValue, 'Request Off');
    save();
    displaySchedule();
    return;
  }
  
  if (hasShift && (trimmed === 'swap' || trimmed === 'reassign')) {
    if (trimmed === 'swap') {
      var withShift = getEmployeesWithShiftOnDate(date).filter(function(e) {
        if (e.id === empId) return false;
        var k = e.id + '_' + date;
        return !lockedCells[k] && !lockedRows[e.id];
      });
      if (withShift.length === 0) {
        alert('No other employee has an unlocked shift on this date to swap with. Unlock another cell or choose a different date.');
        return;
      }
      var list = withShift.map(function(e) { return e.name; }).join(', ');
      var otherName = prompt('Swap this shift with which employee?\n\n' + list);
      if (otherName === null) return;
      var other = employees.find(function(e) { return e.id !== empId && e.name.toLowerCase() === (otherName || '').trim().toLowerCase(); });
      if (!other) other = withShift.find(function(e) { return e.name.toLowerCase().indexOf((otherName || '').trim().toLowerCase()) >= 0; });
      if (!other) {
        alert('Name not found. Use a name from the list: ' + list);
        return;
      }
      var keyB = other.id + '_' + date;
      if (lockedCells[key] || lockedCells[keyB] || lockedRows[other.id]) {
        alert('This swap isn\'t possible because one of the shifts or rows is locked. Unlock to swap.');
        return;
      }
      var editB = manualEdits[keyB];
      var fullAbsence = editB && isFullAbsenceStatus(editB.status);
      if (!editB || fullAbsence) {
        alert(other.name + ' doesn\'t have a shift on this date. Choose someone with a shift to swap.');
        return;
      }
      var violA = checkSeniorityViolation(empId, date);
      var violB = checkSeniorityViolation(other.id, date);
      var violated = violA.violated || violB.violated;
      var overrideReason = null;
      if (violated) {
        var warnMsg = 'A higher-seniority employee (without a shift this day) could have had one of these shifts.\n\n';
        if (violA.violated) warnMsg += 'After swap, ' + emp.name + ' gets a shift; higher seniority available: ' + (violA.names || []).join(', ') + '.\n';
        if (violB.violated) warnMsg += 'After swap, ' + other.name + ' gets a shift; higher seniority available: ' + (violB.names || []).join(', ') + '.\n';
        warnMsg += '\nYou can override and continue (your reason will be logged in the Audit log), or cancel to keep seniority order.';
        if (!confirm(warnMsg)) return;
        overrideReason = promptOverrideReason();
        if (!overrideReason) {
          alert('No reason given. Please choose a reason to log the override, or cancel.');
          return;
        }
      }
      var copyA = JSON.parse(JSON.stringify(currentEdit));
      var copyB = JSON.parse(JSON.stringify(editB));
      manualEdits[key] = copyB;
      manualEdits[keyB] = copyA;
      if (violated && overrideReason) {
        applyOverrideToEdit(manualEdits[key], overrideReason);
        applyOverrideToEdit(manualEdits[keyB], overrideReason);
      }
      delete assignmentReasonTags[key]; delete assignmentReasons[key]; delete assignmentReasonCodes[key];
      delete assignmentReasonTags[keyB]; delete assignmentReasons[keyB]; delete assignmentReasonCodes[keyB];
      var logNew = 'Swap: ' + emp.name + ' \u2194 ' + other.name + '. Seniority violated: ' + (violated ? 'Yes' : 'No') + '. Override: ' + (overrideReason ? 'Yes (' + overrideReason + ')' : 'No') + '. ' + new Date().toISOString();
      addAuditEntry('Shift Swapped', empId, date, emp.name + ' / ' + other.name, logNew);
      save();
      displaySchedule();
      return;
    }
    if (trimmed === 'reassign') {
      var eligible = getEligibleEmployeesForDate(date).filter(function(e) { return e.id !== empId; });
      if (eligible.length === 0) {
        alert('No other eligible employee to reassign this shift to. Add staff or unlock another employee.');
        return;
      }
      var list = eligible.map(function(e) { return e.name; }).join(', ');
      var toName = prompt('Reassign this shift to which employee?\n\n' + list);
      if (toName === null) return;
      var toEmp = employees.find(function(e) { return e.id !== empId && e.name.toLowerCase() === (toName || '').trim().toLowerCase(); });
      if (!toEmp) toEmp = eligible.find(function(e) { return e.name.toLowerCase().indexOf((toName || '').trim().toLowerCase()) >= 0; });
      if (!toEmp) {
        alert('Name not found. Use a name from the list: ' + list);
        return;
      }
      var keyTo = toEmp.id + '_' + date;
      if (lockedCells[key] || lockedCells[keyTo] || lockedRows[toEmp.id]) {
        alert('This shift or the target cell is locked. Unlock to reassign.');
        return;
      }
      var toEd = manualEdits[keyTo];
      if (toEd && !isFullAbsenceStatus(toEd.status) && (toEd.hours || toEd.start)) {
        alert(toEmp.name + ' already has a shift on this date. Use Swap to exchange shifts.');
        return;
      }
      var viol = checkSeniorityViolation(toEmp.id, date);
      var overrideReason = null;
      if (viol.violated) {
        var warnMsg = 'A higher-seniority employee (without a shift this day) could have had this shift: ' + (viol.names || []).join(', ') + '.\n\nYou can override and reassign (your reason will be logged in the Audit log), or cancel.';
        if (!confirm(warnMsg)) return;
        overrideReason = promptOverrideReason();
        if (!overrideReason) {
          alert('No reason given. Please choose a reason to log the override, or cancel.');
          return;
        }
      }
      var cashierOverride = checkCashierSeniorityOverride(toEmp.id, date);
      if (cashierOverride.shouldWarn && !confirm('This assignment gives the shift to a lower-seniority cashier. You can continue (override will be logged) or cancel.')) return;
      var shiftCopy = JSON.parse(JSON.stringify(currentEdit));
      shiftCopy.manualOverride = true;
      if (overrideReason) applyOverrideToEdit(shiftCopy, overrideReason);
      if (cashierOverride.shouldWarn) {
        shiftCopy.cashierSeniorityOverride = true;
        addAuditEntry('Cashier Assignment', toEmp.id, date, null, 'Seniority override approved');
      }
      delete manualEdits[key];
      manualEdits[keyTo] = shiftCopy;
      delete assignmentReasonTags[key]; delete assignmentReasons[key]; delete assignmentReasonCodes[key];
      delete assignmentReasonTags[keyTo]; delete assignmentReasons[keyTo]; delete assignmentReasonCodes[keyTo];
      var logNew = 'Reassign: from ' + emp.name + ' to ' + toEmp.name + '. Seniority violated: ' + (viol.violated ? 'Yes' : 'No') + '. Override: ' + (overrideReason ? 'Yes (' + overrideReason + ')' : 'No') + '. ' + new Date().toISOString();
      addAuditEntry('Shift Reassigned', empId, date, emp.name, logNew);
      save();
      displaySchedule();
      return;
    }
  }
  
  // Parse shift input: start and end time; hours calculated automatically
  let newEdit = null;
  const timeRegex = /^\d{1,2}:\d{2}$/;
  const parts = input.trim().split(/\s+/);
  
  var startStr = null, endStr = null;
  if(parts.length === 2 && timeRegex.test(parts[0]) && timeRegex.test(parts[1])) {
    startStr = parts[0];
    endStr = parts[1];
  } else if(parts.length === 3 && timeRegex.test(parts[1]) && timeRegex.test(parts[2])) {
    startStr = parts[1];
    endStr = parts[2];
  }
  
  if(startStr && endStr) {
    var startM = parseInt(startStr.split(':')[0], 10) * 60 + parseInt(startStr.split(':')[1], 10);
    var endM = parseInt(endStr.split(':')[0], 10) * 60 + parseInt(endStr.split(':')[1], 10);
    if(endM <= startM) {
      alert('End time must be after start time. Enter a later end time to continue.');
      return;
    }
    var calculatedHours = Math.round((endM - startM) / 60 * 10) / 10; // e.g. 6.5
    newEdit = {
      hours: calculatedHours,
      start: startStr,
      end: endStr,
      manualOverride: true
    };
  }
  
  if(!newEdit) {
    alert('Format needs review. Enter start and end time like: 09:00 15:30\n\nOr use: sick, vacation, lock, or clear');
    return;
  }
  
  var cashierOverride = getCashierPoolId() && emp.laborPoolId === getCashierPoolId() ? checkCashierSeniorityOverride(empId, date) : { shouldWarn: false };
  if (cashierOverride.shouldWarn && !confirm('This assignment gives the shift to a lower-seniority cashier. You can continue (override will be logged) or cancel.')) return;
  
  const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
  if (cashierOverride.shouldWarn) {
    newEdit.cashierSeniorityOverride = true;
    addAuditEntry('Cashier Assignment', empId, date, null, 'Seniority override approved');
  }
  manualEdits[key] = newEdit;
  delete assignmentReasonTags[key];
  delete assignmentReasons[key];
  delete assignmentReasonCodes[key];
  addAuditEntry('Shift Manually Edited', empId, date, oldValue, JSON.stringify(newEdit));
  
  alert('Shift saved. Total: ' + newEdit.hours + ' hours (' + newEdit.start + '-' + newEdit.end + ').');
  save(); 
  displaySchedule();
}

function generateSchedule(){
  const start = getWeekStart();
  const weekKey = getWeekKey(start);
  if (typeof console !== 'undefined' && console.log) {
    console.log('[Week] Generate: computed weekKey =', weekKey);
  }
  if (scheduleGeneratedWeeks[weekKey]) {
    if (typeof console !== 'undefined' && console.log) {
      console.log('[Week] Week already exists, loading. queried weekKey =', weekKey);
    }
    displaySchedule();
    return;
  }
  if (!confirm("Generate schedule from events? This will create shifts for all employees based on events and settings.")) return;
  
  const days=[...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
  
  let shiftsCreated = 0;
  let skippedDueToLimit = 0;
  let understaffedEvents = []; // Track events that couldn't be fully staffed
  
  // First, count existing work days for each employee (manual edits)
  const employeeWorkDays = {};
  employees.filter(e => !e.retired).forEach(e => {
    employeeWorkDays[e.id] = 0;
    
    // Count days that already have manual edits
    days.forEach(d => {
      const dateStr = iso(d);
      const key = e.id + "_" + dateStr;
      if(manualEdits[key] && !isFullAbsenceStatus(manualEdits[key].status) && (manualEdits[key].hours || manualEdits[key].start)) {
        employeeWorkDays[e.id]++;
      }
    });
  });
  
  const result = assignEmployeesToWeek(days);
  const assignments = result.assignments;
  const assignmentDetails = result.assignmentDetails || {};
  lastOvertimeSuggestions = result.otFlaggedAssignments || [];
  lastOvertimeLikelyByDay = result.overtimeLikelyByDay || {};
  lastScheduleNeedsReview = lastOvertimeSuggestions.length > 0 || understaffedEvents.length > 0;
  
  // Convert assignments to manual edits (but don't overwrite locked/existing manual edits)
  days.forEach(d => {
    const dateStr = iso(d);
    const ev = events.find(e => e.date === dateStr);
    
    if(!ev) {
      console.log(`No event on ${dateStr}`);
      return;
    }
    
    const assignedCount = assignments[dateStr] ? assignments[dateStr].length : 0;
    const requiredStaff = ev.staff;
    
    // Check if event is understaffed
    if(assignedCount < requiredStaff) {
      understaffedEvents.push({
        name: ev.name,
        date: dateStr,
        assigned: assignedCount,
        required: requiredStaff,
        shortage: requiredStaff - assignedCount
      });
      console.log(`‚ö† ${ev.name} on ${dateStr}: only ${assignedCount}/${requiredStaff} staff assigned`);
    }
    
    if(!assignments[dateStr]) {
      console.log(`No assignments for ${dateStr} (event: ${ev.name})`);
      return;
    }
    
    console.log(`Event: ${ev.name} on ${dateStr}, assigned: ${assignedCount}/${requiredStaff} employees`);
    
    const s = normalizeHours(ev.start, ev.end);
    const t = calculateSmartShift(ev, s.h);
    const detailsForDay = assignmentDetails[dateStr] || {};
    
    assignments[dateStr].forEach(empId => {
      const key = empId + "_" + dateStr;
      
      // Skip if locked (cell or row) or already manually edited
      if(lockedCells[key] || lockedRows[empId]) {
        console.log(`Skipping ${key} - locked`);
        return;
      }
      if(manualEdits[key]) {
        console.log(`Skipping ${key} - already has manual edit`);
        return;
      }
      
      // Check individual employee's max days limit (including already scheduled days)
      const employee = employees.find(e => e.id === empId);
      const empMaxDays = employee.maxDaysPerWeek !== undefined ? employee.maxDaysPerWeek : 5;
      
      if(employeeWorkDays[empId] >= empMaxDays) {
        console.log(`Skipping ${employee.name} on ${dateStr} - already worked ${empMaxDays} days this week (personal limit)`);
        skippedDueToLimit++;
        return;
      }
      
      // Use split/partial shift details when present (OT-avoidance), else full event shift
      const detail = detailsForDay[empId];
      const hours = detail && detail.hours != null ? detail.hours : s.h;
      const startDate = detail && detail.start ? detail.start : t.start;
      const endDate = detail && detail.end ? detail.end : t.end;
      
      manualEdits[key] = {
        hours: hours,
        start: timeStr(startDate),
        end: timeStr(endDate),
        generated: true
      };
      
      employeeWorkDays[empId]++;
      shiftsCreated++;
      console.log(`Created shift for ${key}: ${hours}h (work days: ${employeeWorkDays[empId]})`);
    });
  });
  
  console.log(`Total shifts created: ${shiftsCreated}`);
  console.log(`Shifts skipped due to 5-day limit: ${skippedDueToLimit}`);
  console.log(`Understaffed events: ${understaffedEvents.length}`);
  
  generationConflicts = understaffedEvents.map(evt => ({
    event: evt.name,
    date: new Date(evt.date).toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'}),
    required: evt.required,
    assigned: evt.assigned,
    shortage: evt.shortage,
    reason: 'Insufficient eligible employees after applying all constraints'
  }));
  
  // NEW: Show/hide conflict report button
  const conflictBtn = document.getElementById('conflictReportBtn');
  if(generationConflicts.length > 0) {
    conflictBtn.style.display = 'inline-block';
    conflictBtn.textContent = `‚ö† Conflicts (${generationConflicts.length})`;
  } else {
    conflictBtn.style.display = 'none';
  }
  
  // Build alert message
  let message = '';
  if(shiftsCreated === 0) {
    message = `No shifts were created. Make sure you have:\n1. Events in the current week\n2. Available employees (not retired/sick/vacation)\n3. Unlocked cells\n4. Employees haven't reached max days limit`;
  } else {
    message = `√¢≈ì‚Ä¶ Created ${shiftsCreated} shifts!`;
    
    if(skippedDueToLimit > 0) {
      message += `\n\n‚ö† ${skippedDueToLimit} potential shifts skipped (max days limit)`;
    }
    
    if(understaffedEvents.length > 0) {
      message += `\n\nüö® UNDERSTAFFED EVENTS:\n`;
      understaffedEvents.forEach(evt => {
        const dateObj = new Date(evt.date);
        const dateDisplay = dateObj.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'});
        message += `\n‚Ä¢ ${evt.name} (${dateDisplay})\n  Needs ${evt.shortage} more staff (${evt.assigned}/${evt.required})`;
      });
      message += `\n\nClick "‚ö† Conflicts" button for detailed conflict report.\n\nYou may need to:\n- Manually assign more employees\n- Hire additional staff\n- Reduce event requirements`;
    }
    if (lastOvertimeSuggestions && lastOvertimeSuggestions.length > 0) {
      message += `\n\n√¢¬è¬± Overtime suggested - review required: ${lastOvertimeSuggestions.length} assignment(s) exceed 8h for the day. Please review and approve OT as needed.`;
    }
    message += `\n\n√∞≈∏'¬° TIP: Click any generated shift to see WHY that employee was assigned.\nHover (desktop) or tap (mobile) on shifts with √¢‚Äû¬π√Ø¬∏¬è icon.`;
  }
  alert(message);
  
  scheduleGeneratedWeeks[weekKey] = true;
  saveWeeklyScheduleSnapshot(weekKey);
  addAuditEntry('Schedule Generated', null, null, null, `Generated ${shiftsCreated} shifts, ${understaffedEvents.length} understaffed events`);
  save();
  if (typeof console !== 'undefined' && console.log) {
    console.log('[Week] Save: saved weekKey =', weekKey);
  }
  lastApplyRecommendationsSnapshot = null;
  displaySchedule();
}

function openApplyRecommendationsModal() {
  var overlay = document.getElementById('applyRecommendationsModalOverlay');
  if (overlay) {
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    setTimeout(function(){ var el = document.getElementById('applyRecommendationsConfirmBtn'); if(el) el.focus(); }, 50);
    function onRecKey(e) {
      if (e.key === 'Escape') { closeApplyRecommendationsModal(); remove(); }
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); confirmApplyRecommendations(); }
    }
    function remove() {
      document.removeEventListener('keydown', onRecKey);
    }
    document.addEventListener('keydown', onRecKey);
    overlay._modalCleanup = remove;
  }
}
function closeApplyRecommendationsModal() {
  var overlay = document.getElementById('applyRecommendationsModalOverlay');
  if (overlay) {
    if (overlay._modalCleanup) overlay._modalCleanup();
    overlay.style.display = 'none';
  }
}
function confirmApplyRecommendations() {
  var roleSel = document.getElementById('applyRecommendationsRole');
  var role = (roleSel && roleSel.value === 'housemen') ? 'housemen' : 'cashiers';
  closeApplyRecommendationsModal();
  applyRecommendations(role);
}
function applyRecommendations(role) {
  if (scheduleGlobalLock) {
    alert('Schedule is locked. Unlock it using the lock button above, then apply recommendations.');
    return;
  }
  var start = getWeekStart();
  var days = [];
  for (var i = 0; i < 7; i++) {
    var d = new Date(start);
    d.setDate(start.getDate() + i);
    days.push(d);
  }
  var poolId = role === 'housemen' ? getHousemenPoolId() : getCashierPoolId();
  if (!poolId) {
    alert('No ' + role + ' labor pool found.');
    return;
  }
  var keysToTouch = {};
  var assignmentsToMake = [];
  days.forEach(function(d) {
    var dateStr = iso(d);
    var recommended = role === 'housemen' ? getRecommendedHousemenForDate(dateStr) : getRecommendedCashiersForDate(dateStr);
    var dayEvents = events.filter(function(e) { return e.date === dateStr; });
    dayEvents.sort(function(a, b) { return (a.start || '').localeCompare(b.start || ''); });
    var ev = dayEvents[0];
    if (!ev) return;
    var s = normalizeHours(ev.start || '09:00', ev.end || '17:00');
    var t = calculateSmartShift(ev, s.h);
    var startStr = timeStr(t.start);
    var endStr = timeStr(t.end);
    recommended.forEach(function(emp) {
      var key = emp.id + '_' + dateStr;
      if (lockedCells[key] || lockedRows[emp.id]) return;
      var ed = manualEdits[key];
      if (ed && isFullAbsenceStatus(ed.status)) return;
      keysToTouch[key] = true;
      assignmentsToMake.push({ empId: emp.id, dateStr: dateStr, key: key, hours: s.h, start: startStr, end: endStr, emp: emp });
    });
  });
  if (assignmentsToMake.length === 0) {
    alert('No recommended ' + role + ' to assign for this week (or all are already assigned / locked).');
    return;
  }
  var roleLabel = role === 'housemen' ? 'Housemen' : 'Cashiers';
  var existingViolations = [];
  days.forEach(function(d) {
    var dateStr = iso(d);
    var recommendedForDay = role === 'housemen' ? getRecommendedHousemenForDate(dateStr) : getRecommendedCashiersForDate(dateStr);
    var minRecSeniority = 999;
    recommendedForDay.forEach(function(r) {
      var sr = getSeniorityForEmployee(r);
      if (sr != null && sr < minRecSeniority) minRecSeniority = sr;
    });
    employees.forEach(function(emp) {
      if (emp.retired || emp.laborPoolId !== poolId) return;
      var key = emp.id + '_' + dateStr;
      var ed = manualEdits[key];
      if (!ed || isFullAbsenceStatus(ed.status) || (!ed.hours && !ed.start)) return;
      var empSr = getSeniorityForEmployee(emp);
      empSr = empSr != null ? empSr : 999;
      var inRecommended = recommendedForDay.some(function(r) { return r.id === emp.id; });
      if (!inRecommended && empSr > minRecSeniority) existingViolations.push({ dateStr: dateStr, name: emp.name });
    });
  });
  var override = false;
  if (existingViolations.length > 0 && !confirm('Some assigned staff have lower seniority than staff we\'re about to assign. You can override and continue (reason will be logged), or cancel.')) return;
  if (existingViolations.length > 0) override = true;
  lastApplyRecommendationsSnapshot = JSON.parse(JSON.stringify(manualEdits));
  assignmentsToMake.forEach(function(a) {
    manualEdits[a.key] = { hours: a.hours, start: a.start, end: a.end, manualOverride: true, applyRecommendations: true };
    addAuditEntry('Apply Recommendations', a.empId, a.dateStr, null, roleLabel + ' assigned (recommendation)');
  });
  if (override) addAuditEntry('Apply Recommendations Override', null, null, null, 'Seniority order overridden for ' + roleLabel);
  save();
  var undoWrap = document.getElementById('applyRecommendationsUndoWrap');
  if (undoWrap) undoWrap.style.display = 'inline';
  displaySchedule();
}
function undoApplyRecommendations() {
  if (!lastApplyRecommendationsSnapshot) return;
  manualEdits = JSON.parse(JSON.stringify(lastApplyRecommendationsSnapshot));
  lastApplyRecommendationsSnapshot = null;
  addAuditEntry('Apply Recommendations Undone', null, null, null, 'Reverted to state before Apply Recommendations');
  save();
  var undoWrap = document.getElementById('applyRecommendationsUndoWrap');
  if (undoWrap) undoWrap.style.display = 'none';
  displaySchedule();
}

function getLaborCostForWeek() {
  var start = getWeekStart();
  var days = [];
  for (var i = 0; i < 7; i++) {
    var d = new Date(start);
    d.setDate(start.getDate() + i);
    days.push(d);
  }
  var employeeHours = {};
  var employeeWage = {};
  employees.filter(function(e) { return !e.retired; }).forEach(function(emp) {
    var pool = getLaborPoolById(emp.laborPoolId);
    var wage = (pool && pool.defaultHourlyWage != null) ? parseFloat(pool.defaultHourlyWage, 10) : 0;
    if (isNaN(wage) || wage < 0) wage = 0;
    employeeWage[emp.id] = wage;
    var totalH = 0;
    days.forEach(function(d) {
      var dateStr = iso(d);
      var key = emp.id + '_' + dateStr;
      var edit = manualEdits[key];
      if (edit && !isFullAbsenceStatus(edit.status) && (edit.hours || edit.start || edit.end)) {
        var h = edit.hours || (typeof edit === 'number' ? edit : 0);
        if (typeof h !== 'number') h = parseFloat(h, 10) || 0;
        totalH += h;
      }
    });
    employeeHours[emp.id] = totalH;
  });
  var byPool = {};
  getPoolsInPrintOrder().forEach(function(pool) {
    byPool[pool.id] = { poolName: pool.name || pool.id, amount: 0 };
  });
  employees.filter(function(e) { return !e.retired; }).forEach(function(emp) {
    var poolId = emp.laborPoolId;
    if (!poolId) return;
    if (!byPool[poolId]) byPool[poolId] = { poolName: (getLaborPoolById(poolId) && getLaborPoolById(poolId).name) || poolId, amount: 0 };
    byPool[poolId].amount += (employeeWage[emp.id] || 0) * (employeeHours[emp.id] || 0);
  });
  var total = 0;
  var list = [];
  getPoolsInPrintOrder().forEach(function(pool) {
    if (byPool[pool.id]) {
      list.push({ poolId: pool.id, poolName: pool.name || pool.id, amount: byPool[pool.id].amount });
      total += byPool[pool.id].amount;
    }
  });
  return { byPool: list, total: total };
}

function updateLaborCostPanel() {
  var panel = document.getElementById('laborCostPanel');
  var showWrap = document.getElementById('laborCostShowWrap');
  if (!panel || !showWrap) return;
  var visible = sessionStorage.getItem('laborCostPanelVisible') !== 'false';
  panel.style.display = visible ? 'block' : 'none';
  showWrap.style.display = visible ? 'none' : 'block';
  if (!visible) return;
  var data = getLaborCostForWeek();
  var byPoolEl = document.getElementById('laborCostByPool');
  var totalEl = document.getElementById('laborCostTotal');
  if (byPoolEl) {
    byPoolEl.innerHTML = '';
    data.byPool.forEach(function(item) {
      var p = document.createElement('p');
      p.style.margin = '2px 0';
      p.textContent = (item.poolName || '') + ': ' + formatCurrency(item.amount);
      byPoolEl.appendChild(p);
    });
  }
  if (totalEl) totalEl.textContent = 'Total: ' + formatCurrency(data.total);
  var btn = document.getElementById('laborCostToggleBtn');
  if (btn) btn.textContent = 'Hide';
}

function formatCurrency(n) {
  if (n === 0) return '$0.00';
  return '$' + (Math.round(n * 100) / 100).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function toggleLaborCostPanel() {
  var panel = document.getElementById('laborCostPanel');
  var showWrap = document.getElementById('laborCostShowWrap');
  if (!panel || !showWrap) return;
  var visible = panel.style.display !== 'none';
  sessionStorage.setItem('laborCostPanelVisible', visible ? 'false' : 'true');
  panel.style.display = visible ? 'none' : 'block';
  showWrap.style.display = visible ? 'block' : 'none';
  var btn = document.getElementById('laborCostToggleBtn');
  if (btn) btn.textContent = visible ? 'Show' : 'Hide';
}

/* SCHEDULE DISPLAY */
function displaySchedule(){
  var start = getWeekStart();
  var weekKey = getWeekKey(start);
  if (typeof console !== 'undefined' && console.log) {
    console.log('[Week] On load: queried weekKey =', weekKey);
  }
  if (weeklySchedules[weekKey]) restoreWeeklySchedule(weekKey);
  try {
    var noticeEl = document.getElementById('scheduleManagerNotice');
    var otBanner = document.getElementById('scheduleOvertimeBanner');
    var otBannerText = document.getElementById('scheduleOvertimeBannerText');
    var settingsWarning = document.getElementById('scheduleSettingsWarning');
    if (noticeEl) noticeEl.style.display = 'block';
    if (otBanner && otBannerText) {
      if (lastOvertimeSuggestions && lastOvertimeSuggestions.length > 0) {
        otBanner.style.display = 'block';
        var lines = lastOvertimeSuggestions.map(function(s) {
          var d = new Date(s.dateStr + 'T12:00:00');
          var dayName = DAY_NAMES_MONDAY_BASED[getMondayBasedIndex(d)];
          return (s.eventName || 'Event') + ' on ' + dayName + (s.empName ? ': ' + s.empName : '');
        });
        otBannerText.textContent = lines.join('; ');
      } else {
        otBanner.style.display = 'none';
      }
    }
    if (settingsWarning) settingsWarning.style.display = (lastScheduleNeedsReview ? 'block' : 'none');

    // This function just DISPLAYS the current schedule (manual edits + locked cells)
    scheduleTable.innerHTML="";
    
    const days=[...Array(7)].map((_,i)=>{
      const d=new Date(start);
      d.setDate(start.getDate()+i);
    return d;
  });

  weekHeader.textContent = `${days[0].toLocaleDateString()} - ${days[6].toLocaleDateString()}`;

  // ========== DESKTOP TABLE VIEW ==========
  // Blue column header row: built once, inserted inside first pool section (header ‚Üí toolbar ‚Üí content)
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>üîí</th><th>Employee</th>';
  days.forEach(d=>{
    const th = document.createElement('th');
    th.textContent = d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"});
    headerRow.appendChild(th);
  });
  headerRow.innerHTML += '<th>Total<br><small class="schedule-th-helper">Total scheduled hours</small></th><th>Days<br><small class="schedule-th-helper">Days worked this week</small></th>';

  var selectedPoolId = getScheduleTabSelectedPoolId();

  if (!selectedPoolId) {
  var recRow = document.createElement('tr');
  recRow.className = 'schedule-cashier-rec-row';
  var empty1 = document.createElement('td');
  var empty2 = document.createElement('td');
  empty1.style.border = 'none';
  empty1.style.background = 'transparent';
  empty2.style.border = 'none';
  empty2.style.background = 'transparent';
  recRow.appendChild(empty1);
  recRow.appendChild(empty2);
  days.forEach(function(d) {
    var dateStr = iso(d);
    var rec = getCashierRecommendationForDate(dateStr);
    var td = document.createElement('td');
    td.style.fontSize = '12px';
    td.style.color = 'var(--brand-text-muted, #7f8c8d)';
    td.style.verticalAlign = 'top';
    if (rec.count > 0) {
      var summary = rec.count + ' cashier' + (rec.count !== 1 ? 's' : '') + ' needed';
      var span = document.createElement('span');
      span.textContent = summary;
      td.appendChild(span);
      if (rec.names.length > 0) {
        var detailsLink = document.createElement('a');
        detailsLink.href = '#';
        detailsLink.className = 'schedule-why-link';
        detailsLink.textContent = ' Details';
        detailsLink.title = 'Show recommended names';
        detailsLink.onclick = function(e) { e.preventDefault(); e.stopPropagation(); alert('Recommended: ' + rec.names.join(', ')); };
        td.appendChild(detailsLink);
      }
    }
    recRow.appendChild(td);
  });
  var empty3 = document.createElement('td');
  var empty4 = document.createElement('td');
  empty3.style.border = 'none';
  empty3.style.background = 'transparent';
  empty4.style.border = 'none';
  empty4.style.background = 'transparent';
  recRow.appendChild(empty3);
  recRow.appendChild(empty4);
  scheduleTable.appendChild(recRow);
  }

  if (!selectedPoolId) {
  var housemenRecRow = document.createElement('tr');
  housemenRecRow.className = 'schedule-housemen-rec-row';
  var hmEmpty1 = document.createElement('td');
  var hmEmpty2 = document.createElement('td');
  hmEmpty1.style.border = 'none';
  hmEmpty1.style.background = 'transparent';
  hmEmpty2.style.border = 'none';
  hmEmpty2.style.background = 'transparent';
  housemenRecRow.appendChild(hmEmpty1);
  housemenRecRow.appendChild(hmEmpty2);
  days.forEach(function(d) {
    var dateStr = iso(d);
    var rec = getHousemenRecommendationForDate(dateStr);
    var td = document.createElement('td');
    td.style.fontSize = '12px';
    td.style.color = 'var(--brand-text-muted, #7f8c8d)';
    td.style.verticalAlign = 'top';
    if (rec.count > 0) {
      var summary = rec.count + ' houseman' + (rec.count !== 1 ? 's' : '') + ' needed';
      var span = document.createElement('span');
      span.textContent = summary;
      td.appendChild(span);
      if (rec.names.length > 0) {
        var detailsLink = document.createElement('a');
        detailsLink.href = '#';
        detailsLink.className = 'schedule-why-link';
        detailsLink.textContent = ' Details';
        detailsLink.title = 'Show recommended names';
        detailsLink.onclick = function(e) { e.preventDefault(); e.stopPropagation(); alert('Recommended: ' + rec.names.join(', ')); };
        td.appendChild(detailsLink);
      }
    }
    housemenRecRow.appendChild(td);
  });
  var hmEmpty3 = document.createElement('td');
  var hmEmpty4 = document.createElement('td');
  hmEmpty3.style.border = 'none';
  hmEmpty3.style.background = 'transparent';
  hmEmpty4.style.border = 'none';
  hmEmpty4.style.background = 'transparent';
  housemenRecRow.appendChild(hmEmpty3);
  housemenRecRow.appendChild(hmEmpty4);
  scheduleTable.appendChild(housemenRecRow);
  }

  function appendEmployeeRow(emp) {
    let total=0;
    let daysWorked=0;
    const row = document.createElement('tr');
    row.setAttribute('data-employee-id', emp.id);
    const currentEmpId = emp.id; // Capture ID explicitly
    
    // Add row lock toggle
    const lockCell = document.createElement('td');
    const isRowLocked = lockedRows[currentEmpId];
    lockCell.innerHTML = isRowLocked ? 'üîí' : 'üîì';
    lockCell.style.cursor = 'pointer';
    lockCell.style.fontSize = '18px';
    lockCell.setAttribute('data-employee-id', currentEmpId);
    lockCell.onclick = (function(empId) {
      return function() { toggleRowLock(empId); };
    })(currentEmpId);
    lockCell.title = isRowLocked ? 'Unlock this row so it can be updated when you run Generate' : 'Lock this row so it won\'t change when you run Generate';
    row.appendChild(lockCell);
    
    // Add employee name
    const nameCell = document.createElement('td');
    nameCell.textContent = emp.name;
    row.appendChild(nameCell);

    days.forEach(d=>{
      const dateStr = iso(d);
      const key=emp.id+"_"+dateStr;
      const cell = document.createElement('td');
      cell.className = 'clickable';
      cell.setAttribute('data-emp-id', emp.id);
      cell.setAttribute('data-date', dateStr);
      if (emp.sick === true) {
        cell.classList.add('status-cell');
        var sickLabelEl = document.createElement('div');
        sickLabelEl.className = 'status-label';
        sickLabelEl.textContent = 'SICK';
        cell.appendChild(sickLabelEl);
        row.appendChild(cell);
        return;
      }
      // Week-level employee status (full-week absence): render status cell only, no shift
      var fullWeekStatusIds = { sick: 1, vacation: 1, unpaid_vacation: 1, floating_holiday: 1, off: 1, requested_off: 1 };
      if (emp.status && fullWeekStatusIds[emp.status]) {
        cell.innerHTML = '';
        cell.classList.add('status-cell');
        var weekStatusInfo = ABSENCE_TYPES.find(function(a) { return a.id === emp.status; });
        var statusLabelText = weekStatusInfo ? weekStatusInfo.label : (emp.status === 'off' ? 'Off' : emp.status.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }));
        var statusLabelEl = document.createElement('div');
        statusLabelEl.className = 'status-label';
        statusLabelEl.textContent = statusLabelText;
        cell.appendChild(statusLabelEl);
        cell.onclick = function() { editScheduleCell(emp.id, dateStr); };
        row.appendChild(cell);
        return;
      }
      cell.ondragover = function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (!draggedShiftKey) return;
        var u = draggedShiftKey.indexOf('_');
        if (u === -1) return;
        var srcDate = draggedShiftKey.substring(u + 1);
        if (srcDate !== dateStr) return;
        var targetEmpId = cell.getAttribute('data-emp-id');
        var srcEmpId = draggedShiftKey.substring(0, u);
        if (targetEmpId === srcEmpId) return;
        if (scheduleGlobalLock || lockedCells[targetEmpId + '_' + dateStr] || lockedRows[targetEmpId]) return;
        var ed = manualEdits[draggedShiftKey];
        if (!ed || !ed.start || !ed.end) return;
        var targetKey = targetEmpId + '_' + dateStr;
        var targetEdit = manualEdits[targetKey];
        if (targetEdit && !isFullAbsenceStatus(targetEdit.status) && (targetEdit.hours || targetEdit.start)) return;
        var shiftStart = new Date(dateStr + 'T' + ed.start);
        var shiftEnd = new Date(dateStr + 'T' + ed.end);
        if (!canEmployeeTakeShiftFromEdits(targetEmpId, dateStr, shiftStart, shiftEnd)) return;
        cell.classList.add('schedule-drop-zone');
      };
      cell.ondrop = function(e) {
        e.preventDefault();
        cell.classList.remove('schedule-drop-zone');
        if (!draggedShiftKey) return;
        if (scheduleGlobalLock) return;
        var sourceKey = draggedShiftKey;
        var sourceShift = manualEdits[sourceKey];
        if (!sourceShift) return;
        var targetEmpId = cell.getAttribute('data-emp-id');
        var targetDateStr = cell.getAttribute('data-date');
        var targetKey = targetEmpId + '_' + targetDateStr;
        if (targetKey === sourceKey) return;
        var targetShift = manualEdits[targetKey];
        if (!targetShift) {
          manualEdits[targetKey] = sourceShift;
          delete manualEdits[sourceKey];
        } else {
          manualEdits[sourceKey] = targetShift;
          manualEdits[targetKey] = sourceShift;
        }
        var wk = getWeekKey(getWeekStart());
        saveWeeklyScheduleSnapshot(wk);
        save();
        displaySchedule();
        draggedShiftKey = null;
        draggedShiftDateStr = null;
      };
      cell.ondragleave = function() { cell.classList.remove('schedule-drop-zone'); };
      
      const isLocked = lockedCells[key];
      if(isLocked) cell.classList.add('locked-cell');
      if(lockedRows[emp.id]) cell.classList.add('locked-cell');

      // If employee has a status for this date (no shift to show), render status only and skip shift
      const editForStatus = manualEdits[key];
      if (editForStatus && editForStatus.status) {
        var statusOnlyInfo = ABSENCE_TYPES.find(function(a) { return a.id === editForStatus.status; });
        var isStatusOnly = statusOnlyInfo && (isFullAbsenceStatus(editForStatus.status) || (editForStatus.status === 'requested_off' && !editForStatus.hours && !editForStatus.start));
        if (isStatusOnly) {
          cell.innerHTML = '';
          var statusLabelEl = document.createElement('div');
          statusLabelEl.className = 'status-label';
          statusLabelEl.textContent = statusOnlyInfo.id === 'requested_off' ? 'OFF' : statusOnlyInfo.label;
          cell.appendChild(statusLabelEl);
          cell.classList.add('status-cell');
          cell.title = 'Click to edit or change status' + (statusOnlyInfo.id === 'requested_off' ? '. Request Off is visual only until converted.' : '');
          cell.onclick = function() { editScheduleCell(emp.id, dateStr); };
          cell.draggable = false;
          cell.ondragstart = null;
          row.appendChild(cell);
          return;
        }
      }

      // Check for manual edits (includes generated shifts)
      if(manualEdits[key]){
        const edit = manualEdits[key];
        var absenceInfo = edit.status ? ABSENCE_TYPES.find(function(a) { return a.id === edit.status; }) : null;
        
        if (absenceInfo && absenceInfo.id === 'requested_off' && (edit.hours || edit.start)) {
          const h = edit.hours || edit;
          total += h;
          daysWorked++;
          cell.className += ' ' + getShiftClassByHours(h);
          cell.style.position = 'relative';
          cell.title = 'Click to edit or change status. ' + absenceInfo.cellLabel;
          if(edit.start && edit.end) {
            cell.innerHTML = h + 'h<br><small>' + edit.start + '-' + edit.end + '</small><br><span style="font-size:11px;color:var(--brand-text-muted);">' + (absenceInfo ? absenceInfo.cellLabel : '') + '</span>';
          } else {
            cell.innerHTML = h + 'h<br><span style="font-size:11px;color:var(--brand-text-muted);">' + (absenceInfo ? absenceInfo.cellLabel : '') + '</span>';
          }
          if (!isLocked && !lockedRows[emp.id] && !scheduleGlobalLock && edit.start && edit.end) {
            cell.draggable = true;
            cell.setAttribute('data-shift-id', key);
            cell.setAttribute('data-assigned-employee-id', emp.id);
            cell.ondragstart = function(e) {
              document.body.classList.add('dragging-shift');
              draggedShiftKey = key;
              draggedShiftDateStr = dateStr;
              e.dataTransfer.setData('text/plain', key);
              e.dataTransfer.effectAllowed = 'move';
            };
            cell.ondragend = function() { document.body.classList.remove('dragging-shift'); draggedShiftKey = null; draggedShiftDateStr = null; };
          }
          cell.onclick = function(ev) { if (!ev.target.closest('a')) editScheduleCell(emp.id, dateStr); };
          row.appendChild(cell);
          return;
        }
        
        if (absenceInfo && (absenceInfo.id !== 'requested_off' || (!edit.hours && !edit.start))) {
          cell.classList.add('status-cell');
          var statusLabel = absenceInfo.id === 'requested_off' ? 'OFF' : absenceInfo.label.toUpperCase();
          cell.innerHTML = '<span style="display:block;text-align:center;font-weight:bold;">' + statusLabel + '</span>';
          cell.title = 'Click to edit or change status' + (absenceInfo.id === 'requested_off' ? '. Request Off is visual only until converted.' : '');
          cell.onclick = function() { editScheduleCell(emp.id, dateStr); };
          cell.draggable = false;
          cell.ondragstart = null;
          row.appendChild(cell);
          return;
        }
        
        const h = edit.hours || edit;
        total += h;
        daysWorked++; // Count this as a worked day
        cell.className += ' ' + getShiftClassByHours(h);
        
        cell.style.position = 'relative';
        if (!isLocked && !lockedRows[emp.id] && !scheduleGlobalLock) {
          cell.draggable = true;
          cell.setAttribute('data-shift-id', key);
          cell.setAttribute('data-assigned-employee-id', emp.id);
          cell.ondragstart = function(e) {
            document.body.classList.add('dragging-shift');
            draggedShiftKey = key;
            draggedShiftDateStr = dateStr;
            e.dataTransfer.setData('text/plain', key);
            e.dataTransfer.effectAllowed = 'move';
          };
          cell.ondragend = function() { document.body.classList.remove('dragging-shift'); draggedShiftKey = null; draggedShiftDateStr = null; };
        }
        
        if(isLocked || lockedRows[emp.id]) {
          cell.title = 'Locked shift. Click to edit or unlock.';
        } else {
          cell.title = 'Click to edit or remove this shift. Drag to another employee to reassign.';
        }
        
        if(edit.start && edit.end) {
          const conflicts = detectConflicts(emp.id, dateStr, edit.start, edit.end);
          if(conflicts.length > 0) {
            cell.classList.add('conflict-cell');
            cell.title = (cell.title || '') + ' Less than 8 hours rest from another shift.';
          }
          var overrideInd = edit.seniorityOverride ? ' <span class="override-indicator" title="Seniority override' + (edit.overrideReason ? ': ' + edit.overrideReason : '') + '">&#9888;</span>' : '';
          cell.innerHTML = `${h}h<br><small>${edit.start}-${edit.end}</small>${overrideInd}<br><a href="#" class="schedule-why-link" title="Why this employee?">Why?</a>`;
        } else {
          var overrideInd = edit.seniorityOverride ? ' <span class="override-indicator" title="Seniority override' + (edit.overrideReason ? ': ' + edit.overrideReason : '') + '">&#9888;</span>' : '';
          cell.innerHTML = `${h}h<br>${overrideInd}<a href="#" class="schedule-why-link" title="Why this employee?">Why?</a>`;
        }
        var whyLink = cell.querySelector('.schedule-why-link');
        if (whyLink) {
          whyLink.onclick = function(e) { e.preventDefault(); e.stopPropagation(); showAssignmentReason(emp.id, dateStr); };
        }
        cell.onclick = function(ev) { if (!ev.target.closest('.schedule-why-link')) editScheduleCell(emp.id, dateStr); };
        
        row.appendChild(cell);
        return;
      }

      // Empty cell if no manual edit
      cell.title = 'Click to add a shift';
      cell.onclick = () => editScheduleCell(emp.id, dateStr);
      row.appendChild(cell);
    });

    const totalCell = document.createElement('td');
    totalCell.innerHTML = `<strong>${total}h</strong>`;
    row.appendChild(totalCell);
    
    // Add days worked column with individual max days
    const empMaxDays = emp.maxDaysPerWeek !== undefined ? emp.maxDaysPerWeek : 5;
    const daysCell = document.createElement('td');
    daysCell.innerHTML = `<strong>${daysWorked}/${empMaxDays}</strong>`;
    
    if(daysWorked >= empMaxDays) {
      daysCell.style.background = '#e74c3c';
      daysCell.style.color = '#fff';
      daysCell.title = `Maximum ${empMaxDays} days reached`;
    } else if(daysWorked >= empMaxDays - 1) {
      daysCell.style.background = '#f39c12';
      daysCell.style.color = '#000';
      daysCell.title = `Close to ${empMaxDays}-day limit`;
    }
    row.appendChild(daysCell);
    
    scheduleTable.appendChild(row);
  }

  if (selectedPoolId) {
    var pool = laborPools.find(function(p) { return p.id === selectedPoolId; });
    var singlePoolEmps = employees.filter(function(e) { return !e.retired && e.laborPoolId === selectedPoolId; });
    singlePoolEmps.sort(function(a, b) { return (getSeniorityForEmployee(a) || 999) - (getSeniorityForEmployee(b) || 999); });
    if (pool) {
      var sectionTr = document.createElement('tr');
      sectionTr.className = 'schedule-pool-section-header';
      var sectionTd = document.createElement('td');
      sectionTd.setAttribute('colspan', '11');
      sectionTd.textContent = pool.name || pool.id;
      sectionTr.appendChild(sectionTd);
      scheduleTable.appendChild(sectionTr);
    }
    scheduleTable.appendChild(headerRow);
    singlePoolEmps.forEach(function(emp) { appendEmployeeRow(emp); });
  } else {
    var poolsOrder = getPoolsInPrintOrder();
    var firstPool = true;
    poolsOrder.forEach(function(pool) {
      var poolEmps = employees.filter(function(e) { return !e.retired && e.laborPoolId === pool.id; });
      poolEmps.sort(function(a, b) { return (getSeniorityForEmployee(a) || 999) - (getSeniorityForEmployee(b) || 999); });
      if (poolEmps.length > 0) {
        var sectionTr = document.createElement('tr');
        sectionTr.className = 'schedule-pool-section-header';
        var sectionTd = document.createElement('td');
        sectionTd.setAttribute('colspan', '11');
        sectionTd.textContent = pool.name || pool.id;
        sectionTr.appendChild(sectionTd);
        scheduleTable.appendChild(sectionTr);
        if (firstPool) {
          scheduleTable.appendChild(headerRow);
          firstPool = false;
        }
      }
      poolEmps.forEach(function(emp) { appendEmployeeRow(emp); });
    });
  }

  var totalShown = selectedPoolId
    ? employees.filter(function(e) { return !e.retired && e.laborPoolId === selectedPoolId; }).length
    : employees.filter(function(e) { return !e.retired; }).length;
  if (totalShown === 0) {
    const emptyRow = document.createElement('tr');
    const emptyCell = document.createElement('td');
    emptyCell.setAttribute('colspan', '11');
    emptyCell.style.textAlign = 'center';
    emptyCell.style.padding = '1.5rem';
    emptyCell.style.color = '#7f8c8d';
    emptyCell.textContent = 'No schedule yet. Add employees and events, then click Generate to build your week.';
    emptyRow.appendChild(emptyCell);
    scheduleTable.appendChild(emptyRow);
  }
  
  // Update global lock button state and helper text
  const btn = document.getElementById('globalLockBtn');
  if(btn) {
    if(scheduleGlobalLock) {
      btn.innerHTML = 'üîí Locked Schedule';
      btn.style.background = '#e74c3c';
    } else {
      btn.innerHTML = 'üîì Unlock Schedule';
      btn.style.background = '#f39c12';
    }
  }
  var lockHelper = document.getElementById('scheduleLockHelperText');
  if (lockHelper) lockHelper.textContent = scheduleGlobalLock ? 'Locked schedules cannot be edited' : 'Edits enabled - changes will affect assignments';
  var undoWrap = document.getElementById('applyRecommendationsUndoWrap');
  if (undoWrap) undoWrap.style.display = lastApplyRecommendationsSnapshot ? 'inline' : 'none';
  updateLaborCostPanel();
  } catch(error) {
    console.error('Error in displaySchedule:', error);
    console.error('Error details:', error.message, error.stack);
    scheduleTable.innerHTML = '<tr><td colspan="10" style="padding: 20px; color: #e74c3c; text-align: center;">Schedule could not be displayed. Refresh the page or check the console.</td></tr>';
  }
}

function assignEmployeesToWeek(days) {
  const assignments = {};
  const assignmentDetails = {};
  const otFlaggedAssignments = []; // Assignments that exceed 8h - flagged OT_SUGGESTED, manager must review
  const employeeShiftHistory = {};
  const employeeTotalHours = {};
  const employeeWorkDays = {};
  const employeeHoursToday = {}; // dateStr -> { empId -> hours } for OT-avoidance
  
  employees.filter(e => !e.retired).forEach(e => {
    employeeShiftHistory[e.id] = null;
    employeeTotalHours[e.id] = 0;
    employeeWorkDays[e.id] = 0;
  });
  
  days.forEach(function(d) {
    var dateStr = iso(d);
    employeeHoursToday[dateStr] = {};
    assignments[dateStr] = [];
  });
  employees.filter(function(e) { return !e.retired; }).forEach(function(e) {
    days.forEach(function(d) {
      var dateStr = iso(d);
      var key = e.id + "_" + dateStr;
      if ((!lockedCells[key] && !lockedRows[e.id]) || !manualEdits[key]) return;
      var ed = manualEdits[key];
      if (isFullAbsenceStatus(ed.status)) return;
      if (!ed.hours && !ed.start) return;
      var hours = ed.hours;
      if (hours == null && ed.start && ed.end) {
        var es = new Date(dateStr + 'T' + ed.start), en = new Date(dateStr + 'T' + ed.end);
        hours = (en - es) / 3600000;
      }
      if (!hours) return;
      var startTime = ed.start ? new Date(dateStr + 'T' + ed.start) : new Date(dateStr + 'T00:00');
      var endTime = ed.end ? new Date(dateStr + 'T' + ed.end) : addHoursToDate(new Date(startTime.getTime()), hours);
      assignments[dateStr].push(e.id);
      if (!assignmentDetails[dateStr]) assignmentDetails[dateStr] = {};
      assignmentDetails[dateStr][e.id] = { hours: hours, start: startTime, end: endTime };
      employeeHoursToday[dateStr][e.id] = hours;
      employeeTotalHours[e.id] = (employeeTotalHours[e.id] || 0) + hours;
      employeeWorkDays[e.id] = (employeeWorkDays[e.id] || 0) + 1;
      employeeShiftHistory[e.id] = { date: dateStr, startTime: startTime, endTime: endTime };
    });
  });
  var cashierPoolId = getCashierPoolId();
  var housemenPoolId = getHousemenPoolId();
  var serverPool = employees.filter(function(e) {
    if (e.retired || e.sick) return false;
    if (cashierPoolId && e.laborPoolId === cashierPoolId) return false;
    if (housemenPoolId && e.laborPoolId === housemenPoolId) return false;
    return true;
  });
  function seniorityValue(emp) {
    var v = getSeniorityForEmployee(emp);
    if (v === null || v === undefined) return 99;
    var n = Number(v);
    return isNaN(n) ? 99 : n;
  }
  var employeesBySeniority = serverPool.slice().sort(function(a, b) {
    var sa = Number(seniorityValue(a));
    var sb = Number(seniorityValue(b));
    if (sa !== sb) return sa - sb;
    return 0;
  });
  // Preference audit: shift preference is stored on employee as emp.pref. Expected values: 'AM' | 'PM' | null | ''. Scheduler uses emp.pref everywhere (preferenceMatchScore, isPreferenceAligned, rankEligibleShiftsForStrict, applyOneAssignment).
  if (typeof console !== 'undefined' && console.log) {
    console.log('[Schedule] employeesBySeniority AFTER initial sort (seniority first, lower number = higher seniority):');
    employeesBySeniority.forEach(function(emp, idx) {
      console.log('  ' + (idx + 1) + '. name=' + (emp.name || emp.id) + ' seniority=' + seniorityValue(emp) + ' totalHours=' + (employeeTotalHours[emp.id] || 0));
    });
    console.log('[Schedule] Preference audit - expected values: AM | PM | null | ""');
    employeesBySeniority.forEach(function(emp) {
      var name = emp.name || emp.id;
      var pref = emp.pref;
      var defined = pref !== undefined;
      var inEnum = pref === 'AM' || pref === 'PM' || pref === null || pref === '';
      console.log('[Schedule] preference name=' + name + ' pref=' + JSON.stringify(pref) + ' defined=' + defined + ' inEnum=' + inEnum);
      if (!inEnum && typeof console !== 'undefined' && console.warn) {
        console.warn('[Schedule] preference INVALID: name=' + name + ' pref=' + JSON.stringify(pref) + ' (expected AM, PM, null, or "")');
      }
    });
  }
  
  var weekSlots = [];
  days.forEach(function(d) {
    var dateStr = iso(d);
    var dayEvents = events.filter(function(e) { return e.date === dateStr; });
    if (dayEvents.length === 0) return;
    dayEvents.sort(function(a, b) { return a.start.localeCompare(b.start); });
    dayEvents.forEach(function(ev) {
      var s = normalizeHours(ev.start, ev.end);
      var t = calculateSmartShift(ev, s.h);
      var cashierReq = (ev.laborPoolRequirements || []).find(function(r) { return r.laborPoolId === cashierPoolId; });
      var housemenReq = (ev.laborPoolRequirements || []).find(function(r) { return r.laborPoolId === housemenPoolId; });
      var serverSlots = ev.staff - (cashierReq ? (cashierReq.quantity || 0) : 0) - (housemenReq ? (housemenReq.quantity || 0) : 0);
      if (serverSlots <= 0) return;
      var slotList = [];
      if (s.h <= REGULAR_HOURS_MAX) {
        var slotHours = s.h < MIN_SHIFT_HOURS ? MIN_SHIFT_HOURS : s.h;
        for (var i = 0; i < serverSlots; i++) {
          console.log("SHIFT CREATED:", t.start, "Event:", ev.start);
          slotList.push({ hours: slotHours, start: t.start, end: addHoursToDate(t.start, slotHours) });
        }
      } else {
        var totalPersonHours = serverSlots * s.h;
        var segmentHoursList = [];
        var rem = totalPersonHours;
        while (rem > 0) {
          var seg = Math.min(REGULAR_HOURS_MAX, rem);
          segmentHoursList.push(seg);
          rem -= seg;
        }
        while (segmentHoursList.length >= 2 && segmentHoursList[segmentHoursList.length - 1] < MIN_SHIFT_HOURS) {
          var tail = segmentHoursList.pop();
          var prev = segmentHoursList[segmentHoursList.length - 1];
          if (prev + tail <= REGULAR_HOURS_MAX) {
            segmentHoursList[segmentHoursList.length - 1] = prev + tail;
          } else {
            segmentHoursList.push(tail);
            break;
          }
        }
        if (segmentHoursList.length === 1 && segmentHoursList[0] < MIN_SHIFT_HOURS) segmentHoursList = [];
        var cumHours = 0;
        for (var j = 0; j < segmentHoursList.length; j++) {
          var h = segmentHoursList[j];
          var isLast = (j === segmentHoursList.length - 1);
          if (h < MIN_SHIFT_HOURS) {
            cumHours += h;
            continue;
          }
          if (isLast) {
            var shiftStartLast = addHoursToDate(t.end, -h);
            console.log("SHIFT CREATED:", shiftStartLast, "Event:", ev.start);
            slotList.push({ hours: h, start: shiftStartLast, end: t.end });
          } else {
            var shiftStartSeg = addHoursToDate(t.start, cumHours);
            console.log("SHIFT CREATED:", shiftStartSeg, "Event:", ev.start);
            slotList.push({ hours: h, start: shiftStartSeg, end: addHoursToDate(t.start, cumHours + h) });
            cumHours += h;
          }
        }
      }
      slotList.sort((a, b) => new Date(a.start) - new Date(b.start));
      slotList.forEach(function(slot) {
        var shift = { dateStr: dateStr, d: d, ev: ev, slot: slot, s: s, t: t, assignedTo: null };
        if (!shift.id) shift.id = 'shift_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        weekSlots.push(shift);
      });
    });
  });
  weekSlots.sort(function(a, b) {
    var ah = a.slot.hours, bh = b.slot.hours;
    if (ah !== bh) return bh - ah;
    if (a.dateStr !== b.dateStr) return a.dateStr.localeCompare(b.dateStr);
    return a.slot.start.getTime() - b.slot.start.getTime();
  });
  weekSlots.sort(function(a, b) { return a.slot.start.getTime() - b.slot.start.getTime(); });
  var lockedCountByDate = {};
  days.forEach(function(d) {
    var dateStr = iso(d);
    lockedCountByDate[dateStr] = 0;
    employees.filter(function(emp) { return !emp.retired; }).forEach(function(emp) {
      var key = emp.id + '_' + dateStr;
      if ((lockedCells[key] || lockedRows[emp.id]) && manualEdits[key] && !isFullAbsenceStatus(manualEdits[key].status) && (manualEdits[key].hours || manualEdits[key].start)) lockedCountByDate[dateStr]++;
    });
  });
  for (var dateStr in lockedCountByDate) {
    var toRemove = lockedCountByDate[dateStr];
    for (var i = weekSlots.length - 1; i >= 0 && toRemove > 0; i--) {
      if (weekSlots[i].dateStr === dateStr) {
        weekSlots.splice(i, 1);
        toRemove--;
      }
    }
  }
  var assignmentStyle = settings.assignmentStyle || 'strict';
  var noonMinutes = 12 * 60;
  
  function groupKey(item) {
    var startMinutes = item.slot.start.getHours() * 60 + item.slot.start.getMinutes();
    return item.dateStr + '|' + item.slot.hours + '|' + (startMinutes < noonMinutes ? 'AM' : 'PM');
  }
  
  function isEligibleForSlot(emp, item) {
    var dateStr = item.dateStr;
    var slotStart = item.slot.start;
    var key = emp.id + "_" + dateStr;
    if (item.assignedTo !== null) return false;
    if (lockedCells[key] || lockedRows[emp.id]) return false;
    var ed = manualEdits[key];
    if (ed) {
      if (isFullAbsenceStatus(ed.status)) return false;
      if (ed.status !== 'requested_off' || (ed.hours || ed.start)) return false;
    }
    if (assignments[dateStr] && assignments[dateStr].indexOf(emp.id) !== -1) return false;
    if ((employeeHoursToday[dateStr][emp.id] || 0) + item.slot.hours > REGULAR_HOURS_MAX) return false;
    var empMaxDays = emp.maxDaysPerWeek !== undefined ? emp.maxDaysPerWeek : 5;
    if (employeeWorkDays[emp.id] >= empMaxDays) return false;
    var gapCheck = canWorkShift(emp.id, dateStr, slotStart, item.slot.end, employeeShiftHistory);
    return gapCheck.allowed;
  }
  
  function wouldBreakSeniorityOrdering(emp, addHours) {
    var empSr = seniorityValue(emp);
    var newTotal = (employeeTotalHours[emp.id] || 0) + addHours;
    for (var i = 0; i < employeesBySeniority.length; i++) {
      var h = employeesBySeniority[i];
      var hSr = seniorityValue(h);
      if (hSr >= empSr) continue;
      var hHours = employeeTotalHours[h.id] || 0;
      if (newTotal > hHours) return true;
    }
    return false;
  }
  
  function preferenceMatchScore(emp, slotStart) {
    var startMinutes = slotStart.getHours() * 60 + slotStart.getMinutes();
    var noon = 12 * 60;
    if (emp.pref === 'AM') return startMinutes <= noon ? 2 : -2;
    if (emp.pref === 'PM') return startMinutes >= noon ? 2 : -2;
    return 0;
  }
  
  function applyOneAssignment(one, emp) {
    var slotHoursOne = one.slot.hours;
    var slotStartOne = one.slot.start;
    var slotEndOne = one.slot.end;
    var dateStrOne = one.dateStr;
    if ((employeeHoursToday[dateStrOne][emp.id] || 0) + slotHoursOne > REGULAR_HOURS_MAX) return;
    one.assignedTo = emp.id;
    var ev = one.ev, slot = one.slot, s = one.s, t = one.t;
    var d = one.d;
    var dayOfWeek = typeof getMondayBasedIndex === 'function' ? getMondayBasedIndex(d) : d.getDay();
    employeeHoursToday[dateStrOne][emp.id] = (employeeHoursToday[dateStrOne][emp.id] || 0) + slotHoursOne;
    employeeShiftHistory[emp.id] = { date: dateStrOne, startTime: slotStartOne, endTime: slotEndOne };
    employeeTotalHours[emp.id] = (employeeTotalHours[emp.id] || 0) + slotHoursOne;
    employeeWorkDays[emp.id] = (employeeWorkDays[emp.id] || 0) + 1;
    if (!assignmentDetails[dateStrOne]) assignmentDetails[dateStrOne] = {};
    if (slotHoursOne !== s.h || slotStartOne.getTime() !== t.start.getTime() || slotEndOne.getTime() !== t.end.getTime()) {
      assignmentDetails[dateStrOne][emp.id] = { hours: slotHoursOne, start: slotStartOne, end: slotEndOne };
    }
    if (!assignments[dateStrOne]) assignments[dateStrOne] = [];
    if (assignments[dateStrOne].indexOf(emp.id) === -1) assignments[dateStrOne].push(emp.id);
    var key = emp.id + '_' + dateStrOne;
    var startMinutes = slotStartOne.getHours() * 60 + slotStartOne.getMinutes();
    var preferredShift = (emp.pref === 'AM' && startMinutes <= noonMinutes) || (emp.pref === 'PM' && startMinutes >= noonMinutes);
    var preferredDay = emp.dayPreferences && emp.dayPreferences[dayOfWeek] === true;
    var dislikesShift = (emp.pref === 'AM' && startMinutes > noonMinutes) || (emp.pref === 'PM' && startMinutes < noonMinutes);
    var dislikesDay = emp.dayPreferences && emp.dayPreferences[dayOfWeek] === false;
    var totalHoursAfter = (employeeHoursToday[dateStrOne][emp.id] || 0);
    var wouldBeOT = totalHoursAfter > REGULAR_HOURS_MAX;
    if (wouldBeOT) otFlaggedAssignments.push({ key: key, dateStr: dateStrOne, eventName: ev.name, empName: emp.name });
    var reasonCode = wouldBeOT ? 'OT_SUGGESTED' : (preferredShift || preferredDay) ? 'PREFERENCE_MATCH' : (dislikesShift || dislikesDay) ? 'PREFERENCE_MISMATCH' : 'SENIORITY_PRIORITY';
    assignmentReasonCodes[key] = reasonCode;
    assignmentReasons[key] = [REASON_CODE_EXPLANATIONS[reasonCode] || reasonCode];
    var tags = ['availability', 'within_max_days', 'seniority'];
    if (emp.type === 'FT') tags.push('full_time');
    if (preferredShift || preferredDay) tags.push('prefers_shift');
    if (dislikesShift || dislikesDay) tags.push('preference_overridden');
    if (wouldBeOT) tags.push('OT_SUGGESTED');
    if (assignmentStyle === 'balanced' || assignmentStyle === 'fair') tags.push('rotation_balance');
    assignmentReasonTags[key] = tags;
  }
  
  if (assignmentStyle === 'strict') {
    for (var ei = 0; ei < employeesBySeniority.length; ei++) {
      var emp = employeesBySeniority[ei];
      while ((employeeTotalHours[emp.id] || 0) < TARGET_WEEKLY_HOURS) {
        var eligible = weekSlots.filter(function(s) {
          return s.assignedTo === null && isEligibleForSlot(emp, s) && !wouldBreakSeniorityOrdering(emp, s.slot.hours);
        });
        if (eligible.length === 0) break;
        eligible.sort(function(a, b) {
          var ah = a.slot.hours, bh = b.slot.hours;
          if (ah !== bh) return bh - ah;
          var dayA = typeof getMondayBasedIndex === 'function' ? getMondayBasedIndex(a.d) : a.d.getDay();
          var dayB = typeof getMondayBasedIndex === 'function' ? getMondayBasedIndex(b.d) : b.d.getDay();
          if (dayA !== dayB) return dayB - dayA;
          var prefA = preferenceMatchScore(emp, a.slot.start), prefB = preferenceMatchScore(emp, b.slot.start);
          if (prefA !== prefB) return prefB - prefA;
          if (emp.pref === 'AM') return a.slot.start.getTime() - b.slot.start.getTime();
          if (emp.pref === 'PM') return b.slot.start.getTime() - a.slot.start.getTime();
          return a.slot.start.getTime() - b.slot.start.getTime();
        });
        applyOneAssignment(eligible[0], emp);
      }
    }
  } else {
  weekSlots.forEach(function(item) {
    if (item.assignedTo !== null) return;
    var gk = groupKey(item);
    var groupItems = weekSlots.filter(function(it) { return groupKey(it) === gk && it.assignedTo === null; });
    groupItems.sort(function(a, b) { return a.slot.start.getTime() - b.slot.start.getTime(); });
    var slotHours = item.slot.hours;
    var slotStart = item.slot.start;
    var dateStr = item.dateStr;
    var eligible = [];
    var isGroup = groupItems.length > 1;
    if (isGroup) {
      for (var ei = 0; ei < employeesBySeniority.length; ei++) {
        var emp = employeesBySeniority[ei];
        if ((employeeTotalHours[emp.id] || 0) >= TARGET_WEEKLY_HOURS) continue;
        var canTakeAny = false;
        for (var gi = 0; gi < groupItems.length; gi++) {
          var gitem = groupItems[gi];
          if (isEligibleForSlot(emp, gitem) && !wouldBreakSeniorityOrdering(emp, gitem.slot.hours)) { canTakeAny = true; break; }
        }
        if (canTakeAny) eligible.push(emp);
      }
    } else {
      for (var ei = 0; ei < employeesBySeniority.length; ei++) {
        var emp = employeesBySeniority[ei];
        if ((employeeTotalHours[emp.id] || 0) >= TARGET_WEEKLY_HOURS) continue;
        if (!isEligibleForSlot(emp, item)) continue;
        if (wouldBreakSeniorityOrdering(emp, slotHours)) continue;
        eligible.push(emp);
      }
    }
    if (eligible.length === 0) return;
    // Required order: 1) Seniority descending, 2) Weekly hours ascending, 3) Preference, 4) tie-break. Never evaluate hours before seniority.
    eligible.sort(function(a, b) {
      var aSr = Number(seniorityValue(a));
      var bSr = Number(seniorityValue(b));
      if (aSr !== bSr) return aSr - bSr;
      var aHours = employeeTotalHours[a.id] || 0;
      var bHours = employeeTotalHours[b.id] || 0;
      if (aHours !== bHours) return aHours - bHours;
      var aPref = preferenceMatchScore(a, slotStart);
      var bPref = preferenceMatchScore(b, slotStart);
      if (aPref !== bPref) return bPref - aPref;
      return 0;
    });
    var assignedInGroup = {};
    var itemsToAssign = isGroup ? groupItems : [item];
    itemsToAssign.forEach(function(one) {
      var chosen = null;
      for (var ei = 0; ei < eligible.length; ei++) {
        var emp = eligible[ei];
        if (assignedInGroup[emp.id]) continue;
        if (!isEligibleForSlot(emp, one) || wouldBreakSeniorityOrdering(emp, one.slot.hours)) continue;
        chosen = emp;
        break;
      }
      if (!chosen) return;
      assignedInGroup[chosen.id] = true;
      applyOneAssignment(one, chosen);
    });
  });
  }
  
  function seniorityOrderViolated() {
    for (var i = 0; i < employeesBySeniority.length; i++) {
      var h = employeesBySeniority[i];
      var hHours = employeeTotalHours[h.id] || 0;
      for (var j = i + 1; j < employeesBySeniority.length; j++) {
        var l = employeesBySeniority[j];
        var lHours = employeeTotalHours[l.id] || 0;
        if (hHours < lHours) return { higher: h, lower: l };
      }
    }
    return null;
  }
  
  var rebalanceLimit = 500;
  while (rebalanceLimit-- > 0) {
    var violation = seniorityOrderViolated();
    if (!violation) break;
    var H = violation.higher, L = violation.lower;
    var moved = false;
    var candidates = [];
    for (var si = 0; si < weekSlots.length; si++) {
      var item = weekSlots[si];
      if (item.assignedTo !== L.id) continue;
      var dateStr = item.dateStr, slot = item.slot, ev = item.ev, s = item.s, t = item.t;
      var slotHours = slot.hours, slotStart = slot.start, slotEnd = slot.end;
      var wasAssigned = item.assignedTo;
      item.assignedTo = null;
      var hEligible = isEligibleForSlot(H, item);
      item.assignedTo = wasAssigned;
      if (hEligible) candidates.push({ index: si, item: item });
    }
    if (candidates.length > 0) {
      candidates.sort(function(a, b) {
        var prefA = preferenceMatchScore(H, a.item.slot.start);
        var prefB = preferenceMatchScore(H, b.item.slot.start);
        if (prefA !== prefB) return prefB - prefA;
        if (H.pref === 'AM') return a.item.slot.start.getTime() - b.item.slot.start.getTime();
        if (H.pref === 'PM') return b.item.slot.start.getTime() - a.item.slot.start.getTime();
        return 0;
      });
      var best = candidates[0];
      var item = best.item;
      var dateStr = item.dateStr, slot = item.slot, ev = item.ev, s = item.s, t = item.t;
      var slotHours = slot.hours, slotStart = slot.start, slotEnd = slot.end;
      item.assignedTo = H.id;
      if (assignments[dateStr]) {
        var idx = assignments[dateStr].indexOf(L.id);
        if (idx !== -1) assignments[dateStr].splice(idx, 1);
        if (assignments[dateStr].indexOf(H.id) === -1) assignments[dateStr].push(H.id);
      }
      if (!assignmentDetails[dateStr]) assignmentDetails[dateStr] = {};
      delete assignmentDetails[dateStr][L.id];
      assignmentDetails[dateStr][H.id] = { hours: slotHours, start: slotStart, end: slotEnd };
      employeeTotalHours[L.id] = (employeeTotalHours[L.id] || 0) - slotHours;
      employeeTotalHours[H.id] = (employeeTotalHours[H.id] || 0) + slotHours;
      employeeHoursToday[dateStr][L.id] = (employeeHoursToday[dateStr][L.id] || 0) - slotHours;
      employeeHoursToday[dateStr][H.id] = (employeeHoursToday[dateStr][H.id] || 0) + slotHours;
      employeeWorkDays[L.id] = (employeeWorkDays[L.id] || 0) - 1;
      employeeWorkDays[H.id] = (employeeWorkDays[H.id] || 0) + 1;
      employeeShiftHistory[H.id] = { date: dateStr, startTime: slotStart, endTime: slotEnd };
      var lLast = null;
      weekSlots.forEach(function(it) {
        if (it.assignedTo === L.id && it.dateStr !== dateStr) {
          if (!lLast || it.dateStr > lLast.dateStr) lLast = { dateStr: it.dateStr, startTime: it.slot.start, endTime: it.slot.end };
        }
      });
      employeeShiftHistory[L.id] = lLast ? { date: lLast.dateStr, startTime: lLast.startTime, endTime: lLast.endTime } : null;
      var keyL = L.id + "_" + dateStr, keyH = H.id + "_" + dateStr;
      delete assignmentReasonCodes[keyL]; delete assignmentReasons[keyL]; delete assignmentReasonTags[keyL];
      assignmentReasonCodes[keyH] = 'SENIORITY_PRIORITY';
      assignmentReasons[keyH] = [REASON_CODE_EXPLANATIONS.SENIORITY_PRIORITY || 'Rebalanced for seniority hour fairness.'];
      assignmentReasonTags[keyH] = ['availability', 'within_max_days', 'seniority'];
      otFlaggedAssignments = otFlaggedAssignments.filter(function(o) { return o.key !== keyL; });
      if ((employeeHoursToday[dateStr][H.id] || 0) > REGULAR_HOURS_MAX) {
        otFlaggedAssignments.push({ key: keyH, dateStr: dateStr, eventName: ev.name, empName: H.name });
      }
      moved = true;
    }
    if (!moved) break;
  }
  
  var overtimeLikelyByDay = {};
  days.forEach(function(d) {
    var dateStr = iso(d);
    var requiredHours = 0;
    weekSlots.forEach(function(it) { if (it.dateStr === dateStr) requiredHours += it.slot.hours; });
    var assignedHours = 0;
    if (assignments[dateStr] && assignmentDetails[dateStr]) {
      assignments[dateStr].forEach(function(empId) {
        var det = assignmentDetails[dateStr][empId];
        if (det && det.hours != null) assignedHours += det.hours;
      });
    }
    if (requiredHours > assignedHours) overtimeLikelyByDay[dateStr] = true;
  });
  
  return { assignments: assignments, assignmentDetails: assignmentDetails, otFlaggedAssignments: otFlaggedAssignments, overtimeLikelyByDay: overtimeLikelyByDay };
}

function canWorkShift(empId, currentDate, shiftStart, shiftEnd, shiftHistory) {
  const lastShift = shiftHistory[empId];
  
  if(!lastShift) return {allowed: true};
  
  const lastDate = new Date(lastShift.date);
  const currentDateObj = new Date(currentDate);
  const daysDiff = Math.floor((currentDateObj - lastDate) / (1000 * 60 * 60 * 24));
  
  if(Math.abs(daysDiff) > 1) return {allowed: true};
  
  if(Math.abs(daysDiff) === 1) {
    const lastEnd = lastShift.endTime;
    const lastStart = lastShift.startTime;
    const currentStart = shiftStart;
    const currentEnd = shiftEnd;
    if (daysDiff === -1 && !lastStart) return { allowed: true };
    
    const lastEndMinutes = lastEnd.getHours() * 60 + lastEnd.getMinutes();
    const lastStartMinutes = lastStart ? (lastStart.getHours() * 60 + lastStart.getMinutes()) : 0;
    const currentStartMinutes = currentStart.getHours() * 60 + currentStart.getMinutes();
    const currentEndMinutes = currentEnd ? (currentEnd.getHours() * 60 + currentEnd.getMinutes()) : currentStartMinutes;
    
    var totalMinutesBetween;
    if(daysDiff === 1) {
      // Current day is AFTER last day: gap from last shift end to current shift start
      totalMinutesBetween = (1440 - lastEndMinutes) + currentStartMinutes;
    } else {
      // Current day is BEFORE last day (daysDiff === -1): gap from current shift end to next day's shift start
      totalMinutesBetween = (1440 - currentEndMinutes) + lastStartMinutes;
    }
    
    if(totalMinutesBetween >= 480) {
      return {allowed: true};
    } else {
      return {allowed: false, reason: 'needs 8 hour gap'};
    }
  }
  
  return {allowed: true};
}

/** Check if target employee can take the shift (8h gap from adjacent shifts) using current manualEdits for the week. */
function canEmployeeTakeShiftFromEdits(targetEmpId, dateStr, shiftStart, shiftEnd) {
  var start = getWeekStart();
  var weekKey = getWeekKey(start);
  var days = getDateStrsForWeek(weekKey);
  var dateIdx = days.indexOf(dateStr);
  if (dateIdx === -1) return true;
  var prevDateStr = dateIdx > 0 ? days[dateIdx - 1] : null;
  var nextDateStr = dateIdx < 6 ? days[dateIdx + 1] : null;
  var shiftHistory = {};
  if (prevDateStr) {
    var pk = targetEmpId + '_' + prevDateStr;
    var ped = manualEdits[pk];
    if (ped && (ped.hours || ped.start) && !ped.status) {
      var pe = ped.end ? new Date(prevDateStr + 'T' + ped.end) : null;
      var ps = ped.start ? new Date(prevDateStr + 'T' + ped.start) : null;
      if (pe) shiftHistory[targetEmpId] = { date: prevDateStr, startTime: ps, endTime: pe };
    }
  }
  if (shiftHistory[targetEmpId]) {
    var r = canWorkShift(targetEmpId, dateStr, shiftStart, shiftEnd, shiftHistory);
    if (!r.allowed) return false;
  }
  shiftHistory[targetEmpId] = { date: dateStr, startTime: shiftStart, endTime: shiftEnd };
  if (nextDateStr) {
    var nk = targetEmpId + '_' + nextDateStr;
    var ned = manualEdits[nk];
    if (ned && (ned.hours || ned.start) && !ned.status) {
      var ns = ned.start ? new Date(nextDateStr + 'T' + ned.start) : null;
      var ne = ned.end ? new Date(nextDateStr + 'T' + ned.end) : null;
      if (ns) {
        var r2 = canWorkShift(targetEmpId, nextDateStr, ns, ne, shiftHistory);
        if (!r2.allowed) return false;
      }
    }
  }
  return true;
}

function regenerateSchedule(){ 
  if(!confirm("This will clear unlocked shifts and regenerate from events. Locked shifts will be kept as-is. Continue?")) return;
  
  var start = getWeekStart();
  var weekKey = getWeekKey(start);
  var days = getDateStrsForWeek(weekKey);
  employees.filter(function(e) { return !e.retired; }).forEach(function(e) {
    days.forEach(function(dateStr) {
      var key = e.id + "_" + dateStr;
      if (lockedCells[key] || lockedRows[e.id]) return;
      var ed = manualEdits[key];
      if (ed && isFullAbsenceStatus(ed.status)) return;
      delete manualEdits[key];
    });
  });
  delete scheduleGeneratedWeeks[weekKey];
  addAuditEntry('Schedule Regenerated', null, null, 'Unlocked shifts cleared', 'Regenerated from events; locked shifts and absences (vacation/sick/off etc.) preserved');
  save();
  generateSchedule();
}

function changeWeek(n){ 
  currentWeekOffset+=n;
  var start = getWeekStart();
  var weekKey = getWeekKey(start);
  if (typeof console !== 'undefined' && console.log) {
    console.log('[Week] On week switch: computed weekKey =', weekKey);
  }
  displaySchedule(); // Just display, don't regenerate
}

function toggleDarkMode(){ 
  document.body.classList.toggle("light-mode"); 
}

function getPoolsInPrintOrder() {
  var serversId = getLaborPoolById(DEFAULT_SERVERS_POOL_ID) ? DEFAULT_SERVERS_POOL_ID : null;
  var cashiersId = getCashierPoolId();
  var housemenId = getHousemenPoolId();
  var ordered = [];
  if (serversId && getLaborPoolById(serversId)) ordered.push(getLaborPoolById(serversId));
  if (cashiersId && getLaborPoolById(cashiersId)) ordered.push(getLaborPoolById(cashiersId));
  if (housemenId && getLaborPoolById(housemenId)) ordered.push(getLaborPoolById(housemenId));
  laborPools.forEach(function(p) {
    if (p.id !== serversId && p.id !== cashiersId && p.id !== housemenId) ordered.push(p);
  });
  return ordered;
}

function getScheduleTabSelectedPoolId() {
  var stored = localStorage.getItem('scheduleTabSelectedPoolId');
  if (stored === null || stored === '') return '';
  if (getLaborPoolById(stored)) return stored;
  return '';
}
function setScheduleTabSelectedPoolId(poolId) {
  localStorage.setItem('scheduleTabSelectedPoolId', poolId || '');
}
function renderSchedulePoolSelector() {
  var sel = document.getElementById('schedulePoolFilter');
  if (!sel) return;
  var cur = getScheduleTabSelectedPoolId();
  sel.innerHTML = '<option value="">All Pools</option>';
  getPoolsInPrintOrder().forEach(function(p) {
    var opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name || p.id;
    sel.appendChild(opt);
  });
  if (cur && getLaborPoolById(cur)) sel.value = cur;
  else sel.value = '';
  sel.onchange = function() {
    setScheduleTabSelectedPoolId(sel.value || '');
    displaySchedule();
  };
}

function populatePrintPoolFilter() {
  var sel = document.getElementById('printPoolFilter');
  if (!sel) return;
  var cur = sel.value;
  sel.innerHTML = '<option value="">Full schedule</option>';
  getPoolsInPrintOrder().forEach(function(p) {
    var opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name || p.id;
    sel.appendChild(opt);
  });
  if (cur && getLaborPoolById(cur)) sel.value = cur;
  else sel.value = '';
}

function buildScheduleTableForPrint(filterPoolId) {
  var table = document.getElementById('scheduleTable');
  if (!table) return;
  var start = getWeekStart();
  var days = [];
  for (var i = 0; i < 7; i++) {
    var d = new Date(start);
    d.setDate(start.getDate() + i);
    days.push(d);
  }
  var poolsToRender = filterPoolId ? [getLaborPoolById(filterPoolId)].filter(Boolean) : getPoolsInPrintOrder();
  table.innerHTML = '';
  var headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>üîí</th><th>Employee</th>';
  days.forEach(function(d) {
    var th = document.createElement('th');
    th.textContent = d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' });
    headerRow.appendChild(th);
  });
  headerRow.innerHTML += '<th>Total<br><small class="schedule-th-helper">Total scheduled hours</small></th><th>Days<br><small class="schedule-th-helper">Days worked this week</small></th>';
  var thead = document.createElement('thead');
  thead.appendChild(headerRow);
  table.appendChild(thead);
  var tbody = document.createElement('tbody');
  poolsToRender.forEach(function(pool) {
    var poolEmps = employees.filter(function(e) { return !e.retired && e.laborPoolId === pool.id; });
    poolEmps.sort(function(a, b) { return (getSeniorityForEmployee(a) || 999) - (getSeniorityForEmployee(b) || 999); });
    var headerTr = document.createElement('tr');
    headerTr.className = 'print-pool-header';
    var headerTd = document.createElement('td');
    headerTd.setAttribute('colspan', '11');
    headerTd.textContent = (pool.name || pool.id).toUpperCase();
    headerTr.appendChild(headerTd);
    tbody.appendChild(headerTr);
    poolEmps.forEach(function(emp) {
      var total = 0, daysWorked = 0;
      var row = document.createElement('tr');
      row.appendChild(document.createElement('td'));
      var nameTd = document.createElement('td');
      nameTd.textContent = emp.name;
      row.appendChild(nameTd);
      days.forEach(function(d) {
        var dateStr = iso(d);
        var key = emp.id + '_' + dateStr;
        var cell = document.createElement('td');
        var edit = manualEdits[key];
        if (edit) {
          var absenceInfo = edit.status ? ABSENCE_TYPES.find(function(a) { return a.id === edit.status; }) : null;
          if (absenceInfo && (absenceInfo.id !== 'requested_off' || (!edit.hours && !edit.start))) {
            cell.className = 'status-cell';
            cell.textContent = absenceInfo.id === 'requested_off' ? 'OFF' : (absenceInfo.label || '').toUpperCase();
          } else if (absenceInfo && absenceInfo.id === 'requested_off' && (edit.hours || edit.start)) {
            var h = edit.hours || edit;
            total += h;
            daysWorked++;
            cell.className = getShiftClassByHours(h);
            cell.innerHTML = h + 'h' + (edit.start && edit.end ? '<br><small>' + edit.start + '-' + edit.end + '</small>' : '');
          } else if (edit.hours || edit.start) {
            var h = edit.hours || edit;
            total += h;
            daysWorked++;
            cell.className = getShiftClassByHours(h);
            cell.innerHTML = h + 'h' + (edit.start && edit.end ? '<br><small>' + edit.start + '-' + edit.end + '</small>' : '');
          }
        }
        row.appendChild(cell);
      });
      var totalTd = document.createElement('td');
      totalTd.innerHTML = '<strong>' + total + 'h</strong>';
      row.appendChild(totalTd);
      var empMaxDays = emp.maxDaysPerWeek !== undefined ? emp.maxDaysPerWeek : 5;
      var daysTd = document.createElement('td');
      daysTd.innerHTML = '<strong>' + daysWorked + '/' + empMaxDays + '</strong>';
      if (daysWorked >= empMaxDays) { daysTd.style.background = '#e74c3c'; daysTd.style.color = '#fff'; }
      else if (daysWorked >= empMaxDays - 1) { daysTd.style.background = '#f39c12'; daysTd.style.color = '#000'; }
      row.appendChild(daysTd);
      tbody.appendChild(row);
    });
  });
  table.appendChild(tbody);
}

function printSchedule(){
  showTab("scheduleTab");
  var filterEl = document.getElementById('printPoolFilter');
  var filterPoolId = (filterEl && filterEl.value) || '';
  buildScheduleTableForPrint(filterPoolId || null);
  var originalTitle = document.title;
  var start = getWeekStart();
  var end = new Date(start);
  end.setDate(start.getDate() + 6);
  document.title = "BanquetLogic_Schedule_" + iso(start) + "_to_" + iso(end);
  document.body.classList.add("print-pending");
  function restoreAfterPrint() {
    document.title = originalTitle;
    document.body.classList.remove("print-pending");
    window.removeEventListener("afterprint", restoreAfterPrint);
    displaySchedule();
  }
  window.addEventListener("afterprint", restoreAfterPrint);
  setTimeout(function() {
    requestAnimationFrame(function() {
      window.print();
    });
  }, 100);
}

/* SCHEDULE EXPORT (isolated; does not affect scheduling logic) */
function exportScheduleToCSV() {
  const start = getWeekStart();
  const days = [...Array(7)].map((_, i) => {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    return d;
  });
  const header = ['Employee Name', 'Role', 'Date', 'Hours'];
  const rows = [];
  employees.filter(e => !e.retired).forEach(emp => {
    days.forEach(d => {
      const dateStr = iso(d);
      const key = emp.id + '_' + dateStr;
      const edit = manualEdits[key];
      if (!edit) return;
      let hours;
      if (edit.status && isFullAbsenceStatus(edit.status)) {
        hours = '0';
      } else if (edit.status === 'requested_off' && !edit.hours && !edit.start) {
        hours = '0';
      } else {
        const h = edit.hours != null ? edit.hours : edit;
        hours = String(typeof h === 'number' ? h : (h || 0));
      }
      rows.push([
        emp.name || '',
        emp.type || '',
        dateStr,
        hours
      ]);
    });
  });
  function escapeCsvField(val) {
    const s = String(val);
    if (/[,"\r\n]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }
  const csvContent = '\uFEFF' + [header.map(escapeCsvField).join(',')]
    .concat(rows.map(r => r.map(escapeCsvField).join(',')))
    .join('\r\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'BanquetLogic_Schedule_' + iso(start) + '_to_' + iso(days[6]) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

/* AUDIT LOG */
function renderAuditLog(filter = {}){
  const container = document.getElementById('auditLogContainer');
  container.innerHTML = '';
  
  let filtered = auditLog;
  
  if(filter.employee) {
    filtered = filtered.filter(e => 
      e.employee.toLowerCase().includes(filter.employee.toLowerCase())
    );
  }
  
  if(filter.date) {
    filtered = filtered.filter(e => e.date === filter.date);
  }
  
  if(filtered.length === 0) {
    const hasFilters = !!(filter.employee || filter.date);
    var emptyMsg = hasFilters ? 'No audit entries match your filters. Try clearing the filter.' : 'No audit entries yet. Changes you make will appear here.';
    container.innerHTML = '<div class="audit-empty">' + emptyMsg + '</div>';
    return;
  }
  
  filtered.forEach(entry => {
    const div = document.createElement('div');
    const a = (entry.action || '').toLowerCase();
    let typeClass = '';
    if (a.indexOf('added') !== -1 || a.indexOf('created') !== -1 || a.indexOf('imported') !== -1 || a.indexOf('set') !== -1) typeClass = ' audit-entry--add';
    else if (a.indexOf('updated') !== -1 || a.indexOf('edited') !== -1 || a.indexOf('modified') !== -1 || a.indexOf('changed') !== -1) typeClass = ' audit-entry--edit';
    else if (a.indexOf('removed') !== -1 || a.indexOf('deleted') !== -1 || a.indexOf('retired') !== -1 || a.indexOf('cleared') !== -1) typeClass = ' audit-entry--remove';
    div.className = 'audit-entry' + typeClass;
    
    const timestamp = new Date(entry.timestamp).toLocaleString();
    const header = document.createElement('div');
    header.className = 'audit-entry__header';
    header.innerHTML = '<span class="audit-entry__action">' + entry.action + '</span><span class="audit-entry__time">' + timestamp + '</span>';
    div.appendChild(header);
    
    const parts = [];
    if(entry.employee) parts.push('<span><strong>Employee:</strong> ' + entry.employee + '</span>');
    if(entry.date) parts.push('<span><strong>Date:</strong> ' + entry.date + '</span>');
    if(entry.oldValue) parts.push('<span><strong>Old:</strong> ' + entry.oldValue + '</span>');
    if(entry.newValue) parts.push('<span><strong>New:</strong> ' + entry.newValue + '</span>');
    if(parts.length) {
      const details = document.createElement('div');
      details.className = 'audit-entry__details';
      details.innerHTML = parts.join('');
      div.appendChild(details);
    }
    container.appendChild(div);
  });
}

function filterAuditLog(){
  renderAuditLog({
    employee: document.getElementById('auditEmployee').value,
    date: document.getElementById('auditDate').value
  });
}

function clearAuditFilter(){
  document.getElementById('auditEmployee').value = '';
  document.getElementById('auditDate').value = '';
  renderAuditLog();
}

/* SETTINGS */
function loadSettings(){
  const assignmentStyle = settings.assignmentStyle || 'strict';
  const radioButtons = document.querySelectorAll('input[name="assignmentStyle"]');
  radioButtons.forEach(radio => {
    radio.checked = radio.value === assignmentStyle;
  });
  var ratioEl = document.getElementById('settingsCashierRatio');
  if (ratioEl) ratioEl.value = (settings.cashierRecommendationRatio != null ? settings.cashierRecommendationRatio : 150);
  var hmMode = (settings.housemenRecommendationMode === 'flat') ? 'flat' : 'per_guests';
  var modeRadios = document.querySelectorAll('input[name="housemenRatioMode"]');
  modeRadios.forEach(function(r) { r.checked = (r.value === hmMode); });
  var hmPerGuests = document.getElementById('settingsHousemenPerGuests');
  if (hmPerGuests) hmPerGuests.value = (settings.housemenPerGuests != null && settings.housemenPerGuests >= 1) ? settings.housemenPerGuests : 100;
  var hmFlat = document.getElementById('settingsHousemenFlat');
  if (hmFlat) hmFlat.value = (settings.housemenFlatCount != null && settings.housemenFlatCount >= 0) ? settings.housemenFlatCount : 2;
  renderLaborPoolsTable();
  renderEventTypesTable();
}

function renderLaborPoolsTable() {
  var tbody = document.getElementById('laborPoolsTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  laborPools.forEach(function(p) {
    var tr = document.createElement('tr');
    tr.setAttribute('data-labor-pool-id', p.id);
    tr.innerHTML =
      '<td>' + (p.name || '') + '</td>' +
      '<td>' + (p.defaultHourlyWage != null ? p.defaultHourlyWage : 0) + '</td>' +
      '<td class="event-type-active-cell"><input type="checkbox" ' + (p.canBeScheduled !== false ? 'checked' : '') + ' onchange="toggleLaborPoolCanSchedule(\'' + p.id + '\')" /></td>' +
      '<td class="event-type-active-cell"><input type="checkbox" ' + (p.appearsInEvents !== false ? 'checked' : '') + ' onchange="toggleLaborPoolAppearsInEvents(\'' + p.id + '\')" /></td>' +
      '<td class="event-type-actions-cell"><span class="event-type-actions"><button type="button" onclick="openLaborPoolModal(\'' + p.id + '\')">Edit</button><button type="button" onclick="deleteLaborPool(\'' + p.id + '\')">Delete</button></span></td>';
    tbody.appendChild(tr);
  });
}

function openLaborPoolModal(editId) {
  document.getElementById('laborPoolModalTitle').textContent = editId ? 'Edit labor pool' : 'Add labor pool';
  document.getElementById('laborPoolEditId').value = editId || '';
  if (editId) {
    var p = getLaborPoolById(editId);
    if (p) {
      document.getElementById('laborPoolName').value = p.name || '';
      document.getElementById('laborPoolWage').value = p.defaultHourlyWage != null ? p.defaultHourlyWage : 0;
      document.getElementById('laborPoolCanSchedule').checked = p.canBeScheduled !== false;
      document.getElementById('laborPoolAppearsInEvents').checked = p.appearsInEvents !== false;
    }
  } else {
    document.getElementById('laborPoolName').value = '';
    document.getElementById('laborPoolWage').value = 0;
    document.getElementById('laborPoolCanSchedule').checked = true;
    document.getElementById('laborPoolAppearsInEvents').checked = true;
  }
  document.getElementById('laborPoolModalOverlay').style.display = 'flex';
  setTimeout(function(){ var el = document.getElementById('laborPoolName'); if(el) el.focus(); }, 50);
  function onLaborPoolKey(e) {
    if (e.key === 'Escape') { closeLaborPoolModal(); remove(); }
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); saveLaborPoolFromModal(); }
  }
  function remove() {
    document.removeEventListener('keydown', onLaborPoolKey);
  }
  document.addEventListener('keydown', onLaborPoolKey);
  document.getElementById('laborPoolModalOverlay')._modalCleanup = remove;
}

function closeLaborPoolModal() {
  document.getElementById('laborPoolModalOverlay').style.display = 'none';
  if (document.getElementById('laborPoolModalOverlay')._modalCleanup) {
    document.getElementById('laborPoolModalOverlay')._modalCleanup();
  }
}

function saveLaborPoolFromModal() {
  var name = document.getElementById('laborPoolName').value.trim();
  var wage = parseFloat(document.getElementById('laborPoolWage').value, 10);
  if (isNaN(wage) || wage < 0) wage = 0;
  var editId = document.getElementById('laborPoolEditId').value;
  var canSchedule = document.getElementById('laborPoolCanSchedule').checked;
  var appearsInEvents = document.getElementById('laborPoolAppearsInEvents').checked;
  if (!name) { alert('Please enter a name.'); return; }
  if (editId) {
    var p = getLaborPoolById(editId);
    if (p) { p.name = name; p.defaultHourlyWage = wage; p.canBeScheduled = canSchedule; p.appearsInEvents = appearsInEvents; }
  } else {
    laborPools.push({ id: crypto.randomUUID(), name: name, defaultHourlyWage: wage, canBeScheduled: canSchedule, appearsInEvents: appearsInEvents });
  }
  save();
  renderLaborPoolsTable();
  closeLaborPoolModal();
  populateLaborPoolDropdowns();
}

function toggleLaborPoolCanSchedule(id) {
  var p = getLaborPoolById(id);
  if (p) { p.canBeScheduled = !p.canBeScheduled; save(); renderLaborPoolsTable(); }
}

function toggleLaborPoolAppearsInEvents(id) {
  var p = getLaborPoolById(id);
  if (p) { p.appearsInEvents = !p.appearsInEvents; save(); renderLaborPoolsTable(); }
}

function deleteLaborPool(id) {
  var p = getLaborPoolById(id);
  if (!p) return;
  if (p.id === DEFAULT_SERVERS_POOL_ID) {
    alert('The default Servers pool cannot be deleted.');
    return;
  }
  if (isLaborPoolUsedByEmployees(p)) {
    alert('This labor pool cannot be deleted because one or more employees are assigned to it. Reassign them in the Employees tab first.');
    return;
  }
  if (!confirm('Delete labor pool "' + p.name + '"?')) return;
  laborPools = laborPools.filter(function(x) { return x.id !== id; });
  save();
  renderLaborPoolsTable();
  populateLaborPoolDropdowns();
}

function populateLaborPoolDropdowns() {
  var sel = document.getElementById('empLaborPool');
  if (sel) {
    var cur = sel.value;
    sel.innerHTML = '';
    laborPools.forEach(function(p) {
      var opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name || p.id;
      sel.appendChild(opt);
    });
    if (cur && getLaborPoolById(cur)) sel.value = cur;
    else if (sel.options.length) sel.selectedIndex = 0;
  }
  var editSel = document.getElementById('employeeEditLaborPool');
  if (editSel) {
    var curEdit = editSel.value;
    editSel.innerHTML = '';
    laborPools.forEach(function(p) {
      var opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name || p.id;
      editSel.appendChild(opt);
    });
    if (curEdit && getLaborPoolById(curEdit)) editSel.value = curEdit;
    else if (editSel.options.length) editSel.selectedIndex = 0;
  }
}

function renderEventTypesTable(){
  const tbody = document.getElementById('eventTypesTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  eventTypes.forEach(function(t){
    const tr = document.createElement('tr');
    tr.setAttribute('data-event-type-id', t.id);
    if (!t.active) tr.style.opacity = '0.6';
    tr.innerHTML =
      '<td>' + (t.name || '') + '</td>' +
      '<td>1 per ' + t.guestsPerServer + ' guests</td>' +
      '<td class="event-type-active-cell"><input type="checkbox" ' + (t.active ? 'checked' : '') + ' onchange="toggleEventTypeActive(\'' + t.id + '\')" /></td>' +
      '<td class="event-type-actions-cell"><span class="event-type-actions"><button type="button" onclick="openEventTypeModal(\'' + t.id + '\')">Edit</button><button type="button" onclick="deleteEventType(\'' + t.id + '\')">Delete</button></span></td>';
    tbody.appendChild(tr);
  });
}

function openEventTypeModal(editId){
  document.getElementById('eventTypeModalTitle').textContent = editId ? 'Edit event type' : 'Add event type';
  document.getElementById('eventTypeEditId').value = editId || '';
  if (editId) {
    var t = getEventTypeById(editId);
    if (t) {
      document.getElementById('eventTypeName').value = t.name || '';
      document.getElementById('eventTypeGuestsPerServer').value = t.guestsPerServer || 20;
    }
  } else {
    document.getElementById('eventTypeName').value = '';
    document.getElementById('eventTypeGuestsPerServer').value = 20;
  }
  document.getElementById('eventTypeModalOverlay').style.display = 'flex';
  setTimeout(function(){ var el = document.getElementById('eventTypeName'); if(el) el.focus(); }, 50);
  function onEventTypeKey(e) {
    if (e.key === 'Escape') { closeEventTypeModal(); remove(); }
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); saveEventTypeFromModal(); }
  }
  function remove() {
    document.removeEventListener('keydown', onEventTypeKey);
  }
  document.addEventListener('keydown', onEventTypeKey);
  document.getElementById('eventTypeModalOverlay')._modalCleanup = remove;
}

function closeEventTypeModal(){
  document.getElementById('eventTypeModalOverlay').style.display = 'none';
  if (document.getElementById('eventTypeModalOverlay')._modalCleanup) {
    document.getElementById('eventTypeModalOverlay')._modalCleanup();
  }
}

function saveEventTypeFromModal(){
  var name = document.getElementById('eventTypeName').value.trim();
  var guestsPerServer = parseInt(document.getElementById('eventTypeGuestsPerServer').value, 10) || 20;
  var editId = document.getElementById('eventTypeEditId').value;
  if (!name) { alert('Please enter a name.'); return; }
  if (guestsPerServer < 1) { alert('Guests per server must be at least 1.'); return; }
  if (editId) {
    var t = getEventTypeById(editId);
    if (t) { t.name = name; t.guestsPerServer = guestsPerServer; }
  } else {
    eventTypes.push({ id: crypto.randomUUID(), name: name, guestsPerServer: guestsPerServer, active: true });
  }
  save();
  renderEventTypesTable();
  closeEventTypeModal();
  populateEventServiceDropdown();
}

function toggleEventTypeActive(id){
  var t = getEventTypeById(id);
  if (t) { t.active = !t.active; save(); renderEventTypesTable(); populateEventServiceDropdown(); }
}

function deleteEventType(id){
  var t = getEventTypeById(id);
  if (!t) return;
  if (isEventTypeUsedByEvents(t)) {
    alert('This event type cannot be deleted because it is used by one or more events. Disable it instead to hide it from new events.');
    return;
  }
  if (!confirm('Delete event type "' + t.name + '"?')) return;
  eventTypes = eventTypes.filter(function(x) { return x.id !== id; });
  save();
  renderEventTypesTable();
  populateEventServiceDropdown();
}

function saveSettings(){
  // Save assignment style
  const selectedStyle = document.querySelector('input[name="assignmentStyle"]:checked');
  if(selectedStyle) {
    settings.assignmentStyle = selectedStyle.value;
  }
  var ratioEl = document.getElementById('settingsCashierRatio');
  if (ratioEl) {
    var n = parseInt(ratioEl.value, 10);
    settings.cashierRecommendationRatio = (!isNaN(n) && n >= 1) ? n : 150;
  }
  var hmModeRadio = document.querySelector('input[name="housemenRatioMode"]:checked');
  settings.housemenRecommendationMode = (hmModeRadio && hmModeRadio.value === 'flat') ? 'flat' : 'per_guests';
  var hmPerGuests = document.getElementById('settingsHousemenPerGuests');
  if (hmPerGuests) {
    n = parseInt(hmPerGuests.value, 10);
    settings.housemenPerGuests = (!isNaN(n) && n >= 1) ? n : 100;
  }
  var hmFlat = document.getElementById('settingsHousemenFlat');
  if (hmFlat) {
    n = parseInt(hmFlat.value, 10);
    settings.housemenFlatCount = (!isNaN(n) && n >= 0) ? n : 2;
  }
  save();
  alert('Settings saved!');
}

function clearAllData() {
  var msg = 'This will permanently delete ALL data:\n\n' +
    '‚Ä¢ All employees\n‚Ä¢ All events\n‚Ä¢ All schedules (every week)\n‚Ä¢ Audit log\n‚Ä¢ Assignment explanations\n\n' +
    'Settings will be restored to defaults.\n\n' +
    'This cannot be undone. Are you sure you want to clear everything?';
  if (!confirm(msg)) return;
  employees = [];
  events = [];
  manualEdits = {};
  lockedCells = {};
  lockedRows = {};
  scheduleGlobalLock = false;
  auditLog = [];
  assignmentReasons = {};
  assignmentReasonTags = {};
  assignmentReasonCodes = {};
  generationConflicts = [];
  lastOvertimeSuggestions = [];
  lastScheduleNeedsReview = false;
  editingEventId = null;
  currentWeekOffset = 0;
  settings = {
    assignmentStyle: 'strict',
    ratios: {
      'Plated Service': 20,
      'Buffet Service': 30,
      'Reception': 40,
      'Coffee Break': 50
    }
  };
  eventTypes = getDefaultEventTypes();
  laborPools = getDefaultLaborPools();
  save();
  var conflictBtn = document.getElementById('conflictReportBtn');
  if (conflictBtn) { conflictBtn.style.display = 'none'; conflictBtn.textContent = '‚ö† Conflicts'; }
  renderEmployees();
  renderEvents();
  displaySchedule();
  loadSettings();
  showTab('employeesTab');
  alert('All data has been permanently deleted. The app is now in a fresh state.');
}

/* SUPPORT / CONTACT */
function submitSupport(){
  const category = document.getElementById('supportCategory').value;
  const subject = document.getElementById('supportSubject').value.trim();
  const message = document.getElementById('supportMessage').value.trim();
  const feedback = document.getElementById('supportFeedback');
  feedback.classList.remove('success', 'error', 'visible');
  
  if(!subject) {
    feedback.className = 'support-feedback error visible';
    feedback.innerHTML = 'Please enter a subject.';
    feedback.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    return;
  }
  if(!message) {
    feedback.className = 'support-feedback error visible';
    feedback.innerHTML = 'Please enter a message.';
    feedback.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    return;
  }
  
  var emailSubject = '[BanquetLogic ' + category + '] ' + subject;
  var emailBody = 'Category: ' + category + '\n\n' + message + '\n\n---\nSent from BanquetLogic Scheduler';
  var mailtoLink = 'mailto:Alialannoon@gmail.com?subject=' + encodeURIComponent(emailSubject) + '&body=' + encodeURIComponent(emailBody);
  window.location.href = mailtoLink;
  
  feedback.className = 'support-feedback success visible';
  feedback.innerHTML = 'Your message is ready. Your email client should open-please click Send there to complete your submission. We\'ll reply as soon as we can.';
  feedback.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  setTimeout(function(){
    document.getElementById('supportSubject').value = '';
    document.getElementById('supportMessage').value = '';
    document.getElementById('supportCategory').value = 'Bug';
  }, 2000);
  
  addAuditEntry('Support Request', null, null, null, category + ': ' + subject);
  save();
}

/* INIT */
try {
  initEmployeeEditModal();
  initAbsenceModal();
  updateSeniorityPreFill();
  renderEmployees();
  renderEvents();
  showTab("employeesTab");
} catch(error) {
  console.error('Initialization error:', error);
  alert('BanquetLogic could not load. Please refresh the page.\n\nDetails: ' + error.message);
}

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seniority Scheduler</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:system-ui;background:#f3f6fb;margin:0;padding:20px}
h1{margin-bottom:10px}
.tabs{display:flex;gap:10px;margin-bottom:20px}
.tab{padding:10px 16px;background:#e5e7eb;border-radius:8px;cursor:pointer;font-weight:600}
.tab.active{background:#2563eb;color:white}
.card{background:white;border-radius:10px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.05);margin-bottom:20px}
button{padding:8px 14px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
.primary{background:#2563eb;color:white}
.secondary{background:#e5e7eb}
.danger{background:#dc2626;color:white}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
th{background:#eef2ff}
.employee{font-weight:700;text-align:left;background:#f9fafb}
.shift-4{background:#c8f7c5}
.shift-6{background:#ffd59e}
.shift-8{background:#fff3a0}
.shift-ot{background:#d5b3ff}
.shift-sick{background:#b3d9ff;font-weight:700}
.vacation{background:#e5e7eb;color:#6b7280;font-style:italic}
.hidden{display:none}
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4)}
#editor{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:12px;width:320px}
</style>
</head>

<body>

<h1>Seniority Scheduler</h1>

<div class="tabs">
  <div class="tab active" onclick="showTab('schedule')">Schedule</div>
  <div class="tab" onclick="showTab('events')">Events</div>
  <div class="tab" onclick="showTab('employees')">Employees</div>
  <div class="tab" onclick="showTab('timeoff')">Time Off</div>
</div>

<!-- SCHEDULE -->
<div id="schedule" class="card">
  <button class="primary" onclick="generateSchedule()">Generate Schedule</button>
  <button class="secondary" onclick="exportPDF()">Export PDF</button>
  <h2 id="scheduleHeader"></h2>
  <div id="scheduleTable"></div>
</div>

<!-- EVENTS -->
<div id="events" class="card hidden">
  <h2>Events</h2>
  <input id="evDate" type="date">
  <input id="evStart" type="time">
  <input id="evEnd" type="time">
  <input id="evGuests" type="number" placeholder="Guests">
  <button class="primary" onclick="addEvent()">Add Event</button>
  <ul id="eventList"></ul>
</div>

<!-- EMPLOYEES -->
<div id="employees" class="card hidden">
  <h2>Employees</h2>
  <input id="empName" placeholder="Name">
  <select id="empType">
    <option value="FT">Full-Time</option>
    <option value="PT">Part-Time</option>
  </select>
  <select id="empPref">
    <option value="morning">Morning</option>
    <option value="midday">Midday</option>
    <option value="night">Night</option>
  </select>
  <button class="primary" onclick="addEmployee()">Add Employee</button>
  <ul id="employeeList"></ul>
</div>

<!-- TIME OFF -->
<div id="timeoff" class="card hidden">
  <h2>Vacation</h2>
  <select id="vacEmp"></select>
  <input id="vacStart" type="date">
  <input id="vacEnd" type="date">
  <button class="primary" onclick="addVacation()">Add Vacation</button>
</div>

<div id="overlay"></div>

<div id="editor">
  <h3>Edit Day</h3>
  <label><input type="radio" name="dayType" value="shift" checked> Shift</label>
  <label><input type="radio" name="dayType" value="sick"> Sick</label>
  <div>
    <input id="editStart" type="time">
    <input id="editEnd" type="time">
    <label><input type="checkbox" id="editOT"> OT</label>
  </div>
  <button class="primary" onclick="saveEdit()">Save</button>
  <button class="secondary" onclick="closeEditor()">Cancel</button>
</div>

<script>
const { jsPDF } = window.jspdf;

let employees=JSON.parse(localStorage.getItem("employees"))||[];
let events=JSON.parse(localStorage.getItem("events"))||[];
let scheduleData=JSON.parse(localStorage.getItem("scheduleData"))||{};
let editTarget=null;

function saveAll(){
  localStorage.setItem("employees",JSON.stringify(employees));
  localStorage.setItem("events",JSON.stringify(events));
  localStorage.setItem("scheduleData",JSON.stringify(scheduleData));
}

function showTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  [...document.querySelectorAll('.tab')].find(t=>t.textContent.toLowerCase()===id).classList.add('active');
}

function normalizeSeniority(){
  let ft=employees.filter(e=>e.type==="FT");
  let pt=employees.filter(e=>e.type==="PT");
  employees=[...ft,...pt];
  employees.forEach((e,i)=>e.seniority=i+1);
}

function addEmployee(){
  employees.push({
    name:empName.value,
    type:empType.value,
    preference:empPref.value,
    seniority:0,
    vacations:[]
  });
  normalizeSeniority();
  saveAll();
  renderEmployees();
}

function addEvent(){
  events.push({date:evDate.value,start:evStart.value,end:evEnd.value,guests:+evGuests.value});
  saveAll();
  renderEvents();
}

function addVacation(){
  let emp=employees.find(e=>e.name===vacEmp.value);
  emp.vacations.push({start:vacStart.value,end:vacEnd.value});
  saveAll();
}

function eventPreference(start){
  let h=parseInt(start.split(":")[0]);
  if(h<12) return "morning";
  if(h<15) return "midday";
  return "night";
}

function generateSchedule(){
  scheduleData={};
  employees.forEach(e=>scheduleData[e.name]={});

  events.forEach(ev=>{
    let need=ev.guests<=50?2:ev.guests<=150?4:ev.guests<=300?6:8;
    let pref=eventPreference(ev.start);

    let ordered=[
      ...employees.filter(e=>e.preference===pref),
      ...employees.filter(e=>e.preference!==pref)
    ];

    ordered.forEach(emp=>{
      if(need<=0) return;
      if(emp.vacations.some(v=>ev.date>=v.start&&ev.date<=v.end)) return;
      if(scheduleData[emp.name][ev.date]) return;

      let paid=Math.max(4,Math.min(8,(new Date(ev.date+"T"+ev.end)-new Date(ev.date+"T"+ev.start))/3600000));
      let schedH=paid>4?paid+0.5:paid;

      scheduleData[emp.name][ev.date]={type:"shift",start:ev.start,end:ev.end,paid,schedH,ot:false};
      need--;
    });
  });

  saveAll();
  renderSchedule();
}

function getWeek(){
  let t=new Date();
  let m=new Date(t);m.setDate(t.getDate()-((t.getDay()+6)%7));
  return [...Array(7)].map((_,i)=>{let d=new Date(m);d.setDate(m.getDate()+i);return d.toISOString().split("T")[0];});
}

function renderSchedule(){
  let week=getWeek();
  scheduleHeader.textContent=new Date(week[0]).toLocaleString("default",{month:"long",year:"numeric"});
  let html="<table><tr><th>Employee</th>";
  week.forEach(d=>html+=`<th>${new Date(d).toLocaleDateString("default",{weekday:"short"})}</th>`);
  html+="</tr>";

  employees.forEach(emp=>{
    html+=`<tr><td class="employee">#${emp.seniority} ${emp.name}</td>`;
    week.forEach(d=>{
      let sh=scheduleData[emp.name]?.[d];
      if(sh){
        html+=`<td class="${sh.type==="sick"?"shift-sick":sh.ot?"shift-ot":"shift-"+sh.paid}" onclick="openEditor('${emp.name}','${d}')">
        ${sh.type==="sick"?"SICK":`${sh.start}-${sh.end}<br>${sh.schedH}h`}
        </td>`;
      }else html+=`<td onclick="openEditor('${emp.name}','${d}')"></td>`;
    });
    html+="</tr>";
  });
  scheduleTable.innerHTML=html+"</table>";
}

function openEditor(n,d){
  editTarget={n,d};
  overlay.style.display=editor.style.display="block";
}

function closeEditor(){
  overlay.style.display=editor.style.display="none";
}

function saveEdit(){
  let type=document.querySelector('input[name="dayType"]:checked').value;
  if(type==="sick"){
    scheduleData[editTarget.n][editTarget.d]={type:"sick"};
  }
  saveAll();closeEditor();renderSchedule();
}

function exportPDF(){
  let doc=new jsPDF({orientation:"landscape"});
  doc.html(scheduleTable,{callback:()=>doc.save("schedule.pdf"),x:10,y:10,width:270});
}

function renderEmployees(){
  employeeList.innerHTML="";
  employees.forEach(e=>{
    employeeList.innerHTML+=`<li>#${e.seniority} ${e.name} (${e.type}) â€“ ${e.preference}</li>`;
  });
  vacEmp.innerHTML=employees.map(e=>`<option>${e.name}</option>`).join("");
}

function renderEvents(){
  eventList.innerHTML="";
  events.forEach((e,i)=>{
    eventList.innerHTML+=`<li>${e.date} ${e.start}-${e.end} (${e.guests}) <button class="danger" onclick="events.splice(${i},1);saveAll();renderEvents()">X</button></li>`;
  });
}

renderEmployees();
renderEvents();
renderSchedule();
</script>

</body>
</html>

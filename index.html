<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Seniority Scheduler Dashboard</title>

<style>
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin: 20px;
  background: #1e1e2f;
  color: #f0f0f0;
}
body.light-mode { background:#f8f9fa; color:#333; }

h1 { font-size:26px; }

/* TABS */
.tabs { display:flex; gap:6px; margin-bottom:12px; }
.tabs button {
  padding:8px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#2e2e3d;
  color:#ccc;
}
.tabs button.active { background:#4e9af1; color:#fff; }

/* INPUTS */
input, select, button {
  margin:4px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
}
button { background:#4e9af1; color:#fff; font-weight:bold; }
button.delete { background:#c0392b; }
button.retire { background:#8e44ad; }
button.print { background:#27ae60; }

/* TABLE */
table { border-collapse:collapse; width:100%; margin-top:10px; }
th, td {
  padding:8px;
  text-align:center;
  border:1px solid #555;
}
th { background:#4e9af1; color:#fff; }

/* SHIFTS */
.shift-4 { background:#2ecc71; }
.shift-6 { background:#e67e22; }
.shift-65 { background:#f1c40f; color:#000; }
.shift-85 { background:#9b59b6; }

/* CLICKABLE */
td[onclick] { cursor:pointer; }
td[onclick]:hover { outline:2px dashed #4e9af1; }

/* PRINT */
@media print {
  body { background:#fff; color:#000; }
  .tabs, button, input, select { display:none !important; }
  th { background:#ddd !important; color:#000 !important; }
}

.tab { display:none; }
.tab.active { display:block; }
</style>
</head>

<body>

<h1 id="weekHeader"></h1>
<button onclick="toggleDarkMode()">Toggle Dark Mode</button>
<button class="print" onclick="printSchedule()">Print / Save PDF</button>

<div class="tabs">
  <button id="tabEmpBtn" onclick="showTab('employeesTab')">Employees</button>
  <button id="tabEvBtn" onclick="showTab('eventsTab')">Events</button>
  <button id="tabSchBtn" onclick="showTab('scheduleTab')">Schedule</button>
</div>

<div id="employeesTab" class="tab"></div>
<div id="eventsTab" class="tab"></div>
<div id="scheduleTab" class="tab">
  <button onclick="changeWeek(-1)">⬅ Prev</button>
  <button onclick="changeWeek(1)">Next ➡</button>
  <button onclick="generateSchedule()">Generate</button>
  <button onclick="generateSchedule()">Regenerate</button>
  <table id="scheduleTable"></table>
</div>

<script>
let employees = JSON.parse(localStorage.getItem("employees")||"[]");
let events = JSON.parse(localStorage.getItem("events")||"[]");
let manualEdits = JSON.parse(localStorage.getItem("manualEdits")||"{}");
let currentWeekOffset = 0;

function save(){
  localStorage.setItem("employees",JSON.stringify(employees));
  localStorage.setItem("events",JSON.stringify(events));
  localStorage.setItem("manualEdits",JSON.stringify(manualEdits));
}

/* ---------- TIME HELPERS ---------- */
function roundToHalfHour(d){
  const m=d.getMinutes();
  if(m<15) d.setMinutes(0);
  else if(m<45) d.setMinutes(30);
  else { d.setMinutes(0); d.setHours(d.getHours()+1); }
  d.setSeconds(0);
  return d;
}

function timeStr(d){ return d.toTimeString().slice(0,5); }

function getShiftClass(h){
  if(h===4) return "shift-4";
  if(h===6) return "shift-6";
  if(h===6.5 || h===8) return "shift-65";
  return "shift-85";
}

/* ---------- SHIFT LOGIC (SINGLE SOURCE OF TRUTH) ---------- */
function calculateSmartShift(ev, paidHours){
  let buffer = ev.guests >= 200 ? 2 : 1;
  let baseStart = new Date(`1970-01-01T${ev.start}`);
  let baseEnd   = new Date(`1970-01-01T${ev.end}`);

  let workHours = paidHours > 4 ? paidHours - 0.5 : paidHours;

  let s1 = new Date(baseStart); s1.setHours(s1.getHours()-buffer);
  let e1 = new Date(s1); e1.setHours(e1.getHours()+workHours);

  let e2 = new Date(baseEnd); e2.setHours(e2.getHours()+buffer);
  let s2 = new Date(e2); s2.setHours(s2.getHours()-workHours);

  s1=roundToHalfHour(s1); e1=roundToHalfHour(e1);
  s2=roundToHalfHour(s2); e2=roundToHalfHour(e2);

  let d1=Math.abs(s1-baseStart)+Math.abs(e1-baseEnd);
  let d2=Math.abs(s2-baseStart)+Math.abs(e2-baseEnd);

  return d1<=d2?{start:s1,end:e1}:{start:s2,end:e2};
}

/* ---------- SCHEDULE ---------- */
const iso=d=>d.toISOString().split("T")[0];

function getWeekStart(){
  let d=new Date();
  d.setDate(d.getDate()+currentWeekOffset*7);
  let diff=d.getDay()===0?-6:1-d.getDay();
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d;
}

function generateSchedule(){
  const table=document.getElementById("scheduleTable");
  table.innerHTML="";
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{let d=new Date(start);d.setDate(start.getDate()+i);return d;});
  weekHeader.textContent=`${days[0].toLocaleDateString()} – ${days[6].toLocaleDateString()}`;

  table.innerHTML="<tr><th>Employee</th>"+days.map(d=>`<th>${d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"})}</th>`).join("")+"<th>Total</th></tr>";

  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0,row=`<tr><td>${emp.name}</td>`;
    days.forEach(d=>{
      const key=emp.id+"_"+iso(d);
      if(manualEdits[key]){
        total+=manualEdits[key];
        row+=`<td class="${getShiftClass(manualEdits[key])}" onclick="editCell('${emp.id}','${iso(d)}')">${manualEdits[key]}h</td>`;
        return;
      }

      const ev=events.find(e=>e.date===iso(d));
      if(!ev){ row+=`<td onclick="editCell('${emp.id}','${iso(d)}')"></td>`; return; }

      let paid=ev.staff? (ev.staff<=4?4:ev.staff<=6?6:ev.staff<=7?6.5:8.5):6.5;
      let shift=calculateSmartShift(ev,paid);
      total+=paid;

      row+=`<td class="${getShiftClass(paid)}" onclick="editCell('${emp.id}','${iso(d)}')">
        ${paid}h<br><small>${timeStr(shift.start)}–${timeStr(shift.end)}</small>
      </td>`;
    });
    row+=`<td><strong>${total}h</strong></td></tr>`;
    table.innerHTML+=row;
  });
}

function editCell(empId,date){
  const key=empId+"_"+date;
  const v=prompt("Enter hours (4,5.5,6.5,7.5,8.5) or blank to remove",manualEdits[key]||"");
  if(v===null) return;
  if(v==="") delete manualEdits[key];
  else manualEdits[key]=Number(v);
  save(); generateSchedule();
}

function changeWeek(n){ currentWeekOffset+=n; generateSchedule(); }
function toggleDarkMode(){ document.body.classList.toggle("light-mode"); }
function printSchedule(){ setTimeout(()=>window.print(),200); }

generateSchedule();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Seniority Scheduler Dashboard</title>

<style>
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin: 20px;
  background: #1e1e2f;
  color: #f0f0f0;
}
body.light-mode { background:#f8f9fa; color:#333; }

h1 { font-size:26px; }

/* TABS */
.tabs { display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap; }
.tabs button {
  padding:8px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#2e2e3d;
  color:#ccc;
}
.tabs button.active { background:#4e9af1; color:#fff; }

/* INPUTS */
input, select, button {
  margin:4px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
}
button { background:#4e9af1; color:#fff; font-weight:bold; cursor:pointer; }
button.delete { background:#c0392b; }
button.retire { background:#8e44ad; }
button.print { background:#27ae60; }

/* TABLE */
table { border-collapse:collapse; width:100%; margin-top:10px; }
th, td {
  padding:8px;
  text-align:center;
  border:1px solid #555;
  position:relative;
}
th { background:#4e9af1; color:#fff; }

/* STATUS */
.status-retired { background:#555; opacity:0.6; }

/* SHIFTS */
.shift-4 { background:#2ecc71; }      /* Green - 4 hours */
.shift-5 { background:#3498db; }      /* Blue - 5 hours */
.shift-6 { background:#e67e22; }      /* Orange - 6 hours */
.shift-7 { background:#e91e63; }      /* Pink - 7 hours */
.shift-8 { background:#f1c40f; color:#000; }  /* Yellow - 8 hours */
.shift-ot { background:#9b59b6; }     /* Purple - overtime (>8) */

/* LOCKED CELLS */
.locked-cell {
  border: 3px solid #f39c12 !important;
  position: relative;
}
.locked-cell::after {
  content: 'üîí';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 10px;
}

/* CONFLICT CELLS */
.conflict-cell {
  border: 3px solid #e74c3c !important;
  position: relative;
}
.conflict-cell::before {
  content: '‚ö†Ô∏è';
  position: absolute;
  top: 2px;
  left: 2px;
  font-size: 10px;
}

/* CLICKABLE CELLS */
td[onclick], td.clickable { cursor:pointer; }
td[onclick]:hover, td.clickable:hover { outline:2px dashed #4e9af1; }

/* TOOLTIP */
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 12px;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

/* AUDIT LOG */
.audit-entry {
  padding: 8px;
  margin: 4px 0;
  background: #2e2e3d;
  border-radius: 4px;
  font-size: 13px;
}
.audit-filters {
  margin-bottom: 15px;
}

/* PRINT */
@media print {
  body { background:#fff; color:#000; }
  .tabs, button, input, select { display:none !important; }
  table { font-size:12px; }
  th { background:#ddd !important; color:#000 !important; }
  .locked-cell::after, .conflict-cell::before { display: none; }
}

/* TABS */
.tab { display:none; }
.tab.active { display:block; }

/* SETTINGS */
.settings-section {
  margin: 20px 0;
  padding: 15px;
  background: #2e2e3d;
  border-radius: 8px;
}
.settings-section h3 {
  margin-top: 0;
}
.setting-row {
  margin: 10px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
.setting-row label {
  min-width: 150px;
}
.setting-row input {
  width: 100px;
}
</style>
</head>

<body>

<h1 id="weekHeader"></h1>

<button onclick="toggleDarkMode()">Toggle Dark Mode</button>
<button class="print" onclick="printSchedule()">Print / Save PDF</button>

<div class="tabs">
  <button id="tabEmpBtn" onclick="showTab('employeesTab')">Employees</button>
  <button id="tabEvBtn" onclick="showTab('eventsTab')">Events</button>
  <button id="tabSchBtn" onclick="showTab('scheduleTab')">Schedule</button>
  <button id="tabAuditBtn" onclick="showTab('auditTab')">Audit Log</button>
  <button id="tabSettingsBtn" onclick="showTab('settingsTab')">Settings</button>
</div>

<!-- EMPLOYEES -->
<div id="employeesTab" class="tab">
<h2>Employees</h2>

<input id="empName" placeholder="Name" />
<select id="empType"><option>FT</option><option>PT</option></select>
<input id="empSeniority" type="number" placeholder="Seniority" />
<select id="empPref">
  <option value="">No Pref</option>
  <option value="AM">AM</option>
  <option value="PM">PM</option>
</select>
<button onclick="addEmployee()">Add</button>

<table>
<thead>
<tr>
  <th>Name</th><th>Type</th><th>Seniority</th><th>Pref</th>
  <th>Vacation</th><th>Sick</th><th>Retire</th>
</tr>
</thead>
<tbody id="employeesTable"></tbody>
</table>
</div>

<!-- EVENTS -->
<div id="eventsTab" class="tab">
<h2>Events</h2>

<input id="eventName" placeholder="Event Name" />
<input id="eventDate" type="date" />
<input id="eventStart" type="time" onchange="autoRecommendStaff()" />
<input id="eventEnd" type="time" onchange="autoRecommendStaff()" />
<input id="eventGuests" type="number" placeholder="Guests" oninput="autoRecommendStaff()" />

<select id="eventService" onchange="autoRecommendStaff()">
  <option>Plated Service</option>
  <option>Buffet Service</option>
  <option>Reception</option>
  <option>Coffee Break</option>
</select>

<input id="eventStaff" type="number" placeholder="Staff Needed" />
<button onclick="addEvent()">Add / Save</button>

<table>
<thead>
<tr>
  <th>Name</th><th>Date</th><th>Time</th>
  <th>Guests</th><th>Service</th><th>Staff</th>
  <th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="eventsTable"></tbody>
</table>
</div>

<!-- SCHEDULE -->
<div id="scheduleTab" class="tab">
<h2>Schedule</h2>

<button onclick="changeWeek(-1)">‚¨Ö Previous Week</button>
<button onclick="changeWeek(1)">Next Week ‚û°</button>
<button onclick="generateSchedule()">Generate</button>
<button onclick="regenerateSchedule()">Regenerate</button>

<table id="scheduleTable"></table>
</div>

<!-- AUDIT LOG -->
<div id="auditTab" class="tab">
<h2>Audit Log</h2>

<div class="audit-filters">
  <input id="auditEmployee" placeholder="Filter by employee" />
  <input id="auditDate" type="date" placeholder="Filter by date" />
  <button onclick="filterAuditLog()">Filter</button>
  <button onclick="clearAuditFilter()">Clear Filter</button>
</div>

<div id="auditLogContainer"></div>
</div>

<!-- SETTINGS -->
<div id="settingsTab" class="tab">
<h2>Settings</h2>

<div class="settings-section">
  <h3>Staffing Ratios</h3>
  <p>Set the recommended number of guests per server for each service type:</p>
  
  <div class="setting-row">
    <label>Plated Service:</label>
    <span>1 server per</span>
    <input type="number" id="ratioPlated" value="20" min="1" />
    <span>guests</span>
  </div>
  
  <div class="setting-row">
    <label>Buffet Service:</label>
    <span>1 server per</span>
    <input type="number" id="ratioBuffet" value="30" min="1" />
    <span>guests</span>
  </div>
  
  <div class="setting-row">
    <label>Reception:</label>
    <span>1 server per</span>
    <input type="number" id="ratioReception" value="40" min="1" />
    <span>guests</span>
  </div>
  
  <div class="setting-row">
    <label>Coffee Break:</label>
    <span>1 server per</span>
    <input type="number" id="ratioCoffee" value="50" min="1" />
    <span>guests</span>
  </div>
  
  <button onclick="saveSettings()">Save Settings</button>
</div>
</div>

<script>
let employees = JSON.parse(localStorage.getItem("employees") || "[]");
let events = JSON.parse(localStorage.getItem("events") || "[]");
let manualEdits = JSON.parse(localStorage.getItem("manualEdits") || "{}");
let lockedCells = JSON.parse(localStorage.getItem("lockedCells") || "{}");
let auditLog = JSON.parse(localStorage.getItem("auditLog") || "[]");
let settings = JSON.parse(localStorage.getItem("settings") || JSON.stringify({
  ratios: {
    "Plated Service": 20,
    "Buffet Service": 30,
    "Reception": 40,
    "Coffee Break": 50
  }
}));
let editingEventId = null;
let currentWeekOffset = 0;

function save(){
  localStorage.setItem("employees", JSON.stringify(employees));
  localStorage.setItem("events", JSON.stringify(events));
  localStorage.setItem("manualEdits", JSON.stringify(manualEdits));
  localStorage.setItem("lockedCells", JSON.stringify(lockedCells));
  localStorage.setItem("auditLog", JSON.stringify(auditLog));
  localStorage.setItem("settings", JSON.stringify(settings));
}

function addAuditEntry(action, empId, date, oldValue, newValue){
  const emp = employees.find(e => e.id === empId);
  auditLog.unshift({
    timestamp: new Date().toISOString(),
    action,
    employee: emp ? emp.name : 'Unknown',
    employeeId: empId,
    date,
    oldValue,
    newValue
  });
  
  // Keep only last 1000 entries
  if(auditLog.length > 1000) auditLog = auditLog.slice(0, 1000);
  
  save();
}

/* TABS */
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="employeesTab") tabEmpBtn.classList.add("active");
  if(id==="eventsTab") tabEvBtn.classList.add("active");
  if(id==="scheduleTab") { tabSchBtn.classList.add("active"); generateSchedule(); }
  if(id==="auditTab") { tabAuditBtn.classList.add("active"); renderAuditLog(); }
  if(id==="settingsTab") { tabSettingsBtn.classList.add("active"); loadSettings(); }
}

/* EMPLOYEES */
function addEmployee(){
  if(!empName.value) return;
  const newEmp = {
    id: crypto.randomUUID(),
    name: empName.value,
    type: empType.value,
    seniority:+empSeniority.value || employees.filter(e=>!e.retired).length + 1,
    pref: empPref.value,
    vacation:false,
    sick:false,
    retired:false
  };
  employees.push(newEmp);
  empName.value = "";
  empSeniority.value = "";
  rebalanceSeniority();
  
  addAuditEntry('Employee Added', newEmp.id, null, null, `${newEmp.name} (${newEmp.type}, Seniority ${newEmp.seniority})`);
  save(); renderEmployees(); generateSchedule();
}

function rebalanceSeniority(){
  employees.filter(e=>!e.retired)
    .sort((a,b)=>a.seniority-b.seniority)
    .forEach((e,i)=>e.seniority=i+1);
}

function retireEmployee(id){
  if(!confirm("Retire this employee?")) return;
  const emp = employees.find(e=>e.id===id);
  emp.retired=true;
  rebalanceSeniority();
  
  addAuditEntry('Employee Retired', id, null, 'Active', 'Retired');
  save(); renderEmployees(); generateSchedule();
}

function renderEmployees(){
  employeesTable.innerHTML="";
  employees.sort((a,b)=>a.seniority-b.seniority).forEach(e=>{
    const row = document.createElement('tr');
    row.className = e.retired ? 'status-retired' : '';
    
    row.innerHTML = `
      <td>${e.name}</td>
      <td>${e.type}</td>
      <td>${e.retired ? '-' : e.seniority}</td>
      <td>${e.pref || "-"}</td>
      <td><input type="checkbox" class="vacation-check" ${e.vacation ? "checked" : ""}></td>
      <td><input type="checkbox" class="sick-check" ${e.sick ? "checked" : ""}></td>
      <td>${e.retired ? "‚Äî" : '<button class="retire">Retire</button>'}</td>
    `;
    
    const vacationCheck = row.querySelector('.vacation-check');
    const sickCheck = row.querySelector('.sick-check');
    const retireBtn = row.querySelector('.retire');
    
    if(vacationCheck) {
      vacationCheck.onchange = function() {
        toggleVacation(e.id, this.checked);
      };
    }
    
    if(sickCheck) {
      sickCheck.onchange = function() {
        toggleSick(e.id, this.checked);
      };
    }
    
    if(retireBtn) {
      retireBtn.onclick = () => retireEmployee(e.id);
    }
    
    employeesTable.appendChild(row);
  });
}

function toggleVacation(id, checked){
  const emp = employees.find(e=>e.id===id);
  emp.vacation=checked;
  addAuditEntry('Vacation Changed', id, null, !checked, checked);
  save(); generateSchedule();
}

function toggleSick(id, checked){
  const emp = employees.find(e=>e.id===id);
  emp.sick=checked;
  addAuditEntry('Sick Status Changed', id, null, !checked, checked);
  save(); generateSchedule();
}

/* EVENTS */
function autoRecommendStaff(){
  const guests=+eventGuests.value;
  if(!guests) return;
  const serviceType = eventService.value;
  const ratio = settings.ratios[serviceType] || 30;
  eventStaff.value=Math.ceil(guests/ratio);
}

function addEvent(){
  if(!eventName.value || !eventDate.value) return;
  const data={
    id: editingEventId || crypto.randomUUID(),
    name:eventName.value,
    date:eventDate.value,
    start:eventStart.value || "09:00",
    end:eventEnd.value || "17:00",
    guests:+eventGuests.value || 0,
    service:eventService.value,
    staff:+eventStaff.value || 1
  };
  
  if(editingEventId){
    const oldEvent = events.find(e=>e.id===editingEventId);
    Object.assign(oldEvent, data);
    addAuditEntry('Event Modified', null, data.date, 
      `${oldEvent.name} (${oldEvent.staff} staff)`,
      `${data.name} (${data.staff} staff)`);
    editingEventId=null;
  } else {
    events.push(data);
    addAuditEntry('Event Created', null, data.date, null, `${data.name} (${data.staff} staff)`);
  }
  
  eventName.value="";
  eventDate.value="";
  eventStart.value="";
  eventEnd.value="";
  eventGuests.value="";
  eventStaff.value="";
  
  save(); renderEvents(); generateSchedule();
}

function renderEvents(){
  eventsTable.innerHTML="";
  events.forEach(ev=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${ev.name}</td>
      <td>${ev.date}</td>
      <td>${ev.start}‚Äì${ev.end}</td>
      <td>${ev.guests}</td>
      <td>${ev.service}</td>
      <td>${ev.staff}</td>
      <td><button class="edit-btn">Edit</button></td>
      <td><button class="delete">Delete</button></td>
    `;
    
    row.querySelector('.edit-btn').onclick = () => editEvent(ev.id);
    row.querySelector('.delete').onclick = () => deleteEvent(ev.id);
    
    eventsTable.appendChild(row);
  });
}

function editEvent(id){
  const e=events.find(x=>x.id===id);
  editingEventId=id;
  eventName.value=e.name;
  eventDate.value=e.date;
  eventStart.value=e.start;
  eventEnd.value=e.end;
  eventGuests.value=e.guests;
  eventService.value=e.service;
  eventStaff.value=e.staff;
}

function deleteEvent(id){
  if(!confirm("Delete event?")) return;
  const ev = events.find(e=>e.id===id);
  events=events.filter(e=>e.id!==id);
  addAuditEntry('Event Deleted', null, ev.date, `${ev.name}`, null);
  save(); renderEvents(); generateSchedule();
}

/* HELPER FUNCTIONS */
const iso=d=>d.toISOString().split("T")[0];

function getWeekStart(){
  const d=new Date();
  d.setDate(d.getDate()+currentWeekOffset*7);
  const diff=d.getDay()===0?-6:1-d.getDay();
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d;
}

function roundToHalfHour(date) {
  const mins = date.getMinutes();
  if (mins < 15) date.setMinutes(0);
  else if (mins < 45) date.setMinutes(30);
  else { date.setMinutes(0); date.setHours(date.getHours() + 1); }
  date.setSeconds(0, 0);
  return date;
}

function timeStr(d){
  return d.toTimeString().slice(0,5);
}

function getShiftClassByHours(h){
  if(h === 4) return "shift-4";
  if(h === 5) return "shift-5";
  if(h === 6) return "shift-6";
  if(h === 7) return "shift-7";
  if(h === 8) return "shift-8";
  if(h > 8) return "shift-ot";
  return "";
}

function calculateSmartShift(ev, paidHours) {
  const baseStart = new Date(`1970-01-01T${ev.start}`);
  const baseEnd   = new Date(`1970-01-01T${ev.end}`);

  let buffer = 1;
  if (ev.guests >= 200) buffer = 2;

  const scheduledHours = paidHours > 4 ? paidHours + 0.5 : paidHours;

  let startA = new Date(baseStart);
  startA.setHours(startA.getHours() - buffer);
  let endA = new Date(startA);
  endA.setMinutes(endA.getMinutes() + (scheduledHours * 60));

  let endB = new Date(baseEnd);
  endB.setHours(endB.getHours() + buffer);
  let startB = new Date(endB);
  startB.setMinutes(startB.getMinutes() - (scheduledHours * 60));

  startA = roundToHalfHour(new Date(startA));
  endA   = roundToHalfHour(new Date(endA));
  startB = roundToHalfHour(new Date(startB));
  endB   = roundToHalfHour(new Date(endB));

  const distA = Math.abs(startA - baseStart) + Math.abs(endA - baseEnd);
  const distB = Math.abs(startB - baseStart) + Math.abs(endB - baseEnd);

  return distA <= distB
    ? { start: startA, end: endA }
    : { start: startB, end: endB };
}

function normalizeHours(start, end){
  const diff=(new Date(`1970-01-01T${end}`)-new Date(`1970-01-01T${start}`))/3600000;
  if(diff<=4) return {h:4};
  if(diff<=5) return {h:5};
  if(diff<=6) return {h:6};
  if(diff<=7) return {h:7};
  if(diff<=8) return {h:8};
  return {h:Math.ceil(diff)};
}

/* CONFLICT DETECTION */
function detectConflicts(empId, date, shiftStart, shiftEnd){
  const conflicts = [];
  
  // Check all shifts for this employee across the week
  const start = getWeekStart();
  const days = [...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
  
  days.forEach(d => {
    const dateStr = iso(d);
    const key = empId + "_" + dateStr;
    
    if(dateStr === date) return; // Skip same day
    
    // Check if employee has a shift on adjacent days
    const edit = manualEdits[key];
    if(edit && edit.start && edit.end) {
      // Check rest time between shifts
      const prevDate = new Date(dateStr);
      const currDate = new Date(date);
      const dayDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);
      
      if(Math.abs(dayDiff) === 1) {
        const prevEnd = new Date(`1970-01-01T${edit.end}`);
        const currStart = new Date(`1970-01-01T${shiftStart}`);
        
        let gap;
        if(dayDiff === 1) {
          // Current is day after
          const prevEndMins = prevEnd.getHours() * 60 + prevEnd.getMinutes();
          const currStartMins = currStart.getHours() * 60 + currStart.getMinutes();
          gap = (1440 - prevEndMins) + currStartMins;
        } else {
          // Current is day before
          const currEndMins = new Date(`1970-01-01T${shiftEnd}`).getHours() * 60 + new Date(`1970-01-01T${shiftEnd}`).getMinutes();
          const prevStartMins = new Date(`1970-01-01T${edit.start}`).getHours() * 60 + new Date(`1970-01-01T${edit.start}`).getMinutes();
          gap = (1440 - currEndMins) + prevStartMins;
        }
        
        if(gap < 480) {
          conflicts.push(`Less than 8 hours rest from ${dateStr} shift`);
        }
      }
    }
  });
  
  return conflicts;
}

/* SCHEDULE FUNCTIONS */
function toggleLock(empId, date){
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  
  if(lockedCells[key]) {
    delete lockedCells[key];
    addAuditEntry('Cell Unlocked', empId, date, 'Locked', 'Unlocked');
  } else {
    lockedCells[key] = true;
    addAuditEntry('Cell Locked', empId, date, 'Unlocked', 'Locked');
  }
  
  save();
  generateSchedule();
}

function editScheduleCell(empId, date){
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  const ev = events.find(e => e.date === date);
  
  let currentEdit = manualEdits[key];
  let dialog = `Edit shift for ${emp.name} on ${date}:\n\n`;
  dialog += `Options:\n`;
  dialog += `1. Hours only: "5"\n`;
  dialog += `2. Hours + times: "6,09:00,15:30"\n`;
  dialog += `3. Mark SICK: "sick"\n`;
  dialog += `4. Mark VACATION: "vacation"\n`;
  dialog += `5. Remove shift: "remove"\n`;
  dialog += `6. Lock/unlock: "lock"\n\n`;
  
  if(lockedCells[key]) {
    dialog += `üîí LOCKED\n`;
  }
  
  if(currentEdit) {
    if(currentEdit.status === 'sick') {
      dialog += `Current: SICK\n`;
    } else if(currentEdit.status === 'vacation') {
      dialog += `Current: VACATION\n`;
    } else if(currentEdit.start && currentEdit.end) {
      dialog += `Current: ${currentEdit.hours}h (${currentEdit.start}-${currentEdit.end})\n`;
    } else {
      dialog += `Current: ${currentEdit.hours || currentEdit}h\n`;
    }
  } else if(ev) {
    dialog += `Auto from event: ${ev.name}\n`;
  }
  
  const input = prompt(dialog);
  
  if(input === null) return;
  
  const trimmed = input.trim().toLowerCase();
  
  // Lock/unlock
  if(trimmed === 'lock') {
    toggleLock(empId, date);
    return;
  }
  
  // Remove shift
  if(trimmed === 'remove' || trimmed === '') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
    delete manualEdits[key];
    addAuditEntry('Shift Removed', empId, date, oldValue, null);
    save(); 
    generateSchedule();
    return;
  }
  
  // Mark as sick
  if(trimmed === 'sick') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'sick' };
    addAuditEntry('Marked Sick', empId, date, oldValue, 'SICK');
    save();
    generateSchedule();
    return;
  }
  
  // Mark as vacation
  if(trimmed === 'vacation') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'vacation' };
    addAuditEntry('Marked Vacation', empId, date, oldValue, 'VACATION');
    save();
    generateSchedule();
    return;
  }
  
  // Parse hours/times
  const parts = input.split(',').map(p => p.trim());
  
  let newEdit;
  if(parts.length === 1) {
    newEdit = { hours: Number(parts[0]) };
  } else if(parts.length === 3) {
    newEdit = {
      hours: Number(parts[0]),
      start: parts[1],
      end: parts[2]
    };
  } else {
    alert('Invalid format');
    return;
  }
  
  const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
  manualEdits[key] = newEdit;
  addAuditEntry('Shift Manually Edited', empId, date, oldValue, JSON.stringify(newEdit));
  
  save(); 
  generateSchedule();
}

function clearDay(dateStr){
  if(!confirm("Clear all shifts for this day?")) return;

  Object.keys(manualEdits).forEach(key=>{
    if(key.endsWith("_"+dateStr)){
      delete manualEdits[key];
    }
  });
  
  addAuditEntry('Day Cleared', null, dateStr, 'All shifts', null);
  save();
  generateSchedule();
}

function generateSchedule(){
  scheduleTable.innerHTML="";
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });

  weekHeader.textContent = `${days[0].toLocaleDateString()} ‚Äì ${days[6].toLocaleDateString()}`;

  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>Employee</th>';
  
  days.forEach(d=>{
    const th = document.createElement('th');
    const ds = iso(d);
    th.innerHTML = `
      ${d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"})}
      <br>
      <button class="delete clear-day-btn" style="margin-top:4px; font-size:10px;">üóë</button>
    `;
    th.querySelector('.clear-day-btn').onclick = () => clearDay(ds);
    headerRow.appendChild(th);
  });
  
  headerRow.innerHTML += '<th>Total</th>';
  scheduleTable.appendChild(headerRow);

  const assignments = assignEmployeesToWeek(days);

  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0;
    const row = document.createElement('tr');
    row.innerHTML = `<td>${emp.name}</td>`;

    days.forEach(d=>{
      const dateStr = iso(d);
      const key=emp.id+"_"+dateStr;
      const cell = document.createElement('td');
      cell.className = 'clickable';
      
      const isLocked = lockedCells[key];
      if(isLocked) cell.classList.add('locked-cell');

      // Manual edit override
      if(manualEdits[key]){
        const edit = manualEdits[key];
        
        if(edit.status === 'sick') {
          cell.style.background = '#95a5a6';
          cell.innerHTML = 'SICK';
          cell.onclick = () => editScheduleCell(emp.id, dateStr);
          row.appendChild(cell);
          return;
        }
        
        if(edit.status === 'vacation') {
          cell.style.background = '#3498db';
          cell.innerHTML = 'VAC';
          cell.onclick = () => editScheduleCell(emp.id, dateStr);
          row.appendChild(cell);
          return;
        }
        
        const h = edit.hours || edit;
        total += h;
        cell.className += ' ' + getShiftClassByHours(h);
        
        if(edit.start && edit.end) {
          const conflicts = detectConflicts(emp.id, dateStr, edit.start, edit.end);
          if(conflicts.length > 0) {
            cell.classList.add('conflict-cell');
            cell.title = 'Conflict: ' + conflicts.join(', ');
          }
          cell.innerHTML = `${h}h<br><small>${edit.start}‚Äì${edit.end}</small>`;
        } else {
          cell.innerHTML = `${h}h`;
        }
        
        cell.onclick = () => editScheduleCell(emp.id, dateStr);
        row.appendChild(cell);
        return;
      }

      const ev=events.find(e=>e.date===dateStr);
      const isAssigned = assignments[dateStr] && assignments[dateStr].includes(emp.id);
      
      if(!ev || !isAssigned || emp.vacation || emp.sick){
        cell.onclick = () => editScheduleCell(emp.id, dateStr);
        row.appendChild(cell);
        return;
      }

      const s = normalizeHours(ev.start, ev.end);
      const t = calculateSmartShift(ev, s.h);
      
      total += s.h;

      cell.className += ' ' + getShiftClassByHours(s.h);
      cell.innerHTML = `${s.h}h<br><small>${timeStr(t.start)}‚Äì${timeStr(t.end)}</small>`;
      cell.onclick = () => editScheduleCell(emp.id, dateStr);
      row.appendChild(cell);
    });

    const totalCell = document.createElement('td');
    totalCell.innerHTML = `<strong>${total}h</strong>`;
    row.appendChild(totalCell);
    scheduleTable.appendChild(row);
  });
}

function assignEmployeesToWeek(days) {
  const assignments = {};
  const employeeShiftHistory = {};
  const employeeTotalHours = {};
  
  employees.filter(e => !e.retired).forEach(e => {
    employeeShiftHistory[e.id] = null;
    employeeTotalHours[e.id] = 0;
  });
  
  days.forEach(d => {
    const dateStr = iso(d);
    const dayEvents = events.filter(e => e.date === dateStr);
    
    if(dayEvents.length === 0) return;
    
    dayEvents.sort((a, b) => a.start.localeCompare(b.start));
    
    const available = employees.filter(e => 
      !e.retired && 
      !e.sick && 
      !e.vacation
    ).map(e => ({...e, assignedToday: false}));
    
    dayEvents.forEach((ev, eventIndex) => {
      const isEarliestShift = eventIndex === 0;
      const isLatestShift = eventIndex === dayEvents.length - 1;
      
      const s = normalizeHours(ev.start, ev.end);
      const t = calculateSmartShift(ev, s.h);
      
      const scored = available
        .filter(emp => {
          const key = emp.id + "_" + dateStr;
          // Skip if locked or manually edited
          if(lockedCells[key] || manualEdits[key]) return false;
          // Skip if already assigned today
          if(emp.assignedToday) return false;
          return true;
        })
        .map(emp => {
          let score = 0;
          let canWork = true;
          
          const gapCheck = canWorkShift(emp.id, dateStr, t.start, employeeShiftHistory);
          if(!gapCheck.allowed) {
            canWork = false;
          }
          
          // FT FIRST, then seniority
          if(emp.type === 'FT') score += 10000;
          score += (100 - emp.seniority) * 100;
          
          const expectedHours = (100 - emp.seniority) * 0.5;
          if(employeeTotalHours[emp.id] < expectedHours) {
            score += 500;
          }
          
          if(emp.pref === 'AM' && isEarliestShift) {
            score += 200;
          } else if(emp.pref === 'PM' && isLatestShift) {
            score += 200;
          }
          
          return { ...emp, score, canWork };
        })
        .filter(emp => emp.canWork);
      
      scored.sort((a, b) => b.score - a.score);
      
      const assigned = scored.slice(0, ev.staff);
      
      assigned.forEach(emp => {
        const empRef = available.find(e => e.id === emp.id);
        if(empRef) empRef.assignedToday = true;
        
        employeeShiftHistory[emp.id] = {
          date: dateStr,
          endTime: t.end
        };
        
        employeeTotalHours[emp.id] += s.h;
      });
      
      if(!assignments[dateStr]) {
        assignments[dateStr] = [];
      }
      assigned.forEach(emp => {
        if(!assignments[dateStr].includes(emp.id)) {
          assignments[dateStr].push(emp.id);
        }
      });
    });
  });
  
  return assignments;
}

function canWorkShift(empId, currentDate, shiftStart, shiftHistory) {
  const lastShift = shiftHistory[empId];
  
  if(!lastShift) return {allowed: true};
  
  const lastDate = new Date(lastShift.date);
  const currentDateObj = new Date(currentDate);
  const daysDiff = Math.floor((currentDateObj - lastDate) / (1000 * 60 * 60 * 24));
  
  if(daysDiff > 1) return {allowed: true};
  
  if(daysDiff === 1) {
    const lastEnd = lastShift.endTime;
    const currentStart = shiftStart;
    
    const lastEndMinutes = lastEnd.getHours() * 60 + lastEnd.getMinutes();
    const currentStartMinutes = currentStart.getHours() * 60 + currentStart.getMinutes();
    
    const totalMinutesBetween = (1440 - lastEndMinutes) + currentStartMinutes;
    
    if(totalMinutesBetween >= 480) {
      return {allowed: true};
    } else {
      return {allowed: false, reason: 'needs 8 hour gap'};
    }
  }
  
  return {allowed: true};
}

function regenerateSchedule(){ 
  if(!confirm("This will clear all manual edits. Continue?")) return;
  
  manualEdits = {};
  addAuditEntry('Schedule Regenerated', null, null, 'All manual edits', null);
  save();
  generateSchedule(); 
}

function changeWeek(n){ 
  currentWeekOffset+=n; 
  generateSchedule(); 
}

function toggleDarkMode(){ 
  document.body.classList.toggle("light-mode"); 
}

function printSchedule(){ 
  showTab("scheduleTab"); 
  setTimeout(()=>window.print(),200); 
}

/* AUDIT LOG */
function renderAuditLog(filter = {}){
  const container = document.getElementById('auditLogContainer');
  container.innerHTML = '';
  
  let filtered = auditLog;
  
  if(filter.employee) {
    filtered = filtered.filter(e => 
      e.employee.toLowerCase().includes(filter.employee.toLowerCase())
    );
  }
  
  if(filter.date) {
    filtered = filtered.filter(e => e.date === filter.date);
  }
  
  if(filtered.length === 0) {
    container.innerHTML = '<p>No audit entries found.</p>';
    return;
  }
  
  filtered.forEach(entry => {
    const div = document.createElement('div');
    div.className = 'audit-entry';
    
    const timestamp = new Date(entry.timestamp).toLocaleString();
    let html = `<strong>${entry.action}</strong> - ${timestamp}<br>`;
    
    if(entry.employee) html += `Employee: ${entry.employee}<br>`;
    if(entry.date) html += `Date: ${entry.date}<br>`;
    if(entry.oldValue) html += `Old: ${entry.oldValue}<br>`;
    if(entry.newValue) html += `New: ${entry.newValue}`;
    
    div.innerHTML = html;
    container.appendChild(div);
  });
}

function filterAuditLog(){
  renderAuditLog({
    employee: document.getElementById('auditEmployee').value,
    date: document.getElementById('auditDate').value
  });
}

function clearAuditFilter(){
  document.getElementById('auditEmployee').value = '';
  document.getElementById('auditDate').value = '';
  renderAuditLog();
}

/* SETTINGS */
function loadSettings(){
  document.getElementById('ratioPlated').value = settings.ratios["Plated Service"];
  document.getElementById('ratioBuffet').value = settings.ratios["Buffet Service"];
  document.getElementById('ratioReception').value = settings.ratios["Reception"];
  document.getElementById('ratioCoffee').value = settings.ratios["Coffee Break"];
}

function saveSettings(){
  settings.ratios["Plated Service"] = +document.getElementById('ratioPlated').value;
  settings.ratios["Buffet Service"] = +document.getElementById('ratioBuffet').value;
  settings.ratios["Reception"] = +document.getElementById('ratioReception').value;
  settings.ratios["Coffee Break"] = +document.getElementById('ratioCoffee').value;
  
  save();
  alert('Settings saved!');
}

/* INIT */
renderEmployees();
renderEvents();
showTab("employeesTab");
</script>
</body>
</html>
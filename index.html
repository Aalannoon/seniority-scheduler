<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BanquetLogic - Employee Scheduler</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* Brand: blue + charcoal workforce palette */
:root {
  --brand-primary: #4e9af1;
  --brand-primary-dark: #3d7bc9;
  --brand-bg: #252a32;
  --brand-bg-elevated: #2d343e;
  --brand-text: #e8eaed;
  --brand-text-muted: #9ca3af;
  --brand-text-quiet: #6b7280;
  --brand-accent-muted: #6b7c8d;
  --brand-border: #3d4550;
}

body {
  font-family: "Inter", "DM Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  margin: 0;
  padding: 24px;
  background: var(--brand-bg);
  color: var(--brand-text);
  font-size: 14px;
  line-height: 1.5;
}
body.light-mode {
  background: #f8f9fa;
  color: #1f2937;
}

h1 {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0 0 4px 0;
  letter-spacing: -0.02em;
}
h2 {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0 0 12px 0;
  color: var(--brand-text);
}
body.light-mode h2 { color: #1f2937; }
h3 {
  font-size: 1rem;
  font-weight: 600;
  margin: 0 0 8px 0;
  color: var(--brand-text-muted);
}
body.light-mode h3 { color: #4b5563; }

/* Header: logo + tagline (workforce / fairness feel) */
.app-header {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  padding: 14px 0 16px 0;
  border-bottom: 1px solid var(--brand-border);
  background: var(--brand-bg);
}
body.light-mode .app-header {
  border-bottom-color: #e5e7eb;
  background: #fff;
}
.logo-block {
  display: flex;
  align-items: center;
  gap: 12px;
}
.logo-icon-wrap {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--brand-bg-elevated);
  border-radius: 8px;
  border: 1px solid var(--brand-border);
  width: 1.75rem;
  height: 1.75rem;
}
body.light-mode .logo-icon-wrap {
  background: #f3f4f6;
  border-color: #e5e7eb;
}
.logo-icon {
  width: 1.125rem;
  height: 1.125rem;
  color: var(--brand-primary);
  display: block;
}
.logo-icon .logo-icon-grid { opacity: 0.45; }
.logo-icon .logo-icon-cell { opacity: 1; }
body.light-mode .logo-icon { color: var(--brand-primary); }
.logo-text-col {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.logo-wordmark {
  font-size: 1.375rem;
  font-weight: 600;
  letter-spacing: -0.02em;
  color: var(--brand-primary);
  line-height: 1.2;
}
body.light-mode .logo-wordmark { color: var(--brand-primary); }
.tagline {
  font-size: 0.75rem;
  color: var(--brand-text-quiet);
  font-weight: 400;
  margin: 0;
  letter-spacing: 0.02em;
  line-height: 1.3;
}
body.light-mode .tagline { color: #9ca3af; }
.week-header {
  font-size: 0.9375rem;
  color: var(--brand-text-muted);
  margin-left: auto;
  font-weight: 500;
}
body.light-mode .week-header { color: #6b7280; }

/* TABS */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tabs button {
  padding: 10px 16px;
  border: 1px solid var(--brand-border);
  border-radius: 8px;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  background: var(--brand-bg-elevated);
  color: var(--brand-text-muted);
  white-space: nowrap;
  min-height: 44px;
  transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
}
.tabs button:hover {
  background: #353d48;
  color: var(--brand-text);
}
body.light-mode .tabs button {
  background: #fff;
  color: #4b5563;
  border-color: #e5e7eb;
}
body.light-mode .tabs button:hover {
  background: #f3f4f6;
  color: #1f2937;
}
.tabs button.active {
  background: var(--brand-primary);
  color: #fff;
  border-color: var(--brand-primary);
}

/* INPUTS */
input, select, button {
  margin: 4px;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid var(--brand-border);
  font-size: 14px;
  min-height: 40px;
  font-family: inherit;
}
body.light-mode input,
body.light-mode select { border-color: #d1d5db; }
button {
  background: var(--brand-primary);
  color: #fff;
  font-weight: 500;
  cursor: pointer;
  border: none;
  touch-action: manipulation;
  transition: opacity 0.15s ease, background 0.15s ease;
}
button:hover { opacity: 0.92; }
button.delete { background:#c0392b; }
button.retire { background:#8e44ad; }
button.print { background:#27ae60; }

/* TABLE */
table { 
  border-collapse:collapse; 
  width:100%; 
  margin-top:10px;
  display: table; /* Desktop default */
}
th, td {
  padding:8px;
  text-align:center;
  border:1px solid #555;
  position:relative;
  min-width: 80px;
}
th { background: var(--brand-primary); color: #fff; font-weight: 600; }

/* STATUS */
.status-retired { background:#555; opacity:0.6; }

/* SHIFTS */
.shift-4 { background:#2ecc71; }      /* Green - 4 hours */
.shift-5 { background:#3498db; }      /* Blue - 5 hours */
.shift-6 { background:#e67e22; }      /* Orange - 6 hours */
.shift-7 { background:#e91e63; }      /* Pink - 7 hours */
.shift-8 { background:#f1c40f; color:#000; }  /* Yellow - 8 hours */
.shift-ot { background:#9b59b6; }     /* Purple - overtime (>8) */

/* LOCKED CELLS */
.locked-cell {
  border: 3px solid #f39c12 !important;
  position: relative;
}
.locked-cell::after {
  content: 'üîí';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 10px;
}

/* CONFLICT CELLS */
.conflict-cell {
  border: 3px solid #e74c3c !important;
  position: relative;
}
.conflict-cell::before {
  content: '‚ö†Ô∏è';
  position: absolute;
  top: 2px;
  left: 2px;
  font-size: 10px;
}

/* CLICKABLE CELLS */
td[onclick], td.clickable { cursor:pointer; }
td[onclick]:hover, td.clickable:hover { outline:2px dashed #4e9af1; }
.schedule-why-link { font-size: 11px; color: var(--brand-text-muted); text-decoration: none; }
.schedule-why-link:hover { color: var(--brand-primary); text-decoration: underline; }

/* TOOLTIP */
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 12px;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

/* AUDIT LOG */
.audit-entry {
  padding: 10px 12px;
  margin: 4px 0;
  background: var(--brand-bg-elevated);
  border-radius: 6px;
  font-size: 13px;
  border: 1px solid var(--brand-border);
}
.audit-filters {
  margin-bottom: 15px;
}

/* PRINT */
@media print {
  body { background:#fff !important; color:#000 !important; }
  .tabs, button, input, select, textarea { display:none !important; }
  .tab { display:none !important; }
  #scheduleTab { display:block !important; }
  table { font-size:12px; page-break-inside: avoid; }
  th { background:#ddd !important; color:#000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .locked-cell::after, .conflict-cell::before { display: none !important; }
  .shift-4, .shift-5, .shift-6, .shift-7, .shift-8, .shift-ot {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  h1, .logo-wordmark, .tagline, .week-header { color: #000 !important; }
  .logo-icon { color: #000 !important; }
  .logo-icon-wrap { background: transparent !important; border-color: #ccc !important; }
  .app-header { border-bottom-color: #ccc !important; background: transparent !important; }
  /* Hide lock column and all lock controls in schedule */
  #scheduleTable th:first-child,
  #scheduleTable td:first-child { display: none !important; }
  /* Hide demo UI and explanation link in print */
  .demo-mode-banner,
  .demo-tip,
  .demo-tip-visible,
  .schedule-why-link { display: none !important; }
}

/* TABS */
.tab { display:none; }
.tab.active { display:block; }

/* SETTINGS */
.settings-section {
  margin: 20px 0;
  padding: 20px;
  background: var(--brand-bg-elevated);
  border-radius: 8px;
  max-width: 100%;
  border: 1px solid var(--brand-border);
}
body.light-mode .settings-section { background: #fff; border-color: #e5e7eb; }
.settings-section h3 {
  margin-top: 0;
  margin-bottom: 12px;
}
.setting-row {
  margin: 10px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.setting-row label {
  min-width: 150px;
}
.setting-row input {
  width: 100px;
}

.settings-table { width: 100%; border-collapse: collapse; }
.settings-table th, .settings-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--brand-border); }
.settings-table th { color: var(--brand-text-muted); font-weight: 500; }
body.light-mode .settings-table th, body.light-mode .settings-table td { border-color: #e5e7eb; }
body.light-mode .settings-table th { color: #6b7280; }

/* Events form: time labels and helper text */
.event-time-label { display: block; margin-bottom: 4px; margin-top: 10px; font-size: 13px; color: var(--brand-text-muted); }
.event-time-label:first-of-type { margin-top: 10px; }
.event-type-helper { margin: 4px 0 0 0; font-size: 12px; color: var(--brand-text-muted); }
body.light-mode .event-time-label, body.light-mode .event-type-helper { color: #6b7280; }

/* Events table: hover, numeric alignment, Date/Time grouping */
.events-table tbody tr:hover { background: var(--brand-bg-elevated); }
body.light-mode .events-table tbody tr:hover { background: #f3f4f6; }
.events-table td:nth-child(4), .events-table th:nth-child(4), .events-table td:nth-child(6), .events-table th:nth-child(6) { text-align: right; }
.events-table th:nth-child(3), .events-table td:nth-child(3) { border-right: 2px solid var(--brand-border); }
body.light-mode .events-table th:nth-child(3), body.light-mode .events-table td:nth-child(3) { border-right-color: #e5e7eb; }

/* Schedule: action button groups and lock helper */
.schedule-actions {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px 4px;
  margin-bottom: 12px;
}
.schedule-action-group {
  display: inline-flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
}
.schedule-action-sep {
  color: var(--brand-text-quiet);
  padding: 0 6px;
  font-size: 12px;
  user-select: none;
}
body.light-mode .schedule-action-sep { color: #9ca3af; }
.schedule-lock-helper {
  font-size: 12px;
  color: var(--brand-text-muted);
  margin-left: 4px;
  margin-right: 4px;
}
body.light-mode .schedule-lock-helper { color: #6b7280; }

/* Schedule: one-line helper above grid */
.schedule-grid-helper {
  font-size: 12px;
  color: var(--brand-text-muted);
  margin: 0 0 10px 0;
}
body.light-mode .schedule-grid-helper { color: #6b7280; }

/* Schedule table: alternating row shading (tbody only, subtle) */
#scheduleTable tbody tr:nth-child(odd) { background: rgba(0, 0, 0, 0.06); }
#scheduleTable tbody tr:nth-child(even) { background: transparent; }
body.light-mode #scheduleTable tbody tr:nth-child(odd) { background: rgba(0, 0, 0, 0.03); }

/* Schedule table: editable day cell hover (visual only) */
#scheduleTable td.clickable:hover {
  cursor: pointer;
  outline: 1px solid var(--brand-primary);
  outline-offset: -1px;
  background-color: rgba(78, 154, 241, 0.08) !important;
}
body.light-mode #scheduleTable td.clickable:hover {
  background-color: rgba(78, 154, 241, 0.12) !important;
}

/* Schedule table: Total/Days column header helper text */
.schedule-th-helper {
  display: block;
  font-weight: 400;
  font-size: 10px;
  opacity: 0.85;
}

/* RESPONSIVE: Make table scrollable on smaller screens */
@media (max-width: 1024px) {
  body {
    margin: 10px;
  }
  
  h1 {
    font-size: 22px;
  }
  
  .tabs button {
    padding: 6px 10px;
    font-size: 13px;
  }
  
  /* Make table scrollable horizontally */
  .schedule-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  th, td {
    padding: 6px;
    font-size: 13px;
    min-width: 70px;
  }
  
  .settings-section {
    padding: 10px;
  }
  
  .setting-row {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .setting-row label {
    min-width: auto;
  }
}

@media (max-width: 768px) {
  body {
    margin: 5px;
  }
  
  h1 {
    font-size: 18px;
  }
  
  .tabs button {
    padding: 8px 12px;
    font-size: 12px;
  }
  
  /* Make inputs full width on mobile */
  input, select, textarea {
    max-width: 100%;
    box-sizing: border-box;
  }
  
  th, td {
    padding: 4px;
    font-size: 12px;
    min-width: 60px;
  }
}

/* Demo mode active state */
.demo-mode-banner {
  display: none;
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(90deg, #e67e22 0%, #d35400 100%);
  color: #fff;
  padding: 14px 20px;
  text-align: center;
  font-weight: bold;
  font-size: 15px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.4);
  border-bottom: 3px solid #fff;
}
.demo-mode-banner.demo-mode-banner-visible {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
  gap: 12px;
}
.demo-mode-banner .demo-banner-stop {
  margin-left: 0;
  padding: 12px 24px;
  font-size: 16px;
  background: #fff;
  color: #c0392b;
  border: 2px solid #fff;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  flex-shrink: 0;
}
.demo-mode-banner .demo-banner-stop:hover {
  background: #f5f5f5;
  transform: scale(1.02);
}
.tabs button.demo-active {
  background: #d35400 !important;
  color: #fff !important;
  box-shadow: 0 0 0 2px #fff;
}
body.light-mode .demo-mode-banner {
  border-bottom-color: #333;
}
body.light-mode .demo-mode-banner .demo-banner-stop {
  background: #fff;
  color: #c0392b;
  border-color: #333;
}

/* Demo-only instructional tip (only visible during demo) */
.demo-tip {
  display: none;
  position: sticky;
  top: 0;
  z-index: 99;
  background: #2c3e50;
  color: #ecf0f1;
  padding: 12px 20px;
  font-size: 14px;
  line-height: 1.5;
  border-bottom: 2px solid #4e9af1;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.demo-tip.demo-tip-visible {
  display: flex;
  align-items: center;
  gap: 12px;
}
.demo-tip-icon {
  font-size: 20px;
  flex-shrink: 0;
}
.demo-tip strong { color: #4e9af1; }
body.light-mode .demo-tip {
  background: #ecf0f1;
  color: #2c3e50;
  border-bottom-color: #4e9af1;
}
/* Temporary highlight for demo (demo only, no core change) */
.demo-highlight {
  animation: demo-highlight-pulse 1.2s ease-in-out 2;
}
@keyframes demo-highlight-pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(78, 154, 241, 0.5); }
  50% { box-shadow: 0 0 0 8px rgba(78, 154, 241, 0); }
}

/* Edit employee modal */
#employeeEditModalOverlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
#employeeEditModalOverlay.employee-edit-visible {
  display: flex;
}
#employeeEditModal {
  background: #2c3e50;
  color: #ecf0f1;
  padding: 24px;
  border-radius: 12px;
  min-width: 320px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
#employeeEditModal h3 { margin-top: 0; color: #4e9af1; }
#employeeEditModal .edit-row { margin: 12px 0; }
#employeeEditModal label { display: block; margin-bottom: 4px; font-size: 13px; color: #bdc3c7; }
#employeeEditModal select, #employeeEditModal input[type="checkbox"] { margin-right: 8px; }
#employeeEditModal .edit-actions { margin-top: 20px; display: flex; gap: 10px; }
#employeeEditModal .edit-actions button { padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
#employeeEditModal .edit-actions .save-btn { background: #27ae60; color: #fff; }
#employeeEditModal .edit-actions .cancel-btn { background: #7f8c8d; color: #fff; }
body.light-mode #employeeEditModal { background: #ecf0f1; color: #2c3e50; }
body.light-mode #employeeEditModal h3 { color: #2980b9; }
body.light-mode #employeeEditModal label { color: #7f8c8d; }

.override-indicator { color: #f39c12; font-size: 12px; cursor: help; }

/* Inline editable email in employees table */
.email-cell-wrap { cursor: pointer; padding: 4px 6px; border-radius: 4px; min-height: 1.5em; display: block; }
.email-cell-wrap:hover { background: var(--brand-bg-elevated); }
body.light-mode .email-cell-wrap:hover { background: #f3f4f6; }
.email-cell-placeholder { color: var(--brand-text-quiet); font-style: italic; font-size: 13px; }
.email-cell-input { width: 100%; max-width: 220px; padding: 4px 6px; border: 1px solid var(--brand-primary); border-radius: 4px; font-size: 13px; background: var(--brand-bg-elevated); color: var(--brand-text); box-sizing: border-box; }
body.light-mode .email-cell-input { background: #fff; color: #1f2937; border-color: var(--brand-primary); }

#absenceModalOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
#absenceModalOverlay.absence-visible { display: flex; }
#absenceModal { background: var(--brand-bg-elevated); color: var(--brand-text); padding: 24px; border-radius: 12px; min-width: 340px; border: 1px solid var(--brand-border); }
#absenceModal h3 { margin-top: 0; color: var(--brand-primary); }
#absenceModal .edit-row { margin: 12px 0; }
#absenceModal label { display: block; margin-bottom: 4px; font-size: 13px; color: var(--brand-text-muted); }
#absenceModal input, #absenceModal select { width: 100%; max-width: 280px; padding: 8px; border-radius: 6px; border: 1px solid var(--brand-border); background: var(--brand-bg); color: var(--brand-text); font-size: 14px; box-sizing: border-box; }
#absenceModal .modal-actions { margin-top: 20px; display: flex; gap: 10px; }
#absenceModal .modal-actions button { padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: 500; }
#absenceModal .modal-actions .btn-primary { background: var(--brand-primary); color: #fff; }
#absenceModal .modal-actions .btn-secondary { background: var(--brand-border); color: var(--brand-text); }
body.light-mode #absenceModal { background: #fff; color: #1f2937; border-color: #e5e7eb; }
body.light-mode #absenceModal input, body.light-mode #absenceModal select { background: #fff; color: #1f2937; border-color: #d1d5db; }
</style>
</head>

<body>

<header class="app-header">
  <div class="logo-block">
    <div class="logo-icon-wrap" aria-hidden="true">
      <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Schedule grid">
        <g stroke="currentColor" stroke-width="1.25" fill="none" class="logo-icon-grid">
          <rect x="0.5" y="0.5" width="7" height="7" rx="0.5"/>
          <rect x="8.5" y="0.5" width="7" height="7" rx="0.5"/>
          <rect x="16.5" y="0.5" width="7" height="7" rx="0.5"/>
          <rect x="0.5" y="8.5" width="7" height="7" rx="0.5"/>
          <rect x="16.5" y="8.5" width="7" height="7" rx="0.5"/>
          <rect x="0.5" y="16.5" width="7" height="7" rx="0.5"/>
          <rect x="8.5" y="16.5" width="7" height="7" rx="0.5"/>
          <rect x="16.5" y="16.5" width="7" height="7" rx="0.5"/>
        </g>
        <rect x="8.5" y="8.5" width="7" height="7" rx="0.5" fill="currentColor" class="logo-icon-cell"/>
      </svg>
    </div>
    <div class="logo-text-col">
      <h1 class="logo-wordmark">BanquetLogic</h1>
      <p class="tagline">Every shift has a reason.</p>
    </div>
  </div>
  <span class="week-header" id="weekHeader"></span>
</header>

<div id="absenceModalOverlay">
  <div id="absenceModal">
    <h3 id="absenceModalTitle">Time Off / Sick</h3>
    <p id="absenceModalEmpName" style="margin: 0 0 16px 0; font-size: 15px;"></p>
    <div class="edit-row">
      <label for="absenceStartDate">Start date</label>
      <input type="date" id="absenceStartDate" />
    </div>
    <div class="edit-row">
      <label for="absenceEndDate">End date (optional ‚Äî leave blank for single day)</label>
      <input type="date" id="absenceEndDate" placeholder="Optional" />
    </div>
    <div class="edit-row">
      <label for="absenceType">Type</label>
      <select id="absenceType">
        <option value="sick">Sick</option>
        <option value="vacation">Vacation (Paid)</option>
        <option value="floating_holiday">Floating Holiday (Paid)</option>
        <option value="unpaid_vacation">Unpaid Vacation</option>
        <option value="requested_off">Request Off</option>
      </select>
    </div>
    <p style="font-size: 12px; color: var(--brand-text-muted); margin: 8px 0 0 0;">Request Off is visual only; it does not remove an existing shift until you change it to another type.</p>
    <div class="modal-actions">
      <button type="button" class="btn-primary" id="absenceConfirmBtn">Confirm</button>
      <button type="button" class="btn-secondary" id="absenceCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<button type="button" onclick="toggleDarkMode()">Toggle Dark Mode</button>
<button type="button" class="print" onclick="printSchedule()">Print / Save PDF</button>

<div class="tabs">
  <button type="button" id="tabEmpBtn" onclick="showTab('employeesTab')">Employees</button>
  <button type="button" id="tabEvBtn" onclick="showTab('eventsTab')">Events</button>
  <button type="button" id="tabSchBtn" onclick="showTab('scheduleTab')">Schedule</button>
  <button type="button" id="tabAuditBtn" onclick="showTab('auditTab')">Audit Log</button>
  <button type="button" id="tabSettingsBtn" onclick="showTab('settingsTab')">Settings</button>
  <button type="button" id="tabSupportBtn" onclick="showTab('supportTab')">Support / Contact</button>
  <button type="button" id="tabDemoBtn" onclick="showTab('demoTab')" style="background:#e67e22;" title="Try the app with sample data. Your data is restored when you stop.">üé¨ Demo Mode</button>
</div>

<div id="demoModeBanner" class="demo-mode-banner">
  <span>üé¨ <strong>Demo Mode Active</strong> ‚Äî All data you see is temporary and will be removed when you stop. Your real data is safely stored and will be restored.</span>
  <button type="button" class="demo-banner-stop" onclick="stopDemo()">‚èπÔ∏è Stop Demo &amp; Restore My Data</button>
</div>

<div id="demoTip" class="demo-tip">
  <span class="demo-tip-icon">üí°</span>
  <span id="demoTipText"></span>
</div>

<!-- EMPLOYEES -->
<div id="employeesTab" class="tab">
<h2>Employees</h2>

<div style="margin-bottom: 15px; padding: 10px; background: #2e2e3d; border-radius: 8px;">
  <h3 style="margin-top: 0;">Add Employee Manually</h3>
  <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: flex-end; gap: 10px;">
    <input type="text" id="empName" placeholder="Name" />
    <select id="empType"><option value="FT">FT</option><option value="PT">PT</option></select>
    <div>
      <label for="empSeniority" style="display: block; margin-bottom: 2px; font-size: 13px;">Seniority</label>
      <input id="empSeniority" type="number" min="1" placeholder="Auto" style="width: 70px;" />
      <small style="display: block; margin-top: 2px; color: #95a5a6; font-size: 11px;">Auto-assigned; you can change it. Must be unique.</small>
    </div>
    <select id="empPref">
      <option value="">No Pref</option>
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>
  </div>
  
  <div style="margin-top: 10px; padding: 8px; background: #1e1e2f; border-radius: 6px;">
    <strong>Optional Fields:</strong>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 8px;">
      <input id="empEmail" type="email" placeholder="Email (for schedule send)" style="border: 2px solid #3498db;" />
      <input type="text" id="empEmployeeId" placeholder="Employee ID (optional)" />
      <div>
        <label for="empHireDate" style="display: block; margin-bottom: 4px; font-size: 13px;">Hire Date (optional)</label>
        <input id="empHireDate" type="date" placeholder="yyyy-mm-dd" title="Hire Date (optional)" />
        <small style="display: block; margin-top: 2px; color: #95a5a6; font-size: 12px;">When they started. Does not affect seniority.</small>
      </div>
      <div>
        <label for="empBirthdate" style="display: block; margin-bottom: 4px; font-size: 13px;">Birthday (optional)</label>
        <input id="empBirthdate" type="date" placeholder="yyyy-mm-dd" title="Birthday (optional)" />
        <small style="display: block; margin-top: 2px; color: #95a5a6; font-size: 12px;">For reference only; not used in scheduling.</small>
      </div>
    </div>
    <small style="color: #95a5a6; display: block; margin-top: 5px;">
      üìß Email required for one-click schedule sending. Other fields are optional.
    </small>
  </div>
  
  <button type="button" onclick="addEmployee()" style="margin-top: 10px;">Add Employee</button>
</div>

<div style="margin-bottom: 15px; padding: 10px; background: #2e2e3d; border-radius: 8px;">
  <h3 style="margin-top: 0;">Import Seniority List</h3>
  <p style="margin: 5px 0; font-size: 13px; color: #95a5a6;">
    Upload a CSV file or paste text with employee data
  </p>
  
  <div style="margin: 10px 0;">
    <button type="button" onclick="document.getElementById('importFile').click()" style="background: #27ae60;">
      üìÅ Upload CSV File
    </button>
    <input type="file" id="importFile" accept=".csv,.txt" style="display: none;" onchange="handleFileImport(event)" />
    
    <button type="button" onclick="openPasteImport()" style="background: #9b59b6;">
      üìã Paste Text
    </button>
    
    <button type="button" onclick="exportEmployeeList()" style="background: #3498db;">
      üíæ Export List
    </button>
    
    <button type="button" onclick="showImportHelp()" style="background: #95a5a6;">
      ‚ùì Format Help
    </button>
  </div>
</div>

<table>
<thead>
<tr>
  <th>Name</th><th>Type</th><th>Seniority</th><th>Email</th><th>Pref</th>
  <th>Max Days/Wk</th><th>Vacation</th><th>Day Prefs</th><th>Time Off</th><th>Sick</th><th>Actions</th>
</tr>
</thead>
<tbody id="employeesTable"></tbody>
</table>
</div>

<div id="employeeEditModalOverlay" class="employee-edit-overlay">
  <div id="employeeEditModal">
    <h3 id="employeeEditTitle">Edit employee</h3>
    <p id="employeeEditName" style="margin: 0 0 16px 0; font-size: 15px;"></p>
    <div class="edit-row">
      <label for="employeeEditType">Full-time / Part-time</label>
      <select id="employeeEditType">
        <option value="FT">Full-time (FT)</option>
        <option value="PT">Part-time (PT)</option>
      </select>
    </div>
    <div class="edit-row">
      <label for="employeeEditPref">AM / PM preference</label>
      <select id="employeeEditPref">
        <option value="">No preference</option>
        <option value="AM">AM (morning)</option>
        <option value="PM">PM (afternoon)</option>
      </select>
    </div>
    <div class="edit-row">
      <label for="employeeEditSeniority">Seniority (unique number, 1 = highest)</label>
      <input type="number" id="employeeEditSeniority" min="1" style="width: 80px;" />
    </div>
    <div class="edit-row">
      <label><input type="checkbox" id="employeeEditSick" /> Mark as sick (unavailable this week)</label>
    </div>
    <p style="font-size: 12px; color: #95a5a6; margin: 12px 0 0 0;">Changes apply to future schedule generation only. Existing shifts are not changed.</p>
    <div class="edit-actions">
      <button type="button" class="save-btn" id="employeeEditSaveBtn">Save</button>
      <button type="button" class="cancel-btn" id="employeeEditCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- EVENTS -->
<div id="eventsTab" class="tab">
<h2>Events</h2>

<input type="text" id="eventName" placeholder="Event Name" />
<input id="eventDate" type="date" />
<label for="eventStart" class="event-time-label">Start Time</label>
<input id="eventStart" type="time" placeholder="--:--" onchange="autoRecommendStaff()" aria-label="Start Time" />
<label for="eventEnd" class="event-time-label">End Time</label>
<input id="eventEnd" type="time" placeholder="--:--" onchange="autoRecommendStaff()" aria-label="End Time" />
<input id="eventGuests" type="number" placeholder="Guests" oninput="autoRecommendStaff()" />

<select id="eventService" onchange="autoRecommendStaff()"></select>
<p class="event-type-helper">Affects staffing ratios and scheduling logic</p>

<input id="eventStaff" type="number" placeholder="Staff Needed" />
<button type="button" id="eventSubmitBtn" onclick="addEvent()">Add Event</button>

<table class="events-table">
<thead>
<tr>
  <th>Name</th><th>Date</th><th>Time</th>
  <th>Guests</th><th>Service</th><th>Staff</th>
  <th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="eventsTable"></tbody>
</table>
</div>

<!-- SCHEDULE -->
<div id="scheduleTab" class="tab">
<h2>Schedule</h2>

<div class="schedule-actions">
  <span class="schedule-action-group">
    <button type="button" onclick="changeWeek(-1)">‚¨Ö Previous Week</button>
    <button type="button" onclick="changeWeek(1)">Next Week ‚û°</button>
  </span>
  <span class="schedule-action-sep" aria-hidden="true">|</span>
  <span class="schedule-action-group">
    <button type="button" onclick="generateSchedule()">Generate</button>
    <button type="button" onclick="regenerateSchedule()">Regenerate</button>
  </span>
  <span class="schedule-action-sep" aria-hidden="true">|</span>
  <span class="schedule-action-group">
    <button type="button" id="globalLockBtn" onclick="toggleGlobalLock()" style="background:#f39c12;">üîì Unlock Schedule</button>
    <span id="scheduleLockHelperText" class="schedule-lock-helper">Edits enabled ‚Äî changes will affect assignments</span>
    <button type="button" onclick="emailSchedulesToAll()" style="background:#27ae60;">üìß Email Schedules</button>
    <button type="button" onclick="showGenerationRules()" style="background:#9b59b6;">üìã Generation Rules</button>
    <button type="button" onclick="showConflictReport()" id="conflictReportBtn" style="background:#e74c3c; display:none;">‚ö†Ô∏è Conflicts</button>
    <button type="button" onclick="exportScheduleToCSV()" style="background:#16a085;">üì• Export CSV</button>
  </span>
</div>

<p class="schedule-grid-helper">Click a cell to assign an employee to an event or mark time off</p>
<div class="schedule-container">
  <table id="scheduleTable"></table>
</div>
</div>

<!-- AUDIT LOG -->
<div id="auditTab" class="tab">
<h2>Audit Log</h2>

<div class="audit-filters">
  <input type="text" id="auditEmployee" placeholder="Filter by employee" />
  <input id="auditDate" type="date" placeholder="Filter by date" />
  <button type="button" onclick="filterAuditLog()">Filter</button>
  <button type="button" onclick="clearAuditFilter()">Clear Filter</button>
</div>

<div id="auditLogContainer"></div>
</div>

<!-- SETTINGS -->
<div id="settingsTab" class="tab">
<h2>Settings</h2>

<div class="settings-section">
  <h3>Shift Assignment Style</h3>
  <p>Choose how shifts are assigned when generating schedules:</p>
  
  <div style="margin: 15px 0;">
    <label for="assignmentStyle_strict" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; background: #34495e; border-radius: 6px; margin-bottom: 10px; cursor: pointer;">
      <input type="radio" id="assignmentStyle_strict" name="assignmentStyle" value="strict" checked style="margin-top: 5px;">
      <div>
        <strong style="color: #4e9af1;">Strict Seniority</strong>
        <p style="margin: 5px 0 0 0; font-size: 13px; color: #95a5a6;">
          Higher-seniority employees are always assigned first. Seniority 1 gets all available shifts before Seniority 2, and so on. 
          Preferences are only respected if they don't conflict with seniority priority.
        </p>
      </div>
    </label>
    
    <label for="assignmentStyle_balanced" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; background: #34495e; border-radius: 6px; margin-bottom: 10px; cursor: pointer;">
      <input type="radio" id="assignmentStyle_balanced" name="assignmentStyle" value="balanced" style="margin-top: 5px;">
      <div>
        <strong style="color: #4e9af1;">Seniority + Balanced Coverage</strong>
        <p style="margin: 5px 0 0 0; font-size: 13px; color: #95a5a6;">
          Seniority is prioritized, but shifts are balanced across employee groups (FT/PT). 
          Prevents one group from getting all shifts while others are eligible. 
          Better distribution while still respecting seniority within each group.
        </p>
      </div>
    </label>
    
    <label for="assignmentStyle_fair" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; background: #34495e; border-radius: 6px; margin-bottom: 10px; cursor: pointer;">
      <input type="radio" id="assignmentStyle_fair" name="assignmentStyle" value="fair" style="margin-top: 5px;">
      <div>
        <strong style="color: #4e9af1;">Fair Distribution</strong>
        <p style="margin: 5px 0 0 0; font-size: 13px; color: #95a5a6;">
          Shifts distributed as evenly as possible across all eligible employees. 
          Everyone gets similar hours regardless of seniority. 
          Seniority is only used as a tie-breaker when two employees have equal hours.
        </p>
      </div>
    </label>
  </div>
  
  <button type="button" onclick="saveSettings()">Save Settings</button>
</div>

<div class="settings-section" id="eventTypesSection">
  <h3>Event Types</h3>
  <p>Define event types and staffing ratios (1 server per X guests). Inactive types are hidden when creating events but existing events keep displaying correctly.</p>
  
  <table class="settings-table" style="margin-top: 12px;">
    <thead>
      <tr>
        <th>Name</th>
        <th>1 Server per ___ Guests</th>
        <th>Active</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="eventTypesTableBody"></tbody>
  </table>
  <button type="button" onclick="openEventTypeModal()" style="margin-top: 12px;">Add event type</button>
</div>

<div id="eventTypeModalOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
  <div id="eventTypeModal" style="background: #2c3e50; padding: 24px; border-radius: 8px; min-width: 320px; max-width: 90%;">
    <h3 style="margin-top: 0;" id="eventTypeModalTitle">Add event type</h3>
    <input type="hidden" id="eventTypeEditId" value="" />
    <div style="margin-bottom: 12px;">
      <label for="eventTypeName" style="display: block; margin-bottom: 4px;">Name</label>
      <input type="text" id="eventTypeName" placeholder="e.g. Plated Service" style="width: 100%; padding: 8px; box-sizing: border-box;" />
    </div>
    <div style="margin-bottom: 16px;">
      <label for="eventTypeGuestsPerServer" style="display: block; margin-bottom: 4px;">1 Server per ___ Guests</label>
      <input type="number" id="eventTypeGuestsPerServer" min="1" value="20" style="width: 100px; padding: 8px;" />
    </div>
    <div style="display: flex; gap: 8px; justify-content: flex-end;">
      <button type="button" onclick="closeEventTypeModal()">Cancel</button>
      <button type="button" onclick="saveEventTypeFromModal()">Save</button>
    </div>
  </div>
</div>

<div class="settings-section" id="dataManagementSection">
  <h3>Data Management</h3>
  <p>Back up your data to a file or restore from a previous backup. The app also saves automatic backups when you make changes (not during demo mode).</p>
  <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-top: 12px;">
    <button type="button" onclick="exportData()">Export Data</button>
    <button type="button" onclick="document.getElementById('importDataFile').click()">Import Data</button>
    <button type="button" onclick="createManualBackup()">Create backup now</button>
    <button type="button" onclick="openRestoreBackupModal()">Restore from Backup</button>
    <input type="file" id="importDataFile" accept=".json,application/json" style="display: none;" onchange="handleImportFile(event)" />
  </div>
  <p style="font-size: 12px; color: var(--brand-text-muted); margin-top: 10px;">Import replaces everything currently in the app with the file you choose. Restore from Backup uses a backup saved automatically or one you exported earlier.</p>
</div>

<div id="restoreBackupModalOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;" onclick="if(event.target===this) closeRestoreBackupModal();">
  <div id="restoreBackupModal" style="background: #2c3e50; padding: 24px; border-radius: 8px; min-width: 360px; max-width: 95%; max-height: 85vh; overflow: auto;" onclick="event.stopPropagation();">
    <h3 style="margin-top: 0;">Restore from Backup</h3>
    <p style="color: var(--brand-text-muted); font-size: 13px; margin-bottom: 16px;">Choose a backup to restore or export to a file.</p>
    <div id="restoreBackupList"></div>
    <div style="margin-top: 16px;">
      <button type="button" onclick="closeRestoreBackupModal()">Close</button>
    </div>
  </div>
</div>

<div class="settings-section" style="border: 1px solid #e74c3c; background: #2a1f1f;">
  <h3 style="color: #e74c3c;">Admin: Clear All Data</h3>
  <p>Reset the app to a completely fresh state. Use this to remove all employees, events, schedules (all weeks), audit log, and demo data.</p>
  <p style="color: #f0f0f0; font-weight: bold;">This action cannot be undone. All data will be permanently deleted.</p>
  <button type="button" onclick="clearAllData()" style="background: #c0392b;">Clear All Employee Data</button>
</div>
</div>

<!-- SUPPORT / CONTACT -->
<div id="supportTab" class="tab">
<h2>Support / Contact</h2>

<div class="settings-section">
  <h3>Report a Bug or Suggest a Feature</h3>
  <p>Have feedback about BanquetLogic? Found a bug? Have a feature request? Let us know!</p>
  
  <div style="margin-top: 20px;">
    <div style="margin-bottom: 15px;">
      <label for="supportCategory" style="display: block; margin-bottom: 5px; font-weight: bold;">Category:</label>
      <select id="supportCategory" style="width: 100%; max-width: 400px;">
        <option value="Bug">Bug Report</option>
        <option value="Suggestion">Feature Suggestion</option>
        <option value="Other">Other</option>
      </select>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label for="supportSubject" style="display: block; margin-bottom: 5px; font-weight: bold;">Subject: <span style="color: #e74c3c;">*</span></label>
      <input type="text" id="supportSubject" placeholder="Brief description of the issue or suggestion" 
             style="width: 100%; max-width: 600px; padding: 8px;" />
    </div>
    
    <div style="margin-bottom: 15px;">
      <label for="supportMessage" style="display: block; margin-bottom: 5px; font-weight: bold;">Message: <span style="color: #e74c3c;">*</span></label>
      <textarea id="supportMessage" placeholder="Please provide details about the bug or your suggestion..."
                style="width: 100%; max-width: 600px; min-height: 150px; padding: 8px; font-family: inherit;"></textarea>
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px; background: #34495e; border-radius: 6px; max-width: 600px;">
      <small style="color: #ecf0f1;">
        <strong>Privacy Note:</strong> This form does not automatically send any employee data or schedule information. 
        Only the information you type in the subject and message fields will be included.
      </small>
    </div>
    
    <button type="button" onclick="submitSupport()" style="background: #27ae60; font-size: 16px; padding: 10px 20px;">
      üìß Send Message
    </button>
    
    <div id="supportFeedback" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
  </div>
  
  <div style="margin-top: 30px; padding: 15px; background: #2e2e3d; border-radius: 8px; max-width: 600px;">
    <h4 style="margin-top: 0;">Alternative Contact Methods:</h4>
    <p style="margin: 5px 0;">
      üìß Email directly: <a href="/cdn-cgi/l/email-protection#99d8f5f0f8f5f8f7f7f6f6f7d9fef4f8f0f5b7faf6f4" style="color: #4e9af1;"><span class="__cf_email__" data-cfemail="c081aca9a1aca1aeaeafafae80a7ada1a9aceea3afad">[email&#160;protected]</span></a>
    </p>
    <p style="margin: 5px 0; color: #95a5a6; font-size: 14px;">
      We typically respond within 1-2 business days.
    </p>
  </div>
</div>
</div>

<!-- DEMO MODE -->
<div id="demoTab" class="tab">
<h2>üé¨ Demo Mode</h2>

<div style="max-width: 800px; margin: 0 auto;">
  <div style="padding: 20px; background: #2e2e3d; border-radius: 8px; margin-bottom: 20px;">
    <h3 style="margin-top: 0; color: #e67e22;">Welcome to BanquetLogic Demo!</h3>
    <p style="font-size: 16px; line-height: 1.6;">
      This guided demonstration will walk you through all the features of BanquetLogic, 
      showing you how to manage employees, create events, generate schedules, and more.
    </p>
    
    <div style="padding: 15px; background: #34495e; border-radius: 6px; margin: 15px 0;">
      <strong style="color: #f39c12;">‚ö†Ô∏è Important ‚Äî Demo data is temporary</strong>
      <ul style="margin: 10px 0; padding-left: 20px;">
        <li>Demo uses sample data only. Your real data is <strong>not</strong> modified.</li>
        <li>When you click <strong>Stop Demo</strong>, all demo data is removed and your real employees, events, and schedules are restored.</li>
        <li>Takes approximately 3‚Äì5 minutes. You can stop the demo at any time.</li>
      </ul>
    </div>
    
    <div style="text-align: center; margin-top: 25px;">
      <button type="button" onclick="startDemo()" style="background: #27ae60; font-size: 18px; padding: 15px 30px;">
        ‚ñ∂Ô∏è Start Demo
      </button>
      <div id="demoStopArea" style="display: none; margin-top: 20px; padding: 20px; background: #1e1e2f; border-radius: 8px; border: 2px solid #e74c3c;">
        <p style="margin: 0 0 15px 0; font-size: 16px; color: #f0f0f0;">To exit demo and restore your real data, click below:</p>
        <button type="button" id="stopDemoBtn" onclick="stopDemo()" style="background: #e74c3c; color: #fff; font-size: 20px; padding: 16px 32px; border: 2px solid #fff; border-radius: 8px; font-weight: bold; cursor: pointer;">
          ‚èπÔ∏è Stop Demo &amp; Restore My Data
        </button>
      </div>
    </div>
  </div>
  
  <div id="demoStatus" style="padding: 15px; background: #1e1e2f; border-radius: 8px; margin-bottom: 20px; display: none; border-left: 4px solid #e67e22;">
    <h4 style="margin-top: 0; color: #4e9af1;">Demo Progress</h4>
    <p style="margin: 0 0 10px 0; font-size: 13px; color: #95a5a6;">All data shown is temporary. Your real data will be restored when you click <strong>Stop Demo</strong> (in the orange banner above or below).</p>
    <div id="demoStepInfo" style="font-size: 15px; line-height: 1.8;"></div>
    <div style="margin-top: 10px; background: #2e2e3d; border-radius: 4px; height: 30px; overflow: hidden;">
      <div id="demoProgress" style="background: #27ae60; height: 100%; width: 0%; transition: width 0.5s;"></div>
    </div>
  </div>
  
  <div id="demoInstructions" style="padding: 20px; background: #2e2e3d; border-radius: 8px;">
    <h3 style="margin-top: 0;">What You'll Learn:</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      <div style="padding: 15px; background: #34495e; border-radius: 6px;">
        <h4 style="margin: 0 0 10px 0; color: #4e9af1;">üë• Employee Management</h4>
        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
          <li>Add employees with details</li>
          <li>Set seniority and preferences</li>
          <li>Configure day preferences</li>
          <li>Manage vacation days</li>
        </ul>
      </div>
      
      <div style="padding: 15px; background: #34495e; border-radius: 6px;">
        <h4 style="margin: 0 0 10px 0; color: #4e9af1;">üìÖ Event Creation</h4>
        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
          <li>Create banquet events</li>
          <li>Set dates and times</li>
          <li>Configure guest counts</li>
          <li>Auto-calculate staff needs</li>
        </ul>
      </div>
      
      <div style="padding: 15px; background: #34495e; border-radius: 6px;">
        <h4 style="margin: 0 0 10px 0; color: #4e9af1;">üìä Smart Scheduling</h4>
        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
          <li>Auto-generate schedules</li>
          <li>Respect preferences</li>
          <li>Balance hours fairly</li>
          <li>Handle conflicts</li>
        </ul>
      </div>
      
      <div style="padding: 15px; background: #34495e; border-radius: 6px;">
        <h4 style="margin: 0 0 10px 0; color: #4e9af1;">üîß Advanced Features</h4>
        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
          <li>Manual shift editing</li>
          <li>Lock schedules</li>
          <li>Email to employees</li>
          <li>Audit logging</li>
        </ul>
      </div>
    </div>
  </div>
</div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
let employees = JSON.parse(localStorage.getItem("employees") || "[]");
let events = JSON.parse(localStorage.getItem("events") || "[]");
let manualEdits = JSON.parse(localStorage.getItem("manualEdits") || "{}");
let lockedCells = JSON.parse(localStorage.getItem("lockedCells") || "{}");
let lockedRows = JSON.parse(localStorage.getItem("lockedRows") || "{}");
let scheduleGlobalLock = JSON.parse(localStorage.getItem("scheduleGlobalLock") || "false");
let auditLog = JSON.parse(localStorage.getItem("auditLog") || "[]");
(function() {
  var reasonVersion = localStorage.getItem("assignmentReasonVersion");
  if (reasonVersion !== "2") {
    localStorage.removeItem("assignmentReasons");
    localStorage.removeItem("assignmentReasonTags");
    localStorage.setItem("assignmentReasonVersion", "2");
  }
})();
let assignmentReasons = JSON.parse(localStorage.getItem("assignmentReasons") || "{}"); // Store why each shift was assigned (plain-language only)
let assignmentReasonTags = JSON.parse(localStorage.getItem("assignmentReasonTags") || "{}"); // Abstract tags for human-readable explanations
let generationConflicts = [];
var APP_VERSION = '1.0';
var SCHEMA_VERSION = 1;

var REASON_TAG_EXPLANATIONS = {
  manual_lock: 'This shift was manually assigned or locked.',
  availability: 'Employee was available for this shift.',
  seniority: 'Selected in line with seniority policy.',
  no_conflicts: 'No scheduling conflicts this week.',
  rotation_balance: 'Assigned to support balanced hours under current policy.',
  within_max_days: 'Within allowed working days for the week.',
  full_time: 'Full-time status under current policy.',
  prefers_shift: 'Shift preference matched for this time.',
  day_preference: 'Day preference matched.'
};

var ABSENCE_TYPES = [
  { id: 'sick', label: 'Sick', cellLabel: '(Sick)', reason: 'Marked Sick manually', paid: true },
  { id: 'vacation', label: 'Vacation (Paid)', cellLabel: '(Vacation)', reason: 'Vacation added by manager', paid: true },
  { id: 'floating_holiday', label: 'Floating Holiday (Paid)', cellLabel: '(Floating Holiday)', reason: 'Floating holiday added by manager', paid: true },
  { id: 'unpaid_vacation', label: 'Unpaid Vacation', cellLabel: '(Unpaid Vacation)', reason: 'Unpaid vacation added by manager', paid: false },
  { id: 'requested_off', label: 'Request Off', cellLabel: '(Requested Off)', reason: 'Request off (visual only)', paid: null }
];
function isFullAbsenceStatus(status) {
  return status === 'sick' || status === 'vacation' || status === 'floating_holiday' || status === 'unpaid_vacation';
}
var REASON_TAG_PRIORITY = ['manual_lock', 'availability', 'seniority', 'no_conflicts', 'rotation_balance', 'within_max_days', 'full_time', 'prefers_shift', 'day_preference'];
let settings = JSON.parse(localStorage.getItem("settings") || JSON.stringify({
  assignmentStyle: "strict", // Default: Strict Seniority
  ratios: {
    "Plated Service": 20,
    "Buffet Service": 30,
    "Reception": 40,
    "Coffee Break": 50
  }
}));

function getDefaultEventTypes() {
  var r = settings.ratios || { "Plated Service": 20, "Buffet Service": 30, "Reception": 40, "Coffee Break": 50 };
  return Object.keys(r).map(function(name) {
    return { id: crypto.randomUUID(), name: name, guestsPerServer: r[name], active: true };
  });
}
var eventTypes = JSON.parse(localStorage.getItem("eventTypes") || "null");
if (!eventTypes || eventTypes.length === 0) {
  eventTypes = getDefaultEventTypes();
  localStorage.setItem("eventTypes", JSON.stringify(eventTypes));
}
function getActiveEventTypes() { return eventTypes.filter(function(t) { return t.active; }); }
function getEventTypeById(id) { return eventTypes.find(function(t) { return t.id === id; }); }
function getEventTypeByName(name) { return eventTypes.find(function(t) { return t.name === name; }); }
function isEventTypeUsedByEvents(type) {
  return events.some(function(ev) { return ev.eventTypeId === type.id || ev.service === type.name; });
}

let editingEventId = null;
let currentWeekOffset = 0;

(function clearDemoDataIfRefresh() {
  try {
    if (!sessionStorage.getItem('banquetlogic_demo_active')) return;
    employees = [];
    events = [];
    manualEdits = {};
    lockedCells = {};
    lockedRows = {};
    scheduleGlobalLock = false;
    auditLog = [];
    assignmentReasons = {};
    assignmentReasonTags = {};
    generationConflicts = [];
    editingEventId = null;
    currentWeekOffset = 0;
    settings = { assignmentStyle: 'strict', ratios: { 'Plated Service': 20, 'Buffet Service': 30, 'Reception': 40, 'Coffee Break': 50 } };
    eventTypes = getDefaultEventTypes();
    localStorage.setItem('eventTypes', JSON.stringify(eventTypes));
    localStorage.setItem('employees', '[]');
    localStorage.setItem('events', '[]');
    localStorage.setItem('manualEdits', '{}');
    localStorage.setItem('lockedCells', '{}');
    localStorage.setItem('lockedRows', '{}');
    localStorage.setItem('scheduleGlobalLock', 'false');
    localStorage.setItem('auditLog', '[]');
    localStorage.setItem('assignmentReasons', '{}');
    localStorage.setItem('assignmentReasonTags', '{}');
    localStorage.setItem('settings', JSON.stringify(settings));
    sessionStorage.removeItem('banquetlogic_demo_active');
  } catch (e) {}
})();

// Initialize day preferences for existing employees (backward compatibility)
employees.forEach(emp => {
  if(!emp.dayPreferences) {
    emp.dayPreferences = {
      // 0=Sunday, 1=Monday, etc.
      // null = no preference, true = prefers to work, false = prefers off
      0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null
    };
  }
  if(emp.maxDaysPerWeek === undefined) {
    emp.maxDaysPerWeek = 5; // Default to 5 days per week
  }
});

function save(){
  localStorage.setItem("employees", JSON.stringify(employees));
  localStorage.setItem("events", JSON.stringify(events));
  localStorage.setItem("manualEdits", JSON.stringify(manualEdits));
  localStorage.setItem("lockedCells", JSON.stringify(lockedCells));
  localStorage.setItem("lockedRows", JSON.stringify(lockedRows));
  localStorage.setItem("scheduleGlobalLock", JSON.stringify(scheduleGlobalLock));
  localStorage.setItem("auditLog", JSON.stringify(auditLog));
  localStorage.setItem("assignmentReasons", JSON.stringify(assignmentReasons));
  localStorage.setItem("assignmentReasonTags", JSON.stringify(assignmentReasonTags));
  localStorage.setItem("settings", JSON.stringify(settings));
  localStorage.setItem("eventTypes", JSON.stringify(eventTypes));
  scheduleAutoBackup();
}

/* DATA EXPORT / IMPORT (centralized for future cloud sync) */
function getDataForExport() {
  return {
    employees: employees,
    events: events,
    manualEdits: manualEdits,
    lockedCells: lockedCells,
    lockedRows: lockedRows,
    scheduleGlobalLock: scheduleGlobalLock,
    auditLog: auditLog,
    assignmentReasons: assignmentReasons,
    assignmentReasonTags: assignmentReasonTags,
    settings: settings,
    eventTypes: eventTypes,
    metadata: {
      schemaVersion: SCHEMA_VERSION,
      appVersion: APP_VERSION,
      exportTimestamp: new Date().toISOString()
    }
  };
}

function getDataForBackup(backupType) {
  var payload = getDataForExport();
  payload.metadata.exportTimestamp = undefined;
  payload.metadata.backupTimestamp = new Date().toISOString();
  payload.metadata.backupType = backupType;
  return payload;
}

/* AUTOMATIC BACKUPS (IndexedDB ‚Äì separate from live data) */
var BACKUP_DB_NAME = 'BanquetLogicBackups';
var BACKUP_STORE = 'backups';
var MAX_AUTO_BACKUPS = 10;
var lastAutoBackupTime = 0;
var AUTO_BACKUP_THROTTLE_MS = 60000;

function backupOpenDB() {
  return new Promise(function(resolve, reject) {
    var req = indexedDB.open(BACKUP_DB_NAME, 1);
    req.onerror = function() { reject(req.error); };
    req.onsuccess = function() { resolve(req.result); };
    req.onupgradeneeded = function(ev) {
      var db = ev.target.result;
      if (!db.objectStoreNames.contains(BACKUP_STORE)) {
        var store = db.createObjectStore(BACKUP_STORE, { keyPath: 'id', autoIncrement: true });
        store.createIndex('byTimestamp', 'backupTimestamp', { unique: false });
        store.createIndex('byType', 'backupType', { unique: false });
      }
    };
  });
}

function backupCreate(backupType, payload) {
  if (!payload) payload = getDataForBackup(backupType);
  var record = {
    backupTimestamp: payload.metadata.backupTimestamp,
    backupType: backupType,
    data: payload
  };
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readwrite');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.add(record);
      req.onsuccess = function() { db.close(); resolve(req.result); };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupList() {
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readonly');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.getAll();
      req.onsuccess = function() {
        db.close();
        var list = req.result || [];
        list.sort(function(a, b) {
          var tA = a.backupTimestamp || '';
          var tB = b.backupTimestamp || '';
          return tA > tB ? -1 : tA < tB ? 1 : 0;
        });
        resolve(list);
      };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupGet(id) {
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readonly');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.get(id);
      req.onsuccess = function() { db.close(); resolve(req.result); };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupDelete(id) {
  return backupOpenDB().then(function(db) {
    return new Promise(function(resolve, reject) {
      var tx = db.transaction(BACKUP_STORE, 'readwrite');
      var store = tx.objectStore(BACKUP_STORE);
      var req = store.delete(id);
      req.onsuccess = function() { db.close(); resolve(); };
      req.onerror = function() { db.close(); reject(req.error); };
    });
  });
}

function backupPruneAuto() {
  return backupList().then(function(list) {
    var auto = list.filter(function(b) { return b.backupType === 'auto'; });
    if (auto.length <= MAX_AUTO_BACKUPS) return Promise.resolve();
    var toRemove = auto.slice(MAX_AUTO_BACKUPS);
    return Promise.all(toRemove.map(function(b) { return backupDelete(b.id); }));
  });
}

function scheduleAutoBackup() {
  if (typeof demoInProgress !== 'undefined' && demoInProgress) return;
  var now = Date.now();
  if (lastAutoBackupTime && (now - lastAutoBackupTime) < AUTO_BACKUP_THROTTLE_MS) return;
  lastAutoBackupTime = now;
  backupCreate('auto').then(function() {
    return backupPruneAuto();
  }).catch(function() {});
}

function formatBackupLabel(record) {
  var ts = record.backupTimestamp || '';
  var type = (record.backupType === 'manual') ? 'Manual Backup' : 'Auto Backup';
  var dateStr = '';
  if (ts) {
    try {
      var d = new Date(ts);
      dateStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) + ', ' + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    } catch (e) { dateStr = ts; }
  } else {
    dateStr = 'Unknown date';
  }
  return type + ' ‚Äì ' + dateStr;
}

function openRestoreBackupModal() {
  document.getElementById('restoreBackupModalOverlay').style.display = 'flex';
  var listEl = document.getElementById('restoreBackupList');
  listEl.innerHTML = '<p style="color: var(--brand-text-muted);">Loading backups‚Ä¶</p>';
  backupList().then(function(list) {
    if (!list.length) {
      listEl.innerHTML = '<p style="color: var(--brand-text-muted);">No backups found. Automatic backups are created when you make changes.</p>';
      return;
    }
    listEl.innerHTML = '';
    list.forEach(function(rec) {
      var row = document.createElement('div');
      row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--brand-border);';
      row.innerHTML = '<span>' + formatBackupLabel(rec) + '</span><span><button type="button" onclick="restoreFromBackup(' + rec.id + ')">Restore</button> <button type="button" onclick="exportBackupToFile(' + rec.id + ')">Export</button></span>';
      listEl.appendChild(row);
    });
  }).catch(function() {
    listEl.innerHTML = '<p style="color: #e74c3c;">Could not load backups. Please try again.</p>';
  });
}

function closeRestoreBackupModal() {
  document.getElementById('restoreBackupModalOverlay').style.display = 'none';
}

function restoreFromBackup(id) {
  if (!confirm('Restoring will replace all current data. Continue?')) return;
  backupGet(id).then(function(record) {
    if (!record || !record.data) {
      alert('This backup could not be read.');
      return;
    }
    var data = record.data;
    var errMsg = validateImportData(data);
    if (errMsg) {
      alert('This backup cannot be restored: ' + errMsg);
      return;
    }
    data = migrateImportData(data);
    applyImportedData(data);
    reRenderAfterImport();
    closeRestoreBackupModal();
    alert('Restore complete. Your backup has been restored.');
  }).catch(function() {
    alert('Could not load this backup. Please try again.');
  });
}

function createManualBackup() {
  backupCreate('manual').then(function() {
    alert('Backup created. You can restore it anytime from Restore from Backup.');
  }).catch(function() {
    alert('Could not create backup. Please try again.');
  });
}

function exportBackupToFile(id) {
  backupGet(id).then(function(record) {
    if (!record || !record.data) {
      alert('This backup could not be read.');
      return;
    }
    var payload = record.data;
    var json = JSON.stringify(payload, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var ts = record.backupTimestamp || new Date().toISOString();
    var d = new Date(ts);
    var dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    var filename = 'banquetlogic-backup-' + dateStr + '.json';
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }).catch(function() {
    alert('Could not load this backup. Please try again.');
  });
}

function exportData() {
  var payload = getDataForExport();
  var json = JSON.stringify(payload, null, 2);
  var blob = new Blob([json], { type: 'application/json' });
  var date = new Date();
  var dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
  var filename = 'banquetlogic-backup-' + dateStr + '.json';
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function getImportedSchemaVersion(data) {
  if (!data || !data.metadata || typeof data.metadata !== 'object') return 0;
  var v = data.metadata.schemaVersion;
  return typeof v === 'number' && v >= 0 ? v : 0;
}

function validateImportData(data) {
  if (!data || typeof data !== 'object') return 'The file does not contain valid backup data.';
  if (data.employees !== undefined && !Array.isArray(data.employees)) return 'Employee data in the file is invalid.';
  if (data.events !== undefined && !Array.isArray(data.events)) return 'Event data in the file is invalid.';
  if (data.auditLog !== undefined && !Array.isArray(data.auditLog)) return 'Audit log data in the file is invalid.';
  if (data.eventTypes !== undefined && !Array.isArray(data.eventTypes)) return 'Event types in the file are invalid.';
  if (data.manualEdits !== undefined && (typeof data.manualEdits !== 'object' || data.manualEdits === null)) return 'Schedule data in the file is invalid.';
  if (data.lockedCells !== undefined && (typeof data.lockedCells !== 'object' || data.lockedCells === null)) return 'Lock data in the file is invalid.';
  if (data.lockedRows !== undefined && (typeof data.lockedRows !== 'object' || data.lockedRows === null)) return 'Lock data in the file is invalid.';
  if (data.assignmentReasons !== undefined && (typeof data.assignmentReasons !== 'object' || data.assignmentReasons === null)) return 'Assignment data in the file is invalid.';
  if (data.assignmentReasonTags !== undefined && (typeof data.assignmentReasonTags !== 'object' || data.assignmentReasonTags === null)) return 'Assignment data in the file is invalid.';
  if (data.settings !== undefined && (typeof data.settings !== 'object' || data.settings === null)) return 'Settings in the file are invalid.';
  return null;
}

function migrateImportData(data) {
  var result = {};
  var k;
  for (k in data) if (Object.prototype.hasOwnProperty.call(data, k)) result[k] = data[k];
  if (!Array.isArray(result.employees)) result.employees = [];
  if (!Array.isArray(result.events)) result.events = [];
  if (!result.manualEdits || typeof result.manualEdits !== 'object') result.manualEdits = {};
  if (!result.lockedCells || typeof result.lockedCells !== 'object') result.lockedCells = {};
  if (!result.lockedRows || typeof result.lockedRows !== 'object') result.lockedRows = {};
  result.scheduleGlobalLock = result.scheduleGlobalLock === true || result.scheduleGlobalLock === 'true';
  if (!Array.isArray(result.auditLog)) result.auditLog = [];
  if (!result.assignmentReasons || typeof result.assignmentReasons !== 'object') result.assignmentReasons = {};
  if (!result.assignmentReasonTags || typeof result.assignmentReasonTags !== 'object') result.assignmentReasonTags = {};
  if (!result.settings || typeof result.settings !== 'object') result.settings = { assignmentStyle: 'strict', ratios: {} };
  if (!Array.isArray(result.eventTypes)) {
    var r = (result.settings && result.settings.ratios) ? result.settings.ratios : { 'Plated Service': 20, 'Buffet Service': 30, 'Reception': 40, 'Coffee Break': 50 };
    result.eventTypes = Object.keys(r).map(function(name) {
      return { id: crypto.randomUUID(), name: name, guestsPerServer: r[name], active: true };
    });
  }
  if (!result.metadata || typeof result.metadata !== 'object') result.metadata = {};
  result.metadata.schemaVersion = SCHEMA_VERSION;
  return result;
}

function ensureEmployeeDefaults(list) {
  if (!Array.isArray(list)) return;
  list.forEach(function(emp) {
    if (!emp.dayPreferences) {
      emp.dayPreferences = { 0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null };
    }
    if (emp.maxDaysPerWeek === undefined) emp.maxDaysPerWeek = 5;
  });
}

function applyImportedData(data) {
  employees = Array.isArray(data.employees) ? data.employees : [];
  ensureEmployeeDefaults(employees);
  events = Array.isArray(data.events) ? data.events : [];
  manualEdits = data.manualEdits && typeof data.manualEdits === 'object' ? data.manualEdits : {};
  lockedCells = data.lockedCells && typeof data.lockedCells === 'object' ? data.lockedCells : {};
  lockedRows = data.lockedRows && typeof data.lockedRows === 'object' ? data.lockedRows : {};
  scheduleGlobalLock = data.scheduleGlobalLock === true || data.scheduleGlobalLock === 'true';
  auditLog = Array.isArray(data.auditLog) ? data.auditLog : [];
  assignmentReasons = data.assignmentReasons && typeof data.assignmentReasons === 'object' ? data.assignmentReasons : {};
  assignmentReasonTags = data.assignmentReasonTags && typeof data.assignmentReasonTags === 'object' ? data.assignmentReasonTags : {};
  settings = data.settings && typeof data.settings === 'object' ? data.settings : { assignmentStyle: 'strict', ratios: {} };
  eventTypes = Array.isArray(data.eventTypes) ? data.eventTypes : getDefaultEventTypes();
  editingEventId = null;
}

function reRenderAfterImport() {
  save();
  renderEmployees();
  renderEvents();
  displaySchedule();
  loadSettings();
  renderAuditLog();
  populateEventServiceDropdown();
}

function handleImportFile(ev) {
  var file = ev.target.files[0];
  ev.target.value = '';
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function() {
    var errMsg = null;
    var data = null;
    try {
      data = JSON.parse(reader.result);
      errMsg = validateImportData(data);
    } catch (e) {
      errMsg = 'The file could not be read. It may be damaged or not a valid backup file.';
    }
    if (errMsg) {
      alert(errMsg);
      return;
    }
    var importedVersion = getImportedSchemaVersion(data);
    if (importedVersion > SCHEMA_VERSION) {
      if (!confirm('This backup was created by a newer version of the app. Some information may not work as expected in this version.\n\nDo you want to try importing anyway?')) return;
    } else if (!confirm('Importing will replace all existing data. Continue?')) return;
    data = migrateImportData(data);
    applyImportedData(data);
    reRenderAfterImport();
    if (importedVersion > SCHEMA_VERSION) {
      alert('Import complete. If anything looks wrong, try updating the app and then import again.');
    } else if (importedVersion < SCHEMA_VERSION) {
      alert('Import complete. Your backup has been restored and updated for this version.');
    } else {
      alert('Import complete. Your backup has been restored.');
    }
  };
  reader.onerror = function() {
    alert('The file could not be read. Please try again.');
  };
  reader.readAsText(file, 'UTF-8');
}

function addAuditEntry(action, empId, date, oldValue, newValue){
  const emp = employees.find(e => e.id === empId);
  auditLog.unshift({
    timestamp: new Date().toISOString(),
    action,
    employee: emp ? emp.name : 'Unknown',
    employeeId: empId,
    date,
    oldValue,
    newValue
  });
  
  // Keep only last 1000 entries
  if(auditLog.length > 1000) auditLog = auditLog.slice(0, 1000);
  
  save();
}

/* TABS */
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="employeesTab") tabEmpBtn.classList.add("active");
  if(id==="eventsTab") { tabEvBtn.classList.add("active"); populateEventServiceDropdown(); }
  if(id==="scheduleTab") { tabSchBtn.classList.add("active"); displaySchedule(); }
  if(id==="auditTab") { tabAuditBtn.classList.add("active"); renderAuditLog(); }
  if(id==="settingsTab") { tabSettingsBtn.classList.add("active"); loadSettings(); }
  if(id==="supportTab") { tabSupportBtn.classList.add("active"); }
  if(id==="demoTab") { tabDemoBtn.classList.add("active"); }
}


function showGenerationRules() {
  const assignmentStyle = settings.assignmentStyle || 'strict';
  
  let rules = 'üìã How We Build Your Schedule\n';
  rules += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
  rules += 'We only assign people who are available and within your rules. ';
  rules += 'That means we skip anyone who is sick, on vacation, or already working their max days that week. ';
  rules += 'We never change locked shifts or locked rows‚Äîthose stay exactly as you set them. ';
  rules += 'We also make sure everyone has at least 8 hours rest between shifts.\n\n';
  
  rules += 'Within that, we pick who gets each shift based on your current mode:\n\n';
  
  if(assignmentStyle === 'strict') {
    rules += 'Strict Seniority\n';
    rules += 'We prioritize by seniority first. More senior staff get first choice of shifts. ';
    rules += 'Full-time staff are preferred over part-time when it makes sense. ';
    rules += 'We also try to match people\'s preferences for morning vs afternoon and for certain days of the week.\n\n';
  } else if(assignmentStyle === 'balanced') {
    rules += 'Seniority + Balanced Coverage\n';
    rules += 'We balance full-time and part-time coverage across the week so no one type is overused. ';
    rules += 'Within that balance, we favor seniority and try to keep hours in line with what each person typically works. ';
    rules += 'We also respect preferences for morning vs afternoon and for specific days.\n\n';
  } else {
    rules += 'Fair Distribution\n';
    rules += 'We spread hours fairly so people who have worked less so far get more opportunity. ';
    rules += 'We still respect preferences for morning vs afternoon and for certain days. ';
    rules += 'Seniority is used only to break ties when needed.\n\n';
  }
  
  rules += 'If we can\'t fill a shift (e.g. not enough eligible staff), we assign who we can and note it in the Conflicts report. ';
  rules += 'You can click any generated shift to see why that person was chosen.';
  
  alert(rules);
}

function showConflictReport() {
  if(generationConflicts.length === 0) {
    alert('No conflicts detected in last generation.\n\nAll shifts were successfully assigned!');
    return;
  }
  
  let report = '‚ö†Ô∏è SCHEDULE GENERATION CONFLICTS\n';
  report += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
  report += `Found ${generationConflicts.length} conflict(s):\n\n`;
  
  generationConflicts.forEach((conflict, index) => {
    report += `${index + 1}. ${conflict.event} on ${conflict.date}\n`;
    report += `   Required: ${conflict.required} staff\n`;
    report += `   Assigned: ${conflict.assigned} staff\n`;
    report += `   Shortage: ${conflict.shortage} staff\n`;
    report += `   Reason: ${conflict.reason}\n\n`;
  });
  
  report += 'POSSIBLE SOLUTIONS:\n';
  report += '‚Ä¢ Hire additional staff\n';
  report += '‚Ä¢ Adjust employee max days/week limits\n';
  report += '‚Ä¢ Remove vacation/sick days if not needed\n';
  report += '‚Ä¢ Reduce event staffing requirements\n';
  report += '‚Ä¢ Manually override and assign shifts';
  
  alert(report);
}

function getAssignmentExplanation(empId, dateStr) {
  const key = empId + "_" + dateStr;
  var edit = manualEdits[key];
  if (edit && edit.absenceReason) return edit.absenceReason;
  if (edit && edit.manualOverride) return 'Manually assigned by scheduler.';
  if (lockedCells[key]) return REASON_TAG_EXPLANATIONS.manual_lock;
  const tags = assignmentReasonTags[key];
  if (!tags || !tags.length) return null;
  var ordered = [];
  for (var i = 0; i < REASON_TAG_PRIORITY.length && ordered.length < 3; i++) {
    var t = REASON_TAG_PRIORITY[i];
    if (t === 'manual_lock') continue;
    if (tags.indexOf(t) !== -1) ordered.push(t);
  }
  if (ordered.length === 0) return 'Selected per current scheduling policy.';
  var combined = [];
  var usedAvailability = false;
  var usedNoConflicts = false;
  for (var j = 0; j < ordered.length; j++) {
    var tag = ordered[j];
    if (tag === 'availability' && ordered.indexOf('no_conflicts') !== -1) {
      if (!usedAvailability) { combined.push('Available with no scheduling conflicts this week.'); usedAvailability = true; usedNoConflicts = true; }
      continue;
    }
    if (tag === 'no_conflicts') { if (!usedNoConflicts) combined.push(REASON_TAG_EXPLANATIONS.no_conflicts); usedNoConflicts = true; continue; }
    if (tag === 'availability') { if (!usedAvailability) combined.push(REASON_TAG_EXPLANATIONS.availability); usedAvailability = true; continue; }
    combined.push(REASON_TAG_EXPLANATIONS[tag] || tag);
  }
  if (combined.length === 0) return 'Selected per current scheduling policy.';
  if (combined.length === 1) return combined[0];
  return combined.slice(0, 2).join(' ') + (combined.length > 2 ? ' ' + combined[2] : '');
}

function showAssignmentReason(empId, dateStr) {
  const key = empId + "_" + dateStr;
  const emp = employees.find(e => e.id === empId);
  const date = new Date(dateStr);
  const explanation = getAssignmentExplanation(empId, dateStr);
  const title = emp ? (emp.name + ' ‚Äì ' + date.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' })) : 'Shift';
  if (explanation) {
    alert(title + '\n\n' + explanation);
  } else {
    alert(title + '\n\nThis shift was manually assigned or comes from an earlier schedule. No policy-based explanation is stored.');
  }
}

/* EMAIL SCHEDULES */
function emailSchedulesToAll() {
  // Get current week
  const start = getWeekStart();
  const days = [...Array(7)].map((_, i) => {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    return d;
  });
  
  const weekRange = `${days[0].toLocaleDateString()} ‚Äì ${days[6].toLocaleDateString()}`;
  
  // Check for employees without email
  const activeEmployees = employees.filter(e => !e.retired);
  const employeesWithoutEmail = [];
  const employeesWithSchedule = [];
  
  activeEmployees.forEach(emp => {
    // Check if employee has any shifts this week
    let hasShifts = false;
    days.forEach(d => {
      const dateStr = iso(d);
      const key = emp.id + "_" + dateStr;
      if(manualEdits[key] && !isFullAbsenceStatus(manualEdits[key].status) && (manualEdits[key].hours || manualEdits[key].start)) {
        hasShifts = true;
      }
    });
    
    if(hasShifts) {
      if(!emp.email) {
        employeesWithoutEmail.push(emp.name);
      } else {
        employeesWithSchedule.push(emp);
      }
    }
  });
  
  // Show warning if any employees missing email
  if(employeesWithoutEmail.length > 0) {
    let warning = '‚ö†Ô∏è WARNING: Cannot send schedules to employees without email addresses!\n\n';
    warning += 'Missing email for:\n';
    employeesWithoutEmail.forEach(name => {
      warning += `‚Ä¢ ${name}\n`;
    });
    warning += '\nPlease add or edit email addresses in the Employees tab (click the email cell).\n\n';
    
    if(employeesWithSchedule.length > 0) {
      warning += `Continue sending to ${employeesWithSchedule.length} employee(s) with valid emails?`;
      
      if(!confirm(warning)) {
        return;
      }
    } else {
      alert(warning + '\nNo employees have email addresses set. Cannot send any schedules.');
      return;
    }
  }
  
  if(employeesWithSchedule.length === 0) {
    alert('No employees with shifts and valid email addresses for this week.');
    return;
  }
  
  // Generate individual schedules and open email clients
  let successCount = 0;
  
  employeesWithSchedule.forEach((emp, index) => {
    setTimeout(() => {
      const emailContent = generateEmployeeScheduleEmail(emp, days);
      
      const subject = encodeURIComponent(`Your BanquetLogic Schedule - Week of ${days[0].toLocaleDateString()}`);
      const body = encodeURIComponent(emailContent);
      const mailtoLink = `mailto:${emp.email}?subject=${subject}&body=${body}`;
      
      // Open email client
      window.open(mailtoLink, '_blank');
      
      successCount++;
      
      // Log in audit
      addAuditEntry('Schedule Emailed', emp.id, null, null, `Week: ${weekRange}`);
      
    }, index * 500); // Delay each email by 500ms to avoid browser blocking
  });
  
  save();
  
  // Show confirmation
  setTimeout(() => {
    let message = `‚úÖ Opened ${successCount} email client window(s)!\n\n`;
    message += `Please send each email from your email client.\n\n`;
    message += `Employees receiving schedules:\n`;
    employeesWithSchedule.forEach(emp => {
      message += `‚Ä¢ ${emp.name} (${emp.email})\n`;
    });
    
    if(employeesWithoutEmail.length > 0) {
      message += `\n‚ö†Ô∏è Skipped (no email):\n`;
      employeesWithoutEmail.forEach(name => {
        message += `‚Ä¢ ${name}\n`;
      });
    }
    
    alert(message);
  }, employeesWithSchedule.length * 500 + 200);
}

function generateEmployeeScheduleEmail(emp, days) {
  let email = `Hello ${emp.name},\n\n`;
  email += `Here is your work schedule for the week of ${days[0].toLocaleDateString()}:\n\n`;
  email += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  
  let totalHours = 0;
  let daysWorked = 0;
  
  days.forEach(d => {
    const dateStr = iso(d);
    const key = emp.id + "_" + dateStr;
    const dayName = d.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
    
    if(manualEdits[key]) {
      const edit = manualEdits[key];
      var absInfo = edit.status ? ABSENCE_TYPES.find(function(a) { return a.id === edit.status; }) : null;
      if (absInfo && (isFullAbsenceStatus(edit.status) || (edit.status === 'requested_off' && !edit.hours && !edit.start))) {
        email += `${dayName}\n`;
        email += `  Status: ${absInfo.cellLabel}\n\n`;
      } else if (edit.hours || edit.start) {
        const hours = edit.hours || edit;
        totalHours += hours;
        daysWorked++;
        
        email += `${dayName}\n`;
        email += `  Hours: ${hours}h\n`;
        if(edit.start && edit.end) {
          email += `  Time: ${edit.start} ‚Äì ${edit.end}\n`;
        }
        
        // Find event for this day
        const event = events.find(ev => ev.date === dateStr);
        if(event) {
          email += `  Event: ${event.name}\n`;
        }
        email += '\n';
      } else {
        email += `${dayName}\n`;
        email += `  OFF\n\n`;
      }
    } else {
      email += `${dayName}\n`;
      email += `  OFF\n\n`;
    }
  });
  
  email += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  email += `SUMMARY:\n`;
  email += `Total Hours: ${totalHours}h\n`;
  email += `Days Worked: ${daysWorked}\n\n`;
  
  email += `If you have any questions or concerns about your schedule, please contact your manager.\n\n`;
  email += `Thank you,\nBanquetLogic Scheduling`;
  
  return email;
}

/* EMPLOYEES */
function getNextSeniority() {
  if (employees.length === 0) return 1;
  var max = Math.max.apply(null, employees.map(function(e) { return e.seniority || 0; }));
  return max + 1;
}

function validateSeniority(value, excludeEmployeeId) {
  var num = parseInt(value, 10);
  if (value === '' || value === null || value === undefined) return { ok: false, message: 'Seniority is required.' };
  if (isNaN(num)) return { ok: false, message: 'Seniority must be a number.' };
  if (num < 1) return { ok: false, message: 'Seniority must be at least 1.' };
  var taken = employees.some(function(e) { return e.id !== excludeEmployeeId && e.seniority === num; });
  if (taken) return { ok: false, message: 'Another employee already has this seniority number. Each employee must have a unique seniority.' };
  return { ok: true, value: num };
}

function updateSeniorityPreFill() {
  var el = document.getElementById('empSeniority');
  if (el) el.value = getNextSeniority();
}

function addEmployee(){
  if(!empName.value) return;
  var suggested = getNextSeniority();
  var rawSeniority = (empSeniority.value || '').trim();
  var seniorityVal = rawSeniority === '' ? suggested : null;
  if (rawSeniority !== '') {
    var check = validateSeniority(rawSeniority, null);
    if (!check.ok) {
      alert(check.message);
      return;
    }
    seniorityVal = check.value;
  }
  const newEmp = {
    id: crypto.randomUUID(),
    name: empName.value,
    type: empType.value,
    seniority: seniorityVal,
    pref: empPref.value,
    email: document.getElementById('empEmail').value || null,
    employeeId: document.getElementById('empEmployeeId').value || null,
    hireDate: document.getElementById('empHireDate').value || null,
    birthdate: document.getElementById('empBirthdate').value || null,
    sick:false,
    retired:false,
    maxDaysPerWeek: 5, // Default to 5 days
    dayPreferences: {
      0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null
    }
  };
  employees.push(newEmp);
  empName.value = "";
  document.getElementById('empEmail').value = "";
  document.getElementById('empEmployeeId').value = "";
  document.getElementById('empHireDate').value = "";
  document.getElementById('empBirthdate').value = "";
  updateSeniorityPreFill();
  
  addAuditEntry('Employee Added', newEmp.id, null, null, `${newEmp.name} (${newEmp.type}, Seniority ${newEmp.seniority})`);
  save(); 
  renderEmployees();
}

/* IMPORT FUNCTIONS */
function showImportHelp() {
  const helpText = `
SENIORITY LIST IMPORT FORMAT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

You can import employees using CSV or plain text.

CSV FORMAT (with header):
Name,Type,Seniority,Preference
John Doe,FT,1,AM
Jane Smith,PT,2,PM
Bob Johnson,FT,3,

CSV FORMAT (without header):
John Doe,FT,1,AM
Jane Smith,PT,2,PM
Bob Johnson,FT,3

TEXT FORMAT (tab or comma separated):
John Doe    FT    1    AM
Jane Smith  PT    2    PM
Bob Johnson FT    3

FIELDS:
‚Ä¢ Name (required)
‚Ä¢ Type: FT or PT (required)
‚Ä¢ Seniority: number (required)
‚Ä¢ Preference: AM, PM, or blank (optional)

IMPORT MODES:
‚Ä¢ Replace: Removes all existing employees
‚Ä¢ Merge: Adds to existing employees, rebalances seniority

TIP: Export your current list first as a backup!
  `;
  
  alert(helpText);
}

function openPasteImport() {
  const input = prompt(
    "Paste your employee list:\n\n" +
    "Format: Name, Type, Seniority, Preference\n" +
    "Example:\n" +
    "John Doe, FT, 1, AM\n" +
    "Jane Smith, PT, 2, PM\n\n" +
    "Paste your list below:"
  );
  
  if (!input || input.trim() === '') return;
  
  parseAndImportText(input);
}

function handleFileImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    parseAndImportText(text);
  };
  reader.readAsText(file);
  
  // Reset file input
  event.target.value = '';
}

function parseAndImportText(text) {
  const lines = text.trim().split('\n').filter(line => line.trim() !== '');
  
  if (lines.length === 0) {
    alert('No data found in import');
    return;
  }
  
  const parsed = [];
  let hasHeader = false;
  let startIndex = 0;
  
  // Check if first line is a header
  const firstLine = lines[0].toLowerCase();
  if (firstLine.includes('name') && (firstLine.includes('type') || firstLine.includes('seniority'))) {
    hasHeader = true;
    startIndex = 1;
  }
  
  // Parse each line
  for (let i = startIndex; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Split by comma or tab
    let parts;
    if (line.includes(',')) {
      parts = line.split(',').map(p => p.trim());
    } else if (line.includes('\t')) {
      parts = line.split('\t').map(p => p.trim());
    } else {
      // Try splitting by multiple spaces
      parts = line.split(/\s{2,}/).map(p => p.trim());
    }
    
    if (parts.length < 3) {
      console.warn(`Skipping invalid line ${i + 1}: ${line}`);
      continue;
    }
    
    const name = parts[0];
    const type = parts[1].toUpperCase();
    const seniority = parseInt(parts[2]);
    const pref = parts[3] ? parts[3].toUpperCase() : '';
    
    // Validate
    if (!name || (type !== 'FT' && type !== 'PT') || isNaN(seniority)) {
      console.warn(`Skipping invalid employee on line ${i + 1}: ${line}`);
      continue;
    }
    
    parsed.push({
      name,
      type,
      seniority,
      pref: (pref === 'AM' || pref === 'PM') ? pref : ''
    });
  }
  
  if (parsed.length === 0) {
    alert('No valid employees found in import.\n\nCheck format:\nName, Type, Seniority, Preference');
    return;
  }
  
  // Ask import mode
  const mode = confirm(
    `Found ${parsed.length} employees to import.\n\n` +
    `Click OK to REPLACE all existing employees\n` +
    `Click Cancel to MERGE with existing employees`
  );
  
  if (mode) {
    // Replace mode
    if (!confirm(`This will DELETE all ${employees.length} existing employees and import ${parsed.length} new ones.\n\nAre you sure?`)) {
      return;
    }
    
    employees = [];
  }
  
  // Import employees
  let imported = 0;
  parsed.forEach(emp => {
    employees.push({
      id: crypto.randomUUID(),
      name: emp.name,
      type: emp.type,
      seniority: emp.seniority,
      pref: emp.pref,
      sick: false,
      retired: false
    });
    imported++;
  });
  
  // Rebalance seniority
  rebalanceSeniority();
  
  addAuditEntry('Employees Imported', null, null, null, `${imported} employees imported (${mode ? 'Replace' : 'Merge'} mode)`);
  save();
  renderEmployees();
  
  alert(`‚úÖ Successfully imported ${imported} employees!${mode ? '\n\nAll previous employees were replaced.' : '\n\nSeniority has been rebalanced.'}`);
}

/* EXPORT FUNCTION */
function exportEmployeeList() {
  if (employees.length === 0) {
    alert('No employees to export');
    return;
  }
  
  // Generate CSV
  let csv = 'Name,Type,Seniority,Preference\n';
  
  employees.filter(e => !e.retired)
    .sort((a, b) => a.seniority - b.seniority)
    .forEach(e => {
      csv += `${e.name},${e.type},${e.seniority},${e.pref || ''}\n`;
    });
  
  // Create download
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `BanquetLogic-Employees-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  alert('‚úÖ Employee list exported!');
}

function rebalanceSeniority(){
  employees.filter(e=>!e.retired)
    .sort((a,b)=>a.seniority-b.seniority)
    .forEach((e,i)=>e.seniority=i+1);
}

function retireEmployee(id){
  if(!confirm("Retire this employee?")) return;
  const emp = employees.find(e=>e.id===id);
  emp.retired=true;
  rebalanceSeniority();
  
  addAuditEntry('Employee Retired', id, null, 'Active', 'Retired');
  save(); 
  renderEmployees();
}

function renderEmployees(){
  employeesTable.innerHTML="";
  employees.sort((a,b)=>a.seniority-b.seniority).forEach(e=>{
    const row = document.createElement('tr');
    row.className = e.retired ? 'status-retired' : '';
    
    const maxDays = e.maxDaysPerWeek !== undefined ? e.maxDaysPerWeek : 5;
    
    row.innerHTML = `
      <td>${e.name}</td>
      <td>${e.type}</td>
      <td>${e.retired ? '-' : e.seniority}</td>
      <td class="email-cell-td" data-emp-id="${e.id}" title="${e.email ? 'Click to edit' : 'Click to add email'}"></td>
      <td>${e.pref || "-"}</td>
      <td><input type="number" class="max-days-input" value="${maxDays}" min="1" max="5" placeholder="5" style="width:50px;" ${e.retired ? 'disabled' : ''}></td>
      <td><button type="button" class="vacation-btn" style="background:#3498db; padding:4px 8px;">Vacation</button></td>
      <td><button type="button" class="dayprefs-btn" style="background:#9b59b6; padding:4px 8px;">Day Prefs</button></td>
      <td><button type="button" class="timeoff-btn" style="background:#6b7c8d; padding:4px 8px;" title="Time Off / Sick">Time Off</button></td>
      <td><input type="checkbox" class="sick-check" ${e.sick ? "checked" : ""}></td>
      <td>
        <button type="button" class="info-btn" style="background:#27ae60; padding:4px 8px;" title="View/Edit Info">‚ÑπÔ∏è</button>
        ${e.retired ? "‚Äî" : '<button type="button" class="retire">Retire</button>'}
      </td>
    `;
    
    const emailTd = row.querySelector('.email-cell-td');
    if (emailTd) {
      function setEmailCellDisplay() {
        const emp = employees.find(function(x) { return x.id === e.id; });
        const val = emp ? emp.email : '';
        const display = val ? (val.length > 20 ? val.substring(0, 17) + '...' : val) : '';
        emailTd.innerHTML = '';
        const wrap = document.createElement('span');
        wrap.className = 'email-cell-wrap' + (display ? '' : ' email-cell-placeholder');
        wrap.textContent = display || 'Add email';
        wrap.title = display ? 'Click to edit' : 'Click to add email';
        wrap.onclick = function() {
          const inp = document.createElement('input');
          inp.type = 'email';
          inp.className = 'email-cell-input';
          inp.placeholder = 'email@example.com';
          inp.value = (employees.find(function(x) { return x.id === e.id; }) || {}).email || '';
          emailTd.innerHTML = '';
          emailTd.appendChild(inp);
          inp.focus();
          inp.select();
          function saveEmail() {
            const newVal = (inp.value || '').trim() || null;
            const emp = employees.find(function(x) { return x.id === e.id; });
            if (emp) {
              const oldVal = emp.email || null;
              if (oldVal !== newVal) {
                emp.email = newVal;
                addAuditEntry('Email Updated', e.id, null, oldVal || '(none)', newVal || '(none)');
                save();
              }
            }
            setEmailCellDisplay();
          }
          inp.onblur = saveEmail;
          inp.onkeydown = function(ev) {
            if (ev.key === 'Enter') { inp.blur(); ev.preventDefault(); }
            if (ev.key === 'Escape') { setEmailCellDisplay(); ev.preventDefault(); }
          };
        };
        emailTd.appendChild(wrap);
      }
      setEmailCellDisplay();
    }
    
    const maxDaysInput = row.querySelector('.max-days-input');
    const vacationBtn = row.querySelector('.vacation-btn');
    const dayPrefsBtn = row.querySelector('.dayprefs-btn');
    const timeoffBtn = row.querySelector('.timeoff-btn');
    const sickCheck = row.querySelector('.sick-check');
    const retireBtn = row.querySelector('.retire');
    const infoBtn = row.querySelector('.info-btn');
    
    if(timeoffBtn) {
      timeoffBtn.onclick = function() { openAbsenceModal(e.id); };
    }
    
    if(maxDaysInput) {
      maxDaysInput.onchange = function() {
        setMaxDaysPerWeek(e.id, parseInt(this.value));
      };
    }
    
    if(vacationBtn) {
      vacationBtn.onclick = function() {
        openVacationPicker(e.id);
      };
    }
    
    if(dayPrefsBtn) {
      dayPrefsBtn.onclick = function() {
        openDayPreferences(e.id);
      };
    }
    
    if(sickCheck) {
      sickCheck.onchange = function() {
        toggleSick(e.id, this.checked);
      };
    }
    
    if(retireBtn) {
      retireBtn.onclick = () => retireEmployee(e.id);
    }
    
    if(infoBtn) {
      infoBtn.onclick = function() {
        viewEmployeeInfo(e.id);
      };
    }
    
    employeesTable.appendChild(row);
  });
  if(employees.filter(e=>!e.retired).length === 0){
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="11" style="text-align:center;padding:1.5rem;color:#7f8c8d;">No employees yet. Add an employee above to get started.</td>';
    employeesTable.appendChild(emptyRow);
  }
}

function openVacationPicker(empId) {
  const emp = employees.find(e => e.id === empId);
  
  // Get current week
  const start = getWeekStart();
  const days = [...Array(7)].map((_, i) => {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    return d;
  });
  
  // Build dialog
  let dialog = `Set vacation days for ${emp.name}\n`;
  dialog += `Current week: ${days[0].toLocaleDateString()} ‚Äì ${days[6].toLocaleDateString()}\n\n`;
  dialog += `Select days to mark as VACATION:\n`;
  dialog += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  
  const dayOptions = [];
  days.forEach((d, index) => {
    const dateStr = iso(d);
    const dayName = d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' });
    const key = empId + "_" + dateStr;
    const ed = manualEdits[key];
    const isTimeOff = ed && ed.status && (isFullAbsenceStatus(ed.status) || ed.status === 'requested_off');
    dialog += `${index + 1}. ${dayName}${isTimeOff ? ' ‚úì' : ''}\n`;
    dayOptions.push({ dateStr, dayName, isTimeOff });
  });
  
  dialog += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  dialog += `Enter day numbers separated by commas:\n`;
  dialog += `Example: 1,3,5 (for Mon, Wed, Fri)\n`;
  dialog += `Or enter "all" for entire week\n`;
  dialog += `Or enter "clear" to remove all vacation days\n`;
  
  const input = prompt(dialog);
  
  if (input === null) return; // Cancelled
  
  const trimmed = input.trim().toLowerCase();
  
  // Clear all vacation days
  if (trimmed === 'clear' || trimmed === '') {
    days.forEach(d => {
      const dateStr = iso(d);
      const key = empId + "_" + dateStr;
      if (manualEdits[key] && isFullAbsenceStatus(manualEdits[key].status)) {
        delete manualEdits[key];
      }
    });
    
    addAuditEntry('Time Off Cleared', empId, null, 'Had time off', 'Cleared');
    save();
    displaySchedule();
    return;
  }
  
  // Mark all days
  if (trimmed === 'all') {
    days.forEach(d => {
      const dateStr = iso(d);
      const key = empId + "_" + dateStr;
      manualEdits[key] = { status: 'vacation', manualOverride: true };
      delete assignmentReasonTags[key];
      delete assignmentReasons[key];
    });
    
    addAuditEntry('Vacation Set', empId, null, null, 'Entire week');
    save();
    displaySchedule();
    return;
  }
  
  // Parse specific days
  const selectedDays = trimmed.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 7);
  
  if (selectedDays.length === 0) {
    alert('Invalid input. Please enter day numbers (1-7), "all", or "clear"');
    return;
  }
  
  // Clear existing vacation days first
  days.forEach(d => {
    const dateStr = iso(d);
    const key = empId + "_" + dateStr;
    if (manualEdits[key] && isFullAbsenceStatus(manualEdits[key].status)) {
      delete manualEdits[key];
    }
  });
  
  // Set new vacation days
  const vacationDates = [];
  selectedDays.forEach(dayNum => {
    const d = days[dayNum - 1];
    if (d) {
      const dateStr = iso(d);
      const key = empId + "_" + dateStr;
      manualEdits[key] = { status: 'vacation', manualOverride: true };
      delete assignmentReasonTags[key];
      delete assignmentReasons[key];
      vacationDates.push(d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' }));
    }
  });
  
  addAuditEntry('Vacation Set', empId, null, null, vacationDates.join(', '));
  save();
  displaySchedule();
}

function openDayPreferences(empId) {
  const emp = employees.find(e => e.id === empId);
  
  // Initialize if not exists
  if(!emp.dayPreferences) {
    emp.dayPreferences = {
      0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null
    };
  }
  
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  
  // Build dialog
  let dialog = `Set weekly day preferences for ${emp.name}\n\n`;
  dialog += `These are PREFERENCES only - employee can still be scheduled\n`;
  dialog += `on any day if needed to maximize hours.\n\n`;
  dialog += `Current preferences:\n`;
  dialog += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  
  dayNames.forEach((name, index) => {
    const pref = emp.dayPreferences[index];
    let prefText = '(no preference)';
    if(pref === true) prefText = '‚úì PREFERS to work';
    if(pref === false) prefText = '‚úó PREFERS OFF';
    
    dialog += `${index}. ${name.padEnd(10)} ${prefText}\n`;
  });
  
  dialog += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  dialog += `To set preferences, enter day numbers:\n\n`;
  dialog += `PREFERS TO WORK: Enter numbers with '+'\n`;
  dialog += `  Example: +1,2,5 (prefers Mon, Tue, Fri)\n\n`;
  dialog += `PREFERS OFF: Enter numbers with '-'\n`;
  dialog += `  Example: -0,6 (prefers off Sun, Sat)\n\n`;
  dialog += `BOTH: Separate with semicolon\n`;
  dialog += `  Example: +1,2,3,4,5;-0,6\n`;
  dialog += `  (prefers to work weekdays, off weekends)\n\n`;
  dialog += `CLEAR ALL: Enter "clear"\n`;
  
  const input = prompt(dialog);
  
  if(input === null) return; // Cancelled
  
  const trimmed = input.trim().toLowerCase();
  
  // Clear all preferences
  if(trimmed === 'clear' || trimmed === '') {
    emp.dayPreferences = {
      0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null
    };
    addAuditEntry('Day Preferences Cleared', empId, null, 'Has preferences', 'No preferences');
    save();
    return;
  }
  
  // Parse input
  const parts = input.split(';');
  const prefersWork = [];
  const prefersOff = [];
  
  parts.forEach(part => {
    const trimmedPart = part.trim();
    
    if(trimmedPart.startsWith('+')) {
      // Prefers to work
      const days = trimmedPart.substring(1).split(',')
        .map(s => parseInt(s.trim()))
        .filter(n => !isNaN(n) && n >= 0 && n <= 6);
      prefersWork.push(...days);
    } else if(trimmedPart.startsWith('-')) {
      // Prefers off
      const days = trimmedPart.substring(1).split(',')
        .map(s => parseInt(s.trim()))
        .filter(n => !isNaN(n) && n >= 0 && n <= 6);
      prefersOff.push(...days);
    }
  });
  
  if(prefersWork.length === 0 && prefersOff.length === 0) {
    alert('Invalid format. Examples:\n+1,2,3 (prefers work)\n-0,6 (prefers off)\n+1,2,3,4,5;-0,6 (both)');
    return;
  }
  
  // Clear all first
  emp.dayPreferences = {
    0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null
  };
  
  // Set preferences
  prefersWork.forEach(day => {
    emp.dayPreferences[day] = true;
  });
  
  prefersOff.forEach(day => {
    emp.dayPreferences[day] = false;
  });
  
  // Build audit message
  const workDays = prefersWork.map(d => dayNames[d]).join(', ');
  const offDays = prefersOff.map(d => dayNames[d]).join(', ');
  let auditMsg = '';
  if(workDays) auditMsg += `Work: ${workDays}`;
  if(offDays) auditMsg += `${auditMsg ? '; ' : ''}Off: ${offDays}`;
  
  addAuditEntry('Day Preferences Set', empId, null, null, auditMsg);
  save();
  alert(`Preferences saved!\n\nPrefers to work: ${workDays || 'none'}\nPrefers off: ${offDays || 'none'}`);
}

var absenceModalEmpId = null;

function openAbsenceModal(empId) {
  var emp = employees.find(function(e) { return e.id === empId; });
  if (!emp) return;
  absenceModalEmpId = empId;
  document.getElementById('absenceModalTitle').textContent = 'Time Off / Sick';
  document.getElementById('absenceModalEmpName').textContent = emp.name;
  var start = getWeekStart();
  document.getElementById('absenceStartDate').value = iso(start);
  document.getElementById('absenceEndDate').value = '';
  document.getElementById('absenceType').value = 'sick';
  document.getElementById('absenceModalOverlay').classList.add('absence-visible');
}

function closeAbsenceModal() {
  absenceModalEmpId = null;
  document.getElementById('absenceModalOverlay').classList.remove('absence-visible');
}

function getDatesBetween(startStr, endStr) {
  var out = [];
  var d = new Date(startStr);
  var end = new Date(endStr || startStr);
  if (d > end) { var t = d; d = end; end = t; }
  while (d <= end) {
    out.push(iso(d));
    d.setDate(d.getDate() + 1);
  }
  return out;
}

function applyAbsence() {
  if (!absenceModalEmpId) return;
  var startStr = document.getElementById('absenceStartDate').value;
  if (!startStr) {
    alert('Please select a start date.');
    return;
  }
  var endStr = document.getElementById('absenceEndDate').value || startStr;
  var typeId = document.getElementById('absenceType').value;
  var typeInfo = ABSENCE_TYPES.find(function(t) { return t.id === typeId; });
  if (!typeInfo) return;
  var dateStrs = getDatesBetween(startStr, endStr);
  var emp = employees.find(function(e) { return e.id === absenceModalEmpId; });
  if (!emp) return;
  var isRequestOff = typeId === 'requested_off';
  dateStrs.forEach(function(dateStr) {
    var key = absenceModalEmpId + '_' + dateStr;
    if (isRequestOff) {
      var existing = manualEdits[key];
      if (existing && (existing.hours || existing.start)) {
        manualEdits[key] = { status: 'requested_off', manualOverride: true, absenceReason: typeInfo.reason, requestedOff: true, hours: existing.hours, start: existing.start, end: existing.end };
      } else {
        manualEdits[key] = { status: 'requested_off', manualOverride: true, absenceReason: typeInfo.reason, requestedOff: true };
      }
    } else {
      manualEdits[key] = { status: typeId, manualOverride: true, absenceReason: typeInfo.reason };
      delete assignmentReasonTags[key];
      delete assignmentReasons[key];
    }
  });
  var actionLabel = typeInfo.label;
  addAuditEntry('Absence Added', absenceModalEmpId, null, null, actionLabel + ': ' + (dateStrs.length === 1 ? dateStrs[0] : dateStrs[0] + ' to ' + dateStrs[dateStrs.length - 1]));
  save();
  displaySchedule();
  closeAbsenceModal();
}

function initAbsenceModal() {
  document.getElementById('absenceConfirmBtn').onclick = applyAbsence;
  document.getElementById('absenceCancelBtn').onclick = closeAbsenceModal;
  document.getElementById('absenceModalOverlay').onclick = function(e) {
    if (e.target === this) closeAbsenceModal();
  };
}

function toggleSick(id, checked){
  const emp = employees.find(e=>e.id===id);
  emp.sick=checked;
  addAuditEntry('Sick Status Changed', id, null, !checked, checked);
  save();
}

function setMaxDaysPerWeek(empId, maxDays) {
  const emp = employees.find(e => e.id === empId);
  
  // Default to 5 if empty or invalid
  if(maxDays === '' || maxDays === null || maxDays === undefined || isNaN(maxDays)) {
    maxDays = 5;
  }
  
  maxDays = parseInt(maxDays);
  
  // Validate input - max 5 days per week
  if(maxDays < 1 || maxDays > 5) {
    alert('Max days must be between 1 and 5 (or leave empty for 5 days)');
    renderEmployees(); // Reset display
    return;
  }
  
  const oldValue = emp.maxDaysPerWeek || 5;
  emp.maxDaysPerWeek = maxDays;
  
  addAuditEntry('Max Days Changed', empId, null, `${oldValue} days/week`, `${maxDays} days/week`);
  save();
  
  console.log(`${emp.name} max days set to ${maxDays}/week`);
}

var editingEmployeeId = null;

function viewEmployeeInfo(empId) {
  const emp = employees.find(e => e.id === empId);
  if (!emp) return;
  editingEmployeeId = empId;
  
  document.getElementById('employeeEditTitle').textContent = 'Edit employee';
  document.getElementById('employeeEditName').textContent = emp.name;
  document.getElementById('employeeEditType').value = emp.type || 'FT';
  document.getElementById('employeeEditPref').value = emp.pref || '';
  document.getElementById('employeeEditSeniority').value = emp.seniority != null ? emp.seniority : '';
  document.getElementById('employeeEditSick').checked = !!emp.sick;
  
  var overlay = document.getElementById('employeeEditModalOverlay');
  overlay.classList.add('employee-edit-visible');
}

function closeEmployeeEditModal() {
  editingEmployeeId = null;
  document.getElementById('employeeEditModalOverlay').classList.remove('employee-edit-visible');
}

function saveEmployeeEdit() {
  if (!editingEmployeeId) return;
  const emp = employees.find(e => e.id === editingEmployeeId);
  if (!emp) return;
  
  var typeEl = document.getElementById('employeeEditType');
  var prefEl = document.getElementById('employeeEditPref');
  var seniorityEl = document.getElementById('employeeEditSeniority');
  var sickEl = document.getElementById('employeeEditSick');
  
  var rawSeniority = (seniorityEl.value || '').trim();
  var check = validateSeniority(rawSeniority, editingEmployeeId);
  if (!check.ok) {
    alert(check.message);
    return;
  }
  
  var oldType = emp.type;
  var oldPref = emp.pref || '';
  var oldSeniority = emp.seniority;
  var oldSick = emp.sick;
  
  emp.type = typeEl.value;
  emp.pref = prefEl.value || null;
  emp.seniority = check.value;
  emp.sick = sickEl.checked;
  
  var changes = [];
  if (oldType !== emp.type) changes.push('type ' + oldType + ' ‚Üí ' + emp.type);
  if (oldPref !== (emp.pref || '')) changes.push('preference ' + (oldPref || 'none') + ' ‚Üí ' + (emp.pref || 'none'));
  if (oldSeniority !== emp.seniority) changes.push('seniority ' + oldSeniority + ' ‚Üí ' + emp.seniority);
  if (oldSick !== emp.sick) changes.push('sick ' + (oldSick ? 'yes' : 'no') + ' ‚Üí ' + (emp.sick ? 'yes' : 'no'));
  
  if (changes.length) {
    addAuditEntry('Employee Updated', emp.id, null, changes.join('; '), emp.name);
  }
  
  save();
  renderEmployees();
  closeEmployeeEditModal();
}

function initEmployeeEditModal() {
  document.getElementById('employeeEditSaveBtn').onclick = saveEmployeeEdit;
  document.getElementById('employeeEditCancelBtn').onclick = closeEmployeeEditModal;
  document.getElementById('employeeEditModalOverlay').onclick = function(e) {
    if (e.target === this) closeEmployeeEditModal();
  };
}

/* EVENTS */
function populateEventServiceDropdown(){
  var sel = document.getElementById('eventService');
  if (!sel) return;
  var active = getActiveEventTypes();
  sel.innerHTML = '';
  active.forEach(function(t){
    var opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = t.name;
    sel.appendChild(opt);
  });
}

function autoRecommendStaff(){
  const guests = +eventGuests.value;
  if (!guests) return;
  const typeId = eventService.value;
  const t = getEventTypeById(typeId);
  const ratio = t ? t.guestsPerServer : 30;
  eventStaff.value = Math.ceil(guests / ratio);
}

function addEvent(){
  if(!eventName.value || !eventDate.value) return;
  var typeId = eventService.value;
  var type = getEventTypeById(typeId);
  var typeName = type ? type.name : (eventService.options[eventService.selectedIndex] ? eventService.options[eventService.selectedIndex].text : '');
  const data={
    id: editingEventId || crypto.randomUUID(),
    name: eventName.value,
    date: eventDate.value,
    start: eventStart.value || "09:00",
    end: eventEnd.value || "17:00",
    guests: +eventGuests.value || 0,
    service: typeName,
    eventTypeId: typeId || undefined,
    eventTypeName: typeName,
    staff: +eventStaff.value || 1
  };
  
  if(editingEventId){
    const oldEvent = events.find(e=>e.id===editingEventId);
    Object.assign(oldEvent, data);
    addAuditEntry('Event Modified', null, data.date, 
      `${oldEvent.name} (${oldEvent.staff} staff)`,
      `${data.name} (${data.staff} staff)`);
    editingEventId=null;
  } else {
    events.push(data);
    addAuditEntry('Event Created', null, data.date, null, `${data.name} (${data.staff} staff)`);
  }
  
  eventName.value="";
  eventDate.value="";
  eventStart.value="";
  eventEnd.value="";
  eventGuests.value="";
  eventStaff.value="";
  
  save(); 
  renderEvents();
}

function renderEvents(){
  eventsTable.innerHTML="";
  events.forEach(ev=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${ev.name}</td>
      <td>${ev.date}</td>
      <td>${ev.start}‚Äì${ev.end}</td>
      <td>${ev.guests}</td>
      <td>${ev.eventTypeName || ev.service || ev.serviceType || ''}</td>
      <td>${ev.staff}</td>
      <td><button type="button" class="edit-btn">Edit</button></td>
      <td><button type="button" class="delete">Delete</button></td>
    `;
    
    row.querySelector('.edit-btn').onclick = () => editEvent(ev.id);
    row.querySelector('.delete').onclick = () => deleteEvent(ev.id);
    
    eventsTable.appendChild(row);
  });
  if(events.length === 0){
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = '<td colspan="8" style="text-align:center;padding:1.5rem;color:#7f8c8d;">No events yet. Add an event above to build your schedule.</td>';
    eventsTable.appendChild(emptyRow);
  }
  var eventSubmitBtn = document.getElementById('eventSubmitBtn');
  if (eventSubmitBtn) eventSubmitBtn.textContent = editingEventId ? 'Save Changes' : 'Add Event';
}

function editEvent(id){
  const e = events.find(x => x.id === id);
  editingEventId = id;
  document.getElementById('eventSubmitBtn').textContent = 'Save Changes';
  eventName.value = e.name;
  eventDate.value = e.date;
  eventStart.value = e.start || '09:00';
  eventEnd.value = e.end || '17:00';
  eventGuests.value = e.guests;
  var typeId = e.eventTypeId || (getEventTypeByName(e.service) ? getEventTypeByName(e.service).id : '');
  var type = typeId ? getEventTypeById(typeId) : null;
  if (typeId && type && !type.active) {
    var hasOpt = [].slice.call(eventService.options).some(function(o) { return o.value === typeId; });
    if (!hasOpt) {
      var opt = document.createElement('option');
      opt.value = typeId;
      opt.textContent = e.eventTypeName || e.service || type.name || 'Unknown';
      eventService.appendChild(opt);
    }
  }
  eventService.value = typeId || (eventService.options.length ? eventService.options[0].value : '');
  eventStaff.value = e.staff;
}

function deleteEvent(id){
  if(!confirm("Delete event?")) return;
  const ev = events.find(e=>e.id===id);
  events=events.filter(e=>e.id!==id);
  addAuditEntry('Event Deleted', null, ev.date, `${ev.name}`, null);
  save(); 
  renderEvents();
}

/* HELPER FUNCTIONS */
const iso=d=>d.toISOString().split("T")[0];

function getWeekStart(){
  const d=new Date();
  d.setDate(d.getDate()+currentWeekOffset*7);
  const diff=d.getDay()===0?-6:1-d.getDay();
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d;
}

function roundToHalfHour(date) {
  const mins = date.getMinutes();
  if (mins < 15) date.setMinutes(0);
  else if (mins < 45) date.setMinutes(30);
  else { date.setMinutes(0); date.setHours(date.getHours() + 1); }
  date.setSeconds(0, 0);
  return date;
}

function timeStr(d){
  return d.toTimeString().slice(0,5);
}

function getShiftClassByHours(h){
  if(h === 4) return "shift-4";
  if(h === 5) return "shift-5";
  if(h === 6) return "shift-6";
  if(h === 7) return "shift-7";
  if(h === 8) return "shift-8";
  if(h > 8) return "shift-ot";
  return "";
}

function calculateSmartShift(ev, paidHours) {
  const baseStart = new Date(`1970-01-01T${ev.start}`);
  const baseEnd   = new Date(`1970-01-01T${ev.end}`);

  let buffer = 1;
  if (ev.guests >= 200) buffer = 2;

  const scheduledHours = paidHours > 4 ? paidHours + 0.5 : paidHours;

  let startA = new Date(baseStart);
  startA.setHours(startA.getHours() - buffer);
  let endA = new Date(startA);
  endA.setMinutes(endA.getMinutes() + (scheduledHours * 60));

  let endB = new Date(baseEnd);
  endB.setHours(endB.getHours() + buffer);
  let startB = new Date(endB);
  startB.setMinutes(startB.getMinutes() - (scheduledHours * 60));

  startA = roundToHalfHour(new Date(startA));
  endA   = roundToHalfHour(new Date(endA));
  startB = roundToHalfHour(new Date(startB));
  endB   = roundToHalfHour(new Date(endB));

  const distA = Math.abs(startA - baseStart) + Math.abs(endA - baseEnd);
  const distB = Math.abs(startB - baseStart) + Math.abs(endB - baseEnd);

  return distA <= distB
    ? { start: startA, end: endA }
    : { start: startB, end: endB };
}

function normalizeHours(start, end){
  const diff=(new Date(`1970-01-01T${end}`)-new Date(`1970-01-01T${start}`))/3600000;
  if(diff<=4) return {h:4};
  if(diff<=5) return {h:5};
  if(diff<=6) return {h:6};
  if(diff<=7) return {h:7};
  if(diff<=8) return {h:8};
  return {h:Math.ceil(diff)};
}

/* CONFLICT DETECTION */
function detectConflicts(empId, date, shiftStart, shiftEnd){
  const conflicts = [];
  
  // Check all shifts for this employee across the week
  const start = getWeekStart();
  const days = [...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
  
  days.forEach(d => {
    const dateStr = iso(d);
    const key = empId + "_" + dateStr;
    
    if(dateStr === date) return; // Skip same day
    
    // Check if employee has a shift on adjacent days
    const edit = manualEdits[key];
    if(edit && edit.start && edit.end) {
      // Check rest time between shifts
      const prevDate = new Date(dateStr);
      const currDate = new Date(date);
      const dayDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);
      
      if(Math.abs(dayDiff) === 1) {
        const prevEnd = new Date(`1970-01-01T${edit.end}`);
        const currStart = new Date(`1970-01-01T${shiftStart}`);
        
        let gap;
        if(dayDiff === 1) {
          // Current is day after
          const prevEndMins = prevEnd.getHours() * 60 + prevEnd.getMinutes();
          const currStartMins = currStart.getHours() * 60 + currStart.getMinutes();
          gap = (1440 - prevEndMins) + currStartMins;
        } else {
          // Current is day before
          const currEndMins = new Date(`1970-01-01T${shiftEnd}`).getHours() * 60 + new Date(`1970-01-01T${shiftEnd}`).getMinutes();
          const prevStartMins = new Date(`1970-01-01T${edit.start}`).getHours() * 60 + new Date(`1970-01-01T${edit.start}`).getMinutes();
          gap = (1440 - currEndMins) + prevStartMins;
        }
        
        if(gap < 480) {
          conflicts.push(`Less than 8 hours rest from ${dateStr} shift`);
        }
      }
    }
  });
  
  return conflicts;
}

/* SCHEDULE FUNCTIONS */
function toggleGlobalLock(){
  scheduleGlobalLock = !scheduleGlobalLock;
  const btn = document.getElementById('globalLockBtn');
  
  if(scheduleGlobalLock) {
    btn.innerHTML = 'üîí Locked Schedule';
    btn.style.background = '#e74c3c';
    var hel = document.getElementById('scheduleLockHelperText');
    if (hel) hel.textContent = 'Locked schedules cannot be edited';
    addAuditEntry('Schedule Locked', null, null, 'Unlocked', 'Locked');
  } else {
    btn.innerHTML = 'üîì Unlock Schedule';
    btn.style.background = '#f39c12';
    var hel = document.getElementById('scheduleLockHelperText');
    if (hel) hel.textContent = 'Edits enabled ‚Äî changes will affect assignments';
    addAuditEntry('Schedule Unlocked', null, null, 'Locked', 'Unlocked');
  }
  
  save();
}

function toggleRowLock(empId){
  if(lockedRows[empId]) {
    delete lockedRows[empId];
    addAuditEntry('Row Unlocked', empId, null, 'Locked', 'Unlocked');
  } else {
    lockedRows[empId] = true;
    addAuditEntry('Row Locked', empId, null, 'Unlocked', 'Locked');
  }
  
  save();
  displaySchedule();
}

function toggleLock(empId, date){
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  
  if(lockedCells[key]) {
    delete lockedCells[key];
    addAuditEntry('Cell Unlocked', empId, date, 'Locked', 'Unlocked');
  } else {
    lockedCells[key] = true;
    addAuditEntry('Cell Locked', empId, date, 'Unlocked', 'Locked');
  }
  
  save();
  displaySchedule(); // Just refresh display, don't regenerate
}

var OVERRIDE_REASONS = [
  'Manager discretion',
  'Training / development',
  'Employee request',
  'Coverage need',
  'Other'
];

function getEligibleEmployeesForDate(dateStr) {
  return employees.filter(function(e) {
    if (e.retired || e.sick) return false;
    var vk = e.id + '_' + dateStr;
    if (manualEdits[vk] && isFullAbsenceStatus(manualEdits[vk].status)) return false;
    return true;
  });
}

function getEmployeesWithShiftOnDate(dateStr) {
  return employees.filter(function(e) {
    if (e.retired) return false;
    var k = e.id + '_' + dateStr;
    var edit = manualEdits[k];
    return edit && !isFullAbsenceStatus(edit.status) && (edit.hours || edit.start || edit.end);
  });
}

function checkSeniorityViolation(empIdReceiving, dateStr) {
  var receiving = employees.find(function(e) { return e.id === empIdReceiving; });
  if (!receiving || receiving.retired) return { violated: false };
  var eligible = getEligibleEmployeesForDate(dateStr);
  var hasShift = {};
  eligible.forEach(function(e) {
    var k = e.id + '_' + dateStr;
    var ed = manualEdits[k];
    hasShift[e.id] = !!(ed && !isFullAbsenceStatus(ed.status) && (ed.hours || ed.start || ed.end));
  });
  var higherRankNoShift = eligible.filter(function(e) {
    return e.id !== empIdReceiving && !hasShift[e.id] && (e.seniority != null) && (receiving.seniority != null) && e.seniority < receiving.seniority;
  });
  if (higherRankNoShift.length === 0) return { violated: false };
  return { violated: true, names: higherRankNoShift.map(function(e) { return e.name; }) };
}

function promptOverrideReason() {
  var msg = 'Reason for override (required):\n\n';
  OVERRIDE_REASONS.forEach(function(r, i) { msg += (i + 1) + ' = ' + r + '\n'; });
  msg += '\nEnter number or type your reason:';
  var raw = prompt(msg);
  if (raw === null || (raw && raw.trim()) === '') return null;
  var n = parseInt(raw.trim(), 10);
  if (!isNaN(n) && n >= 1 && n <= OVERRIDE_REASONS.length) return OVERRIDE_REASONS[n - 1];
  return raw.trim();
}

function applyOverrideToEdit(edit, reason) {
  if (!edit) return;
  edit.seniorityOverride = true;
  edit.overrideReason = reason;
  edit.overrideTimestamp = new Date().toISOString();
}

function editScheduleCell(empId, date){
  // Check global lock first
  if(scheduleGlobalLock) {
    alert('Schedule is globally locked! Unlock it first using the "üîí Locked Schedule" button.');
    return;
  }
  
  // Check row lock
  if(lockedRows[empId]) {
    alert('This employee\'s entire row is locked! Click the lock icon next to their name to unlock.');
    return;
  }
  
  const key = empId + "_" + date;
  const emp = employees.find(e => e.id === empId);
  const ev = events.find(e => e.date === date);
  
  let currentEdit = manualEdits[key];
  var hasShift = currentEdit && !isFullAbsenceStatus(currentEdit.status) && (currentEdit.hours || currentEdit.start || currentEdit.end);
  
  // Create a clearer menu dialog
  let dialog = "Edit shift for " + emp.name + " on " + date + ":\n\n";
  dialog += "Enter start and end time (hours are calculated for you):\n";
  dialog += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
  dialog += "SHIFT (start end):\n";
  dialog += "  09:00 15:30\n\n";
  dialog += "STATUS:\n";
  dialog += "  sick\n";
  dialog += "  vacation\n\n";
  dialog += "ACTIONS:\n";
  if (hasShift) {
    dialog += "  swap    (swap this shift with another employee)\n";
    dialog += "  reassign (give this shift to another employee)\n";
  }
  dialog += "  lock\n";
  dialog += "  clear\n";
  dialog += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
  
  if(lockedCells[key]) {
    dialog += "üîí LOCKED\n\n";
  }
  
  if(currentEdit) {
    var curAbsence = currentEdit.status ? ABSENCE_TYPES.find(function(a) { return a.id === currentEdit.status; }) : null;
    if (curAbsence) {
      dialog += "Current: " + curAbsence.cellLabel + "\n";
    } else if(currentEdit.start && currentEdit.end) {
      dialog += "Current: " + currentEdit.hours + "h (" + currentEdit.start + "-" + currentEdit.end + ")\n";
    } else {
      dialog += "Current: " + (currentEdit.hours || currentEdit) + "h (no times)\n";
    }
  } else if(ev) {
    dialog += "Event: " + ev.name + "\n";
  } else {
    dialog += "Current: (empty)\n";
  }
  
  const input = prompt(dialog);
  
  if(input === null) return;
  
  const trimmed = input.trim().toLowerCase();
  
  // Lock/unlock
  if(trimmed === 'lock') {
    toggleLock(empId, date);
    return;
  }
  
  // Remove shift
  if(trimmed === 'remove' || trimmed === 'clear' || trimmed === '') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
    delete manualEdits[key];
    addAuditEntry('Shift Removed', empId, date, oldValue, null);
    save(); 
    displaySchedule();
    return;
  }
  
  // Mark as sick
  if(trimmed === 'sick') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'sick', manualOverride: true, absenceReason: 'Marked Sick manually' };
    delete assignmentReasonTags[key];
    delete assignmentReasons[key];
    addAuditEntry('Absence Added', empId, date, oldValue, 'Sick');
    save();
    displaySchedule();
    return;
  }
  
  // Mark as vacation
  if(trimmed === 'vacation' || trimmed === 'vac') {
    const oldValue = currentEdit ? JSON.stringify(currentEdit) : null;
    manualEdits[key] = { status: 'vacation', manualOverride: true, absenceReason: 'Vacation added by manager' };
    delete assignmentReasonTags[key];
    delete assignmentReasons[key];
    addAuditEntry('Absence Added', empId, date, oldValue, 'Vacation');
    save();
    displaySchedule();
    return;
  }
  
  if (hasShift && (trimmed === 'swap' || trimmed === 'reassign')) {
    if (trimmed === 'swap') {
      var withShift = getEmployeesWithShiftOnDate(date).filter(function(e) {
        if (e.id === empId) return false;
        var k = e.id + '_' + date;
        return !lockedCells[k] && !lockedRows[e.id];
      });
      if (withShift.length === 0) {
        alert('No other employee has an unlocked shift on this date to swap with.');
        return;
      }
      var list = withShift.map(function(e) { return e.name; }).join(', ');
      var otherName = prompt('Swap this shift with which employee?\n\n' + list);
      if (otherName === null) return;
      var other = employees.find(function(e) { return e.id !== empId && e.name.toLowerCase() === (otherName || '').trim().toLowerCase(); });
      if (!other) other = withShift.find(function(e) { return e.name.toLowerCase().indexOf((otherName || '').trim().toLowerCase()) >= 0; });
      if (!other) {
        alert('Employee not found. Use a name from the list: ' + list);
        return;
      }
      var keyB = other.id + '_' + date;
      if (lockedCells[key] || lockedCells[keyB] || lockedRows[other.id]) {
        alert('Cannot swap: one of the shifts or rows is locked.');
        return;
      }
      var editB = manualEdits[keyB];
      var fullAbsence = editB && isFullAbsenceStatus(editB.status);
      if (!editB || fullAbsence) {
        alert(other.name + ' does not have a shift on this date.');
        return;
      }
      var violA = checkSeniorityViolation(empId, date);
      var violB = checkSeniorityViolation(other.id, date);
      var violated = violA.violated || violB.violated;
      var overrideReason = null;
      if (violated) {
        var warnMsg = 'Seniority warning: a higher-seniority employee (without a shift this day) could have had this shift.\n\n';
        if (violA.violated) warnMsg += 'After swap, ' + emp.name + ' receives a shift; higher seniority available: ' + (violA.names || []).join(', ') + '.\n';
        if (violB.violated) warnMsg += 'After swap, ' + other.name + ' receives a shift; higher seniority available: ' + (violB.names || []).join(', ') + '.\n';
        warnMsg += '\nDo you want to override and proceed?';
        if (!confirm(warnMsg)) return;
        overrideReason = promptOverrideReason();
        if (!overrideReason) {
          alert('Override cancelled. Reason is required to proceed.');
          return;
        }
      }
      var copyA = JSON.parse(JSON.stringify(currentEdit));
      var copyB = JSON.parse(JSON.stringify(editB));
      manualEdits[key] = copyB;
      manualEdits[keyB] = copyA;
      if (violated && overrideReason) {
        applyOverrideToEdit(manualEdits[key], overrideReason);
        applyOverrideToEdit(manualEdits[keyB], overrideReason);
      }
      delete assignmentReasonTags[key]; delete assignmentReasons[key];
      delete assignmentReasonTags[keyB]; delete assignmentReasons[keyB];
      var logNew = 'Swap: ' + emp.name + ' \u2194 ' + other.name + '. Seniority violated: ' + (violated ? 'Yes' : 'No') + '. Override: ' + (overrideReason ? 'Yes (' + overrideReason + ')' : 'No') + '. ' + new Date().toISOString();
      addAuditEntry('Shift Swapped', empId, date, emp.name + ' / ' + other.name, logNew);
      save();
      displaySchedule();
      return;
    }
    if (trimmed === 'reassign') {
      var eligible = getEligibleEmployeesForDate(date).filter(function(e) { return e.id !== empId; });
      if (eligible.length === 0) {
        alert('No other eligible employee to reassign this shift to.');
        return;
      }
      var list = eligible.map(function(e) { return e.name; }).join(', ');
      var toName = prompt('Reassign this shift to which employee?\n\n' + list);
      if (toName === null) return;
      var toEmp = employees.find(function(e) { return e.id !== empId && e.name.toLowerCase() === (toName || '').trim().toLowerCase(); });
      if (!toEmp) toEmp = eligible.find(function(e) { return e.name.toLowerCase().indexOf((toName || '').trim().toLowerCase()) >= 0; });
      if (!toEmp) {
        alert('Employee not found. Use a name from the list: ' + list);
        return;
      }
      var keyTo = toEmp.id + '_' + date;
      if (lockedCells[key] || lockedCells[keyTo] || lockedRows[toEmp.id]) {
        alert('Cannot reassign: this shift or the target row/cell is locked.');
        return;
      }
      var toEd = manualEdits[keyTo];
      if (toEd && !isFullAbsenceStatus(toEd.status) && (toEd.hours || toEd.start)) {
        alert(toEmp.name + ' already has a shift on this date. Use "swap" to exchange shifts.');
        return;
      }
      var viol = checkSeniorityViolation(toEmp.id, date);
      var overrideReason = null;
      if (viol.violated) {
        var warnMsg = 'Seniority warning: a higher-seniority employee (without a shift this day) could have had this shift: ' + (viol.names || []).join(', ') + '.\n\nDo you want to override and reassign anyway?';
        if (!confirm(warnMsg)) return;
        overrideReason = promptOverrideReason();
        if (!overrideReason) {
          alert('Override cancelled. Reason is required to proceed.');
          return;
        }
      }
      var shiftCopy = JSON.parse(JSON.stringify(currentEdit));
      shiftCopy.manualOverride = true;
      if (overrideReason) applyOverrideToEdit(shiftCopy, overrideReason);
      delete manualEdits[key];
      manualEdits[keyTo] = shiftCopy;
      delete assignmentReasonTags[key]; delete assignmentReasons[key];
      delete assignmentReasonTags[keyTo]; delete assignmentReasons[keyTo];
      var logNew = 'Reassign: from ' + emp.name + ' to ' + toEmp.name + '. Seniority violated: ' + (viol.violated ? 'Yes' : 'No') + '. Override: ' + (overrideReason ? 'Yes (' + overrideReason + ')' : 'No') + '. ' + new Date().toISOString();
      addAuditEntry('Shift Reassigned', empId, date, emp.name, logNew);
      save();
      displaySchedule();
      return;
    }
  }
  
  // Parse shift input: start and end time; hours calculated automatically
  let newEdit = null;
  const timeRegex = /^\d{1,2}:\d{2}$/;
  const parts = input.trim().split(/\s+/);
  
  var startStr = null, endStr = null;
  if(parts.length === 2 && timeRegex.test(parts[0]) && timeRegex.test(parts[1])) {
    startStr = parts[0];
    endStr = parts[1];
  } else if(parts.length === 3 && timeRegex.test(parts[1]) && timeRegex.test(parts[2])) {
    startStr = parts[1];
    endStr = parts[2];
  }
  
  if(startStr && endStr) {
    var startM = parseInt(startStr.split(':')[0], 10) * 60 + parseInt(startStr.split(':')[1], 10);
    var endM = parseInt(endStr.split(':')[0], 10) * 60 + parseInt(endStr.split(':')[1], 10);
    if(endM <= startM) {
      alert('End time must be after start time. Please enter a later end time.');
      return;
    }
    var calculatedHours = Math.round((endM - startM) / 60 * 10) / 10; // e.g. 6.5
    newEdit = {
      hours: calculatedHours,
      start: startStr,
      end: endStr,
      manualOverride: true
    };
  }
  
  if(!newEdit) {
    alert('Invalid format.\n\nEnter start and end time like: 09:00 15:30\n\nOr use:\n‚Ä¢ sick\n‚Ä¢ vacation\n‚Ä¢ lock\n‚Ä¢ clear');
    return;
  }
  
  const oldValue = currentEdit ? JSON.stringify(currentEdit) : 'Auto-assigned';
  manualEdits[key] = newEdit;
  delete assignmentReasonTags[key];
  delete assignmentReasons[key];
  addAuditEntry('Shift Manually Edited', empId, date, oldValue, JSON.stringify(newEdit));
  
  alert('Shift saved. Total: ' + newEdit.hours + ' hours (' + newEdit.start + '‚Äì' + newEdit.end + ').');
  save(); 
  displaySchedule();
}

function generateSchedule(){
  // This function GENERATES shifts from events
  if(!confirm("Generate schedule from events? This will create shifts for all employees based on events and settings.")) return;
  
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });
  
  let shiftsCreated = 0;
  let skippedDueToLimit = 0;
  let understaffedEvents = []; // Track events that couldn't be fully staffed
  
  // First, count existing work days for each employee (manual edits)
  const employeeWorkDays = {};
  employees.filter(e => !e.retired).forEach(e => {
    employeeWorkDays[e.id] = 0;
    
    // Count days that already have manual edits
    days.forEach(d => {
      const dateStr = iso(d);
      const key = e.id + "_" + dateStr;
      if(manualEdits[key] && !isFullAbsenceStatus(manualEdits[key].status) && (manualEdits[key].hours || manualEdits[key].start)) {
        employeeWorkDays[e.id]++;
      }
    });
  });
  
  const assignments = assignEmployeesToWeek(days);
  
  // Convert assignments to manual edits (but don't overwrite locked/existing manual edits)
  days.forEach(d => {
    const dateStr = iso(d);
    const ev = events.find(e => e.date === dateStr);
    
    if(!ev) {
      console.log(`No event on ${dateStr}`);
      return;
    }
    
    const assignedCount = assignments[dateStr] ? assignments[dateStr].length : 0;
    const requiredStaff = ev.staff;
    
    // Check if event is understaffed
    if(assignedCount < requiredStaff) {
      understaffedEvents.push({
        name: ev.name,
        date: dateStr,
        assigned: assignedCount,
        required: requiredStaff,
        shortage: requiredStaff - assignedCount
      });
      console.log(`‚ö†Ô∏è ${ev.name} on ${dateStr}: only ${assignedCount}/${requiredStaff} staff assigned`);
    }
    
    if(!assignments[dateStr]) {
      console.log(`No assignments for ${dateStr} (event: ${ev.name})`);
      return;
    }
    
    console.log(`Event: ${ev.name} on ${dateStr}, assigned: ${assignedCount}/${requiredStaff} employees`);
    
    assignments[dateStr].forEach(empId => {
      const key = empId + "_" + dateStr;
      
      // Skip if locked or already manually edited
      if(lockedCells[key]) {
        console.log(`Skipping ${key} - locked`);
        return;
      }
      if(manualEdits[key]) {
        console.log(`Skipping ${key} - already has manual edit`);
        return;
      }
      
      // Check individual employee's max days limit (including already scheduled days)
      const employee = employees.find(e => e.id === empId);
      const empMaxDays = employee.maxDaysPerWeek !== undefined ? employee.maxDaysPerWeek : 5;
      
      if(employeeWorkDays[empId] >= empMaxDays) {
        console.log(`Skipping ${employee.name} on ${dateStr} - already worked ${empMaxDays} days this week (personal limit)`);
        skippedDueToLimit++;
        return;
      }
      
      // Calculate shift times
      const s = normalizeHours(ev.start, ev.end);
      const t = calculateSmartShift(ev, s.h);
      
      // Create the shift as a manual edit
      manualEdits[key] = {
        hours: s.h,
        start: timeStr(t.start),
        end: timeStr(t.end),
        generated: true // Mark as auto-generated
      };
      
      // Increment work day counter
      employeeWorkDays[empId]++;
      
      shiftsCreated++;
      console.log(`Created shift for ${key}: ${s.h}h (work days: ${employeeWorkDays[empId]})`);
    });
  });
  
  console.log(`Total shifts created: ${shiftsCreated}`);
  console.log(`Shifts skipped due to 5-day limit: ${skippedDueToLimit}`);
  console.log(`Understaffed events: ${understaffedEvents.length}`);
  
  // NEW: Store conflicts for conflict report
  generationConflicts = understaffedEvents.map(evt => ({
    event: evt.name,
    date: new Date(evt.date).toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'}),
    required: evt.required,
    assigned: evt.assigned,
    shortage: evt.shortage,
    reason: 'Insufficient eligible employees after applying all constraints'
  }));
  
  // NEW: Show/hide conflict report button
  const conflictBtn = document.getElementById('conflictReportBtn');
  if(generationConflicts.length > 0) {
    conflictBtn.style.display = 'inline-block';
    conflictBtn.textContent = `‚ö†Ô∏è Conflicts (${generationConflicts.length})`;
  } else {
    conflictBtn.style.display = 'none';
  }
  
  // Build alert message
  let message = '';
  if(shiftsCreated === 0) {
    message = `No shifts were created. Make sure you have:\n1. Events in the current week\n2. Available employees (not retired/sick/vacation)\n3. Unlocked cells\n4. Employees haven't reached max days limit`;
  } else {
    message = `‚úÖ Created ${shiftsCreated} shifts!`;
    
    if(skippedDueToLimit > 0) {
      message += `\n\n‚ö†Ô∏è ${skippedDueToLimit} potential shifts skipped (max days limit)`;
    }
    
    if(understaffedEvents.length > 0) {
      message += `\n\nüö® UNDERSTAFFED EVENTS:\n`;
      understaffedEvents.forEach(evt => {
        const dateObj = new Date(evt.date);
        const dateDisplay = dateObj.toLocaleDateString(undefined, {weekday: 'short', month: 'short', day: 'numeric'});
        message += `\n‚Ä¢ ${evt.name} (${dateDisplay})\n  Needs ${evt.shortage} more staff (${evt.assigned}/${evt.required})`;
      });
      message += `\n\nClick "‚ö†Ô∏è Conflicts" button for detailed conflict report.\n\nYou may need to:\n- Manually assign more employees\n- Hire additional staff\n- Reduce event requirements`;
    }
    
    message += `\n\nüí° TIP: Click any generated shift to see WHY that employee was assigned.\nHover (desktop) or tap (mobile) on shifts with ‚ÑπÔ∏è icon.`;
  }
  alert(message);
  
  addAuditEntry('Schedule Generated', null, null, null, `Generated ${shiftsCreated} shifts, ${understaffedEvents.length} understaffed events`);
  save();
  displaySchedule();
}

/* SCHEDULE DISPLAY */
function displaySchedule(){
  try {
    // This function just DISPLAYS the current schedule (manual edits + locked cells)
    scheduleTable.innerHTML="";
    
    const start=getWeekStart();
    const days=[...Array(7)].map((_,i)=>{
      const d=new Date(start);
      d.setDate(start.getDate()+i);
    return d;
  });

  weekHeader.textContent = `${days[0].toLocaleDateString()} ‚Äì ${days[6].toLocaleDateString()}`;

  // ========== DESKTOP TABLE VIEW ==========
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>üîí</th><th>Employee</th>';
  
  days.forEach(d=>{
    const th = document.createElement('th');
    th.textContent = d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"});
    headerRow.appendChild(th);
  });
  
  headerRow.innerHTML += '<th>Total<br><small class="schedule-th-helper">Total scheduled hours</small></th><th>Days<br><small class="schedule-th-helper">Days worked this week</small></th>';
  scheduleTable.appendChild(headerRow);

  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0;
    let daysWorked=0;
    const row = document.createElement('tr');
    const currentEmpId = emp.id; // Capture ID explicitly
    
    // Add row lock toggle
    const lockCell = document.createElement('td');
    const isRowLocked = lockedRows[currentEmpId];
    lockCell.innerHTML = isRowLocked ? 'üîí' : 'üîì';
    lockCell.style.cursor = 'pointer';
    lockCell.style.fontSize = '18px';
    lockCell.setAttribute('data-employee-id', currentEmpId);
    lockCell.onclick = (function(empId) {
      return function() { toggleRowLock(empId); };
    })(currentEmpId);
    lockCell.title = isRowLocked ? 'Unlock this row so it can be updated when you run Generate' : 'Lock this row so it won\'t change when you run Generate';
    row.appendChild(lockCell);
    
    // Add employee name
    const nameCell = document.createElement('td');
    nameCell.textContent = emp.name;
    row.appendChild(nameCell);

    days.forEach(d=>{
      const dateStr = iso(d);
      const key=emp.id+"_"+dateStr;
      const cell = document.createElement('td');
      cell.className = 'clickable';
      cell.setAttribute('data-emp-id', emp.id);
      cell.setAttribute('data-date', dateStr);
      
      const isLocked = lockedCells[key];
      if(isLocked) cell.classList.add('locked-cell');
      if(lockedRows[emp.id]) cell.classList.add('locked-cell');

      // Check for manual edits (includes generated shifts)
      if(manualEdits[key]){
        const edit = manualEdits[key];
        var absenceInfo = edit.status ? ABSENCE_TYPES.find(function(a) { return a.id === edit.status; }) : null;
        
        if (absenceInfo && absenceInfo.id === 'requested_off' && (edit.hours || edit.start)) {
          const h = edit.hours || edit;
          total += h;
          daysWorked++;
          cell.className += ' ' + getShiftClassByHours(h);
          cell.style.position = 'relative';
          cell.title = 'Click to edit or change status. ' + absenceInfo.cellLabel;
          if(edit.start && edit.end) {
            cell.innerHTML = h + 'h<br><small>' + edit.start + '‚Äì' + edit.end + '</small><br><span style="font-size:11px;color:var(--brand-text-muted);">' + (absenceInfo ? absenceInfo.cellLabel : '') + '</span>';
          } else {
            cell.innerHTML = h + 'h<br><span style="font-size:11px;color:var(--brand-text-muted);">' + (absenceInfo ? absenceInfo.cellLabel : '') + '</span>';
          }
          cell.onclick = function(ev) { if (!ev.target.closest('a')) editScheduleCell(emp.id, dateStr); };
          row.appendChild(cell);
          return;
        }
        
        if (absenceInfo && absenceInfo.id !== 'requested_off') {
          cell.style.background = absenceInfo.id === 'sick' ? '#95a5a6' : absenceInfo.id === 'vacation' || absenceInfo.id === 'floating_holiday' ? '#3498db' : absenceInfo.id === 'unpaid_vacation' ? '#7f8c8d' : '#6b7c8d';
          cell.innerHTML = absenceInfo.cellLabel;
          cell.title = 'Click to edit or change status';
          cell.onclick = () => editScheduleCell(emp.id, dateStr);
          row.appendChild(cell);
          return;
        }
        
        if (absenceInfo && absenceInfo.id === 'requested_off') {
          cell.style.background = '#3d4550';
          cell.innerHTML = absenceInfo.cellLabel;
          cell.title = 'Click to edit or change status. Request Off is visual only until converted.';
          cell.onclick = () => editScheduleCell(emp.id, dateStr);
          row.appendChild(cell);
          return;
        }
        
        const h = edit.hours || edit;
        total += h;
        daysWorked++; // Count this as a worked day
        cell.className += ' ' + getShiftClassByHours(h);
        
        cell.style.position = 'relative';
        
        if(isLocked || lockedRows[emp.id]) {
          cell.title = 'Locked shift. Click to edit or unlock.';
        } else {
          cell.title = 'Click to edit or remove this shift';
        }
        
        if(edit.start && edit.end) {
          const conflicts = detectConflicts(emp.id, dateStr, edit.start, edit.end);
          if(conflicts.length > 0) {
            cell.classList.add('conflict-cell');
            cell.title = (cell.title || '') + ' Less than 8 hours rest from another shift.';
          }
          var overrideInd = edit.seniorityOverride ? ' <span class="override-indicator" title="Seniority override' + (edit.overrideReason ? ': ' + edit.overrideReason : '') + '">&#9888;</span>' : '';
          cell.innerHTML = `${h}h<br><small>${edit.start}‚Äì${edit.end}</small>${overrideInd}<br><a href="#" class="schedule-why-link" title="Why this employee?">Why?</a>`;
        } else {
          var overrideInd = edit.seniorityOverride ? ' <span class="override-indicator" title="Seniority override' + (edit.overrideReason ? ': ' + edit.overrideReason : '') + '">&#9888;</span>' : '';
          cell.innerHTML = `${h}h<br>${overrideInd}<a href="#" class="schedule-why-link" title="Why this employee?">Why?</a>`;
        }
        var whyLink = cell.querySelector('.schedule-why-link');
        if (whyLink) {
          whyLink.onclick = function(e) { e.preventDefault(); e.stopPropagation(); showAssignmentReason(emp.id, dateStr); };
        }
        cell.onclick = function(ev) { if (!ev.target.closest('.schedule-why-link')) editScheduleCell(emp.id, dateStr); };
        
        row.appendChild(cell);
        return;
      }

      // Empty cell if no manual edit
      cell.title = 'Click to add a shift';
      cell.onclick = () => editScheduleCell(emp.id, dateStr);
      row.appendChild(cell);
    });

    const totalCell = document.createElement('td');
    totalCell.innerHTML = `<strong>${total}h</strong>`;
    row.appendChild(totalCell);
    
    // Add days worked column with individual max days
    const empMaxDays = emp.maxDaysPerWeek !== undefined ? emp.maxDaysPerWeek : 5;
    const daysCell = document.createElement('td');
    daysCell.innerHTML = `<strong>${daysWorked}/${empMaxDays}</strong>`;
    
    if(daysWorked >= empMaxDays) {
      daysCell.style.background = '#e74c3c';
      daysCell.style.color = '#fff';
      daysCell.title = `Maximum ${empMaxDays} days reached`;
    } else if(daysWorked >= empMaxDays - 1) {
      daysCell.style.background = '#f39c12';
      daysCell.style.color = '#000';
      daysCell.title = `Close to ${empMaxDays}-day limit`;
    }
    row.appendChild(daysCell);
    
    scheduleTable.appendChild(row);
  });
  
  if(employees.filter(e=>!e.retired).length === 0){
    const emptyRow = document.createElement('tr');
    const emptyCell = document.createElement('td');
    emptyCell.setAttribute('colspan', '11');
    emptyCell.style.textAlign = 'center';
    emptyCell.style.padding = '1.5rem';
    emptyCell.style.color = '#7f8c8d';
    emptyCell.textContent = 'Add employees in the Employees tab, then add events and click Generate to build your schedule.';
    emptyRow.appendChild(emptyCell);
    scheduleTable.appendChild(emptyRow);
  }
  
  // Update global lock button state and helper text
  const btn = document.getElementById('globalLockBtn');
  if(btn) {
    if(scheduleGlobalLock) {
      btn.innerHTML = 'üîí Locked Schedule';
      btn.style.background = '#e74c3c';
    } else {
      btn.innerHTML = 'üîì Unlock Schedule';
      btn.style.background = '#f39c12';
    }
  }
  var lockHelper = document.getElementById('scheduleLockHelperText');
  if (lockHelper) lockHelper.textContent = scheduleGlobalLock ? 'Locked schedules cannot be edited' : 'Edits enabled ‚Äî changes will affect assignments';
  } catch(error) {
    console.error('Error in displaySchedule:', error);
    console.error('Error details:', error.message, error.stack);
    scheduleTable.innerHTML = '<tr><td colspan="10" style="padding: 20px; color: #e74c3c; text-align: center;">Error displaying schedule. Please check console for details.</td></tr>';
  }
}

function assignEmployeesToWeek(days) {
  const assignments = {};
  const employeeShiftHistory = {};
  const employeeTotalHours = {};
  const employeeWorkDays = {}; // NEW: Track days worked per week
  
  employees.filter(e => !e.retired).forEach(e => {
    employeeShiftHistory[e.id] = null;
    employeeTotalHours[e.id] = 0;
    employeeWorkDays[e.id] = 0; // Initialize work day counter
  });
  
  days.forEach(d => {
    const dateStr = iso(d);
    const dayEvents = events.filter(e => e.date === dateStr);
    
    if(dayEvents.length === 0) return;
    
    dayEvents.sort((a, b) => a.start.localeCompare(b.start));
    
    // Filter available employees (not retired, not sick, not on vacation this specific day)
    const available = employees.filter(e => {
      if(e.retired || e.sick) return false;
      
      const vacationKey = e.id + "_" + dateStr;
      var ed = manualEdits[vacationKey];
      if (ed && isFullAbsenceStatus(ed.status)) return false;
      
      return true;
    }).map(e => ({...e, assignedToday: false}));
    
    dayEvents.forEach((ev, eventIndex) => {
      const isEarliestShift = eventIndex === 0;
      const isLatestShift = eventIndex === dayEvents.length - 1;
      
      const s = normalizeHours(ev.start, ev.end);
      const t = calculateSmartShift(ev, s.h);
      
      const scored = available
        .filter(emp => {
          const key = emp.id + "_" + dateStr;
          if(lockedCells[key]) return false;
          var ed = manualEdits[key];
          if (ed) {
            if (isFullAbsenceStatus(ed.status)) return false;
            if (ed.status === 'requested_off' && !ed.hours && !ed.start) { /* still available for assignment */ }
            else return false;
          }
          // Skip if already assigned today
          if(emp.assignedToday) return false;
          
          // Check individual employee's max days per week limit
          const empMaxDays = emp.maxDaysPerWeek !== undefined ? emp.maxDaysPerWeek : 5;
          if(employeeWorkDays[emp.id] >= empMaxDays) {
            console.log(`${emp.name} already worked ${empMaxDays} days this week (personal limit), skipping`);
            return false;
          }
          
          return true;
        })
        .map(emp => {
          let score = 0;
          let canWork = true;
          
          const gapCheck = canWorkShift(emp.id, dateStr, t.start, employeeShiftHistory);
          if(!gapCheck.allowed) {
            canWork = false;
          }
          
          // Apply scoring based on selected assignment style
          const assignmentStyle = settings.assignmentStyle || 'strict';
          
          if(assignmentStyle === 'strict') {
            // STRICT SENIORITY: Seniority is dominant factor
            score += (100 - emp.seniority) * 10000; // Seniority is the main driver
            if(emp.type === 'FT') score += 1000; // FT bonus, but less than seniority difference
            
            // Preferences are secondary
            if(emp.pref === 'AM' && isEarliestShift) score += 50;
            else if(emp.pref === 'PM' && isLatestShift) score += 50;
            
            const dayOfWeek = d.getDay();
            if(emp.dayPreferences && emp.dayPreferences[dayOfWeek] === true) {
              score += 50;
            } else if(emp.dayPreferences && emp.dayPreferences[dayOfWeek] === false) {
              score -= 50;
            }
            
          } else if(assignmentStyle === 'balanced') {
            // SENIORITY + BALANCED COVERAGE: Balance FT/PT while respecting seniority
            if(emp.type === 'FT') score += 10000; // FT priority
            score += (100 - emp.seniority) * 100; // Seniority within groups
            
            // Balance by checking group hours
            const ftHours = Object.keys(employeeTotalHours)
              .filter(id => employees.find(e => e.id === id && e.type === 'FT'))
              .reduce((sum, id) => sum + (employeeTotalHours[id] || 0), 0);
            
            const ptHours = Object.keys(employeeTotalHours)
              .filter(id => employees.find(e => e.id === id && e.type === 'PT'))
              .reduce((sum, id) => sum + (employeeTotalHours[id] || 0), 0);
            
            // If one group has significantly more hours, boost the other group
            if(emp.type === 'FT' && ftHours > ptHours + 20) {
              score -= 2000; // Reduce FT priority if they're ahead
            } else if(emp.type === 'PT' && ptHours > ftHours + 20) {
              score -= 2000; // Reduce PT priority if they're ahead
            }
            
            // Hour balance within employee
            const expectedHours = (100 - emp.seniority) * 0.5;
            if(employeeTotalHours[emp.id] < expectedHours) {
              score += 500;
            }
            
            // Preferences
            if(emp.pref === 'AM' && isEarliestShift) score += 200;
            else if(emp.pref === 'PM' && isLatestShift) score += 200;
            
            const dayOfWeek = d.getDay();
            if(emp.dayPreferences && emp.dayPreferences[dayOfWeek] === true) {
              score += 150;
            } else if(emp.dayPreferences && emp.dayPreferences[dayOfWeek] === false) {
              score -= 150;
            }
            
          } else if(assignmentStyle === 'fair') {
            // FAIR DISTRIBUTION: Hours are primary, seniority is tie-breaker
            const currentHours = employeeTotalHours[emp.id] || 0;
            
            // Heavily prioritize employees with fewer hours
            score += (100 - currentHours) * 1000;
            
            // Seniority is only a minor tie-breaker
            score += (100 - emp.seniority) * 10;
            
            // FT/PT doesn't matter much, just slight preference for FT
            if(emp.type === 'FT') score += 100;
            
            // Preferences still matter
            if(emp.pref === 'AM' && isEarliestShift) score += 200;
            else if(emp.pref === 'PM' && isLatestShift) score += 200;
            
            const dayOfWeek = d.getDay();
            if(emp.dayPreferences && emp.dayPreferences[dayOfWeek] === true) {
              score += 150;
            } else if(emp.dayPreferences && emp.dayPreferences[dayOfWeek] === false) {
              score -= 150;
            }
          }
          
          return { ...emp, score, canWork };
        })
        .filter(emp => emp.canWork);
      
      scored.sort((a, b) => b.score - a.score);
      
      const assigned = scored.slice(0, ev.staff);
      
      // NEW: Track assignment reasons for audit
      const assignmentStyle = settings.assignmentStyle || 'strict';
      
      assigned.forEach((emp, assignIndex) => {
        const empRef = available.find(e => e.id === emp.id);
        if(empRef) empRef.assignedToday = true;
        
        employeeShiftHistory[emp.id] = {
          date: dateStr,
          endTime: t.end
        };
        
        employeeTotalHours[emp.id] += s.h;
        
        // NEW: Increment work day counter for this employee
        employeeWorkDays[emp.id] += 1;
        
        // NEW: Record WHY this employee was assigned (plain-language only; no numbers, weights, or scoring)
        const key = emp.id + "_" + dateStr;
        const reasons = [];
        
        reasons.push('Event: ' + ev.name);
        reasons.push('Chosen among eligible staff for this shift.');
        
        if(assignmentStyle === 'strict') {
          reasons.push('Seniority was the main factor.');
          if(emp.type === 'FT') reasons.push('Full-time status considered.');
          if((emp.pref === 'AM' && isEarliestShift) || (emp.pref === 'PM' && isLatestShift)) reasons.push('Shift preference matched.');
          if(emp.dayPreferences && emp.dayPreferences[d.getDay()] === true) reasons.push('Day preference matched.');
        } else if(assignmentStyle === 'balanced') {
          reasons.push('Balance of full-time and part-time coverage.');
          reasons.push('Seniority considered within that balance.');
          if(emp.type === 'FT') reasons.push('Full-time status considered.');
          if((emp.pref === 'AM' && isEarliestShift) || (emp.pref === 'PM' && isLatestShift)) reasons.push('Shift preference matched.');
          if(emp.dayPreferences && emp.dayPreferences[d.getDay()] === true) reasons.push('Day preference matched.');
        } else if(assignmentStyle === 'fair') {
          reasons.push('Hours so far were among the lowest.');
          if((emp.pref === 'AM' && isEarliestShift) || (emp.pref === 'PM' && isLatestShift)) reasons.push('Shift preference matched.');
          if(emp.dayPreferences && emp.dayPreferences[d.getDay()] === true) reasons.push('Day preference matched.');
          reasons.push('Seniority used only to break ties.');
        }
        
        reasons.push('Available (not sick or on vacation).');
        reasons.push('Within allowed working days for the week.');
        reasons.push('Rest period between shifts respected.');
        
        assignmentReasons[key] = reasons;
        var tags = ['availability', 'no_conflicts', 'within_max_days', 'seniority'];
        if (emp.type === 'FT') tags.push('full_time');
        if ((emp.pref === 'AM' && isEarliestShift) || (emp.pref === 'PM' && isLatestShift)) tags.push('prefers_shift');
        if (emp.dayPreferences && emp.dayPreferences[d.getDay()] === true) tags.push('day_preference');
        if (assignmentStyle === 'balanced' || assignmentStyle === 'fair') tags.push('rotation_balance');
        assignmentReasonTags[key] = tags;
      });
      
      if(!assignments[dateStr]) {
        assignments[dateStr] = [];
      }
      assigned.forEach(emp => {
        if(!assignments[dateStr].includes(emp.id)) {
          assignments[dateStr].push(emp.id);
        }
      });
    });
  });
  
  return assignments;
}

function canWorkShift(empId, currentDate, shiftStart, shiftHistory) {
  const lastShift = shiftHistory[empId];
  
  if(!lastShift) return {allowed: true};
  
  const lastDate = new Date(lastShift.date);
  const currentDateObj = new Date(currentDate);
  const daysDiff = Math.floor((currentDateObj - lastDate) / (1000 * 60 * 60 * 24));
  
  if(daysDiff > 1) return {allowed: true};
  
  if(daysDiff === 1) {
    const lastEnd = lastShift.endTime;
    const currentStart = shiftStart;
    
    const lastEndMinutes = lastEnd.getHours() * 60 + lastEnd.getMinutes();
    const currentStartMinutes = currentStart.getHours() * 60 + currentStart.getMinutes();
    
    const totalMinutesBetween = (1440 - lastEndMinutes) + currentStartMinutes;
    
    if(totalMinutesBetween >= 480) {
      return {allowed: true};
    } else {
      return {allowed: false, reason: 'needs 8 hour gap'};
    }
  }
  
  return {allowed: true};
}

function regenerateSchedule(){ 
  if(!confirm("This will clear ALL shifts (manual and generated) and regenerate from events. Continue?")) return;
  
  manualEdits = {};
  addAuditEntry('Schedule Regenerated', null, null, 'All shifts cleared', 'Regenerated from events');
  save();
  generateSchedule(); // This will regenerate
}

function changeWeek(n){ 
  currentWeekOffset+=n; 
  displaySchedule(); // Just display, don't regenerate
}

function toggleDarkMode(){ 
  document.body.classList.toggle("light-mode"); 
}

function printSchedule(){ 
  showTab("scheduleTab");
  // Wait for schedule to render before printing
  setTimeout(() => {
    window.print();
  }, 500);
}

/* SCHEDULE EXPORT (isolated; does not affect scheduling logic) */
function exportScheduleToCSV() {
  const start = getWeekStart();
  const days = [...Array(7)].map((_, i) => {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    return d;
  });
  const header = ['Employee Name', 'Role', 'Date', 'Hours'];
  const rows = [];
  employees.filter(e => !e.retired).forEach(emp => {
    days.forEach(d => {
      const dateStr = iso(d);
      const key = emp.id + '_' + dateStr;
      const edit = manualEdits[key];
      if (!edit) return;
      let hours;
      if (edit.status && isFullAbsenceStatus(edit.status)) {
        hours = '0';
      } else if (edit.status === 'requested_off' && !edit.hours && !edit.start) {
        hours = '0';
      } else {
        const h = edit.hours != null ? edit.hours : edit;
        hours = String(typeof h === 'number' ? h : (h || 0));
      }
      rows.push([
        emp.name || '',
        emp.type || '',
        dateStr,
        hours
      ]);
    });
  });
  function escapeCsvField(val) {
    const s = String(val);
    if (/[,"\r\n]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }
  const csvContent = '\uFEFF' + [header.map(escapeCsvField).join(',')]
    .concat(rows.map(r => r.map(escapeCsvField).join(',')))
    .join('\r\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'BanquetLogic_Schedule_' + iso(start) + '_to_' + iso(days[6]) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

/* AUDIT LOG */
function renderAuditLog(filter = {}){
  const container = document.getElementById('auditLogContainer');
  container.innerHTML = '';
  
  let filtered = auditLog;
  
  if(filter.employee) {
    filtered = filtered.filter(e => 
      e.employee.toLowerCase().includes(filter.employee.toLowerCase())
    );
  }
  
  if(filter.date) {
    filtered = filtered.filter(e => e.date === filter.date);
  }
  
  if(filtered.length === 0) {
    container.innerHTML = '<p>No audit entries found.</p>';
    return;
  }
  
  filtered.forEach(entry => {
    const div = document.createElement('div');
    div.className = 'audit-entry';
    
    const timestamp = new Date(entry.timestamp).toLocaleString();
    let html = `<strong>${entry.action}</strong> - ${timestamp}<br>`;
    
    if(entry.employee) html += `Employee: ${entry.employee}<br>`;
    if(entry.date) html += `Date: ${entry.date}<br>`;
    if(entry.oldValue) html += `Old: ${entry.oldValue}<br>`;
    if(entry.newValue) html += `New: ${entry.newValue}`;
    
    div.innerHTML = html;
    container.appendChild(div);
  });
}

function filterAuditLog(){
  renderAuditLog({
    employee: document.getElementById('auditEmployee').value,
    date: document.getElementById('auditDate').value
  });
}

function clearAuditFilter(){
  document.getElementById('auditEmployee').value = '';
  document.getElementById('auditDate').value = '';
  renderAuditLog();
}

/* SETTINGS */
function loadSettings(){
  // Load assignment style
  const assignmentStyle = settings.assignmentStyle || 'strict';
  const radioButtons = document.querySelectorAll('input[name="assignmentStyle"]');
  radioButtons.forEach(radio => {
    radio.checked = radio.value === assignmentStyle;
  });
  renderEventTypesTable();
}

function renderEventTypesTable(){
  const tbody = document.getElementById('eventTypesTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  eventTypes.forEach(function(t){
    const tr = document.createElement('tr');
    tr.setAttribute('data-event-type-id', t.id);
    if (!t.active) tr.style.opacity = '0.6';
    tr.innerHTML =
      '<td>' + (t.name || '') + '</td>' +
      '<td>1 per ' + t.guestsPerServer + ' guests</td>' +
      '<td><input type="checkbox" ' + (t.active ? 'checked' : '') + ' onchange="toggleEventTypeActive(\'' + t.id + '\')" /></td>' +
      '<td><button type="button" onclick="openEventTypeModal(\'' + t.id + '\')">Edit</button> ' +
      '<button type="button" onclick="deleteEventType(\'' + t.id + '\')">Delete</button></td>';
    tbody.appendChild(tr);
  });
}

function openEventTypeModal(editId){
  document.getElementById('eventTypeModalTitle').textContent = editId ? 'Edit event type' : 'Add event type';
  document.getElementById('eventTypeEditId').value = editId || '';
  if (editId) {
    var t = getEventTypeById(editId);
    if (t) {
      document.getElementById('eventTypeName').value = t.name || '';
      document.getElementById('eventTypeGuestsPerServer').value = t.guestsPerServer || 20;
    }
  } else {
    document.getElementById('eventTypeName').value = '';
    document.getElementById('eventTypeGuestsPerServer').value = 20;
  }
  document.getElementById('eventTypeModalOverlay').style.display = 'flex';
}

function closeEventTypeModal(){
  document.getElementById('eventTypeModalOverlay').style.display = 'none';
}

function saveEventTypeFromModal(){
  var name = document.getElementById('eventTypeName').value.trim();
  var guestsPerServer = parseInt(document.getElementById('eventTypeGuestsPerServer').value, 10) || 20;
  var editId = document.getElementById('eventTypeEditId').value;
  if (!name) { alert('Please enter a name.'); return; }
  if (guestsPerServer < 1) { alert('Guests per server must be at least 1.'); return; }
  if (editId) {
    var t = getEventTypeById(editId);
    if (t) { t.name = name; t.guestsPerServer = guestsPerServer; }
  } else {
    eventTypes.push({ id: crypto.randomUUID(), name: name, guestsPerServer: guestsPerServer, active: true });
  }
  save();
  renderEventTypesTable();
  closeEventTypeModal();
  populateEventServiceDropdown();
}

function toggleEventTypeActive(id){
  var t = getEventTypeById(id);
  if (t) { t.active = !t.active; save(); renderEventTypesTable(); populateEventServiceDropdown(); }
}

function deleteEventType(id){
  var t = getEventTypeById(id);
  if (!t) return;
  if (isEventTypeUsedByEvents(t)) {
    alert('This event type cannot be deleted because it is used by one or more events. Disable it instead to hide it from new events.');
    return;
  }
  if (!confirm('Delete event type "' + t.name + '"?')) return;
  eventTypes = eventTypes.filter(function(x) { return x.id !== id; });
  save();
  renderEventTypesTable();
  populateEventServiceDropdown();
}

function saveSettings(){
  // Save assignment style
  const selectedStyle = document.querySelector('input[name="assignmentStyle"]:checked');
  if(selectedStyle) {
    settings.assignmentStyle = selectedStyle.value;
  }
  save();
  alert('Settings saved!');
}

function clearAllData() {
  var msg = 'This will permanently delete ALL data:\n\n' +
    '‚Ä¢ All employees\n‚Ä¢ All events\n‚Ä¢ All schedules (every week)\n‚Ä¢ Audit log\n‚Ä¢ Assignment explanations\n\n' +
    'Demo mode will be reset. Settings will be restored to defaults.\n\n' +
    'This cannot be undone. Are you sure you want to clear everything?';
  if (!confirm(msg)) return;
  clearTimeout(demoTimer);
  demoTimer = null;
  demoInProgress = false;
  demoBackupData = null;
  employees = [];
  events = [];
  manualEdits = {};
  lockedCells = {};
  lockedRows = {};
  scheduleGlobalLock = false;
  auditLog = [];
  assignmentReasons = {};
  assignmentReasonTags = {};
  generationConflicts = [];
  editingEventId = null;
  currentWeekOffset = 0;
  settings = {
    assignmentStyle: 'strict',
    ratios: {
      'Plated Service': 20,
      'Buffet Service': 30,
      'Reception': 40,
      'Coffee Break': 50
    }
  };
  eventTypes = getDefaultEventTypes();
  save();
  var banner = document.getElementById('demoModeBanner');
  if (banner) banner.classList.remove('demo-mode-banner-visible');
  var tip = document.getElementById('demoTip');
  if (tip) tip.classList.remove('demo-tip-visible');
  var stopArea = document.getElementById('demoStopArea');
  if (stopArea) stopArea.style.display = 'none';
  var status = document.getElementById('demoStatus');
  if (status) status.style.display = 'none';
  var instructions = document.getElementById('demoInstructions');
  if (instructions) instructions.style.display = 'block';
  if (typeof tabDemoBtn !== 'undefined') tabDemoBtn.classList.remove('demo-active');
  var conflictBtn = document.getElementById('conflictReportBtn');
  if (conflictBtn) { conflictBtn.style.display = 'none'; conflictBtn.textContent = '‚ö†Ô∏è Conflicts'; }
  renderEmployees();
  renderEvents();
  displaySchedule();
  loadSettings();
  showTab('employeesTab');
  alert('All data has been permanently deleted. The app is now in a fresh state.');
}

/* SUPPORT / CONTACT */
function submitSupport(){
  const category = document.getElementById('supportCategory').value;
  const subject = document.getElementById('supportSubject').value.trim();
  const message = document.getElementById('supportMessage').value.trim();
  const feedback = document.getElementById('supportFeedback');
  
  // Validation
  if(!subject) {
    feedback.style.display = 'block';
    feedback.style.background = '#e74c3c';
    feedback.style.color = '#fff';
    feedback.innerHTML = '‚ùå Please enter a subject';
    return;
  }
  
  if(!message) {
    feedback.style.display = 'block';
    feedback.style.background = '#e74c3c';
    feedback.style.color = '#fff';
    feedback.innerHTML = '‚ùå Please enter a message';
    return;
  }
  
  // Build email content
  const emailSubject = `[BanquetLogic ${category}] ${subject}`;
  const emailBody = `Category: ${category}\n\n${message}\n\n---\nSent from BanquetLogic Scheduler`;
  
  // Create mailto link
  const mailtoLink = `mailto:Alialannoon@gmail.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
  
  // Open email client
  window.location.href = mailtoLink;
  
  // Show success message
  feedback.style.display = 'block';
  feedback.style.background = '#27ae60';
  feedback.style.color = '#fff';
  feedback.innerHTML = '‚úÖ Your email client should open shortly. Please send the pre-filled email to complete your submission.';
  
  // Clear form after a delay
  setTimeout(() => {
    document.getElementById('supportSubject').value = '';
    document.getElementById('supportMessage').value = '';
    document.getElementById('supportCategory').value = 'Bug';
  }, 2000);
  
  // Log in audit
  addAuditEntry('Support Request', null, null, null, `${category}: ${subject}`);
  save();
}

/* DEMO MODE */
let demoInProgress = false;
let demoTimer = null;
let demoBackupData = null;

function startDemo() {
  if(!confirm('Start the BanquetLogic demo?\n\nThis will temporarily replace your data with sample data. Your real data will be restored when the demo ends.')) {
    return;
  }
  
  // Backup all state that can be modified during demo or persisted to storage
  demoBackupData = {
    employees: JSON.parse(JSON.stringify(employees)),
    events: JSON.parse(JSON.stringify(events)),
    manualEdits: JSON.parse(JSON.stringify(manualEdits)),
    lockedCells: JSON.parse(JSON.stringify(lockedCells)),
    lockedRows: JSON.parse(JSON.stringify(lockedRows)),
    scheduleGlobalLock: scheduleGlobalLock,
    currentWeekOffset: currentWeekOffset,
    auditLog: JSON.parse(JSON.stringify(auditLog)),
    assignmentReasons: JSON.parse(JSON.stringify(assignmentReasons)),
    assignmentReasonTags: JSON.parse(JSON.stringify(assignmentReasonTags))
  };
  
  demoInProgress = true;
  try { sessionStorage.setItem('banquetlogic_demo_active', '1'); } catch (e) {}
  document.getElementById('demoModeBanner').classList.add('demo-mode-banner-visible');
  document.getElementById('demoStopArea').style.display = 'block';
  document.getElementById('demoStatus').style.display = 'block';
  document.getElementById('demoInstructions').style.display = 'none';
  if(typeof tabDemoBtn !== 'undefined') tabDemoBtn.classList.add('demo-active');
  
  runDemoSequence();
}

function performDemoCleanup(skipConfirm) {
  clearTimeout(demoTimer);
  demoTimer = null;
  
  const hasValidBackup = demoBackupData && Array.isArray(demoBackupData.employees);
  if (hasValidBackup) {
    employees = demoBackupData.employees;
    events = demoBackupData.events;
    manualEdits = demoBackupData.manualEdits;
    lockedCells = demoBackupData.lockedCells;
    lockedRows = demoBackupData.lockedRows;
    scheduleGlobalLock = demoBackupData.scheduleGlobalLock;
    currentWeekOffset = demoBackupData.currentWeekOffset;
    auditLog = demoBackupData.auditLog != null ? demoBackupData.auditLog : auditLog;
    assignmentReasons = demoBackupData.assignmentReasons != null ? demoBackupData.assignmentReasons : assignmentReasons;
    assignmentReasonTags = demoBackupData.assignmentReasonTags != null ? demoBackupData.assignmentReasonTags : assignmentReasonTags;
    generationConflicts = [];
    const conflictBtn = document.getElementById('conflictReportBtn');
    if (conflictBtn) { conflictBtn.style.display = 'none'; conflictBtn.textContent = '‚ö†Ô∏è Conflicts'; }
    save();
    renderEmployees();
    renderEvents();
    displaySchedule();
  } else {
    generationConflicts = [];
  }
  
  demoInProgress = false;
  demoBackupData = null;
  try { sessionStorage.removeItem('banquetlogic_demo_active'); } catch (e) {}
  const banner = document.getElementById('demoModeBanner');
  if (banner) banner.classList.remove('demo-mode-banner-visible');
  const tip = document.getElementById('demoTip');
  if (tip) tip.classList.remove('demo-tip-visible');
  const stopArea = document.getElementById('demoStopArea');
  if (stopArea) stopArea.style.display = 'none';
  const status = document.getElementById('demoStatus');
  if (status) status.style.display = 'none';
  const instructions = document.getElementById('demoInstructions');
  if (instructions) instructions.style.display = 'block';
  if (typeof tabDemoBtn !== 'undefined') tabDemoBtn.classList.remove('demo-active');
  
  if (!skipConfirm && hasValidBackup) {
    alert('Demo stopped. Your original data has been restored.');
  }
}

function stopDemo() {
  if (!demoInProgress) return;
  if (!confirm('Stop the demo and restore your real data?')) {
    return;
  }
  performDemoCleanup(false);
}

function updateDemoStatus(step, total, message) {
  const progress = (step / total) * 100;
  document.getElementById('demoProgress').style.width = progress + '%';
  document.getElementById('demoStepInfo').innerHTML = `<strong>Step ${step}/${total}:</strong> ${message}`;
}

function showDemoTip(html) {
  if(!demoInProgress) return;
  const el = document.getElementById('demoTip');
  if(el) {
    document.getElementById('demoTipText').innerHTML = html;
    el.classList.add('demo-tip-visible');
  }
}
function hideDemoTip() {
  const el = document.getElementById('demoTip');
  if(el) el.classList.remove('demo-tip-visible');
}
function demoHighlightElement(id, durationMs) {
  if(!demoInProgress) return;
  const el = document.getElementById(id);
  if(el) {
    el.classList.add('demo-highlight');
    setTimeout(function() { if(el) el.classList.remove('demo-highlight'); }, durationMs || 3000);
  }
}

function runDemoSequence() {
  const steps = [
    { delay: 0, action: () => demoStep1_ClearData() },
    { delay: 2000, action: () => demoStep2_AddEmployees() },
    { delay: 3000, action: () => demoStep3_ShowEmployees() },
    { delay: 3000, action: () => demoStep4_SetPreferences() },
    { delay: 3000, action: () => demoStep5_AddEvents() },
    { delay: 3000, action: () => demoStep6_ShowEvents() },
    { delay: 3000, action: () => demoStep7_GenerateSchedule() },
    { delay: 3000, action: () => demoStep8_ShowSchedule() },
    { delay: 3000, action: () => demoStep9_ManualEdit() },
    { delay: 3000, action: () => demoStep10_ShowFeatures() },
    { delay: 4000, action: () => demoStep11_Complete() }
  ];
  
  let currentStep = 0;
  
  function runNextStep() {
    if(!demoInProgress || currentStep >= steps.length) return;
    try {
      const step = steps[currentStep];
      step.action();
      currentStep++;
      if(currentStep < steps.length) {
        demoTimer = setTimeout(runNextStep, steps[currentStep].delay);
      }
    } catch (err) {
      console.error('Demo step error:', err);
      performDemoCleanup(true);
    }
  }
  
  runNextStep();
}

function demoStep1_ClearData() {
  hideDemoTip();
  updateDemoStatus(1, 11, 'Setting the scene: preparing a fresh demo workspace for a realistic banquet week...');
  employees = [];
  events = [];
  manualEdits = {};
  lockedCells = {};
  lockedRows = {};
  currentWeekOffset = 0;
}

function demoStep2_AddEmployees() {
  updateDemoStatus(2, 11, 'Building your team: adding 5 banquet staff with different seniority, types (FT/PT), and shift preferences...');
  
  const sampleEmployees = [
    { name: 'Alice Johnson', type: 'FT', seniority: 1, pref: 'AM', email: 'alice@example.com', maxDaysPerWeek: 5 },
    { name: 'Bob Smith', type: 'FT', seniority: 2, pref: 'PM', email: 'bob@example.com', maxDaysPerWeek: 5 },
    { name: 'Carol Davis', type: 'FT', seniority: 3, pref: '', email: 'carol@example.com', maxDaysPerWeek: 4 },
    { name: 'David Lee', type: 'PT', seniority: 4, pref: 'AM', email: 'david@example.com', maxDaysPerWeek: 3 },
    { name: 'Emma Wilson', type: 'PT', seniority: 5, pref: 'PM', email: 'emma@example.com', maxDaysPerWeek: 5 }
  ];
  
  sampleEmployees.forEach(emp => {
    employees.push({
      id: crypto.randomUUID(),
      ...emp,
      sick: false,
      retired: false,
      dayPreferences: { 0: null, 1: null, 2: null, 3: null, 4: null, 5: null, 6: null }
    });
  });
}

function demoStep3_ShowEmployees() {
  showDemoTip('This roster drives <strong>who gets first pick</strong> of shifts. Seniority and FT/PT status are used when you Generate.');
  updateDemoStatus(3, 11, 'Your team roster ‚Äî seniority and type (FT/PT) determine who gets first choice of shifts when you generate.');
  showTab('employeesTab');
  renderEmployees();
}

function demoStep4_SetPreferences() {
  showDemoTip('Day preferences help the system avoid scheduling someone on days they prefer off when possible.');
  updateDemoStatus(4, 11, 'Setting preferences: e.g. Alice prefers weekdays ‚Äî the system will favor that when assigning shifts.');
  // Set Alice to prefer weekdays
  if(employees[0]) {
    employees[0].dayPreferences = { 0: false, 1: true, 2: true, 3: true, 4: true, 5: true, 6: false };
  }
}

function demoStep5_AddEvents() {
  hideDemoTip();
  updateDemoStatus(5, 11, 'Adding this week\'s events: a corporate lunch, a wedding reception, and a birthday party ‚Äî each with guest-based staff needs.');
  
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());
  
  const sampleEvents = [
    { day: 2, name: 'Corporate Lunch', start: '11:00', end: '14:30', guests: 80, serviceType: 'Plated Service' },
    { day: 4, name: 'Wedding Reception', start: '17:00', end: '23:00', guests: 150, serviceType: 'Plated Service' },
    { day: 6, name: 'Birthday Party', start: '18:00', end: '22:00', guests: 60, serviceType: 'Buffet Service' }
  ];
  
  sampleEvents.forEach(evt => {
    const eventDate = new Date(weekStart);
    eventDate.setDate(weekStart.getDate() + evt.day);
    
    var type = getEventTypeByName(evt.serviceType);
    var ratio = type ? type.guestsPerServer : (settings.ratios[evt.serviceType] || 30);
    const staffNeeded = Math.ceil(evt.guests / ratio);
    events.push({
      id: crypto.randomUUID(),
      name: evt.name,
      date: iso(eventDate),
      start: evt.start,
      end: evt.end,
      guests: evt.guests,
      service: evt.serviceType,
      eventTypeId: type ? type.id : undefined,
      eventTypeName: evt.serviceType,
      staff: staffNeeded
    });
  });
}

function demoStep6_ShowEvents() {
  showDemoTip('Events drive <strong>how many staff</strong> you need each day. Plated service needs more servers per guest than buffet.');
  updateDemoStatus(6, 11, 'Events drive staffing: guest count and service type determine how many servers are needed each day.');
  showTab('eventsTab');
  renderEvents();
}

function demoStep7_GenerateSchedule() {
  hideDemoTip();
  updateDemoStatus(7, 11, 'Generating the schedule: assigning shifts by seniority, preferences, rest rules, and max days ‚Äî so it\'s fair and explainable.');
  const start = getWeekStart();
  const days = [...Array(7)].map((_, i) => {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    return d;
  });
  
  const assignments = assignEmployeesToWeek(days);
  
  days.forEach(d => {
    const dateStr = iso(d);
    const ev = events.find(e => e.date === dateStr);
    if(!ev || !assignments[dateStr]) return;
    
    assignments[dateStr].forEach(empId => {
      const key = empId + "_" + dateStr;
      const s = normalizeHours(ev.start, ev.end);
      const t = calculateSmartShift(ev, s.h);
      
      manualEdits[key] = {
        hours: s.h,
        start: timeStr(t.start),
        end: timeStr(t.end),
        generated: true
      };
    });
  });
}

function demoStep8_ShowSchedule() {
  showDemoTip('Click any <strong>colored shift</strong> to see why that employee was assigned. Try the üìã Generation Rules button to see what we prioritize when building your schedule.');
  updateDemoStatus(8, 11, 'Your schedule ‚Äî colors show shift length. Every assignment has a reason; click a shift to see why that person was chosen.');
  showTab('scheduleTab');
  displaySchedule();
  demoHighlightElement('scheduleTable', 4500);
  var rulesBtn = document.querySelector('button[onclick="showGenerationRules()"]');
  if(rulesBtn) { rulesBtn.classList.add('demo-highlight'); setTimeout(function() { rulesBtn.classList.remove('demo-highlight'); }, 4500); }
}

function demoStep9_ManualEdit() {
  showDemoTip('The üîí lock means this row won\'t be changed if you run Generate again. Use it when someone\'s schedule is final.');
  updateDemoStatus(9, 11, 'Locking Alice\'s row ‚Äî her shifts are now protected from being overwritten when you run Generate. Useful when a schedule is final.');
  // Lock one employee's row
  if(employees[0]) {
    lockedRows[employees[0].id] = true;
  }
  displaySchedule();
}

function demoStep10_ShowFeatures() {
  showDemoTip('Every change is logged here. In Settings you can switch how shifts are assigned (strict seniority vs. fair distribution).');
  updateDemoStatus(10, 11, 'Audit Log ‚Äî every change is recorded for accountability. In Settings you can change how the system assigns shifts (e.g. strict seniority vs. fair distribution).');
  showTab('auditTab');
  renderAuditLog();
}

function demoStep11_Complete() {
  hideDemoTip();
  updateDemoStatus(11, 11, '‚úÖ Demo complete! You\'ve seen how BanquetLogic keeps scheduling fair, explainable, and auditable. Click Stop Demo to restore your data.');
  
  alert('üéâ Demo Complete!\n\nYou\'ve seen how BanquetLogic:\n‚Ä¢ Builds a roster where seniority and preferences drive who gets shifts\n‚Ä¢ Turns events into staff needs automatically\n‚Ä¢ Generates schedules that are fair and explainable (click any shift to see why)\n‚Ä¢ Protects finalized rows with locking\n‚Ä¢ Logs every change for accountability\n\nClick "Stop Demo" to restore your original data.');
}

/* INIT */
try {
  initEmployeeEditModal();
  initAbsenceModal();
  updateSeniorityPreFill();
  renderEmployees();
  renderEvents();
  showTab("employeesTab");
} catch(error) {
  console.error('Initialization error:', error);
  alert('Error loading BanquetLogic. Please refresh the page.\n\nError: ' + error.message);
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Seniority Scheduler Dashboard</title>

<style>
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin: 20px;
  background: #1e1e2f;
  color: #f0f0f0;
}
body.light-mode { background:#f8f9fa; color:#333; }

h1 { font-size:26px; }

/* TABS */
.tabs { display:flex; gap:6px; margin-bottom:12px; }
.tabs button {
  padding:8px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#2e2e3d;
  color:#ccc;
}
.tabs button.active { background:#4e9af1; color:#fff; }

/* INPUTS */
input, select, button {
  margin:4px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
}
button { background:#4e9af1; color:#fff; font-weight:bold; }
button.delete { background:#c0392b; }
button.retire { background:#8e44ad; }
button.print { background:#27ae60; }

/* TABLE */
table { border-collapse:collapse; width:100%; margin-top:10px; }
th, td {
  padding:8px;
  text-align:center;
  border:1px solid #555;
}
th { background:#4e9af1; color:#fff; }

/* STATUS */
.status-retired { background:#555; opacity:0.6; }

/* SHIFTS */
.shift-4 { background:#2ecc71; }
.shift-6 { background:#e67e22; }
.shift-65 { background:#f1c40f; color:#000; }
.shift-85 { background:#9b59b6; }

/* CLICKABLE CELLS */
td[onclick] { cursor:pointer; }
td[onclick]:hover { outline:2px dashed #4e9af1; }

/* PRINT */
@media print {
  body { background:#fff; color:#000; }
  .tabs, button, input, select { display:none !important; }
  table { font-size:12px; }
  th { background:#ddd !important; color:#000 !important; }
}

/* TABS */
.tab { display:none; }
.tab.active { display:block; }
</style>
</head>

<body>

<h1 id="weekHeader"></h1>

<button onclick="toggleDarkMode()">Toggle Dark Mode</button>
<button class="print" onclick="printSchedule()">Print / Save PDF</button>

<div class="tabs">
  <button id="tabEmpBtn" onclick="showTab('employeesTab')">Employees</button>
  <button id="tabEvBtn" onclick="showTab('eventsTab')">Events</button>
  <button id="tabSchBtn" onclick="showTab('scheduleTab')">Schedule</button>
</div>

<!-- EMPLOYEES -->
<div id="employeesTab" class="tab">
<h2>Employees</h2>

<input id="empName" placeholder="Name" />
<select id="empType"><option>FT</option><option>PT</option></select>
<input id="empSeniority" type="number" placeholder="Seniority" />
<select id="empPref">
  <option value="">No Pref</option>
  <option value="AM">AM</option>
  <option value="PM">PM</option>
</select>
<button onclick="addEmployee()">Add</button>

<table>
<thead>
<tr>
  <th>Name</th><th>Type</th><th>Seniority</th><th>Pref</th>
  <th>Vacation</th><th>Sick</th><th>Retire</th>
</tr>
</thead>
<tbody id="employeesTable"></tbody>
</table>
</div>

<!-- EVENTS -->
<div id="eventsTab" class="tab">
<h2>Events</h2>

<input id="eventName" placeholder="Event Name" />
<input id="eventDate" type="date" />
<input id="eventStart" type="time" onchange="autoRecommendStaff()" />
<input id="eventEnd" type="time" onchange="autoRecommendStaff()" />
<input id="eventGuests" type="number" placeholder="Guests" oninput="autoRecommendStaff()" />

<select id="eventService" onchange="autoRecommendStaff()">
  <option>Plated Service</option>
  <option>Buffet Service</option>
  <option>Reception</option>
  <option>Coffee Break</option>
</select>

<input id="eventStaff" type="number" placeholder="Staff Needed" />
<button onclick="addEvent()">Add / Save</button>

<table>
<thead>
<tr>
  <th>Name</th><th>Date</th><th>Time</th>
  <th>Guests</th><th>Service</th><th>Staff</th>
  <th>Edit</th><th>Delete</th>
</tr>
</thead>
<tbody id="eventsTable"></tbody>
</table>
</div>

<!-- SCHEDULE -->
<div id="scheduleTab" class="tab">
<h2>Schedule</h2>

<button onclick="changeWeek(-1)">â¬… Previous Week</button>
<button onclick="changeWeek(1)">Next Week âž¡</button>
<button onclick="generateSchedule()">Generate</button>
<button onclick="regenerateSchedule()">Regenerate</button>

<table id="scheduleTable"></table>
</div>

<script>
let employees = JSON.parse(localStorage.getItem("employees") || "[]");
let events = JSON.parse(localStorage.getItem("events") || "[]");
let manualEdits = JSON.parse(localStorage.getItem("manualEdits") || "{}");
let editingEventId = null;
let currentWeekOffset = 0;

function save(){
  localStorage.setItem("employees", JSON.stringify(employees));
  localStorage.setItem("events", JSON.stringify(events));
  localStorage.setItem("manualEdits", JSON.stringify(manualEdits));
}

/* TABS */
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="employeesTab") tabEmpBtn.classList.add("active");
  if(id==="eventsTab") tabEvBtn.classList.add("active");
  if(id==="scheduleTab") { tabSchBtn.classList.add("active"); generateSchedule(); }
}

/* EMPLOYEES */
function addEmployee(){
  employees.push({
    id: crypto.randomUUID(),
    name: empName.value,
    type: empType.value,
    seniority:+empSeniority.value,
    pref: empPref.value,
    vacation:false,
    sick:false,
    retired:false
  });
  rebalanceSeniority();
  save(); renderEmployees(); generateSchedule();
}

function rebalanceSeniority(){
  employees.filter(e=>!e.retired)
    .sort((a,b)=>a.seniority-b.seniority)
    .forEach((e,i)=>e.seniority=i+1);
}

function retireEmployee(id){
  if(!confirm("Retire this employee?")) return;
  employees.find(e=>e.id===id).retired=true;
  rebalanceSeniority();
  save(); renderEmployees(); generateSchedule();
}

function renderEmployees(){
  employeesTable.innerHTML="";
  employees.sort((a,b)=>a.seniority-b.seniority).forEach((e,i)=>{
    employeesTable.innerHTML+=`
    <tr class="${e.retired?'status-retired':''}">
      <td>${e.name}</td>
      <td>${e.type}</td>
      <td>${e.retired?'-':e.seniority}</td>
      <td>${e.pref||"-"}</td>
      <td><input type="checkbox" ${e.vacation?"checked":""}
        onchange="employees[${i}].vacation=this.checked;save();generateSchedule()"></td>
      <td><input type="checkbox" ${e.sick?"checked":""}
        onchange="employees[${i}].sick=this.checked;save();generateSchedule()"></td>
      <td>${e.retired?"â€”":`<button class="retire" onclick="retireEmployee('${e.id}')">Retire</button>`}</td>
    </tr>`;
  });
}

/* EVENTS */
function autoRecommendStaff(){
  const guests=+eventGuests.value;
  if(!guests) return;
  const ratio={ "Plated Service":20,"Buffet Service":30,"Reception":40,"Coffee Break":50 }[eventService.value]||30;
  eventStaff.value=Math.ceil(guests/ratio);
}

function addEvent(){
  const data={
    id: editingEventId || crypto.randomUUID(),
    name:eventName.value,
    date:eventDate.value,
    start:eventStart.value,
    end:eventEnd.value,
    guests:+eventGuests.value,
    service:eventService.value,
    staff:+eventStaff.value
  };
  if(editingEventId){
    Object.assign(events.find(e=>e.id===editingEventId),data);
    editingEventId=null;
  } else events.push(data);
  save(); renderEvents(); generateSchedule();
}

function renderEvents(){
  eventsTable.innerHTML="";
  events.forEach(ev=>{
    eventsTable.innerHTML+=`
    <tr>
      <td>${ev.name}</td><td>${ev.date}</td>
      <td>${ev.start}â€“${ev.end}</td>
      <td>${ev.guests}</td><td>${ev.service}</td>
      <td>${ev.staff}</td>
      <td><button onclick="editEvent('${ev.id}')">Edit</button></td>
      <td><button class="delete" onclick="deleteEvent('${ev.id}')">X</button></td>
    </tr>`;
  });
}

function editEvent(id){
  const e=events.find(x=>x.id===id);
  editingEventId=id;
  eventName.value=e.name;
  eventDate.value=e.date;
  eventStart.value=e.start;
  eventEnd.value=e.end;
  eventGuests.value=e.guests;
  eventService.value=e.service;
  eventStaff.value=e.staff;
}

function deleteEvent(id){
  if(!confirm("Delete event?")) return;
  events=events.filter(e=>e.id!==id);
  save(); renderEvents(); generateSchedule();
}

/* SCHEDULE */
const iso=d=>d.toISOString().split("T")[0];

function getWeekStart(){
  const d=new Date();
  d.setDate(d.getDate()+currentWeekOffset*7);
  const diff=d.getDay()===0?-6:1-d.getDay();
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d;
}

function normalizeHours(start,end){
  const diff=(new Date(`1970-01-01T${end}`)-new Date(`1970-01-01T${start}`))/3600000;
  if(diff<=4) return {h:4,cls:"shift-4"};
  if(diff<6) return {h:6,cls:"shift-6"};
  if(diff<8) return {h:6.5,cls:"shift-65"};
  return {h:8.5,cls:"shift-85"};
}

function editScheduleCell(empId,date){
  const key=empId+"_"+date;
  const val=prompt("Enter hours (4, 5.5, 6.5, 7.5, 8.5). Blank removes shift.",manualEdits[key]||"");
  if(val===null) return;
  if(val==="") delete manualEdits[key];
  else manualEdits[key]=Number(val);
  save(); generateSchedule();
}

function generateSchedule(){
  scheduleTable.innerHTML="";
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{const d=new Date(start);d.setDate(start.getDate()+i);return d;});
  weekHeader.textContent=`${days[0].toLocaleDateString()} â€“ ${days[6].toLocaleDateString()}`;

  scheduleTable.innerHTML="<tr><th>Employee</th>"+
    days.map(d=>`<th>${d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"})}</th>`).join("")+
    "<th>Total</th></tr>";

  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0,row=`<tr><td>${emp.name}</td>`;
    days.forEach(d=>{
      const key=emp.id+"_"+iso(d);
      if(manualEdits[key]){
        total+=manualEdits[key];
        row+=`<td onclick="editScheduleCell('${emp.id}','${iso(d)}')">${manualEdits[key]}h</td>`;
        return;
      }
      const ev=events.find(e=>e.date===iso(d));
      if(!ev || emp.vacation || emp.sick){
        row+=`<td onclick="editScheduleCell('${emp.id}','${iso(d)}')"></td>`;
        return;
      }
      const s = normalizeHours(ev.start, ev.end);
const t = calculateSmartShift(ev, s.h);
total += s.h;

row+=`<td class="${getShiftClassByHours(s.h)}"
      onclick="editScheduleCell('${emp.id}','${iso(d)}')">
      ${s.h}h<br>
      <small>${timeStr(t.start)}â€“${timeStr(t.end)}</small>
      </td>`;
      row+=`<td class="${s.cls}" onclick="editScheduleCell('${emp.id}','${iso(d)}')">${s.h}h</td>`;
    });
    row+=`<td><strong>${total}h</strong></td></tr>`;
    scheduleTable.innerHTML+=row;
  });
}

function regenerateSchedule(){ generateSchedule(); }
function changeWeek(n){ currentWeekOffset+=n; generateSchedule(); }
function toggleDarkMode(){ document.body.classList.toggle("light-mode"); }
function printSchedule(){ showTab("scheduleTab"); setTimeout(()=>window.print(),200); }

/* INIT */
renderEmployees();
renderEvents();
showTab("employeesTab");
generateSchedule();
/* ===== ADD-ON: Time display + correct color logic (NO REMOVALS) ===== */

/* Map hours to correct shift class */
function getShiftClassByHours(h){
  if(h === 4) return "shift-4";
  if(h === 6) return "shift-6";
  if(h === 6.5) return "shift-65";
  if(h === 8) return "shift-65";   // 8h stays YELLOW
  if(h === 8.5) return "shift-85"; // 8.5h stays PURPLE
  return "";
}

/* Format time range */
function formatTimeRange(start, end){
  if(!start || !end) return "";
  return `${start}â€“${end}`;
}

/* Patch schedule rendering without removing original logic */
const _originalGenerateSchedule = generateSchedule;
generateSchedule = function(){
  scheduleTable.innerHTML="";
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{const d=new Date(start);d.setDate(start.getDate()+i);return d;});
  weekHeader.textContent=`${days[0].toLocaleDateString()} â€“ ${days[6].toLocaleDateString()}`;

  scheduleTable.innerHTML="<tr><th>Employee</th>"+
    days.map(d=>`<th>${d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"})}</th>`).join("")+
    "<th>Total</th></tr>";

  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0,row=`<tr><td>${emp.name}</td>`;
    days.forEach(d=>{
      const key=emp.id+"_"+iso(d);

      /* Manual override */
      if(manualEdits[key]){
        const h=manualEdits[key];
        total+=h;
        row+=`<td class="${getShiftClassByHours(h)}"
              onclick="editScheduleCell('${emp.id}','${iso(d)}')">
              ${h}h
              </td>`;
        return;
      }

      const ev=events.find(e=>e.date===iso(d));
      if(!ev || emp.vacation || emp.sick){
        row+=`<td onclick="editScheduleCell('${emp.id}','${iso(d)}')"></td>`;
        return;
      }

      const s=normalizeHours(ev.start,ev.end);
      total+=s.h;

      row+=`<td class="${getShiftClassByHours(s.h)}"
            onclick="editScheduleCell('${emp.id}','${iso(d)}')">
            ${s.h}h<br>
            <small>${formatTimeRange(ev.start, ev.end)}</small>
            </td>`;
    });
    row+=`<td><strong>${total}h</strong></td></tr>`;
    scheduleTable.innerHTML+=row;
  });
};
/* ===== END ADD-ON ===== */
/* ===== ADD-ON: Event buffer + rounding + meal break logic ===== */

/* Round minutes to :00 or :30 */
function roundToHalfHour(date, direction="nearest"){
  const d = new Date(date);
  const m = d.getMinutes();

  if(direction === "down"){
    d.setMinutes(m < 30 ? 0 : 30);
  } else if(direction === "up"){
    d.setMinutes(m <= 30 ? 30 : 60);
  } else {
    d.setMinutes(m < 15 ? 0 : m < 45 ? 30 : 60);
  }
  d.setSeconds(0,0);
  return d;
}

/* Build shift times from event */
function buildShiftTimes(ev){
  const start = new Date(`${ev.date}T${ev.start}`);
  const end   = new Date(`${ev.date}T${ev.end}`);

  const bigEvent = ev.guests >= 200;
  const buffer   = bigEvent ? 2 : 1;

  let shiftStart = new Date(start);
  let shiftEnd   = new Date(end);

  shiftStart.setHours(shiftStart.getHours() - buffer);
  shiftEnd.setHours(shiftEnd.getHours() + buffer);

  shiftStart = roundToHalfHour(shiftStart, "down");
  shiftEnd   = roundToHalfHour(shiftEnd, "up");

  let hours = (shiftEnd - shiftStart) / 3600000;

  /* Meal break logic */
  let paidHours = hours;
  if(hours > 4){
    paidHours -= 0.5; // display hours
  }

  return {
    start: shiftStart,
    end: shiftEnd,
    scheduledHours: hours,
    displayHours: paidHours
  };
}

/* Override normalizeHours WITHOUT removing original */
const _originalNormalizeHours = normalizeHours;
normalizeHours = function(start, end, ev=null){
  if(!ev){
    return _originalNormalizeHours(start, end);
  }

  const shift = buildShiftTimes(ev);

  let h = shift.scheduledHours;
  if(h <= 4) h = 4;
  else if(h < 6) h = 6;
  else if(h < 8) h = 6.5;
  else h = 8.5;

  return {
    h,
    cls: getShiftClassByHours(h),
    start: shift.start,
    end: shift.end,
    display: shift.displayHours
  };
};

/* Patch generateSchedule again to inject new logic */
const _patchedGenerateSchedule2 = generateSchedule;
generateSchedule = function(){
  scheduleTable.innerHTML="";
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{const d=new Date(start);d.setDate(start.getDate()+i);return d;});
  weekHeader.textContent=`${days[0].toLocaleDateString()} â€“ ${days[6].toLocaleDateString()}`;

  scheduleTable.innerHTML="<tr><th>Employee</th>"+
    days.map(d=>`<th>${d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"})}</th>`).join("")+
    "<th>Total</th></tr>";

  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0,row=`<tr><td>${emp.name}</td>`;
    days.forEach(d=>{
      const key=emp.id+"_"+iso(d);

      if(manualEdits[key]){
        const h=manualEdits[key];
        total+=h;
        row+=`<td class="${getShiftClassByHours(h)}"
              onclick="editScheduleCell('${emp.id}','${iso(d)}')">${h}h</td>`;
        return;
      }

      const ev=events.find(e=>e.date===iso(d));
      if(!ev || emp.vacation || emp.sick){
        row+=`<td onclick="editScheduleCell('${emp.id}','${iso(d)}')"></td>`;
        return;
      }

      const shift = buildShiftFromEvent(ev);

total += shift.internalHours;

row+=`<td class="${getShiftClassByHours(shift.displayHours)}"
      onclick="editScheduleCell('${emp.id}','${iso(d)}')">
      ${shift.displayHours}h<br>
      <small>${shift.start}â€“${shift.end}</small>
      </td>`;
    });
    row+=`<td><strong>${total}h</strong></td></tr>`;
    scheduleTable.innerHTML+=row;
  });
};
/* ===== END ADD-ON ===== */
/* ===== ADD-ON: Event buffer + rounding + meal-break shift times ===== */

function roundToHalfHour(timeStr){
  const [h,m] = timeStr.split(":").map(Number);
  if(m <= 14) return `${String(h).padStart(2,"0")}:00`;
  if(m <= 44) return `${String(h).padStart(2,"0")}:30`;
  return `${String(h+1).padStart(2,"0")}:00`;
}

function addHours(timeStr, hrs){
  const d = new Date(`1970-01-01T${timeStr}`);
  d.setMinutes(d.getMinutes() + hrs*60);
  return d.toTimeString().slice(0,5);
}

function buildShiftFromEvent(ev){
  const buffer = ev.guests >= 200 ? 2 : 1;

  let start = addHours(ev.start, -buffer);
  let end   = addHours(ev.end, buffer);

  start = roundToHalfHour(start);
  end   = roundToHalfHour(end);

  let diff = (new Date(`1970-01-01T${end}`) - new Date(`1970-01-01T${start}`)) / 3600000;

  let displayHours = diff;
  let internalHours = diff;

  if(diff > 4){
    internalHours += 0.5;

    // decide where meal goes
    const preBuffer  = buffer;
    const postBuffer = buffer;

    if(preBuffer >= postBuffer){
      start = addHours(start, -0.5);
    } else {
      end = addHours(end, 0.5);
    }
  }

  return {
    start,
    end,
    displayHours: Math.round(displayHours),
    internalHours
  };
}
/* ===== ADD-ON: Clear Day Button (NO REMOVALS) ===== */

function clearDay(dateStr){
  if(!confirm("Clear all shifts for this day?")) return;

  // Remove manual edits for this day
  Object.keys(manualEdits).forEach(key=>{
    if(key.endsWith("_"+dateStr)){
      delete manualEdits[key];
    }
  });

  // Remove auto-generated shifts by temporarily ignoring events that day
  // (events stay saved â€” schedule just clears)
  save();
  generateSchedule();
}

/* Patch header to add clear buttons */
const _origGenerateScheduleWithClear = generateSchedule;
generateSchedule = function(){
  scheduleTable.innerHTML="";
  const start=getWeekStart();
  const days=[...Array(7)].map((_,i)=>{
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    return d;
  });

  weekHeader.textContent =
    `${days[0].toLocaleDateString()} â€“ ${days[6].toLocaleDateString()}`;

  scheduleTable.innerHTML =
    "<tr><th>Employee</th>" +
    days.map(d=>{
      const ds = iso(d);
      return `
        <th>
          ${d.toLocaleDateString(undefined,{weekday:"short",day:"numeric"})}
          <br>
          <button class="delete" style="margin-top:4px"
            onclick="clearDay('${ds}')">ðŸ—‘</button>
        </th>`;
    }).join("") +
    "<th>Total</th></tr>";

  // Run original row logic
  employees.filter(e=>!e.retired).forEach(emp=>{
    let total=0;
    let row=`<tr><td>${emp.name}</td>`;

    days.forEach(d=>{
      const key=emp.id+"_"+iso(d);

      if(manualEdits[key]){
        total+=manualEdits[key];
        row+=`<td onclick="editScheduleCell('${emp.id}','${iso(d)}')">
              ${manualEdits[key]}h
              </td>`;
        return;
      }

      const ev=events.find(e=>e.date===iso(d));
      if(!ev || emp.vacation || emp.sick){
        row+=`<td onclick="editScheduleCell('${emp.id}','${iso(d)}')"></td>`;
        return;
      }

      const s=normalizeHours(ev.start,ev.end);
      total+=s.h;
      row+=`<td class="${s.cls}"
            onclick="editScheduleCell('${emp.id}','${iso(d)}')">
            ${s.h}h
            </td>`;
    });

    row+=`<td><strong>${total}h</strong></td></tr>`;
    scheduleTable.innerHTML+=row;
  });
};

/* ===== END ADD-ON ===== */
/* ===== SMART SHIFT TIME + MEAL LOGIC (OPTION C) ===== */

function roundToHalfHour(date) {
  const mins = date.getMinutes();
  if (mins < 15) date.setMinutes(0);
  else if (mins < 45) date.setMinutes(30);
  else { date.setMinutes(0); date.setHours(date.getHours() + 1); }
  date.setSeconds(0);
  return date;
}

function calculateSmartShift(ev, paidHours) {
  const baseStart = new Date(`1970-01-01T${ev.start}`);
  const baseEnd   = new Date(`1970-01-01T${ev.end}`);

  let buffer = 1;
  if (ev.guests >= 200) buffer = 2;

  const workHours = paidHours > 4 ? paidHours - 0.5 : paidHours;

  // OPTION A: meal AFTER
  let startA = new Date(baseStart);
  startA.setHours(startA.getHours() - buffer);
  let endA = new Date(startA);
  endA.setHours(endA.getHours() + workHours);

  // OPTION B: meal BEFORE
  let endB = new Date(baseEnd);
  endB.setHours(endB.getHours() + buffer);
  let startB = new Date(endB);
  startB.setHours(startB.getHours() - workHours);

  // Round both
  startA = roundToHalfHour(startA);
  endA   = roundToHalfHour(endA);
  startB = roundToHalfHour(startB);
  endB   = roundToHalfHour(endB);

  // Pick closer to event window (OPTION C)
  const distA = Math.abs(startA - baseStart) + Math.abs(endA - baseEnd);
  const distB = Math.abs(startB - baseStart) + Math.abs(endB - baseEnd);

  return distA <= distB
    ? { start: startA, end: endA }
    : { start: startB, end: endB };
}

function timeStr(d){
  return d.toTimeString().slice(0,5);
}
</script>
</body>
</html>
